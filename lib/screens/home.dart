import 'dart:async';
import 'dart:convert';
import 'dart:core';
import 'dart:core';
import 'dart:core';
import 'dart:ffi';
import 'dart:io';
import 'package:connect/Activities/CustomerUserHome/HomePager/ui_components.dart';
import 'package:connect/DarkThemeManager.dart';
import 'package:connect/Toast/AppToast.dart';
import 'package:connect/utils/featureSettings.dart';
import 'package:flutter/material.dart';
import 'package:flutter/material.dart';
import 'dart:io';
import 'package:connect/Activities/CameraGallaryWIdget/camera_gallary.dart';
import 'package:connect/Activities/CameraToggleSwitch/cameraToggle.dart';
import 'package:connect/Activities/CustomBottomNavigationBar/appBottomNavigationBar.dart';
import 'package:connect/Activities/CustomerUserHome/Reportings/logics.dart';
import 'package:connect/Activities/CustomerUserHome/Reportings/ui_components.dart';
import 'package:connect/Activities/contstantWidgets/constantWidgets.dart';
import 'package:connect/Appabr/appbar_widget.dart';
import 'package:connect/components/buttonView.dart';
import 'package:connect/scanningAnimatedIcon/wave.dart';
import 'package:connect/screens/popup/deleteFolderPopup.dart';
import 'package:connect/screens/popup/folder_exists_error.dart';
import 'package:connect/screens/popup/testSavedPopup.dart';
import 'package:geolocator/geolocator.dart' as gl;
import "dart:typed_data";
import 'package:camera/camera.dart';
import 'package:geolocator/geolocator.dart';
import 'package:permission_handler/permission_handler.dart';
import 'package:connect/Activities/CustomerUserHome/logics.dart';
import 'package:connect/Activities/TestPerformActivity/activity_page.dart';
import 'package:connect/Activities/TestPerformActivity/logics.dart';
import 'package:connect/Activities/TestPerformActivity/ui_components.dart';
import 'package:connect/Activities/old_test_perform/old_test_perform.dart';
import 'package:connect/components/appBarCustom.dart';
import 'package:connect/screens/popup/editTargetLoadAndTimePopUp.dart';
import 'package:connect/screens/testMapScreen.dart';
import 'package:connect/screens/testScreen.dart';
import 'package:connect/utils/appConst.dart';
import 'package:connect/utils/colorConst.dart';
import 'package:connect/utils/textConst.dart';
import 'package:connect/utils/textStyleConst.dart';
import 'package:connect/utils/themeManager.dart';
import 'package:convert/convert.dart';
 import 'package:flutter_svg/svg.dart';
 import 'package:google_maps_flutter/google_maps_flutter.dart';
 import 'package:connect/labels/appLabels.dart';
import 'package:connect/localization/language/languages.dart';
import 'package:connect/pages/pion.dart';
import 'package:connect/pages/settigs_page.dart';
import 'package:connect/services/Firestoredatabase.dart';
import 'package:connect/services/StorageManager.dart';
import 'package:connect/services/os_dependent_settings.dart';
import 'package:connect/services/themeManager.dart';
import 'package:connect/streams/buttonStreams.dart';
import 'package:connect/widgets/appwidgets.dart';
 import 'package:flutter_picker/flutter_picker.dart';
import 'package:flutter/cupertino.dart';
import 'package:flutter/services.dart';
import 'package:connect/pages/TestPeromationActivity.dart';
import 'package:connect/screens/CallWidget.dart';
import 'package:connect/services/Signal.dart';
import 'package:connect/widgets/cu.dart';
import 'package:image_picker/image_picker.dart';

import 'package:screenshot/screenshot.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'dart:typed_data';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'dart:math' as math;
import 'package:share/share.dart';
import 'dart:ui' as ui;
 import 'package:flutter/material.dart';
import 'dart:math' as math;
import 'package:flutter/foundation.dart' show kIsWeb;
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:firebase_core/firebase_core.dart';
import 'package:firebase_messaging/firebase_messaging.dart';
import 'package:flutter/gestures.dart';
import 'package:flutter/material.dart';
import 'package:connect/models/SavedData.dart';
import 'package:connect/models/todo.dart';
import 'package:connect/pages/TestDetailsPage.dart';
import 'package:connect/pages/app_map_view.dart';
import 'package:connect/pages/connected_device_page.dart';
import 'package:connect/pages/graph_3.dart';
import 'package:connect/pages/home_page.dart';
import 'package:connect/pages/map_view.dart';
import 'package:connect/pages/perform_test.dart';
import 'package:connect/services/auth.dart';
import 'package:connect/services/database.dart';
import 'package:connect/services/restApi.dart';
import 'package:connect/services/show_widgets.dart';
import 'package:connect/widgets/lists_widgets.dart';
import 'package:connect/widgets/todo_card.dart';
import 'package:flutter_blue/flutter_blue.dart';
import 'package:syncfusion_flutter_signaturepad/signaturepad.dart';
import 'package:video_player/video_player.dart';

import '../Storage.dart';
import '../main.dart';
import '../widgets.dart';
import 'package:intl/intl.dart';
import 'package:flutter/material.dart';

void _pushPage(BuildContext context, Widget page) {
  Navigator.of(context) /*!*/ .push(
    MaterialPageRoute<void>(builder: (_) => page),
  );
}








void initCallIntent(
    //IO.Socket socket,
    String callTYpe,
    String ownid,
    String partner,
    bool isCaller,
    FirebaseFirestore firestore,
    BuildContext context,
    String displayName) {
  callStartedNotify() {}
  callUserIsNoAvailable() {}

  doSomething() {
    Navigator.pop(context);
  }

  // if(isCaller){
  //  firestore.collection("users").where("uid",isEqualTo: ownid).get().then((value) {
  //     socket.emit("calldial", {
  //       "partner": partner,
  //       "callerName": value.docs.first.data()["displayName"],
  //       "callerId": ownid,
  //       "time":DateTime.now().millisecondsSinceEpoch
  //     });
  //   });
  //
  // }


  List all = [ownid,partner];
  all.sort();
  // Navigator.push(
  //   context,
  //   MaterialPageRoute(
  //       builder: (context) =>
  //           WillPopScope(
  //             onWillPop: () async => false,
  //             child: MainHomePagePion(
  //               uid: FirebaseAuth.instance.currentUser!.uid,
  //               grpId:all.first+all.last, grpName: '',
  //               //socket: socket ,
  //             ),
  //           )),
  // );

  // Navigator.push(
  //   context,
  //   MaterialPageRoute(
  //       builder: (context) => WillPopScope(
  //             onWillPop: () async => false,
  //             child: SimpleWebCall(
  //               socket: socket,
  //               containsVideo: false,
  //               ownID: ownid,
  //               partnerid: partner,
  //               isCaller: isCaller,
  //               firestore: firestore,
  //               // partnerPair: ids.first + "-" + ids.last,
  //               callback: doSomething,
  //               callStartedNotify: callStartedNotify,
  //               callUserIsNoAvailable: callUserIsNoAvailable,
  //               partnerName: displayName,
  //             ),
  //           )),
  // );
}

class ViewTestSection extends StatefulWidget {
  @override
  _ViewTestSectionState createState() => _ViewTestSectionState();
}

class _ViewTestSectionState extends State<ViewTestSection> {
  @override
  Widget build(BuildContext context) {
    return Container();
  }
}

class PerformtestSection extends StatefulWidget {
  @override
  _PerformtestSectionState createState() => _PerformtestSectionState();
}

class _PerformtestSectionState extends State<PerformtestSection> {
  @override
  Widget build(BuildContext context) {
    return Container();
  }
}



class SectionOne extends StatefulWidget {
  @override
  _RedState createState() => _RedState();
}

class _RedState extends State<SectionOne> {
  @override
  Widget build(BuildContext context) {
    return Container(
      child: Stack(
        children: [
          Column(
            mainAxisAlignment: MainAxisAlignment.start,
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Padding(
                padding: const EdgeInsets.fromLTRB(20, 10, 8, 8),
                child: Text(
                  "Recently Performed Tests",
                  style: TextStyle(
                      fontSize: 20,
                      fontWeight: FontWeight.bold,),
                ),
              ),
            ],
          ),
          Align(
            alignment: Alignment.bottomCenter,
            child: Padding(
              padding: EdgeInsets.all(10),
              child: Card(
                elevation: 2,
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(30),
                ),
                color: Theme.of(context).primaryColor,
                child: Container(
                    height: 50,
                    child: Center(
                        child: Text(
                      "Perform a Test",
                      style: TextStyle(
                          fontSize: 20,
                          fontWeight: FontWeight.bold,),
                    ))),
              ),
            ),
          )
        ],
      ),
    );
  }
}





class FileExplorar extends StatefulWidget {
  List<String> folderStack = ["root"];

  String currentFolderName = "";

  // String folderParent;
  FirebaseFirestore customerFirestore;

  FileExplorar({required this.customerFirestore});

  int selectedFolderType = 0;

  @override
  _FileExplorarState createState() => _FileExplorarState();
}

class _FileExplorarState extends State<FileExplorar> {
  TextEditingController _folderNameController = TextEditingController();

  @override
  Widget build(BuildContext context) {
    return DefaultTabController(
      length: 3,
      child: Scaffold(
        appBar: AppBar(
          title: Text('Fixed Tabs'),
          automaticallyImplyLeading: false,
          backgroundColor: Color(0xff5808e5),
          bottom: TabBar(
            indicatorColor: Colors.white,
            tabs: [
              Tab(text: 'DOGS', icon: Icon(Icons.favorite)),
              Tab(text: 'CATS', icon: Icon(Icons.music_note)),
              Tab(text: 'BIRDS', icon: Icon(Icons.search)),
            ],
          ),
        ),
        body: TabBarView(
          children: [
            Center(child: Text('DOGS')),
            Center(child: Text('CATS')),
            Center(child: Text('BIRDS')),
          ],
        ),
      ),
    );
  }
}


class UserTestsByRecent extends StatefulWidget {
  FirebaseFirestore customerFirestore;
  String customerId;
  Locale locale;
  UserTestsByRecent({required this.customerId,required this.customerFirestore,required this.locale});

  @override
  _UserTestsByRecentState createState() => _UserTestsByRecentState();
}

class _UserTestsByRecentState extends State<UserTestsByRecent> {
  @override
  Widget build(BuildContext context) {
    return  StreamBuilder<QuerySnapshot>(
        stream: AppFirestore(firestore: widget.customerFirestore,auth: FirebaseAuth.instance, projectId: '').getUsrsRecentAllTests(),
        //recent
        builder: (context, snapshot) {

          if (snapshot.hasData &&
              snapshot.data != null &&
              snapshot.data!.docs != null) {
            if (snapshot.data!.size > 0 && snapshot.data!.docs.length>0)
              //List list = snapshot.data.docs;

              return ListView.separated(
                // reverse: true,
                  separatorBuilder: (context, index) {
                    return Divider(color: AppThemeManager(). getDividerColor(),);
                  },
                  //padding: EdgeInsets.zero,
                  physics: NeverScrollableScrollPhysics(),
                  // physics: const BouncingScrollPhysics(parent: AlwaysScrollableScrollPhysics()),
                  shrinkWrap: true,
                  //reverse: true,
                  itemCount: snapshot.data == null
                      ? 0
                      : snapshot.data!.docs.length,
                  itemBuilder: (_, index) {
                    return Padding(
                      padding: const EdgeInsets.all(5.0),
                      child: InkWell(
                        onTap: () {
                          AppWidgets(customerId: widget.customerId,customerFirestore:
                          widget.customerFirestore). showTestRecordBody(

                              snapshot.data!.docs[(snapshot.data!.docs.length-1)-index].id,
                              snapshot.data!.docs[(snapshot.data!.docs.length-1)-index],
                              context,widget.locale,2);
                        },
                        child: Row(
                          children: [

                            Padding(
                              padding: const EdgeInsets.fromLTRB(0,0,10,0),
                              child:   Container(
                                margin: EdgeInsets.only(
                                  left: width * 0.02,
                                ),
                                // child:Image.asset("assets/svg/gr.png",fit: BoxFit.cover,),
                                child:SvgPicture.asset("assets/svg/loadIcon.svg",fit: BoxFit.cover,color: ThemeManager().getYellowGradientColor,),
                              ),
                            ),
                            //
                            Text(snapshot.data!.docs[(snapshot.data!.docs.length-1)-index]["name"].toString().length>25?snapshot.data!.docs[(snapshot.data!.docs.length-1)-index]["name"].toString().substring(0,25):snapshot.data!.docs[(snapshot.data!.docs.length-1)-index]["name"],
                                style: interRegular.copyWith(
                                color: AppThemeManager(). getTextColor1(),
                      fontSize: width * 0.045,
                    )),



                            // Padding(
                            //   padding: const EdgeInsets.fromLTRB(
                            //       10, 5, 10, 5),
                            //   child: Icon(
                            //     Icons.circle,
                            //     size: 15,
                            //   ),
                            // ),
                            // Column(
                            //   mainAxisAlignment:
                            //   MainAxisAlignment.start,
                            //   crossAxisAlignment:
                            //   CrossAxisAlignment.start,
                            //   children: [
                            //     Text(
                            //       snapshot.data!.docs[(snapshot.data!.docs.length-1)-index]["name"]
                            //           .toString(),
                            //       style: TextStyle(
                            //         fontWeight: FontWeight.bold,),
                            //     ),
                            //     timeFormate(snapshot
                            //         .data!.docs[(snapshot.data!.docs.length-1)-index]["time"])
                            //   ],
                            // )
                          ],
                        ),
                      ),
                    );

                  });
            else
              return  ConstantWidget().notData();;
          } else {
            return Scaffold(body: Center(child: Text("Please wait")),);
          }
        });
  }


}


class TestRecordWidget extends StatefulWidget {
  String customerId;
  FirebaseFirestore customerFirestore;
  Locale locale;

  TestRecordWidget({required this.customerId, required this.customerFirestore, required this.locale});

  @override
  _TestRecordWidgetState createState() => _TestRecordWidgetState();
}

class _TestRecordWidgetState extends State<TestRecordWidget> {
  @override
  Widget build(BuildContext context) {
    return DefaultTabController(
      length: 2,
      child: Scaffold(

        appBar: PreferredSize(
          preferredSize: Size.fromHeight(kToolbarHeight),
          child: Padding(
            padding: const EdgeInsets.all(4.0),
            child: Container(
              width: 100,
              child: TabBar(


                tabs: [
                  Padding(
                    padding: const EdgeInsets.all(15.0),
                    child: new Text(
                      "My records",
                      style: TextStyle(),
                    ),
                  ),
                  Padding(
                    padding: const EdgeInsets.all(15.0),
                    child: new Text("Shared with me", style: TextStyle()),
                  )
                ],
              ),
            ),
          ),
        ),

        body: Expanded(
          child: TabBarView(
            children: [
              StreamBuilder(
                  // Initialize FlutterFire:
                  stream: Api(firestore: widget.customerFirestore).fetchCustomerUsersAllTestRecordWithFirestore(
                      uid: FirebaseAuth.instance.currentUser!.uid,
                      firestore: widget.customerFirestore),
                  builder: (BuildContext context,
                      AsyncSnapshot<QuerySnapshot> snapshotHistory) {
                    if (snapshotHistory.hasData &&
                        snapshotHistory.data!.docs.length > 0) {
                      // return Text("ok");

                      return ListView.builder(
                          shrinkWrap: true,
                          itemCount: snapshotHistory.data!.docs.length,
                          itemBuilder: (_, index) {
                            return ListTile(
                              onTap: () {
                                //here
                              AppWidgets(customerId:  widget.customerId,customerFirestore:
                              widget.customerFirestore).  showTestRecordBody(

                                    snapshotHistory.data!.docs[index].id,
                                    snapshotHistory.data!.docs[index],
                                    context,widget.locale,2);
                              },
                              trailing: Text(
                                "View",
                                style: TextStyle(
                                    color: Theme.of(context).primaryColor),
                              ),
                              subtitle: Text(
                                DateFormat('hh:mm aa MMM dd').format(
                                    DateTime.fromMillisecondsSinceEpoch(
                                        snapshotHistory.data!.docs[index]
                                            ["time"])),
                                style: TextStyle(),
                              ),
                              title: Text(
                                  snapshotHistory.data!.docs[index].get("name")),
                            );
                          });
                    } else {
                      return Padding(
                        padding: const EdgeInsets.all(15.0),
                        child: Text("No records available"),
                      );
                    }
                  }),
              StreamBuilder<QuerySnapshot>(
                  // Initialize FlutterFire:
                  stream: widget.customerFirestore
                      .collection("sharedRecords")
                      .where("sharedTo",
                          isEqualTo: FirebaseAuth.instance.currentUser!.uid)
                      .snapshots(),
                  builder: (BuildContext context,
                      AsyncSnapshot<QuerySnapshot> snapshotHistory) {
                    if (snapshotHistory.hasData &&
                        snapshotHistory.data!.docs.length > 0) {
                      return ListView.builder(
                          shrinkWrap: true,
                          itemCount: snapshotHistory.data!.docs.length,
                          itemBuilder: (_, index) {
                            return FutureBuilder<DocumentSnapshot>(
                                // Initialize FlutterFire:
                                //  future: Firebase.initializeApp(),
                                future: widget.customerFirestore
                                    .collection("pulltest")
                                    .doc(snapshotHistory.data!.docs[index]
                                        ["testId"])
                                    .get(),
                                builder: (BuildContext context,
                                    AsyncSnapshot<DocumentSnapshot> snapsto) {
                                  //snapshot.data.docs[index]["id"].toString()
                                  if (snapsto.hasData &&
                                      snapsto.data != null &&
                                      snapsto.data!.get != null) {
                                    return ListTile(
                                      onTap: () {
                                        AppWidgets(customerId:  widget.customerId,customerFirestore:   widget.customerFirestore). showTestRecordBody(

                                            snapsto.data!.id,
                                            snapsto.data,
                                            context,widget.locale,2
                                          );
                                      },
                                      title: Text(snapsto.data!.get("name")),
                                    );
                                    // return Text(snapsto.data.get["name"]);
                                  } else
                                    return CircularProgressIndicator();
                                });


                          });
                    } else {
                      return Padding(
                        padding: const EdgeInsets.all(15.0),
                        child: Text("No records available"),
                      );
                    }
                  }),
            ],
          ),
        ),
      ),
    );
  }
}

class AllUsersListActivity extends StatefulWidget {
 late FirebaseFirestore customerFirestore;
 late String customerId;
 late String customerName;
 late FirebaseAuth auth;
 late FirebaseFirestore firestore;
 late CollectionReference firestoreFolderRef;

  AllUsersListActivity(
      {
        required  this.firestore,
        required this.customerFirestore,
        required this.customerId,
        required this.auth,
        required  this.customerName});

  @override
  _AllUsersListActivityState createState() => _AllUsersListActivityState();
}

class _AllUsersListActivityState extends State<AllUsersListActivity> {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: StreamBuilder<QuerySnapshot>(
          stream: widget.firestore
              .collection("users")
              .where("parentType", isEqualTo: "customer")
              .where("parentId", isEqualTo: widget.customerId)
              // .where("roleId",isEqualTo: ROLE_ID_CUSTOMER_USER)
              .snapshots(),
          builder: (c, snapshotUsers) {
            // return Text(usersnapshot.data.docs[index].id);
            if (snapshotUsers.hasData) {
              return ListView.builder(
                  shrinkWrap: true,
                  itemCount: snapshotUsers.data!.size,
                  itemBuilder: (context, index) {
                    //dia
//
                    return ListTile(
                      trailing: InkWell(
                          onTap: () {
                            initCallIntent(
                               // widget.socket,
                                "a",
                                widget.auth.currentUser!.uid,
                                snapshotUsers.data!.docs[index].get("uid"),
                                true,
                                widget.firestore,
                                context,
                                snapshotUsers.data!.docs[index]
                                    .get("displayName"));
                          },
                          child: Padding(
                            padding: const EdgeInsets.all(8.0),
                            child: Icon(Icons.call),
                          )),
                      leading: Container(
                        width: 40,
                        height: 40,
                        child: Stack(
                          children: [
                            Align(
                              alignment: Alignment.center,
                              child: CircleAvatar(),
                            ),
                            Align(
                                alignment: Alignment.center,
                                child: Text(
                                  snapshotUsers.data!.docs[index]
                                      .get("displayName")
                                      .toString()
                                      .characters
                                      .first
                                      .toUpperCase()
                                      .toString(),
                                  style: TextStyle(),
                                )),
                          ],
                        ),
                      ),
                      title: Text(
                          snapshotUsers.data!.docs[index].get("displayName")),
                      //  subtitle: Text( snapshotUsers.data.docs[index].get["roleId"]),
                      subtitle: FutureBuilder<DocumentSnapshot>(
                          future: widget.firestore
                              .collection("roles")
                              .doc(snapshotUsers.data!.docs[index].get("roleId"))
                              .get(),
                          builder: (c, snapshotRecordRoleName) {
                            if (snapshotRecordRoleName.hasData &&
                                snapshotRecordRoleName.data!.exists) {
                              // return  Text(snapshotRecordRoleName.data.docs.length.toString());
                              return Wrap(
                                children: [
                                  Text(snapshotUsers.data!.docs[index]
                                      .get("email")),
                                  Padding(
                                    padding:
                                        const EdgeInsets.fromLTRB(0, 0, 0, 0),
                                    child: Text(
                                      snapshotRecordRoleName.data!
                                          .get("roleName"),
                                      style: TextStyle(),
                                    ),
                                  ),
                                ],
                              );
                              // return Wrap(child: Text( snapshotRecordRoleName.data.get["roleName"]));
                            } else {
                              return Text("Please wait");
                            }
                          }),
                    );
                  });
              //return Text("ik", style: TextStyle(fontSize: 30));

            } else {
              return Center(
                child: Text("No Users"),
              );
            }
          }),
    );
  }
}



class TakePreDataActivity extends StatefulWidget {
  BluetoothDevice d;
  String customerId;
  int testDuration = 5;
  FirebaseFirestore customerFirestore;
  SharedPreferences sPref;
  String lastLoad;
  TextEditingController controller;
  Widget appbar;


  TakePreDataActivity(
      {required this.controller,
        required this.lastLoad,
        required this.d,
        required this.appbar,
        required  this.customerFirestore,
        required  this.customerId,
        required this.sPref});

  @override
  _TakePreDataActivityState createState() => _TakePreDataActivityState();
}

class _TakePreDataActivityState extends State<TakePreDataActivity>  {
  ScreenshotController screenshotController = ScreenshotController();
  int stage = 0 ;
  double maxZoom = 0;
  double minZoom = 0;
  double zoom = 1;
  bool? isSelected = false;
  XFile? imageFile;
  Set<Marker> _markers = {};
  LatLng? currentPosition;
  CameraPosition? defaultLocation;
  BitmapDescriptor? markerIcon;
  bool? _isSelectForPhoto;
  List<String> imageList = [];
  List newImageList = [];
  ScrollController _scrollController = ScrollController();
  var camera;
  late CameraController _controller;
  Future<void>? _initializeControllerFuture;
  List<CameraDescription> cameras = [];
  bool _isRecording = false;
  static const countdownDuration = Duration(minutes: 0);
  Duration duration = Duration();
  Timer? timer;

  bool countDown = true;
  Widget mapWidget  = Container(child: Center(child: Text("No Map Data"),),);

  var loadValue = "0";
  var secondValue = "0";
  var loadUnitValue = "";


  int selectedPosition = 0;

  //TextEditingController controllerLoad = new TextEditingController();
  int selectedTime = 0;

  bool didLimitKnExceed = false;
  String index2 = "";
  String index6 = "";

  final Map<int, Widget> logoWidgets = const <int, Widget>{
    0: Padding(
      padding: EdgeInsets.all(10),
      child: Text('30 Second'),
    ),
    1: Padding(
      padding: EdgeInsets.all(10),
      child: Text('60 Second'),
    ),
    2: Padding(
      padding: EdgeInsets.all(10),
      child: Text('Custom'),
    ),
  };

  itemClickListener(int val) async {
    if (val == 0) {
      await widget.sPref.setInt('timer', 30);
      widget.testDuration = 30;
    }
    if (val == 1) {
      await widget.sPref.setInt('timer', 60);
      widget.testDuration = 60;
    }
    if (val == 2) {
      //pop up custom time picker
      int? time = widget.sPref.getInt("timer");
      if (time != null) {
        if (time == 30) {
        } else if (time == 60) {
        } else {}
      }
      //TODO slider will be populated with the last time minute / second
      showPickerNumber(
        context,
      );

/*
      var resultingDuration = await showDurationPicker(
        context: context,snapToMins: 1,
        initialTime: Duration(seconds: 5),
      );
      ScaffoldMessenger.of(context).showSnackBar(SnackBar(
          content: Text('Chose duration: $resultingDuration')));



      await prefs.setInt('timer', 20);
      widget.testDuration = 20;

 */
    }
  }

  showPickerNumber(BuildContext context) {
    new Picker(
        adapter: NumberPickerAdapter(data: [
          NumberPickerColumn(begin: 0, end: 59),
          NumberPickerColumn(begin: 0, end: 59),
        ]),
        delimiter: [
          PickerDelimiter(
              child: Container(
            width: 30.0,
            alignment: Alignment.center,
            child: Icon(Icons.more_vert),
          ))
        ],
        hideHeader: true,
        title: new Text("Minute : Second"),
        onConfirm: (Picker picker, List value) async {
          print(value.toString());
          if(picker!=null) {
            int seconds = 60 * (int.parse(picker.getSelectedValues()[0].toString())) +int.parse(picker.getSelectedValues()[1].toString());
            await widget.sPref.setInt('timer', seconds.toInt());
            widget.testDuration = seconds.toInt();
            setState(() {
              selectedTime = seconds.toInt();
            });
          }
        }).showDialog(context);
  }

  @override
  void initState() {
    // TODO: implement initState
    super.initState();
    //initMemoryOfLastTest();
    initDeviceSlAndCalibDate(widget.d);



    initCamera();
  }
  late AppLifecycleState _notification;


  @override
  void dispose() {
    timer!.cancel();
    super.dispose();
  }
  void selected(int pos, int second) async {
    widget.sPref.setInt("timer", second);

    setState(() {
      selectedPosition = pos;
      selectedTime = second;
    });
  }

  void preparePicker() async {
    print("prepare picker");
    // prefs.setInt("timer",second);
    setState(() {
      selectedPosition = 2;
    });

    showPickerNumber(context);
  }


  Widget camaraGalleryView()  {
    String twoDigits(int n) => n.toString().padLeft(2, '0');
    final minutes = twoDigits(duration.inMinutes.remainder(60));
    final seconds = twoDigits(duration.inSeconds.remainder(60));





  try{
    return FutureBuilder(
      future: _initializeControllerFuture,
      builder: (context, snapshot) {
        if (snapshot.connectionState == ConnectionState.done) {
          return Column(
            children: [
              Container(
                margin: EdgeInsets.only(top: height * 0.035),
                height: height * 0.29,
                width: double.infinity,
                child: Stack(
                  alignment: Alignment.bottomCenter,
                  children: [
                    // return the widget to show the live preview of camera.
                    // Container(
                    //     height: height * 0.19,
                    //     width: double.infinity,
                    //     child: CameraPreview(_controller)),

                    Container(
                        height: height * 0.29,
                        width: double.infinity,
                        child:ClipRect(
                            child: new OverflowBox(
                                maxWidth: double.infinity,
                                maxHeight: double.infinity,
                                alignment: Alignment.center,
                                child: new FittedBox(
                                    fit: BoxFit.cover,
                                    alignment: Alignment.center,
                                    child: new Container(
                                        width: width,
                                        height: height*0.7,
                                        child: new  CameraPreview(_controller)
                                    )
                                )
                            )
                        )),
                    isSelected == true && _isRecording == true
                        ? Positioned(
                      top: height * .02,
                      child: Container(
                        child: Text(
                          minutes + ":" + seconds,
                          style: TextStyle(
                            color: whiteColor,
                          ),
                        ),
                      ),
                    )
                        : Container(),
                    gallaryPhotoAdd?   Positioned(left: 10,bottom: 10,child:      Padding(
                      padding: const EdgeInsets.all(8.0),
                      child: GestureDetector(
                        onTap: () async {

                          showDialog(
                              context: context,
                              builder: (_) => Dialog(child: Container(width: MediaQuery.of(context).size.width*0.9,child: Wrap(
                                children: [
                                  Container(height: 50,
                                    child: Stack(children: [
                                      Align(alignment: Alignment.centerLeft,child: Padding(
                                        padding: const EdgeInsets.only(left: 10),
                                        child: Text("Add attachments from Gallery",style: interSemiBold.copyWith(
                                            color: ThemeManager().getBlackColor,
                                            fontSize: width * 0.042),),
                                      ),),
                                      Align(alignment: Alignment.centerRight,child: InkWell(onTap: (){
                                        Navigator.pop(context);
                                      },child: Padding(
                                        padding: const EdgeInsets.only(right: 10),
                                        child: Icon(Icons.clear),
                                      ),),),
                                    ],),
                                  ),

                                  Padding(
                                    padding: const EdgeInsets.all(8.0),
                                    child: Row(
                                      children: [
                                        Expanded(child: Padding(
                                          padding: const EdgeInsets.all(4.0),
                                          child: Container(decoration: BoxDecoration(borderRadius: BorderRadius.circular(4),color: ThemeManager().getDarkGreenColor),child:
                                          InkWell(onTap: () async {
                                            final ImagePicker _picker = ImagePicker();
                                            // Pick an image
                                            final XFile? image = await _picker.pickImage(source: ImageSource.gallery);

                                            // imageList.add(media.path);
                                            imageList.insert(0,image!.path);

                                            newImageList.add(image!.path);
                                            setState(() {
                                              imageFile = image;

                                            });
                                            Navigator.pop(context);
                                          },
                                            child: Center(child: Padding(
                                              padding: const EdgeInsets.all(8.0),
                                              child: Text("Pick Photo",style: interSemiBold.copyWith(
                                                  color: ThemeManager().getWhiteColor,
                                                  fontSize: width * 0.042),),
                                            ),),
                                          ),),
                                        ),),
                                        Expanded(child: Padding(
                                          padding: const EdgeInsets.all(4.0),
                                          child: Container(decoration: BoxDecoration(borderRadius: BorderRadius.circular(4),color: ThemeManager().getDarkGreenColor),child:
                                          InkWell(onTap: () async {
                                            final ImagePicker _picker = ImagePicker();
                                            // Pick an image
                                            final XFile? image = await _picker.pickVideo(source: ImageSource.gallery);

                                            // imageList.add(media.path);
                                            imageList.insert(0,image!.path);

                                            newImageList.add(image!.path);
                                            setState(() {
                                              imageFile = image;

                                            });
                                            Navigator.pop(context);
                                          },
                                            child: Center(child: Padding(
                                              padding: const EdgeInsets.all(8.0),
                                              child: Text("Pick Video",style: interSemiBold.copyWith(
                                                  color: ThemeManager().getWhiteColor,
                                                  fontSize: width * 0.042),),
                                            ),),
                                          ),),
                                        ),),
                                      ],
                                    ),
                                  ),

                                ],
                              ),),)
                          );


                        },
                        child: Icon(
                          Icons.photo_library_sharp,
                          color: ThemeManager().getWhiteColor,
                          size: height * .03,
                        ),
                      ),
                    ),):Container(height: 0,width: 0,),
                    Wrap(
                        children:[
                          Padding(
                            padding: const EdgeInsets.all(8.0),
                            child: GestureDetector(
                              onTap: () {
                                if (isSelected == false) {
                                  _controller.takePicture().then((value) {
                                    setState(() {
                                      imageFile = value;

                                    });
                                    File media = File(value.path);
                                    // imageList.add(media.path);
                                    imageList.insert(0, media.path);

                                    newImageList.add(media);
                                    //log(imageList.toString());
                                  });
                                } else {
                                  if (_isRecording == false) {
                                    _controller.startVideoRecording().then((value) {
                                      setState(() {
                                        _isRecording = true;
                                      });
                                      startTimer();
                                    });
                                  } else {
                                    _controller.stopVideoRecording().then((value) {
                                      setState(() {
                                        imageFile = value;
                                        _isRecording = false;

                                      });
                                      File media = File(value.path);
                                      // imageList.add(media.path);
                                      imageList.insert(0, media.path);
                                      newImageList.add(media);
                                      // log(imageList.toString());
                                      stopTimer();
                                    });
                                  }
                                }
                              },
                              child: _isRecording == true
                                  ? Container(
                                height: height * .06,
                                width: height * .06,
                                decoration: BoxDecoration(
                                  color: whiteColor,
                                  shape: BoxShape.circle,
                                ),
                                alignment: Alignment.center,
                                child: Container(
                                  decoration: BoxDecoration(color: blackColor),
                                  height: height * .02,
                                  width: height * .02,
                                ),
                              )
                                  : Icon(
                                Icons.circle_outlined,
                                color: ThemeManager().getWhiteColor,
                                size: height * .08,
                              ),
                            ),
                          ),

                        ]
                    ),

                    Align(alignment: Alignment.topRight,child:  Container(
                      //width: width * 0.16,
                      // height: height * 0.045,
                      margin: EdgeInsets.only(
                          left: width * 0.65, top: height * 0.015,right: height * 0.015 ),
                      child: CameraToggle(isPhoto:!isSelected! ,isVideoSelected: (bool ) {
                        print("callbac came"+ bool.toString());

                        _isSelectForPhoto = !bool;
                        isSelected = bool;

                        // isSelected = bool;

                      },),



                    ),),
                    true? Positioned(left: 10,top: 10,child: Column(
                      children: [
                        Padding(
                          padding: const EdgeInsets.all(1.0),
                          child: InkWell(onTap: (){


                            if(maxZoom>0 &&  zoom <maxZoom){
                              _controller.setZoomLevel((zoom+1)).then((value){
                                zoom++;
                              });

                            }

                          },
                            child: Card(color : ThemeManager().getDarkGreenColor,elevation: 4,shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(0.0),),
                              child: Container(width: 40,height: 40,child: Center(child:
                              Text("+",style: TextStyle(fontSize: 20,fontWeight: FontWeight.bold,color: Colors.white)),),),),
                          ),
                        ),
                        Padding(
                          padding: const EdgeInsets.all(1.0),
                          child: InkWell(onTap: (){
                            if(minZoom>0 &&  zoom > minZoom){
                              _controller.setZoomLevel((zoom-1)).then((value){
                                zoom--;
                              });

                            }

                          },
                            child: Card(color: ThemeManager().getDarkGreenColor,elevation: 4,shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(0.0),),
                              child: Container(width: 40,height: 40,child: Center(child:
                              Text("-",style: TextStyle(fontSize: 20,fontWeight: FontWeight.bold,color: Colors.white)),),),),
                          ),
                        ),

                      ],
                    )):Container(width: 0,height: 0,),

                  ],
                ),
              ),
              imageFile == null
                  ? Container()
                  : Stack(
                alignment: Alignment.center,
                clipBehavior: Clip.none,
                children: [
                  SingleChildScrollView(physics: ClampingScrollPhysics(),
                    controller: _scrollController,
                    scrollDirection: Axis.horizontal,
                    child: Row(
                      children: List.generate(imageList.length, (index) {
                        return Container(
                          height: height * 0.07,
                          width: width * 0.18,
                          child: imageList[index].endsWith(".jpg")
                              ? Image.file(
                            File(imageList[index]),
                            fit: BoxFit.cover,
                          )
                              : Container(
                            child: Center(
                              child: Icon(Icons.play_arrow,color: ThemeManager().getDarkGreenColor,),
                              //         child: VideoPlay(
                              //                file: File(imageList[index]),
                              // ),
                            ),
                          ),
                        );
                      }),
                    ),
                  ),
                  imageList.length >= 5
                      ? Positioned(
                    left: -width * .02,
                    right: -width * .02,
                    child: Row(
                      mainAxisAlignment:
                      MainAxisAlignment.spaceBetween,
                      children: [
                        GestureDetector(
                          onTap: () {
                            // _scrollController.animateTo(0, duration: Duration(seconds: 2), curve: Curves.easeIn);
                          },
                          child: Container(
                            height: height * .08,
                            width: width * .05,
                            decoration: BoxDecoration(
                                shape: BoxShape.circle,
                                color: whiteColor,
                                boxShadow: [
                                  BoxShadow(
                                    color: ThemeManager()
                                        .getLightGrey1Color,
                                    spreadRadius: .25,
                                  )
                                ]),
                            padding:
                            EdgeInsets.only(left: width * .012),
                            child: Icon(
                              Icons.arrow_back_ios,
                              color: Colors.black,
                              size: height * .02,
                            ),
                          ),
                        ),
                        GestureDetector(
                          onTap: () {
                            _scrollController.animateTo(width,
                                duration: Duration(seconds: 2),
                                curve: Curves.easeIn);
                          },
                          child: Container(
                            height: height * .08,
                            width: width * .05,
                            decoration: BoxDecoration(
                                shape: BoxShape.circle,
                                color: whiteColor,
                                boxShadow: [
                                  BoxShadow(
                                    color: lightGrey1Color,
                                    spreadRadius: .25,
                                  )
                                ]),
                            padding:
                            EdgeInsets.only(left: width * .004),
                            child: Icon(
                              Icons.arrow_forward_ios,
                              color: Colors.black,
                              size: height * .02,
                            ),
                          ),
                        ),
                      ],
                    ),
                  )
                      : Container()
                ],
              )
            ],
          );
        } else {
          return CircularProgressIndicator();
        }
      },
    );
  }catch(e){
      return Center(child: Container(child: Center(child: Text("Failed to load camera"),),height: 200,width: 300,));
  }
  }
  Future<bool> _willPopCallback() async {
    print("will pop pressed");

    // await showDialog or Show add banners or whatever
    // then
    return false; // return true if the route to be popped
  }
  void initCamera() async {
    WidgetsFlutterBinding.ensureInitialized();

    // Map<Permission, PermissionStatus> statuses = await [
    //   Permission.camera,
    //   Permission.storage,
    //   Permission.location,
    // ].request();
    // print(statuses[Permission.location]);


    if (true || await Permission.camera.request().isGranted && await Permission.camera.request().isGranted && await Permission.location.request().isGranted) {
      // Either the permission was already granted before or the user just granted it.
      try{
        // Obtain a list of the available cameras on the device.
        final cameras = await availableCameras();

        // Get a specific camera from the list of available cameras.
        setState(() {
          for (var i = 0; i < cameras.length; i++) {
            if (cameras[i].lensDirection == CameraLensDirection.back) {
              camera = cameras[i];
            } else {}
          }

          _controller = CameraController(
            // Get a specific camera from the list of available cameras.
            camera,
            // Define the resolution to use.
            ResolutionPreset.medium,
          );
          //_controller.lockCaptureOrientation(DeviceOrientation.landscapeLeft);

          // Next, initialize the controller. This returns a Future.
          _initializeControllerFuture = _controller.initialize().then((value) async {
            maxZoom = await _controller.getMaxZoomLevel();
            minZoom = await _controller.getMinZoomLevel();
          });
        });
      }catch(e){
        // Obtain a list of the available cameras on the device.
        final cameras = await availableCameras();

        // Get a specific camera from the list of available cameras.
        setState(() {
          for (var i = 0; i < cameras.length; i++) {
            if (cameras[i].lensDirection == CameraLensDirection.back) {
              camera = cameras[i];
            } else {}
          }

          _controller = CameraController(
            // Get a specific camera from the list of available cameras.
            camera,
            // Define the resolution to use.
            ResolutionPreset.medium,
          );
          //_controller.lockCaptureOrientation(DeviceOrientation.landscapeLeft);

          // Next, initialize the controller. This returns a Future.
          _initializeControllerFuture = _controller.initialize().then((value) async {
            maxZoom = await _controller.getMaxZoomLevel();
            minZoom = await _controller.getMinZoomLevel();
          });
        });
      }
    }



  }
  @override
  Widget build(BuildContext context) {
    return StreamBuilder<bool>(
        stream:CustomerHomePageLogic().connectedDevicesStream.outData,


        builder: (con, snapshotagain) {
          return    FutureBuilder<bool>(
              future:Future.delayed(Duration(seconds: 0)).then((value) => true),


              builder: (con, snapshotTimer) {
                print("rebuilding 2nd tab really xx");
                if(snapshotTimer.hasData)
                  return  FutureBuilder<SharedPreferences>(
                      future: SharedPreferences.getInstance(),
                      // async work
                      builder: (BuildContext context, AsyncSnapshot<SharedPreferences> snapshotSharefPreff) {
                        if (snapshotSharefPreff.hasData) {
                          loadValue = "5";
                          secondValue= "5";
                          if(snapshotSharefPreff.data!.getString("lastLoad")!=null){
                            loadValue = snapshotSharefPreff.data!.getString("lastLoad")!;
                          }
                          if(snapshotSharefPreff.data!.getString("timer")!=null){
                            secondValue = snapshotSharefPreff.data!.getString("timer")!;
                          } if(snapshotSharefPreff.data!.getString("loadUnit")!=null){
                            print("unit");

                            loadUnitValue = snapshotSharefPreff.data!.getString("loadUnit")!;
                            print(loadUnitValue);
                          }else{
                            loadUnitValue = "kN";
                          }
                          // loadValue   =  snapshotSharefPreff.data!.get("lastLoad").toString()!=null? snapshotSharefPreff.data!.get("lastLoad").toString():"0";
                          // secondValue =  snapshotSharefPreff.data!.get("timer").toString()!=null?snapshotSharefPreff.data!.get("timer").toString():"0";

                        //  Widget camera  =  CameraGallaryActivity();

                         // AppTitleAppbarStream.getInstance().dataReload( TextConst.testAppbarText);

                          return SafeArea(child: Scaffold(backgroundColor: AppThemeManager().getScaffoldBackgroundColor(),
                            resizeToAvoidBottomInset: false,
                            //resizeToAvoidBottomInset = false,
                            // appBar: AppBar(
                            //   title: Text("Time and Load info"),
                            // ),
                            appBar: PreferredSize(
                              preferredSize: AppBar().preferredSize,
                              child:  ApplicationAppbar(). getAppbar(title: "Tests"),
                            ),
                            body: Container(margin: EdgeInsets.only(
                                left: width * 0.05, right: width * 0.05, top: height * 0.03),
                              child: Column( children: [
                                //map only shows at stage 0
                                //BitmapDescriptor.fromAssetImage(
                                //                         ImageConfiguration(), 'assets/icons/mapMarker1Icon.png')
                                Container(
                                    height: height * 0.20,
                                    width: double.infinity,
                                    child:const  MapViewOnDataCollectionActivity(),
                                    ),

                             if(false)   FutureBuilder<Position?>(
                                    future:  GeolocatorPlatform.instance.getLastKnownPosition(),
                                    builder: (context, snapshot) {
                                      if(snapshot.connectionState == ConnectionState.done){
                                        AppToast().show(message: snapshot.data.toString());
                                        String mapUri = "https://maps.googleapis.com/maps/api/staticmap?center=" +
                                            snapshot.data!.latitude
                                            .toString() +
                                            "," +
                                            snapshot.data!.longitude
                                                .toString() +
                                            "&zoom=8&size=" +
                                            ( width * 0.88).toStringAsFixed(0)+
                                            "x"+
                                            ( height * 0.21).toStringAsFixed(0)


                                            +"&maptype=normal"+
                                            "&markers=anchor:center|"+
                                            "icon:https%3A%2F%2Ffirebasestorage.googleapis.com%2Fv0%2Fb%2Fstaht-connect-322113.appspot.com%2Fo%2FmapMarker1Icon.png%3Falt%3Dmedia%26token%3D29e63d7e-2a40-46ec-ac38-740c4b22435d|"+
                                            snapshot.data!.latitude
                                                .toString() +
                                            "," +
                                            snapshot.data!.longitude
                                                .toString() +
                                            "&key=AIzaSyDOrDoiG0aLER7Y8cv2QhNr182Z0H5pMVw"+"&map_id="+(darkTheme?"90b3e5c6b64b6c5e":"");
                                        return      Container(
                                            height: height * 0.20,
                                            width: double.infinity,
                                            child: (snapshot.data != null)
                                                ? Image.network(mapUri,fit: BoxFit.cover,)
                                                : Center(
                                              child:   Scaffold(body: Center(child: CircularProgressIndicator(color: Colors.redAccent,)),),
                                            ));
                                      }else  return Scaffold(body: Center(child: CircularProgressIndicator(color: Colors.redAccent,)),);

                                    }),

                                // FutureBuilder<BitmapDescriptor>(
                                //     future: BitmapDescriptor.fromAssetImage(ImageConfiguration(), 'assets/icons/mapMarker1Icon.png'),
                                //     builder: (context, snapshot) {
                                //       if(snapshot.hasData){
                                //         mapWidget = TestPerformUiComponents().mapSegment(snapshot.data!);
                                //         return   Container( height: height * 0.20, width: MediaQuery.of(context).size.width,
                                //          // child:  TestPerformUiComponents().mapSegment(snapshot.data!),
                                //           child: mapWidget,
                                //         );
                                //
                                //       }else{
                                //         return Scaffold(body: Center(child: CircularProgressIndicator(color: Colors.redAccent,)),);
                                //       }
                                //     }),

                                Container(
                                  height: height * 0.06,
                                  margin: EdgeInsets.only(top: height * 0.03),
                                  decoration: BoxDecoration(
                                      borderRadius: BorderRadius.circular(10),
                                      color: ThemeManager().getWhiteColor,
                                      boxShadow: [
                                        BoxShadow(
                                          blurRadius: 5,
                                          color: ThemeManager().getLightGrey3Color,
                                        )
                                      ]),
                                  child: Row(
                                    children: [
                                      //---------Load icon---------
                                      Container(
                                        margin: EdgeInsets.only(left: width * 0.06, right: width * 0.02),
                                        child: SvgPicture.asset(
                                          ("assets/svg/loadIcon.svg"),
                                          height: height * 0.03,
                                          color: ThemeManager().getBlackColor,
                                        ),
                                      ),
                                      Expanded(
                                        child: Row(
                                          children: [
                                            Container(
                                              constraints: BoxConstraints(
                                                maxWidth: width * 0.14,
                                              ),

                                              //-----------Load value---------
                                              child: Text(loadValue,
                                                style: interBold.copyWith(
                                                    color: ThemeManager().getBlackColor,
                                                    fontSize: width * 0.045),
                                              ),
                                            ),

                                            // -----------Load unit------------
                                            // Container(
                                            //   margin: EdgeInsets.only(right: width * 0.04),
                                            //   child: Text(loadUnitValue,
                                            //     style: interRegular.copyWith(
                                            //         color: ThemeManager().getBlackColor,
                                            //         fontSize: width * 0.035),
                                            //   ),
                                            // ),
                                            // UnitChangedStream.getInstance().

                                            Container(
                                              margin: EdgeInsets.only(right: width * 0.04),
                                              child:StreamBuilder<String>(
                                                  stream: UnitChangedStream.getInstance().outData,
                                                  // async work
                                                  builder: (BuildContext context,
                                                      AsyncSnapshot<String> snapshot) {
                                                    if(snapshot.hasData){
                                                      loadUnitValue = snapshot.data!;
                                                      try{
                                                        snapshotSharefPreff.data!.setString("loadUnit",loadUnitValue);
                                                        print("saved unit");
                                                      }catch(e){
                                                        print(e);
                                                      }

                                                     return Text(snapshot.data!,
                                                        style: interRegular.copyWith(
                                                            color: ThemeManager().getBlackColor,
                                                            fontSize: width * 0.035),
                                                      );
                                                    }else{
                                                      return   Text(loadUnitValue,
                                                        style: interRegular.copyWith(
                                                            color: ThemeManager().getBlackColor,
                                                            fontSize: width * 0.035),
                                                      );
                                                    }


                                                  }),
                                            ),

                                            //----------Time icon----------
                                            Container(
                                              margin:
                                              EdgeInsets.only(left: width * 0.07, right: width * 0.02),
                                              child: SvgPicture.asset(
                                                ("assets/svg/timeIcon.svg"),
                                                height: height * 0.025,
                                                color: ThemeManager().getBlackColor,
                                                fit: BoxFit.cover,
                                              ),
                                            ),

                                            // //---------Time Minute value---------
                                            // Container(
                                            //   child: Text(
                                            //     minuteValue,
                                            //     style: interBold.copyWith(
                                            //         color: ThemeManager().getBlackColor,
                                            //         fontSize: width * 0.045),
                                            //   ),
                                            // ),
                                            // Text(
                                            //   "m  ",
                                            //   style: interRegular.copyWith(
                                            //       color: ThemeManager().getBlackColor,
                                            //       fontSize: width * 0.035),
                                            // ),

                                            //----------time Second value-------
                                            Container(
                                              child: Text(secondValue,
                                                style: interBold.copyWith(
                                                    color: ThemeManager().getBlackColor,
                                                    fontSize: width * 0.045),
                                              ),
                                            ),
                                            Text(
                                              " sec",
                                              style: interRegular.copyWith(
                                                  color: ThemeManager().getBlackColor,
                                                  fontSize: width * 0.035),
                                            ),
                                          ],
                                        ),
                                      ),

                                      //---------------------Edit Test Load and Time value------------------
                                      GestureDetector(
                                        onTap: () {





                                          showDialog(
                                              context: context,
                                              builder: (context) =>EditTargetLoadAndTimePopUp(sharedPreferences: snapshotSharefPreff.data!,forceMode: loadUnitValue,oldLoad: loadValue,oldTime: secondValue,
                                                loadUnitValueCallback: (loadUnitValNew) {
                                                print("unit got");
                                                print(loadUnitValNew);





                                                  // setState(() {
                                                  //   loadUnitValue = loadUnitValNew;
                                                  //   print("should update the unit val");
                                                  // });

                                                },
                                                secondValueCallback: (second) {

                                                  print("second got");
                                                  print(second);


                                                  try{
                                                    snapshotSharefPreff.data!.setString("timer",second);
                                                  }catch(e){
                                                    print(e);
                                                  }
                                                  setState(() {
                                                    secondValue = second;
                                                  });

                                                },
                                                // minuteValueCallback: (minuteVal) {
                                                //   setState(() {
                                                //     minuteValue=minuteVal;
                                                //   });
                                                // },
                                                loadValueCallback: (loadValNew) {
                                                  try{
                                                    snapshotSharefPreff.data!.setString("lastLoad",loadValNew);
                                                  }catch(e){
                                                    print(e);
                                                  }

                                                 setState(() {
                                                   loadValue = loadValNew;
                                                 });

                                                },
                                              ));
                                        },
                                        child: Container(
                                          height: double.infinity,
                                          width: width * 0.16,
                                          decoration: BoxDecoration(
                                              borderRadius: BorderRadius.only(
                                                  topRight: Radius.circular(10),
                                                  bottomRight: Radius.circular(10)),
                                              gradient: LinearGradient(
                                                colors: [
                                                  ThemeManager().getOrangeGradientColor,
                                                  ThemeManager().getYellowGradientColor,
                                                ],
                                              )),
                                          child: Image.asset('assets/icons/editIcon.png', scale: 0.8),
                                        ),
                                      ),
                                    ],
                                  ),
                                ),
                                //camera
                                // Container( margin: EdgeInsets.only(top: height * 0.035),
                                //     height: height * 0.19,
                                //     width: double.infinity,child: CameraGallaryActivity()),
                                //CameraGallaryActivitySecond(),
                                camaraGalleryView(),
                                //camera,
                                GestureDetector(
                                  onTap: () async {

                                    print("Go to test page");
                                    int secValue = 5 ;
                                    secValue = int.parse(secondValue);

                                    if(secondValue!=null){
                                      secValue = int.parse(secondValue);
                                    }














                                      String i2 =  "";
                                      String i6 =  "";
                                      if(snapshotSharefPreff.data!.getString("index2")!=null){
                                        i2 = snapshotSharefPreff.data!.getString("index2")??"";
                                      }
                                      if(snapshotSharefPreff.data!.getString("index6")!=null){
                                        i6 = snapshotSharefPreff.data!.getString("index6")??"";
                                      }
                                      try{
                                        loadUnitValue = snapshotSharefPreff.data!.getString("loadUnit")!;
                                      }catch(e){

                                      }
                                      // Navigator.push(
                                      //     context,
                                      //     MaterialPageRoute(
                                      //         builder: (context) => PerformTestPageActivity(
                                      //
                                      //
                                      //           testDuration: int.parse(secondValue),
                                      //           durationForTest: int.parse(secondValue),
                                      //
                                      //           project: widget.customerId,start:int.parse(secondValue) ,
                                      //           device: widget.d,
                                      //           customerFirestore: widget.customerFirestore,
                                      //           index2: i2,index6: i6, targetLoad: double.parse(loadValue),
                                      //          // imageListNew: imageList,
                                      //          // secondData: secondValue,
                                      //           // minuteData: minuteValue,
                                      //          // loadUnitData: loadUnitValue,
                                      //          // loadData: loadValue,
                                      //         )));

                                      // PerformTestPageActivity(
                                      //     index2:i2,
                                      //     index6:i6,
                                      //
                                      //     //index6: index6,
                                      //     start: widget.testDuration,
                                      //     testDuration: duration!,
                                      //     durationForTest: duration,
                                      //     targetLoad: double.parse(
                                      //         widget.controller.text.toString()),
                                      //     device: widget.d,
                                      //     project: widget.customerId,
                                      //     customerFirestore: widget.customerFirestore);
                                      // Navigator.push(
                                      //     context,
                                      //     MaterialPageRoute(
                                      //         builder: (context) => TestScreen(project: widget.customerId,start:int.parse(secondValue) ,
                                      //           device: widget.d,
                                      //           customerFirestore: widget.customerFirestore,
                                      //           index2: i2,index6: i6,
                                      //           imageListNew: imageList,
                                      //           secondData: secondValue,
                                      //           // minuteData: minuteValue,
                                      //           loadUnitData: loadUnitValue,
                                      //           //loadData: loadValue,
                                      //           targetLoad: double.parse(loadValue),
                                      //         )));

                                      try{
                                        print("Getting location");
                                        //var position = await gl.GeolocatorPlatform.instance.getCurrentPosition(desiredAccuracy: gl.LocationAccuracy.high);
                                        var position = await gl. Geolocator.getLastKnownPosition();
                                        print("got location");
                                        // Map<Permission, PermissionStatus> statuses = await [
                                        //   Permission.location, Permission.storage,Permission.camera,Permission.microphone,Permission.locationAlways,
                                        // ].request();
                                        Widget w = OldPerformTestPageActivity(loadMode:loadUnitValue ,
                                          //cameraWidget: camera,
                                          index2:i2,
                                          index6:i6,
                                          position: position!,
                                          attachmentsFromPreviousScreen: imageList,

                                          //index6: index6,
                                          start:secValue ,
                                          // testDuration: duration!,
                                          // durationForTest: duration,
                                          targetLoad: double.parse(
                                              loadValue),
                                          device: widget.d,
                                          project: widget.customerId,
                                          customerFirestore: widget.customerFirestore, testDuration:secValue, durationForTest: secValue,);


                                        Navigator.push(
                                            context,
                                            MaterialPageRoute(
                                                builder: (BuildContext context) =>
                                                w)).whenComplete(() {
                                          setState(() {
                                            imageList.clear();
                                            newImageList.clear();
                                          });

                                        });

                                        // Navigator.of(context).push(new MaterialPageRoute<Null>(
                                        //     builder: (BuildContext context) {
                                        //       String width = MediaQuery.of(context).size.width.ceil().toString();
                                        //
                                        //       final scaffoldState = GlobalKey<ScaffoldState>();
                                        //       return w;
                                        //     },
                                        //     fullscreenDialog: true)).whenComplete(() {
                                        //       setState(() {
                                        //         imageList.clear();
                                        //         newImageList.clear();
                                        //
                                        //       });
                                        // });







                                      }catch(e){
                                        // Map<Permission, PermissionStatus> statuses = await [
                                        //   Permission.location, Permission.storage,Permission.camera,Permission.microphone,Permission.locationAlways,Permission.bluetooth,Permission.bluetoothScan
                                        // ].request();
                                        // print(e);
                                        print("No location location");
                                        var position = gl.Position(speedAccuracy: 0,heading: 0,accuracy: 0,speed: 0,timestamp: DateTime.now(),latitude: 0,longitude: 0,altitude: 0);
                                        Widget w =   OldPerformTestPageActivity(loadMode:loadUnitValue ,
                                          //cameraWidget: camera,
                                          index2:i2,
                                          index6:i6,
                                          attachmentsFromPreviousScreen: imageList,
                                          position: position,
                                          //index6: index6,
                                          start:secValue,
                                          // testDuration: duration!,
                                          // durationForTest: duration,
                                          targetLoad: double.parse(
                                              loadValue),
                                          device: widget.d,
                                          project: widget.customerId,
                                          customerFirestore: widget.customerFirestore, testDuration: secValue, durationForTest:  secValue,);

                                        Navigator.push(
                                            context,
                                            MaterialPageRoute(
                                                builder: (BuildContext context) =>
                                                w)).whenComplete(() {
                                          setState(() {
                                            imageList.clear();
                                            newImageList.clear();
                                          });

                                        });

                                        // Navigator.of(context).push(new MaterialPageRoute<Null>(
                                        //     builder: (BuildContext context) {
                                        //       String width = MediaQuery.of(context).size.width.ceil().toString();
                                        //
                                        //       final scaffoldState = GlobalKey<ScaffoldState>();
                                        //       return w;
                                        //     },
                                        //     fullscreenDialog: true)).whenComplete(() {
                                        //   setState(() {
                                        //     imageList.clear();
                                        //     newImageList.clear();
                                        //
                                        //   });
                                        // });

                                      }











                                  },
                                  child: Container(
                                    margin: EdgeInsets.only(top: height * 0.02),
                                    height: height * 0.065,
                                    width: width * 0.42,
                                    decoration: BoxDecoration(
                                        image: new DecorationImage(
                                          image: new ExactAssetImage('assets/icons/playButtonIcon.png',
                                              scale: 1.0),
                                        ),
                                        borderRadius: BorderRadius.all(Radius.circular(50)),
                                        gradient: LinearGradient(
                                          colors: [
                                            ThemeManager().getOrangeGradientColor,
                                            ThemeManager().getYellowGradientColor,
                                          ],
                                        )),
                                  ),
                                ),
                                // Visibility(visible: false,
                                //   child: Padding(
                                //     padding: const EdgeInsets.fromLTRB(20, 15, 20, 4),
                                //     child: TextFormField(
                                //       autofocus: false,
                                //       controller: widget.controller,
                                //       inputFormatters: [DecimalTextInputFormatter(decimalRange: 1)],
                                //       keyboardType: TextInputType.numberWithOptions(decimal: true),
                                //       onChanged: (val) {
                                //         print(val);
                                //         //check if the value is more than 60
                                //         if (double.tryParse(val) != null) {
                                //           if (double.parse(val) > 60) {
                                //             widget.sPref.setString("lastLoad", "59");
                                //             setState(() {
                                //               didLimitKnExceed = true;
                                //             });
                                //           } else {
                                //             widget.sPref.setString("lastLoad", val);
                                //             setState(() {
                                //               didLimitKnExceed = false;
                                //             });
                                //           }
                                //         } else {}
                                //       },
                                //       // inputFormatters: <TextInputFormatter>[
                                //       //   // FilteringTextInputFormatter.allow(RegExp(r'[0-9]')),
                                //       // //  WhitelistingTextInputFormatter(RegExp(r'^(\d+)?\.?\d{0,1+}')),
                                //       // ],
                                //       decoration: InputDecoration(
                                //         labelText: 'Target Load',
                                //         suffixText: "kN",
                                //         border: OutlineInputBorder(),
                                //       ),
                                //     ),
                                //   ),
                                // ),
                                //
                                // Visibility(visible: false,
                                //   child: Padding(
                                //       padding: EdgeInsets.all(10),
                                //       child: Row(
                                //         children: [
                                //           Expanded(
                                //             child: InkWell(
                                //               onTap: () => selected(0, 30),
                                //               child: Padding(
                                //                 padding: const EdgeInsets.all(8.0),
                                //                 child: Container(
                                //                   decoration: BoxDecoration(
                                //                       borderRadius: BorderRadius.circular(5),
                                //                       color: selectedPosition == 0
                                //                           ? Theme.of(context).primaryColor
                                //                           : Colors.white),
                                //                   child: Padding(
                                //                     padding: const EdgeInsets.all(10.0),
                                //                     child: Center(
                                //                       child: Text(
                                //                         "30 Second",
                                //                         style: TextStyle(
                                //                             color: selectedPosition == 0
                                //                                 ? Colors.white
                                //                                 : Theme.of(context).primaryColor),
                                //                       ),
                                //                     ),
                                //                   ),
                                //                 ),
                                //               ),
                                //             ),
                                //           ),
                                //           Expanded(
                                //             child: InkWell(
                                //               onTap: () => selected(1, 60),
                                //               child: Padding(
                                //                 padding: const EdgeInsets.all(8.0),
                                //                 child: Container(
                                //                   decoration: BoxDecoration(
                                //                       borderRadius: BorderRadius.circular(5),
                                //                       color: selectedPosition == 1
                                //                           ? Theme.of(context).primaryColor
                                //                           : Colors.white),
                                //                   child: Padding(
                                //                     padding: const EdgeInsets.all(10.0),
                                //                     child: Center(
                                //                       child: Text(
                                //                         "1 Minute",
                                //                         style: TextStyle(
                                //                             color: selectedPosition == 1
                                //                                 ? Colors.white
                                //                                 : Theme.of(context).primaryColor),
                                //                       ),
                                //                     ),
                                //                   ),
                                //                 ),
                                //               ),
                                //             ),
                                //           ),
                                //           Expanded(
                                //             child: InkWell(
                                //               onTap: () async {
                                //                 // prefs.setInt("timer",second);
                                //                 setState(() {
                                //                   selectedPosition = 2;
                                //                 });
                                //
                                //                 showPickerNumber(context);
                                //               },
                                //               child: Padding(
                                //                 padding: const EdgeInsets.all(8.0),
                                //                 child: Container(
                                //                   decoration: BoxDecoration(
                                //                       borderRadius: BorderRadius.circular(5),
                                //                       color: selectedPosition == 2
                                //                           ? Theme.of(context).primaryColor
                                //                           : Colors.white),
                                //                   child: Padding(
                                //                     padding: const EdgeInsets.all(10.0),
                                //                     child: Center(
                                //                       child: Text(
                                //                         selectedPosition == 2
                                //                             ? "Custom(" +
                                //                             selectedTime.toString() +
                                //                             ")"
                                //                             : "Custom",
                                //                         style: TextStyle(
                                //                             color: selectedPosition == 2
                                //                                 ? Colors.white
                                //                                 : Theme.of(context).primaryColor),
                                //                       ),
                                //                     ),
                                //                   ),
                                //                 ),
                                //               ),
                                //             ),
                                //           )
                                //         ],
                                //       )),
                                // ),
                                // Padding(
                                //   padding: const EdgeInsets.all(8.0),
                                //   child: Text("Device SN :" + index2),
                                // ),
                                // Padding(
                                //   padding: const EdgeInsets.all(8.0),
                                //   child: Text("Next Calibration Date :" + index6),
                                // ),
                                // Padding(
                                //   padding: const EdgeInsets.fromLTRB(4, 4, 4, 15),
                                //   child: TextFormField(
                                //     keyboardType: TextInputType.number,
                                //     inputFormatters: <TextInputFormatter>[
                                //       FilteringTextInputFormatter.allow(RegExp(r'[0-9]')),
                                //     ],
                                //     decoration: InputDecoration(
                                //       labelText: 'Duration',
                                //
                                //       border: OutlineInputBorder(),
                                //
                                //     ),
                                //   ),
                                // ),
                                // didLimitKnExceed == false
                                //     ? Visibility(visible: false,
                                //       child: InkWell(
                                //   onTap: () async {
                                //
                                //       // You can request multiple permissions at once.
                                //       Map<Permission, PermissionStatus> statuses = await [
                                //         Permission.location,
                                //         Permission.storage,
                                //         Permission.camera,
                                //         Permission.microphone,
                                //       ].request();
                                //
                                //       SharedPreferences sf =
                                //       await SharedPreferences.getInstance();
                                //       print("clciked to go test perform page");
                                //       int duration = 30;
                                //       duration = sf.getInt("timer")??30;
                                //       if (duration == null) {
                                //         duration = 30;
                                //       }
                                //
                                //       try {
                                //         //await widget.d.disconnect();
                                //         // print("disconnected");
                                //         // await widget.d.connect(autoConnect: false);
                                //         //print("connected");
                                //         SharedPreferences sf =await SharedPreferences.getInstance();
                                //
                                //         String i2 =  "";
                                //         String i6 =  "";
                                //         if(sf.getString("index2")!=null){
                                //           i2 = sf.getString("index2")??"";
                                //         }
                                //         if(sf.getString("index6")!=null){
                                //           i6 = sf.getString("index6")??"";
                                //         }
                                //         runningTestRunning = PerformTestPageActivity(
                                //             index2:i2,
                                //             index6:i6,
                                //
                                //             //index6: index6,
                                //             start: widget.testDuration,
                                //             testDuration: duration!,
                                //             durationForTest: duration,
                                //             targetLoad: double.parse(
                                //                 widget.controller.text.toString()),
                                //             device: widget.d,
                                //             project: widget.customerId,
                                //             customerFirestore: widget.customerFirestore);
                                //
                                //         isTestRunning = true;
                                //         CustomerHomePageLogic().testRunningUniversalNotifier.dataReload(true);
                                //         Navigator.of(context).push(MaterialPageRoute(
                                //             builder: (context) => runningTestRunning));
                                //         // Future.delayed(Duration(seconds: 1));
                                //         // CustomerHomePageLogic().testRunningFlaotingWidgetStream.dataReload(runningTestRunning);
                                //         // Future.delayed(Duration(seconds: 1));
                                //         // CustomerHomePageLogic().testRunningUniversalNotifier.dataReload(true);
                                //         // Future.delayed(Duration(seconds: 1));
                                //         // CustomerHomePageLogic().testRunningFlaotingWidgetStream.dataReload(runningTestRunning);
                                //
                                //         // Navigator.of(context).push(MaterialPageRoute(
                                //         //     builder: (context) =>runningTestRunning ));
                                //       } catch (e) {
                                //         print("working on exception");
                                //         print(e);
                                //         // SharedPreferences sf =await SharedPreferences.getInstance();
                                //         // String i2 = "";
                                //         // String i6 ="";
                                //         // i2 =  sf.getString("index2")!;
                                //         // i6 =  sf.getString("index6")!;
                                //         // runningTestRunning = PerformTestPageActivity(
                                //         //   start: widget.testDuration,
                                //         //   testDuration: duration!,
                                //         //   durationForTest: duration,
                                //         //   targetLoad: double.parse(
                                //         //       widget.controller.text.toString()),
                                //         //   device: widget.d,
                                //         //   project: widget.customerId,
                                //         //   customerFirestore: widget.customerFirestore, index2: i2, index6: i6,);
                                //         //
                                //         //
                                //         // isTestRunning = true;
                                //         // CustomerHomePageLogic().testRunningUniversalNotifier.dataReload(true);
                                //         // Future.delayed(Duration(seconds: 1));
                                //         // CustomerHomePageLogic().testRunningFlaotingWidgetStream.dataReload(runningTestRunning);
                                //         // Future.delayed(Duration(seconds: 1));
                                //         // CustomerHomePageLogic().testRunningUniversalNotifier.dataReload(true);
                                //         // Future.delayed(Duration(seconds: 1));
                                //         // CustomerHomePageLogic().testRunningFlaotingWidgetStream.dataReload(runningTestRunning);
                                //
                                //
                                //
                                //       }
                                //
                                //       // widget.d.state.last.then((value) {
                                //       //   if(value == BluetoothDeviceState.connected){
                                //       //     MaterialPageRoute(
                                //       //         builder: (context) =>
                                //       //             PerformTestPageActivity(
                                //       //                 start: widget.testDuration,
                                //       //                 testDuration: duration,
                                //       //                 durationForTest: duration,
                                //       //                 targetLoad: double.parse(
                                //       //                     widget.controller.text.toString()),
                                //       //                 device: widget.d,
                                //       //                 project: widget.customerId,
                                //       //                 customerFirestore:
                                //       //                 widget.customerFirestore));
                                //       //
                                //       //   }else{
                                //       //     widget.d.connect().then((value) {
                                //       //       Navigator.of(context).push(
                                //       //         //  MaterialPageRoute(builder: (context) => ConnectedDevicePage(device: d))),
                                //       //           MaterialPageRoute(
                                //       //               builder: (context) =>
                                //       //                   PerformTestPageActivity(
                                //       //                       start: widget.testDuration,
                                //       //                       testDuration: duration,
                                //       //                       durationForTest: duration,
                                //       //                       targetLoad: double.parse(
                                //       //                           widget.controller.text.toString()),
                                //       //                       device: widget.d,
                                //       //                       project: widget.customerId,
                                //       //                       customerFirestore:
                                //       //                       widget.customerFirestore)));
                                //       //     });
                                //       //   }
                                //       // });
                                //       //   try {
                                //       //     widget.d.connect().then((value) {
                                //       //       Navigator.of(context).push(
                                //       //         //  MaterialPageRoute(builder: (context) => ConnectedDevicePage(device: d))),
                                //       //           MaterialPageRoute(
                                //       //               builder: (context) =>
                                //       //                   PerformTestPageActivity(
                                //       //                       start: widget.testDuration,
                                //       //                       testDuration: duration,
                                //       //                       durationForTest: duration,
                                //       //                       targetLoad: double.parse(
                                //       //                           widget.controller.text.toString()),
                                //       //                       device: widget.d,
                                //       //                       project: widget.customerId,
                                //       //                       customerFirestore:
                                //       //                       widget.customerFirestore)));
                                //       //     });
                                //       //   } catch (e) {
                                //       //     MaterialPageRoute(
                                //       //         builder: (context) =>
                                //       //             PerformTestPageActivity(
                                //       //                 start: widget.testDuration,
                                //       //                 testDuration: duration,
                                //       //                 durationForTest: duration,
                                //       //                 targetLoad: double.parse(
                                //       //                     widget.controller.text.toString()),
                                //       //                 device: widget.d,
                                //       //                 project: widget.customerId,
                                //       //                 customerFirestore:
                                //       //                 widget.customerFirestore));
                                //       //
                                //       // }
                                //   },
                                //   child: Padding(
                                //       padding: const EdgeInsets.all(20.0),
                                //       child: Container(
                                //         decoration: BoxDecoration(
                                //           borderRadius: BorderRadius.circular(5),
                                //           color: Theme.of(context).primaryColor,
                                //         ),
                                //         width: MediaQuery.of(context).size.width,
                                //         child: Center(
                                //             child: Padding(
                                //               padding: const EdgeInsets.all(15.0),
                                //               child: Text(
                                //                 "Proceed",
                                //                 style: TextStyle(color: Colors.white),
                                //               ),
                                //             )),
                                //       ),
                                //   ),
                                // ),
                                //     )
                                //     : Padding(
                                //   padding: EdgeInsets.all(20),
                                //   child: Container(
                                //     decoration: BoxDecoration(
                                //         color: Colors.redAccent,
                                //         borderRadius: BorderRadius.circular(5)),
                                //     child: Center(
                                //       child: Padding(
                                //         padding: const EdgeInsets.all(15.0),
                                //         child: Text(
                                //           "Proof Test limit is 60 kN",
                                //           style: TextStyle(
                                //               color: Colors.white,
                                //               fontWeight: FontWeight.bold),
                                //         ),
                                //       ),
                                //     ),
                                //   ),
                                // )
                              ],),
                            ),
                          ));

                        }else return Scaffold(body:  Center(child: CircularProgressIndicator(),),);
                      });else return Scaffold(body: Center(child: CircularProgressIndicator(color: Colors.red,),),);
              });
          // return   TakePreDataActivity(
          //   lastLoad: lastLoad,
          //   d: snapshotDevices.data!.first,
          //   customerId:
          //   widget.projct,
          //   customerFirestore:
          //   widget.customerFirestore,
          //   sPref: snapshot.data!,
          //   controller: c,
          // );
        });




  }

  void initMemoryOfLastTest() async {
    SharedPreferences prefs = await SharedPreferences.getInstance();
    int? oldTimer = prefs.getInt("timer");
    if (oldTimer == null || oldTimer == 0 || oldTimer == 30) {
      setState(() {
        selectedPosition = 0;
        selectedTime = 30;
      });
    } else if (oldTimer == 60) {
      setState(() {
        selectedPosition = 1;
        selectedTime = 60;
      });
    } else {
      setState(() {
        selectedPosition = 2;
        selectedTime = oldTimer;
      });
    }
  }

  Future<void> conenctDevice() async {
    try {
      await widget.d.connect(autoConnect: false);
    } catch (e) {
      // if (e.code != 'already_connected') {
      //   throw e;
      // }
    } finally {
      await widget.d.discoverServices();
    }
  }

  void startTimer() {
   try{
     timer = Timer.periodic(Duration(seconds: 1), (_) => addTime());
   }catch(e){

   }
  }

  void reset() {
    if (countDown) {
      setState(() => duration = countdownDuration);
    } else {
      setState(() => duration = Duration());
    }
  }


  void addTime() {
    final addSeconds = countDown ? 1 : -1;
    setState(() {
      final seconds = duration.inSeconds + addSeconds;
      if (seconds < 0) {
        timer?.cancel();
      } else {
        duration = Duration(seconds: seconds);
      }
    });
    if(duration.inSeconds>19){
      _controller.stopVideoRecording().then((value) {
        setState(() {
          imageFile = value;
          _isRecording = false;

        });
        File media = File(value.path);
        imageList.insert(0, media.path);
        newImageList.insert(0, media);
        // log(imageList.toString());
        stopTimer();
      });
    }
  }

  void stopTimer({bool resets = true}) {
    if (resets) {
      reset();
    }
    setState(() => timer?.cancel());
  }

  reloadScreen () async {
    print("Reload");initState();
    setState(() {
      imageList.clear();
    });

  }

}









Future<void> conenctDevice(BluetoothDevice device) async {
  try {
    await device.connect(autoConnect: false);
  } catch (e) {
    // if (e.code != 'already_connected') {
    //   throw e;
    // }
  } finally {
    await device.discoverServices();
  }
}
void initDeviceSlAndCalibDate(BluetoothDevice device) async {
  print("initDeviceSlAndCalibDate");
  String index2= "";
  String index6 = "";
  SharedPreferences sf =await SharedPreferences.getInstance();

  Duration waitingDuration = Duration(milliseconds: 50);
  await conenctDevice(device);
  List<BluetoothService> allService = await device.services.first;
  // print(allService.length.toString());


  dynamic readWrite = await OsDependentSettings().getReadWriteCharacters(device: device);

  BluetoothCharacteristic read = readWrite["read"];

  BluetoothCharacteristic write = readWrite["write"];




  getIndex6()async{
    await Future.delayed(waitingDuration);
    await conenctDevice(device);
    allService = await device.services.first;
    print(allService.length.toString());

    dynamic readWrite = await OsDependentSettings().getReadWriteCharacters(device:device);

    read = readWrite["read"];

    write = readWrite["write"];






    await write.write(StringToASCII(COMMAND_INDEX_6_GET_),
        withoutResponse: OsDependentSettings().writeWithresponse);
    await read.read();
    await write.write(StringToASCII(COMMAND_INDEX_6_GET_),
        withoutResponse: OsDependentSettings().writeWithresponse);
    List<int> responseAray6 = await read.read();
    String responseInString6 = utf8.decode(responseAray6);
    String data6 =
    removeCodesFromStrings(responseInString6, COMMAND_INDEX_6_GET_);
    print("2 " + data6);
    String g = "ok";
    sf.setString("index6", data6);

      index6 = data6;


    if(index6.length == 0){
      try{
        await getIndex6();
      }catch(e){
        await Future.delayed(waitingDuration);
        await getIndex6();
      }
    }
  }


  //await widget.d.disconnect();


  getIndex1()async{
    await Future.delayed(waitingDuration);

    await write.write(StringToASCII(COMMAND_INDEX_2_GET_),
        withoutResponse: OsDependentSettings().writeWithresponse);
    await read.read();
    await write.write(StringToASCII(COMMAND_INDEX_2_GET_),
        withoutResponse: OsDependentSettings().writeWithresponse);
    List<int> responseAray2 = await read.read();
    String responseInString = utf8.decode(responseAray2);
    String data =
    removeCodesFromStrings(responseInString, COMMAND_INDEX_2_GET_);
    print("2 " + data);
    sf.setString("index2", data);

      index2 = data;


    if(index2.length == 0){
      try{
        await getIndex1();
      }catch(e){
        await Future.delayed(waitingDuration);
        await getIndex1();
      }





    }else{
      try{
        await getIndex6();
      }catch(e){
        await Future.delayed(waitingDuration);
        await getIndex6();
      }
    }
  }

  try{
    await getIndex1();
  }catch(e){
    await Future.delayed(waitingDuration);
    await getIndex1();
  }




}
enum fileSortType { none, title, date }
enum folderAction { rename, delete, move }
EdgeInsets folderPadding =  EdgeInsets.fromLTRB(0,0, 0, 0);
EdgeInsets indendfolderPadding =  EdgeInsets.fromLTRB(width*.08,0, 0, 0);

class AllFileFolderActivity extends StatefulWidget {
  List<String> folderStack = ["root"];
  String currentFolderName = "";
  FirebaseFirestore customerFirestore;
  String customerId;
  Locale locale;

  AllFileFolderActivity({required this.customerId,required this.customerFirestore,required this.locale});

  @override
  _AllFileFolderActivityState createState() => _AllFileFolderActivityState();
}
class ExpandenFolderActivity extends StatefulWidget {
  String parentFolder;
  String customerId;

  FirebaseFirestore customerFirestore;
  Locale locale;
  ExpandenFolderActivity({required this.parentFolder,required this.customerFirestore,required this.customerId,required this.locale});

  @override
  _ExpandenFolderActivityState createState() => _ExpandenFolderActivityState();
}

class _ExpandenFolderActivityState extends State<ExpandenFolderActivity> {
 // bool expand = false;
  showNextLevelFolder(String data) {
    int step = 0;

    return StreamBuilder<QuerySnapshot>(
        stream: AppFirestore(firestore: widget.customerFirestore,projectId: "",auth: FirebaseAuth.instance).getFolders(parentFolder: data),
        builder: (context, snapshot) {
          if (snapshot.hasData && snapshot.data!.docs.length>0) {
            step++;

            //sort here
            List<QueryDocumentSnapshot> filteredData = [];
              filteredData = snapshot.data!.docs;
              filteredData.sort((a, b) {
                return a
                    .get("name")
                    .toString()
                    .toLowerCase()
                    .compareTo(b.get("name").toString().toLowerCase());
              });

            return   ListView.builder(
              //  separatorBuilder: (BuildContext context, int index) => Divider(),
                physics: NeverScrollableScrollPhysics(),

                shrinkWrap: true,
                padding: EdgeInsets.zero,
                itemCount: filteredData.length,
                itemBuilder: (_, index) {
                  //ExpandFolderStream

                  show(bool expand,String id){

                    return   Padding(
                      padding: const EdgeInsets.fromLTRB(5, 0, 0, 0),
                      child: Wrap(
                        children: [
                          Stack(
                            children: [
                              Align(alignment: Alignment.centerLeft,child: InkWell(onTap: (){
                                try{

                                  ExpandFolderStream.getInstance().dataReload({"id":filteredData[index].id,"expand":!expand});
                                }catch(e){
                                  print("enpand er");
                                  print(e);
                                }
                              },
                                child: Column(
                                  children: [
                                    Container(
                                     // color: expand?ThemeManager().getLightYellowColor:Colors.white,
                                      child: Row(
                                        children: [
                                          Padding(padding: folderPadding),
                                          GestureDetector(
                                            onTap: () {
                                            try{

                                              ExpandFolderStream.getInstance().dataReload({"id":filteredData[index].id,"expand":!expand});
                                            }catch(e){
                                              print("enpand er");
                                              print(e);
                                            }
                                            },
                                            //newFolder.isExpanded == fals
                                            child: expand
                                                ? Icon(
                                              Icons.keyboard_arrow_up_outlined,
                                              size: width * 0.085,
                                              color:AppThemeManager(). getTextColor1() ,
                                            )
                                                : Icon(
                                              Icons.keyboard_arrow_down_outlined,
                                              size: width * 0.085,
                                              color: AppThemeManager(). getTextColor1(),
                                            ),
                                          ),
                                          GestureDetector(
                                            onTap: () {
                                              try{

                                                ExpandFolderStream.getInstance().dataReload({"id":filteredData[index].id,"expand":!expand});
                                              }catch(e){
                                                print("enpand er");
                                                print(e);
                                              }
                                            },
                                            child: Container(
                                              margin: EdgeInsets.only(
                                              left: width * 0.02,
                                              ),
                                              child: SvgPicture.asset(
                                                (expand?"assets/svg/folder_open.svg": "assets/svg/folder_close.svg"),
                                                fit: BoxFit.cover,width:width * 0.075,
                                              ),
                                            ),
                                          ),
                                          GestureDetector(   onTap: () {
                                            try{

                                              ExpandFolderStream.getInstance().dataReload({"id":filteredData[index].id,"expand":!expand});
                                            }catch(e){
                                              print("enpand er");
                                              print(e);
                                            }
                                          },
                                            child: Container(
                                                margin: EdgeInsets.only(
                                                  left: width * 0.03,
                                                ),
                                                child: Text(filteredData[index]["name"],
                                                  style: interRegular.copyWith(
                                                    color: AppThemeManager(). getTextColor2(),
                                                    fontSize: width * 0.045,
                                                  ),
                                                )),
                                          ),

                                          // Container(
                                          // //  height: 50,
                                          //   width: MediaQuery.of(context).size.width,
                                          //   child: Stack(
                                          //     children: [
                                          //       Align(
                                          //         alignment: Alignment.centerLeft,
                                          //         child: Row(
                                          //           children: [
                                          //             GestureDetector(
                                          //               onTap: () {
                                          //                 // setState(() {
                                          //                 //   newFolder.isExpanded = !(newFolder.isExpanded);
                                          //                 //   newFolder.isVisible = !newFolder.isVisible;
                                          //                 // });
                                          //               },
                                          //               //newFolder.isExpanded == fals
                                          //               child: false
                                          //                   ? Icon(
                                          //                 Icons.keyboard_arrow_up_outlined,
                                          //                 size: width * 0.085,
                                          //                 color: ThemeManager().getDarkGrey2Color,
                                          //               )
                                          //                   : Icon(
                                          //                 Icons.keyboard_arrow_down_outlined,
                                          //                 size: width * 0.085,
                                          //                 color: ThemeManager().getDarkGrey2Color,
                                          //               ),
                                          //             ),
                                          //             Container(
                                          //               margin: EdgeInsets.only(
                                          //                 left: width * 0.02,
                                          //               ),
                                          //               child: SvgPicture.asset(
                                          //                 ("assets/svg/folderIcon.svg"),
                                          //                 fit: BoxFit.cover,
                                          //               ),
                                          //             ),
                                          //             Container(
                                          //                 margin: EdgeInsets.only(
                                          //                   left: width * 0.03,
                                          //                 ),
                                          //                 child: Text(
                                          //                   snapshot.data!.docs[index]["name"],
                                          //                   style: interRegular.copyWith(
                                          //                     color: ThemeManager().getBlackColor,
                                          //                     fontSize: width * 0.045,
                                          //                   ),
                                          //                 ))
                                          //             // Column(
                                          //             //   mainAxisAlignment:
                                          //             //   MainAxisAlignment.center,
                                          //             //   crossAxisAlignment:
                                          //             //   CrossAxisAlignment.start,
                                          //             //   children: [
                                          //             //
                                          //             //     Text(
                                          //             //       snapshot.data!.docs[index]["name"]
                                          //             //           .toString(),
                                          //             //       style: TextStyle(
                                          //             //           fontWeight:
                                          //             //           FontWeight.bold,
                                          //             //           color: Colors.black),
                                          //             //     ),
                                          //             //     timeFormate(snapshot.data!.docs[index]["created_at"]),
                                          //             //   ],
                                          //             // ),
                                          //           ],
                                          //         ),
                                          //       ),
                                          //       Align(
                                          //         alignment: Alignment.centerRight,
                                          //         child: Container(
                                          //           height: MediaQuery.of(context)
                                          //               .size
                                          //               .height,
                                          //           width: 50,
                                          //           child: PopupMenuButton<folderAction>(
                                          //             onSelected: (folderAction value) {
                                          //               if (value ==
                                          //                   folderAction.rename) {
                                          //                 //rename folder
                                          //                 TextEditingController
                                          //                 controller =
                                          //                 TextEditingController(
                                          //                     text: snapshot.data!.docs[index]
                                          //                     ["name"]
                                          //                         .toString());
                                          //
                                          //                 Navigator.of(context)
                                          //                     .push(
                                          //                     new MaterialPageRoute<
                                          //                         Null>(
                                          //                         builder:
                                          //                             (BuildContext
                                          //                         context) {
                                          //                           return Scaffold(
                                          //                             appBar: AppBar(
                                          //                               title: Text(
                                          //                                   "Rename Folder"),
                                          //                             ),
                                          //                             body: Container(
                                          //                               decoration:
                                          //                               BoxDecoration(
                                          //                                 color: Color
                                          //                                     .fromARGB(
                                          //                                     255,
                                          //                                     247,
                                          //                                     247,
                                          //                                     247),
                                          //                                 borderRadius: BorderRadius.only(
                                          //                                     topLeft:
                                          //                                     Radius.circular(
                                          //                                         10.0),
                                          //                                     topRight:
                                          //                                     Radius.circular(10.0)),
                                          //                               ),
                                          //                               child:
                                          //                               Padding(
                                          //                                 padding: const EdgeInsets
                                          //                                     .all(
                                          //                                     15.0),
                                          //                                 child: Wrap(
                                          //                                   children: [
                                          //                                     Padding(
                                          //                                       padding:
                                          //                                       const EdgeInsets.all(8.0),
                                          //                                       child:
                                          //                                       TextFormField(
                                          //                                         controller:
                                          //                                         controller,
                                          //                                         autofocus:
                                          //                                         true,
                                          //                                         decoration:
                                          //                                         InputDecoration(
                                          //                                           labelText: 'Folder Name',
                                          //                                           border: OutlineInputBorder(),
                                          //                                         ),
                                          //                                       ),
                                          //                                     ),
                                          //                                     InkWell(
                                          //                                       onTap:
                                          //                                           () {
                                          //                                         widget.customerFirestore.collection("folders").doc(snapshot.data!.docs[index].id).update({
                                          //                                           "name": controller.text
                                          //                                         }).then((value) {
                                          //                                           Navigator.pop(context);
                                          //                                         });
                                          //                                       },
                                          //                                       child:
                                          //                                       Card(
                                          //                                         color:
                                          //                                         Theme.of(context).primaryColor,
                                          //                                         child: Center(
                                          //                                             child: Padding(
                                          //                                               padding: const EdgeInsets.all(10.0),
                                          //                                               child: Text(
                                          //                                                 "Submit",
                                          //                                                 style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold),
                                          //                                               ),
                                          //                                             )),
                                          //                                       ),
                                          //                                     )
                                          //                                   ],
                                          //                                 ),
                                          //                               ),
                                          //                             ),
                                          //                           );
                                          //                         },
                                          //                         fullscreenDialog:
                                          //                         true));
                                          //               }
                                          //               if (value ==
                                          //                   folderAction.delete) {
                                          //                 //rename folder
                                          //                 showModalBottomSheet(
                                          //                     context: context,
                                          //                     builder: (builder) {
                                          //                       return new Wrap(
                                          //                         children: [
                                          //                           Padding(
                                          //                             padding:
                                          //                             const EdgeInsets
                                          //                                 .all(8.0),
                                          //                             child: Text(
                                          //                               "Do you want to delete this Folder?",
                                          //                               style: TextStyle(
                                          //                                   fontSize: 20,
                                          //                                   color: Theme.of(
                                          //                                       context)
                                          //                                       .primaryColor),
                                          //                             ),
                                          //                           ),
                                          //                           Row(
                                          //                             children: [
                                          //                               Expanded(
                                          //                                   child:
                                          //                                   InkWell(
                                          //                                     onTap: () {
                                          //                                       Navigator.of(
                                          //                                           context)
                                          //                                           .pop();
                                          //                                     },
                                          //                                     child: Padding(
                                          //                                       padding:
                                          //                                       const EdgeInsets
                                          //                                           .all(
                                          //                                           8.0),
                                          //                                       child: Card(
                                          //                                         elevation:
                                          //                                         8,
                                          //                                         color: Colors
                                          //                                             .grey,
                                          //                                         child: Center(
                                          //                                             child: Padding(
                                          //                                               padding: const EdgeInsets
                                          //                                                   .all(
                                          //                                                   15.0),
                                          //                                               child:
                                          //                                               Text(
                                          //                                                 "Cancel",
                                          //                                                 style: TextStyle(
                                          //                                                     color:
                                          //                                                     Colors.white,
                                          //                                                     fontWeight: FontWeight.bold),
                                          //                                               ),
                                          //                                             )),
                                          //                                       ),
                                          //                                     ),
                                          //                                   )),
                                          //                               Expanded(
                                          //                                   child:
                                          //                                   InkWell(
                                          //                                     onTap: () {
                                          //                                       widget
                                          //                                           .customerFirestore
                                          //                                           .collection(
                                          //                                           "folders")
                                          //                                           .doc(snapshot.data!.docs[index].id)
                                          //                                           .delete()
                                          //                                           .then(
                                          //                                               (value) {
                                          //                                             Navigator.pop(
                                          //                                                 context);
                                          //                                           });
                                          //                                     },
                                          //                                     child: Padding(
                                          //                                       padding:
                                          //                                       const EdgeInsets
                                          //                                           .all(
                                          //                                           8.0),
                                          //                                       child: Card(
                                          //                                         elevation:
                                          //                                         8,
                                          //                                         color: Theme.of(
                                          //                                             context)
                                          //                                             .primaryColor,
                                          //                                         child: Center(
                                          //                                             child: Padding(
                                          //                                               padding: const EdgeInsets
                                          //                                                   .all(
                                          //                                                   15.0),
                                          //                                               child:
                                          //                                               Text(
                                          //                                                 "Delete",
                                          //                                                 style: TextStyle(
                                          //                                                     color:
                                          //                                                     Colors.white,
                                          //                                                     fontWeight: FontWeight.bold),
                                          //                                               ),
                                          //                                             )),
                                          //                                       ),
                                          //                                     ),
                                          //                                   )),
                                          //                             ],
                                          //                           ),
                                          //                         ],
                                          //                       );
                                          //                     });
                                          //               }
                                          //
                                          //               if (value == folderAction.move) {
                                          //                 //rename folder
                                          //                 showModalBottomSheet(
                                          //                     context: context,
                                          //                     builder: (builder) {
                                          //                       return new Wrap(
                                          //                         children: [
                                          //                           ListTile(
                                          //                             title: Text(
                                          //                               "Move Folder",
                                          //                               style: TextStyle(
                                          //                                   fontSize: 20,
                                          //                                   color: Theme.of(
                                          //                                       context)
                                          //                                       .primaryColor),
                                          //                             ),
                                          //                             trailing: Padding(
                                          //                               padding:
                                          //                               const EdgeInsets
                                          //                                   .all(8.0),
                                          //                               child: InkWell(
                                          //                                 onTap: () {
                                          //                                   Navigator.of(
                                          //                                       context)
                                          //                                       .pop();
                                          //                                 },
                                          //                                 child: Icon(
                                          //                                     Icons
                                          //                                         .close),
                                          //                               ),
                                          //                             ),
                                          //                           ),
                                          //                           Padding(
                                          //                             padding:
                                          //                             const EdgeInsets
                                          //                                 .all(8.0),
                                          //                             child: Text(
                                          //                               "Move Folder",
                                          //                               style: TextStyle(
                                          //                                   fontSize: 20,
                                          //                                   color: Theme.of(
                                          //                                       context)
                                          //                                       .primaryColor),
                                          //                             ),
                                          //                           ),
                                          //
                                          //                           MoveFolderActivity(
                                          //                             customerId: widget
                                          //                                 .customerId,
                                          //                             customerFirestore:
                                          //                             widget
                                          //                                 .customerFirestore,
                                          //                             curentFolderID:snapshot.data!.docs[index].id,locale: widget.locale,
                                          //                           ),
                                          //                           //here show move folder target
                                          //                         ],
                                          //                       );
                                          //                     });
                                          //               }
                                          //             },
                                          //             child:
                                          //             Center(child: Icon(Icons.menu)),
                                          //             itemBuilder: (BuildContext
                                          //             context) =>
                                          //             <PopupMenuEntry<folderAction>>[
                                          //               PopupMenuItem<folderAction>(
                                          //                 value: folderAction.rename,
                                          //                 child: Text('Rename'),
                                          //               ),
                                          //               PopupMenuItem<folderAction>(
                                          //                 value: folderAction.delete,
                                          //                 child: Text('Delete'),
                                          //               ),
                                          //               PopupMenuItem<folderAction>(
                                          //                 value: folderAction.move,
                                          //                 child: Text('Move'),
                                          //               ),
                                          //             ],
                                          //           ),
                                          //         ),
                                          //       ),
                                          //     ],
                                          //   ),
                                          // ),
                                          // Container(
                                          //
                                          //  // width: MediaQuery.of(context).size.width,
                                          //   child:showNextLevelFolder(snapshot.data!.docs[index].id),)

                                        ],
                                      ),
                                    ),

                                    // if(widget.isExpanded) showNextLevelFolder(snapshot.data!.docs[index].id),

                                    if(expand)  showTestItemsInFolder(filteredData[index].id,widget.customerFirestore,widget.customerId,widget.locale),
                                    if(expand) Padding(
                                      padding:  EdgeInsets.only(left: width * 0.02),
                                      child: ExpandenFolderActivityLevel1(parentFolder:filteredData[index].id, customerId: widget.customerId,locale: widget.locale, customerFirestore: widget.customerFirestore, expand: false,),
                                    ),

                                  ],
                                ),
                              ),),
                              Align(alignment: Alignment.centerRight,child: addOrDeletePopMenuBox(filteredData[index].id,filteredData[index].get("name")),),
                            ],
                          ),
                          // if(widget.isExpanded)   Padding(padding: EdgeInsets.fromLTRB(40,0,0,0),child:  showTestItemsInFolder(snapshot.data!.docs[index].id),),
                          // if(widget.isExpanded)   Padding(padding: EdgeInsets.fromLTRB(40,0,0,0),child:ExpandedFiles(parentFolder: snapshot.data!.docs[index].id, customerId: widget.customerId,locale: widget.locale, customerFirestore: widget.customerFirestore,),),

                        ],
                      ),
                    );
                  }
                  // return   Padding(
                  //   padding:  EdgeInsets.fromLTRB((step* 20), 2, 0, 2),
                  //   child: Column(
                  //     children: [
                  //       Stack(
                  //         children: [
                  //           Align(alignment: Alignment.centerLeft,child: Padding(
                  //             padding:  EdgeInsets.fromLTRB(0, 0, 0, 0),
                  //             child: Column(
                  //               children: [
                  //                 Row(
                  //                   children: [
                  //                     GestureDetector(
                  //                       onTap: () {
                  //
                  //                         setState(() {
                  //                           expand = !expand;
                  //                         });
                  //
                  //                         // try{
                  //                         //   ExpandFolderStream.getInstance().dataReload({"id":snapshot.data!.docs[index].id,"expand":!expand});
                  //                         // }catch(e){
                  //                         //   print("enpand er");
                  //                         //   print(e);
                  //                         // }
                  //                       },
                  //                       //newFolder.isExpanded == fals
                  //                       child: expand
                  //                           ? Icon(
                  //                         Icons.keyboard_arrow_up_outlined,
                  //                         size: width * 0.085,
                  //                         color: ThemeManager().getDarkGrey2Color,
                  //                       )
                  //                           : Icon(
                  //                         Icons.keyboard_arrow_down_outlined,
                  //                         size: width * 0.085,
                  //                         color: ThemeManager().getDarkGrey2Color,
                  //                       ),
                  //                     ),
                  //                     Container(
                  //                       margin: EdgeInsets.only(
                  //                         left: width * 0.02,
                  //                       ),
                  //                       child: SvgPicture.asset(
                  //                         ("assets/svg/folderIcon.svg"),
                  //                         fit: BoxFit.cover,
                  //                       ),
                  //                     ),
                  //                     Container(
                  //                         margin: EdgeInsets.only(
                  //                           left: width * 0.03,
                  //                         ),
                  //                         child: Text(
                  //                           snapshot.data!.docs[index]["name"],
                  //                           style: interRegular.copyWith(
                  //                             color: ThemeManager().getBlackColor,
                  //                             fontSize: width * 0.045,
                  //                           ),
                  //                         )),
                  //
                  //                     // Container(
                  //                     // //  height: 50,
                  //                     //   width: MediaQuery.of(context).size.width,
                  //                     //   child: Stack(
                  //                     //     children: [
                  //                     //       Align(
                  //                     //         alignment: Alignment.centerLeft,
                  //                     //         child: Row(
                  //                     //           children: [
                  //                     //             GestureDetector(
                  //                     //               onTap: () {
                  //                     //                 // setState(() {
                  //                     //                 //   newFolder.isExpanded = !(newFolder.isExpanded);
                  //                     //                 //   newFolder.isVisible = !newFolder.isVisible;
                  //                     //                 // });
                  //                     //               },
                  //                     //               //newFolder.isExpanded == fals
                  //                     //               child: false
                  //                     //                   ? Icon(
                  //                     //                 Icons.keyboard_arrow_up_outlined,
                  //                     //                 size: width * 0.085,
                  //                     //                 color: ThemeManager().getDarkGrey2Color,
                  //                     //               )
                  //                     //                   : Icon(
                  //                     //                 Icons.keyboard_arrow_down_outlined,
                  //                     //                 size: width * 0.085,
                  //                     //                 color: ThemeManager().getDarkGrey2Color,
                  //                     //               ),
                  //                     //             ),
                  //                     //             Container(
                  //                     //               margin: EdgeInsets.only(
                  //                     //                 left: width * 0.02,
                  //                     //               ),
                  //                     //               child: SvgPicture.asset(
                  //                     //                 ("assets/svg/folderIcon.svg"),
                  //                     //                 fit: BoxFit.cover,
                  //                     //               ),
                  //                     //             ),
                  //                     //             Container(
                  //                     //                 margin: EdgeInsets.only(
                  //                     //                   left: width * 0.03,
                  //                     //                 ),
                  //                     //                 child: Text(
                  //                     //                   snapshot.data!.docs[index]["name"],
                  //                     //                   style: interRegular.copyWith(
                  //                     //                     color: ThemeManager().getBlackColor,
                  //                     //                     fontSize: width * 0.045,
                  //                     //                   ),
                  //                     //                 ))
                  //                     //             // Column(
                  //                     //             //   mainAxisAlignment:
                  //                     //             //   MainAxisAlignment.center,
                  //                     //             //   crossAxisAlignment:
                  //                     //             //   CrossAxisAlignment.start,
                  //                     //             //   children: [
                  //                     //             //
                  //                     //             //     Text(
                  //                     //             //       snapshot.data!.docs[index]["name"]
                  //                     //             //           .toString(),
                  //                     //             //       style: TextStyle(
                  //                     //             //           fontWeight:
                  //                     //             //           FontWeight.bold,
                  //                     //             //           color: Colors.black),
                  //                     //             //     ),
                  //                     //             //     timeFormate(snapshot.data!.docs[index]["created_at"]),
                  //                     //             //   ],
                  //                     //             // ),
                  //                     //           ],
                  //                     //         ),
                  //                     //       ),
                  //                     //       Align(
                  //                     //         alignment: Alignment.centerRight,
                  //                     //         child: Container(
                  //                     //           height: MediaQuery.of(context)
                  //                     //               .size
                  //                     //               .height,
                  //                     //           width: 50,
                  //                     //           child: PopupMenuButton<folderAction>(
                  //                     //             onSelected: (folderAction value) {
                  //                     //               if (value ==
                  //                     //                   folderAction.rename) {
                  //                     //                 //rename folder
                  //                     //                 TextEditingController
                  //                     //                 controller =
                  //                     //                 TextEditingController(
                  //                     //                     text: snapshot.data!.docs[index]
                  //                     //                     ["name"]
                  //                     //                         .toString());
                  //                     //
                  //                     //                 Navigator.of(context)
                  //                     //                     .push(
                  //                     //                     new MaterialPageRoute<
                  //                     //                         Null>(
                  //                     //                         builder:
                  //                     //                             (BuildContext
                  //                     //                         context) {
                  //                     //                           return Scaffold(
                  //                     //                             appBar: AppBar(
                  //                     //                               title: Text(
                  //                     //                                   "Rename Folder"),
                  //                     //                             ),
                  //                     //                             body: Container(
                  //                     //                               decoration:
                  //                     //                               BoxDecoration(
                  //                     //                                 color: Color
                  //                     //                                     .fromARGB(
                  //                     //                                     255,
                  //                     //                                     247,
                  //                     //                                     247,
                  //                     //                                     247),
                  //                     //                                 borderRadius: BorderRadius.only(
                  //                     //                                     topLeft:
                  //                     //                                     Radius.circular(
                  //                     //                                         10.0),
                  //                     //                                     topRight:
                  //                     //                                     Radius.circular(10.0)),
                  //                     //                               ),
                  //                     //                               child:
                  //                     //                               Padding(
                  //                     //                                 padding: const EdgeInsets
                  //                     //                                     .all(
                  //                     //                                     15.0),
                  //                     //                                 child: Wrap(
                  //                     //                                   children: [
                  //                     //                                     Padding(
                  //                     //                                       padding:
                  //                     //                                       const EdgeInsets.all(8.0),
                  //                     //                                       child:
                  //                     //                                       TextFormField(
                  //                     //                                         controller:
                  //                     //                                         controller,
                  //                     //                                         autofocus:
                  //                     //                                         true,
                  //                     //                                         decoration:
                  //                     //                                         InputDecoration(
                  //                     //                                           labelText: 'Folder Name',
                  //                     //                                           border: OutlineInputBorder(),
                  //                     //                                         ),
                  //                     //                                       ),
                  //                     //                                     ),
                  //                     //                                     InkWell(
                  //                     //                                       onTap:
                  //                     //                                           () {
                  //                     //                                         widget.customerFirestore.collection("folders").doc(snapshot.data!.docs[index].id).update({
                  //                     //                                           "name": controller.text
                  //                     //                                         }).then((value) {
                  //                     //                                           Navigator.pop(context);
                  //                     //                                         });
                  //                     //                                       },
                  //                     //                                       child:
                  //                     //                                       Card(
                  //                     //                                         color:
                  //                     //                                         Theme.of(context).primaryColor,
                  //                     //                                         child: Center(
                  //                     //                                             child: Padding(
                  //                     //                                               padding: const EdgeInsets.all(10.0),
                  //                     //                                               child: Text(
                  //                     //                                                 "Submit",
                  //                     //                                                 style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold),
                  //                     //                                               ),
                  //                     //                                             )),
                  //                     //                                       ),
                  //                     //                                     )
                  //                     //                                   ],
                  //                     //                                 ),
                  //                     //                               ),
                  //                     //                             ),
                  //                     //                           );
                  //                     //                         },
                  //                     //                         fullscreenDialog:
                  //                     //                         true));
                  //                     //               }
                  //                     //               if (value ==
                  //                     //                   folderAction.delete) {
                  //                     //                 //rename folder
                  //                     //                 showModalBottomSheet(
                  //                     //                     context: context,
                  //                     //                     builder: (builder) {
                  //                     //                       return new Wrap(
                  //                     //                         children: [
                  //                     //                           Padding(
                  //                     //                             padding:
                  //                     //                             const EdgeInsets
                  //                     //                                 .all(8.0),
                  //                     //                             child: Text(
                  //                     //                               "Do you want to delete this Folder?",
                  //                     //                               style: TextStyle(
                  //                     //                                   fontSize: 20,
                  //                     //                                   color: Theme.of(
                  //                     //                                       context)
                  //                     //                                       .primaryColor),
                  //                     //                             ),
                  //                     //                           ),
                  //                     //                           Row(
                  //                     //                             children: [
                  //                     //                               Expanded(
                  //                     //                                   child:
                  //                     //                                   InkWell(
                  //                     //                                     onTap: () {
                  //                     //                                       Navigator.of(
                  //                     //                                           context)
                  //                     //                                           .pop();
                  //                     //                                     },
                  //                     //                                     child: Padding(
                  //                     //                                       padding:
                  //                     //                                       const EdgeInsets
                  //                     //                                           .all(
                  //                     //                                           8.0),
                  //                     //                                       child: Card(
                  //                     //                                         elevation:
                  //                     //                                         8,
                  //                     //                                         color: Colors
                  //                     //                                             .grey,
                  //                     //                                         child: Center(
                  //                     //                                             child: Padding(
                  //                     //                                               padding: const EdgeInsets
                  //                     //                                                   .all(
                  //                     //                                                   15.0),
                  //                     //                                               child:
                  //                     //                                               Text(
                  //                     //                                                 "Cancel",
                  //                     //                                                 style: TextStyle(
                  //                     //                                                     color:
                  //                     //                                                     Colors.white,
                  //                     //                                                     fontWeight: FontWeight.bold),
                  //                     //                                               ),
                  //                     //                                             )),
                  //                     //                                       ),
                  //                     //                                     ),
                  //                     //                                   )),
                  //                     //                               Expanded(
                  //                     //                                   child:
                  //                     //                                   InkWell(
                  //                     //                                     onTap: () {
                  //                     //                                       widget
                  //                     //                                           .customerFirestore
                  //                     //                                           .collection(
                  //                     //                                           "folders")
                  //                     //                                           .doc(snapshot.data!.docs[index].id)
                  //                     //                                           .delete()
                  //                     //                                           .then(
                  //                     //                                               (value) {
                  //                     //                                             Navigator.pop(
                  //                     //                                                 context);
                  //                     //                                           });
                  //                     //                                     },
                  //                     //                                     child: Padding(
                  //                     //                                       padding:
                  //                     //                                       const EdgeInsets
                  //                     //                                           .all(
                  //                     //                                           8.0),
                  //                     //                                       child: Card(
                  //                     //                                         elevation:
                  //                     //                                         8,
                  //                     //                                         color: Theme.of(
                  //                     //                                             context)
                  //                     //                                             .primaryColor,
                  //                     //                                         child: Center(
                  //                     //                                             child: Padding(
                  //                     //                                               padding: const EdgeInsets
                  //                     //                                                   .all(
                  //                     //                                                   15.0),
                  //                     //                                               child:
                  //                     //                                               Text(
                  //                     //                                                 "Delete",
                  //                     //                                                 style: TextStyle(
                  //                     //                                                     color:
                  //                     //                                                     Colors.white,
                  //                     //                                                     fontWeight: FontWeight.bold),
                  //                     //                                               ),
                  //                     //                                             )),
                  //                     //                                       ),
                  //                     //                                     ),
                  //                     //                                   )),
                  //                     //                             ],
                  //                     //                           ),
                  //                     //                         ],
                  //                     //                       );
                  //                     //                     });
                  //                     //               }
                  //                     //
                  //                     //               if (value == folderAction.move) {
                  //                     //                 //rename folder
                  //                     //                 showModalBottomSheet(
                  //                     //                     context: context,
                  //                     //                     builder: (builder) {
                  //                     //                       return new Wrap(
                  //                     //                         children: [
                  //                     //                           ListTile(
                  //                     //                             title: Text(
                  //                     //                               "Move Folder",
                  //                     //                               style: TextStyle(
                  //                     //                                   fontSize: 20,
                  //                     //                                   color: Theme.of(
                  //                     //                                       context)
                  //                     //                                       .primaryColor),
                  //                     //                             ),
                  //                     //                             trailing: Padding(
                  //                     //                               padding:
                  //                     //                               const EdgeInsets
                  //                     //                                   .all(8.0),
                  //                     //                               child: InkWell(
                  //                     //                                 onTap: () {
                  //                     //                                   Navigator.of(
                  //                     //                                       context)
                  //                     //                                       .pop();
                  //                     //                                 },
                  //                     //                                 child: Icon(
                  //                     //                                     Icons
                  //                     //                                         .close),
                  //                     //                               ),
                  //                     //                             ),
                  //                     //                           ),
                  //                     //                           Padding(
                  //                     //                             padding:
                  //                     //                             const EdgeInsets
                  //                     //                                 .all(8.0),
                  //                     //                             child: Text(
                  //                     //                               "Move Folder",
                  //                     //                               style: TextStyle(
                  //                     //                                   fontSize: 20,
                  //                     //                                   color: Theme.of(
                  //                     //                                       context)
                  //                     //                                       .primaryColor),
                  //                     //                             ),
                  //                     //                           ),
                  //                     //
                  //                     //                           MoveFolderActivity(
                  //                     //                             customerId: widget
                  //                     //                                 .customerId,
                  //                     //                             customerFirestore:
                  //                     //                             widget
                  //                     //                                 .customerFirestore,
                  //                     //                             curentFolderID:snapshot.data!.docs[index].id,locale: widget.locale,
                  //                     //                           ),
                  //                     //                           //here show move folder target
                  //                     //                         ],
                  //                     //                       );
                  //                     //                     });
                  //                     //               }
                  //                     //             },
                  //                     //             child:
                  //                     //             Center(child: Icon(Icons.menu)),
                  //                     //             itemBuilder: (BuildContext
                  //                     //             context) =>
                  //                     //             <PopupMenuEntry<folderAction>>[
                  //                     //               PopupMenuItem<folderAction>(
                  //                     //                 value: folderAction.rename,
                  //                     //                 child: Text('Rename'),
                  //                     //               ),
                  //                     //               PopupMenuItem<folderAction>(
                  //                     //                 value: folderAction.delete,
                  //                     //                 child: Text('Delete'),
                  //                     //               ),
                  //                     //               PopupMenuItem<folderAction>(
                  //                     //                 value: folderAction.move,
                  //                     //                 child: Text('Move'),
                  //                     //               ),
                  //                     //             ],
                  //                     //           ),
                  //                     //         ),
                  //                     //       ),
                  //                     //     ],
                  //                     //   ),
                  //                     // ),
                  //                     // Container(
                  //                     //
                  //                     //  // width: MediaQuery.of(context).size.width,
                  //                     //   child:showNextLevelFolder(snapshot.data!.docs[index].id),)
                  //
                  //                   ],
                  //                 ),
                  //
                  //                 // if(widget.isExpanded) showNextLevelFolder(snapshot.data!.docs[index].id),
                  //                 if(true) ExpandenFolderActivityLevel1(expand: expand,parentFolder: snapshot.data!.docs[index].id, customerId: widget.customerId,locale: widget.locale, customerFirestore: widget.customerFirestore,),
                  //                 //showTestItemsInFolder(snapshot.data!.docs[index].id),
                  //
                  //               ],
                  //             ),
                  //           ),),
                  //           // Align(alignment: Alignment.centerRight,child: addOrDeletePopMenuBox(snapshot.data!.docs[index].id),),
                  //         ],
                  //       ),
                  //       // if(widget.isExpanded)   Padding(padding: EdgeInsets.fromLTRB(40,0,0,0),child:  showTestItemsInFolder(snapshot.data!.docs[index].id),),
                  //       // if(widget.isExpanded)   Padding(padding: EdgeInsets.fromLTRB(40,0,0,0),child:ExpandedFiles(parentFolder: snapshot.data!.docs[index].id, customerId: widget.customerId,locale: widget.locale, customerFirestore: widget.customerFirestore,),),
                  //
                  //     ],
                  //   ),
                  // );
                  return  StreamBuilder<dynamic>(
                      stream: ExpandFolderStream.getInstance().outData,
                      builder: (c, snapshotEx) {
                        if(snapshotEx.hasData && snapshotEx.data["id"] == filteredData[index].id )
                          return show(snapshotEx.data["expand"],filteredData[index].id);
                        else{
                          return show(false,filteredData[index].id);
                        }

                      });





                });


            return Text( snapshot.data!.docs.length.toString());
          }else return ConstantWidget().notFolders();
        });
  }
  @override
  Widget build(BuildContext context) {
    return Column(children: [
      showNextLevelFolder(widget.parentFolder),
     // ExpandedFolders(parentFolder: widget.parentFolder, customerId: widget.customerId,locale: widget.locale, customerFirestore: widget.customerFirestore,),
     // ExpandedFiles(parentFolder: widget.parentFolder, customerId: widget.customerId,locale: widget.locale, customerFirestore: widget.customerFirestore,),

    ],);
  }

  addOrDeletePopMenuBox(String id,String title) {
    addNewFolderNamePopUp(String id) {
      final _formKey = GlobalKey<FormState>();
      showDialog(
          context: context,
          builder: (
              context,
              ) {
            return StatefulBuilder(builder: (context, setState) {
              return AlertDialog(
                scrollable: true,
                shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.all(Radius.circular(10))),
                contentPadding: EdgeInsets.only(top: 10.0),
                content: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Container(
                      margin: EdgeInsets.only(
                          top: height * 0.01,
                          left: width * 0.04,
                          right: width * 0.04),
                      child: Row(
                        mainAxisAlignment: MainAxisAlignment.spaceBetween,
                        children: [
                          Text("Add new Subfolder",
                            style: interSemiBold.copyWith(
                              color: ThemeManager().getBlackColor,
                              fontSize: width * 0.04,
                            ),
                          ),
                          InkWell(
                              onTap: () {
                                Navigator.of(context).pop();
                              },
                              child: Icon(
                                Icons.clear,
                                size: width * 0.06,
                                color: ThemeManager().getLightGrey4Color,
                              )),
                        ],
                      ),
                    ),
                    Container(
                      margin: EdgeInsets.only(top: height * 0.015),
                      height: height * 0.001,
                      color: ThemeManager().getBlackColor.withOpacity(0.19),
                    ),
                    Container(
                      margin: EdgeInsets.only(
                          top: height * 0.02,
                          left: width * 0.04,
                          right: width * 0.04),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text("Subfolder Name",
                            style: interMedium.copyWith(
                              color: ThemeManager().getPopUpTextGreyColor,
                              fontSize: width * 0.036,
                            ),
                          ),
                          Container(
                            margin: EdgeInsets.only(top: height * 0.015),
                            child: Form(
                              key: _formKey,
                              child: TextFormField(
                                controller: _folderNameController,
                                maxLength: 22,
                                autovalidateMode: AutovalidateMode.onUserInteraction,
                                keyboardType: TextInputType.text,
                                decoration: InputDecoration(
                                  counterText: "",
                                  border: InputBorder.none,
                                  hintText: TextConst.textFieldFolderText,
                                  hintStyle: interMedium.copyWith(
                                    color: ThemeManager().getLightGrey4Color,
                                    fontSize: width * 0.036,
                                  ),
                                  enabledBorder: OutlineInputBorder(
                                      borderSide: BorderSide(
                                        color: Colors.transparent,
                                      ),
                                      borderRadius:
                                      BorderRadius.circular(width * 0.014)),
                                  contentPadding: EdgeInsets.symmetric(
                                      vertical: height * 0.0,
                                      horizontal: width * 0.045),
                                  fillColor:
                                  ThemeManager().getLightGreenTextFieldColor,
                                  filled: true,
                                ),
                                validator: (value) {



                                  if (value!.isEmpty) {


              //    AppFirestore(firestore: widget.customerFirestore, projectId: '', auth: FirebaseAuth.instance).checkFolders(name:_folderNameController.text,parent: id ).then((valueR) {
              //    if(valueR == false) return "Folder name exists";
              //     else  return null;
                                    //     });


                                  } else if (value!.isEmpty) {
                                    return "Please enter folder name";
                                  } else if (_folderNameController.text.length > 22) {
                                    return "Name should be 22 character only";
                                  }
                                },
                              ),
                            ),
                          ),
                          // Container(
                          //   margin: EdgeInsets.only(top: height * 0.015),
                          //   child: Text(
                          //     "*Name must be within 10 characters.",
                          //     style: interMedium.copyWith(
                          //       color: ThemeManager().getPopUpTextGreyColor,
                          //       fontSize: width * 0.03,
                          //     ),
                          //   ),
                          // ),
                          InkWell(
                            onTap: () async {
                              if (_formKey.currentState!.validate()) {



                                if (_formKey.currentState!.validate()) {
                                  var r = await  AppFirestore(firestore: widget.customerFirestore, projectId: '', auth: FirebaseAuth.instance).createFolders(name:_folderNameController.text,parent: id );

                                  if(r == true) {
                                    _folderNameController.clear();
                                    Navigator.of(context).pop();
                                  }else{
                                    _folderNameController.clear();
                                    Navigator.of(context).pop();
                                    showDialog(context: context,
                                        builder: (BuildContext context){
                                          return FolderExistsPopUp();
                                        });
                                  }


                                } else {}






                                //  Navigator.pop(context);

// Close progress dialog
//                                 final dialogContextCompleter = Completer<BuildContext>();
//                                 final dialogContext = await dialogContextCompleter.future;
//                                 Navigator.pop(dialogContext);
//                                 Navigator.of(context).pop();
                              } else {}
                            },
                            child: Container(
                                margin: EdgeInsets.only(
                                    top: height * 0.04, bottom: height * 0.02),
                                child: ButtonView(
                                    buttonLabel: TextConst.saveButtonText)
                            ),
                          ),
                        ],
                      ),
                    ),
                  ],
                ),
              );
            });
          });
    }
    renameFolderNamePopUp(String id,String oldName) {
      _folderNameController = TextEditingController(text: title);
      final _formKey = GlobalKey<FormState>();
      showDialog(
          context: context,
          builder: (
              context,
              ) {
            return StatefulBuilder(builder: (context, setState) {
              return AlertDialog(
                scrollable: true,
                shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.all(Radius.circular(10))),
                contentPadding: EdgeInsets.only(top: 10.0),
                content: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Container(
                      margin: EdgeInsets.only(
                          top: height * 0.01,
                          left: width * 0.04,
                          right: width * 0.04),
                      child: Row(
                        mainAxisAlignment: MainAxisAlignment.spaceBetween,
                        children: [
                          Text("Rename",
                            style: interSemiBold.copyWith(
                              color: ThemeManager().getBlackColor,
                              fontSize: width * 0.04,
                            ),
                          ),
                          InkWell(
                              onTap: () {
                                Navigator.of(context).pop();
                              },
                              child: Icon(
                                Icons.clear,
                                size: width * 0.06,
                                color: ThemeManager().getLightGrey4Color,
                              )),
                        ],
                      ),
                    ),
                    Container(
                      margin: EdgeInsets.only(top: height * 0.015),
                      height: height * 0.001,
                      color: ThemeManager().getBlackColor.withOpacity(0.19),
                    ),
                    Container(
                      margin: EdgeInsets.only(
                          top: height * 0.02,
                          left: width * 0.04,
                          right: width * 0.04),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text("Subfolder Name",
                            style: interMedium.copyWith(
                              color: ThemeManager().getPopUpTextGreyColor,
                              fontSize: width * 0.036,
                            ),
                          ),
                          Container(
                            margin: EdgeInsets.only(top: height * 0.015),
                            child: Form(
                              key: _formKey,
                              child: TextFormField(

                                controller: _folderNameController,
                                maxLength: 22,
                                autovalidateMode: AutovalidateMode.onUserInteraction,
                                keyboardType: TextInputType.text,
                                decoration: InputDecoration(
                                  counterText: "",
                                  border: InputBorder.none,
                                  hintText: TextConst.textFieldFolderText,
                                  hintStyle: interMedium.copyWith(
                                    color: ThemeManager().getLightGrey4Color,
                                    fontSize: width * 0.036,
                                  ),
                                  enabledBorder: OutlineInputBorder(
                                      borderSide: BorderSide(
                                        color: Colors.transparent,
                                      ),
                                      borderRadius:
                                      BorderRadius.circular(width * 0.014)),
                                  contentPadding: EdgeInsets.symmetric(
                                      vertical: height * 0.0,
                                      horizontal: width * 0.045),
                                  fillColor:
                                  ThemeManager().getLightGreenTextFieldColor,
                                  filled: true,
                                ),
                                validator: (value) {
                                  if (value!.isEmpty) {
                                    return "Please enter folder name";
                                  } else if (_folderNameController.text.length > 22) {
                                    return "Name should be 22 character only";
                                  }
                                },
                              ),
                            ),
                          ),
                          // Container(
                          //   margin: EdgeInsets.only(top: height * 0.015),
                          //   child: Text(
                          //     "*Name must be within 10 characters.",
                          //     style: interMedium.copyWith(
                          //       color: ThemeManager().getPopUpTextGreyColor,
                          //       fontSize: width * 0.03,
                          //     ),
                          //   ),
                          // ),
                          InkWell(
                            onTap: () async {
                              if (_formKey.currentState!.validate()) {
                                AppFirestore(firestore: widget.customerFirestore, projectId: '', auth: FirebaseAuth.instance).renameFolders(name:_folderNameController.text,parent: id );
                                //  Navigator.pop(context);
                                _folderNameController.clear();
                                Navigator.of(context).pop();
// Close progress dialog
//                                 final dialogContextCompleter = Completer<BuildContext>();
//                                 final dialogContext = await dialogContextCompleter.future;
//                                 Navigator.pop(dialogContext);
//                                 Navigator.of(context).pop();
                              } else {}
                            },
                            child: Container(
                                margin: EdgeInsets.only(
                                    top: height * 0.04, bottom: height * 0.02),
                                child: ButtonView(
                                    buttonLabel: TextConst.saveButtonText)
                            ),
                          ),
                        ],
                      ),
                    ),
                  ],
                ),
              );
            });
          });
    }
    return PopupMenuButton(
      elevation: 1,
      icon: Icon(Icons.more_horiz),

      itemBuilder: (context) => [
        PopupMenuItem(
         // padding: EdgeInsets.only(top: height * 0.01, left: width * 0.0065, right: width * 0.0065),

          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [

              InkWell(
                onTap: () {
                 Navigator.of(context).pop();
                 addNewFolderNamePopUp(id);
                },
                child: Container(
                  margin: EdgeInsets.only(
                      left: width * 0.005, right: width * 0.005),
                  alignment: Alignment.center,
                  child: Text(
                    TextConst.addNewFolderPopUpText,
                    style: interRegular.copyWith(
                        color: ThemeManager().getBlackColor,
                        fontSize: width * 0.035),
                  ),
                ),
              ),
              Container(
                margin: EdgeInsets.only(
                    top: height * 0.01, bottom: height * 0.01),
                height: height * 0.001,
                width: double.infinity,
                color: ThemeManager().getBlackColor.withOpacity(0.19),
              ),
              InkWell(
                onTap: () {
                  Navigator.of(context).pop();
                  renameFolderNamePopUp(id,title);
                },
                child: Container(
                  margin: EdgeInsets.only(
                      left: width * 0.005, right: width * 0.005),
                  alignment: Alignment.center,
                  child: Text("Rename",
                    style: interRegular.copyWith(
                        color: ThemeManager().getBlackColor,
                        fontSize: width * 0.035),
                  ),
                ),
              ),
              Container(
                margin: EdgeInsets.only(
                    top: height * 0.01, bottom: height * 0.01),
                height: height * 0.001,
                width: double.infinity,
                color: ThemeManager().getBlackColor.withOpacity(0.19),
              ),
              InkWell(
                onTap: () {
                  //delete

                  showDialog(context: context,
                      builder: (BuildContext context){
                        return DeleteFolderPopUp(title:title, onClickAction: (answer ) {
                          print("delete actin found");
                          print(answer);
                          if(answer == true){

                            widget.customerFirestore.collection("folders").doc(id).delete();
                            Navigator.of(context).pop();

                          }else{
                            Navigator.of(context).pop();
                          }
                        },);
                      }
                  );
                  
                  
                 
                },
                child: Container(
                    alignment: Alignment.center,
                    child: Text(
                      TextConst.deleteFolderPopUpText,
                      style: interRegular.copyWith(
                          color: ThemeManager().getBlackColor,
                          fontSize: width * 0.035),
                    )),
              )
            ],
          ),
          // value: 1,
        ),
      ],
    );
  }
}



class ExpandenFolderActivityForReporting extends StatefulWidget {
  String parentFolder;
  String customerId;

  FirebaseFirestore customerFirestore;
  Locale locale;
  ExpandenFolderActivityForReporting({required this.parentFolder,required this.customerFirestore,required this.customerId,required this.locale});

  @override
  _ExpandenFolderActivityForReportingState createState() => _ExpandenFolderActivityForReportingState();
}

class _ExpandenFolderActivityForReportingState extends State<ExpandenFolderActivityForReporting> {
  // bool expand = false;
  showNextLevelFolder(String data) {
    int step = 0;

    return StreamBuilder<QuerySnapshot>(
        stream: AppFirestore(firestore: widget.customerFirestore,projectId: "",auth: FirebaseAuth.instance).getFolders(parentFolder: data),
        builder: (context, snapshot) {
          if (snapshot.hasData && snapshot.data!.docs.length>0) {
            step++;

            //sort here
            List<QueryDocumentSnapshot> filteredData = [];
            filteredData = snapshot.data!.docs;
            filteredData.sort((a, b) {
              return a
                  .get("name")
                  .toString()
                  .toLowerCase()
                  .compareTo(b.get("name").toString().toLowerCase());
            });

            return   ListView.separated(
                separatorBuilder: (BuildContext context, int index) => Divider(),
                physics: NeverScrollableScrollPhysics(),
                // separatorBuilder: (context, index) {
                //   return Divider();
                // },
                shrinkWrap: true,
                padding: EdgeInsets.zero,
                itemCount: filteredData.length,
                itemBuilder: (_, index) {
                  //ExpandFolderStream

                  show(bool expand,String id){


                    return   Padding(
                      padding: const EdgeInsets.fromLTRB(0, 0, 0, 0),
                      child: Wrap(
                        children: [
                          Stack(
                            children: [
                              Align(alignment: Alignment.centerLeft,child: Column(
                                children: [
                                  Container(
                                    // color: expand?ThemeManager().getLightYellowColor:Colors.white,
                                    child: Row(
                                      children: [
                                        GestureDetector(
                                          onTap: () {
                                            try{

                                              ExpandFolderStream.getInstance().dataReload({"id":filteredData[index].id,"expand":!expand});
                                              Future.delayed(Duration(seconds: 1)).then((value) {
                                                NeedToRefreshFilesNameAsStream.getInstance().dataReload(true);
                                              });
                                            }catch(e){
                                              print("enpand er");
                                              print(e);
                                            }
                                          },
                                          //newFolder.isExpanded == fals
                                          child: expand
                                              ? Icon(
                                            Icons.keyboard_arrow_up_outlined,
                                            size: width * 0.085,
                                            color: ThemeManager().getDarkGrey2Color,
                                          )
                                              : Icon(
                                            Icons.keyboard_arrow_down_outlined,
                                            size: width * 0.085,
                                            color: ThemeManager().getDarkGrey2Color,
                                          ),
                                        ),
                                        GestureDetector(
                                          onTap: () {
                                            try{

                                              ExpandFolderStream.getInstance().dataReload({"id":filteredData[index].id,"expand":!expand});
                                              Future.delayed(Duration(seconds: 1)).then((value) {
                                                NeedToRefreshFilesNameAsStream.getInstance().dataReload(true);
                                              });
                                            }catch(e){
                                              print("enpand er");
                                              print(e);
                                            }
                                          },
                                          child: Container(
                                            margin: EdgeInsets.only(
                                              left: width * 0.02,
                                            ),
                                            child: SvgPicture.asset(
                                              (expand?"assets/svg/folder_open.svg": "assets/svg/folder_close.svg"),
                                              fit: BoxFit.cover,width:width * 0.075,
                                            ),
                                          ),
                                        ),
                                        GestureDetector(   onTap: () {
                                          try{

                                            ExpandFolderStream.getInstance().dataReload({"id":filteredData[index].id,"expand":!expand});
                                            Future.delayed(Duration(seconds: 1)).then((value) {
                                              NeedToRefreshFilesNameAsStream.getInstance().dataReload(true);
                                            });
                                          }catch(e){
                                            print("enpand er");
                                            print(e);
                                          }
                                        },
                                          child: Container(
                                              margin: EdgeInsets.only(
                                                left: width * 0.03,
                                              ),
                                             child: StreamBuilder<List>(
                                                  stream:ReportingsLogics().folderSelectedForReportStream().outData,

                                                  builder: (context, snapshotFolders) {
                                                    return Text(  filteredData[index]["name"], style: interRegular.copyWith(color: (snapshotFolders.hasData &&  snapshotFolders.data!.contains(id))? ThemeManager().getDarkGreenColor: ThemeManager().getBlackColor, fontSize: width * 0.045,));
                                                  }),
                                             // child: Text(filteredData[index]["name"], style: interRegular.copyWith(color: ThemeManager().getBlackColor, fontSize: width * 0.045,),
                                              )),


                                        // Container(
                                        // //  height: 50,
                                        //   width: MediaQuery.of(context).size.width,
                                        //   child: Stack(
                                        //     children: [
                                        //       Align(
                                        //         alignment: Alignment.centerLeft,
                                        //         child: Row(
                                        //           children: [
                                        //             GestureDetector(
                                        //               onTap: () {
                                        //                 // setState(() {
                                        //                 //   newFolder.isExpanded = !(newFolder.isExpanded);
                                        //                 //   newFolder.isVisible = !newFolder.isVisible;
                                        //                 // });
                                        //               },
                                        //               //newFolder.isExpanded == fals
                                        //               child: false
                                        //                   ? Icon(
                                        //                 Icons.keyboard_arrow_up_outlined,
                                        //                 size: width * 0.085,
                                        //                 color: ThemeManager().getDarkGrey2Color,
                                        //               )
                                        //                   : Icon(
                                        //                 Icons.keyboard_arrow_down_outlined,
                                        //                 size: width * 0.085,
                                        //                 color: ThemeManager().getDarkGrey2Color,
                                        //               ),
                                        //             ),
                                        //             Container(
                                        //               margin: EdgeInsets.only(
                                        //                 left: width * 0.02,
                                        //               ),
                                        //               child: SvgPicture.asset(
                                        //                 ("assets/svg/folderIcon.svg"),
                                        //                 fit: BoxFit.cover,
                                        //               ),
                                        //             ),
                                        //             Container(
                                        //                 margin: EdgeInsets.only(
                                        //                   left: width * 0.03,
                                        //                 ),
                                        //                 child: Text(
                                        //                   snapshot.data!.docs[index]["name"],
                                        //                   style: interRegular.copyWith(
                                        //                     color: ThemeManager().getBlackColor,
                                        //                     fontSize: width * 0.045,
                                        //                   ),
                                        //                 ))
                                        //             // Column(
                                        //             //   mainAxisAlignment:
                                        //             //   MainAxisAlignment.center,
                                        //             //   crossAxisAlignment:
                                        //             //   CrossAxisAlignment.start,
                                        //             //   children: [
                                        //             //
                                        //             //     Text(
                                        //             //       snapshot.data!.docs[index]["name"]
                                        //             //           .toString(),
                                        //             //       style: TextStyle(
                                        //             //           fontWeight:
                                        //             //           FontWeight.bold,
                                        //             //           color: Colors.black),
                                        //             //     ),
                                        //             //     timeFormate(snapshot.data!.docs[index]["created_at"]),
                                        //             //   ],
                                        //             // ),
                                        //           ],
                                        //         ),
                                        //       ),
                                        //       Align(
                                        //         alignment: Alignment.centerRight,
                                        //         child: Container(
                                        //           height: MediaQuery.of(context)
                                        //               .size
                                        //               .height,
                                        //           width: 50,
                                        //           child: PopupMenuButton<folderAction>(
                                        //             onSelected: (folderAction value) {
                                        //               if (value ==
                                        //                   folderAction.rename) {
                                        //                 //rename folder
                                        //                 TextEditingController
                                        //                 controller =
                                        //                 TextEditingController(
                                        //                     text: snapshot.data!.docs[index]
                                        //                     ["name"]
                                        //                         .toString());
                                        //
                                        //                 Navigator.of(context)
                                        //                     .push(
                                        //                     new MaterialPageRoute<
                                        //                         Null>(
                                        //                         builder:
                                        //                             (BuildContext
                                        //                         context) {
                                        //                           return Scaffold(
                                        //                             appBar: AppBar(
                                        //                               title: Text(
                                        //                                   "Rename Folder"),
                                        //                             ),
                                        //                             body: Container(
                                        //                               decoration:
                                        //                               BoxDecoration(
                                        //                                 color: Color
                                        //                                     .fromARGB(
                                        //                                     255,
                                        //                                     247,
                                        //                                     247,
                                        //                                     247),
                                        //                                 borderRadius: BorderRadius.only(
                                        //                                     topLeft:
                                        //                                     Radius.circular(
                                        //                                         10.0),
                                        //                                     topRight:
                                        //                                     Radius.circular(10.0)),
                                        //                               ),
                                        //                               child:
                                        //                               Padding(
                                        //                                 padding: const EdgeInsets
                                        //                                     .all(
                                        //                                     15.0),
                                        //                                 child: Wrap(
                                        //                                   children: [
                                        //                                     Padding(
                                        //                                       padding:
                                        //                                       const EdgeInsets.all(8.0),
                                        //                                       child:
                                        //                                       TextFormField(
                                        //                                         controller:
                                        //                                         controller,
                                        //                                         autofocus:
                                        //                                         true,
                                        //                                         decoration:
                                        //                                         InputDecoration(
                                        //                                           labelText: 'Folder Name',
                                        //                                           border: OutlineInputBorder(),
                                        //                                         ),
                                        //                                       ),
                                        //                                     ),
                                        //                                     InkWell(
                                        //                                       onTap:
                                        //                                           () {
                                        //                                         widget.customerFirestore.collection("folders").doc(snapshot.data!.docs[index].id).update({
                                        //                                           "name": controller.text
                                        //                                         }).then((value) {
                                        //                                           Navigator.pop(context);
                                        //                                         });
                                        //                                       },
                                        //                                       child:
                                        //                                       Card(
                                        //                                         color:
                                        //                                         Theme.of(context).primaryColor,
                                        //                                         child: Center(
                                        //                                             child: Padding(
                                        //                                               padding: const EdgeInsets.all(10.0),
                                        //                                               child: Text(
                                        //                                                 "Submit",
                                        //                                                 style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold),
                                        //                                               ),
                                        //                                             )),
                                        //                                       ),
                                        //                                     )
                                        //                                   ],
                                        //                                 ),
                                        //                               ),
                                        //                             ),
                                        //                           );
                                        //                         },
                                        //                         fullscreenDialog:
                                        //                         true));
                                        //               }
                                        //               if (value ==
                                        //                   folderAction.delete) {
                                        //                 //rename folder
                                        //                 showModalBottomSheet(
                                        //                     context: context,
                                        //                     builder: (builder) {
                                        //                       return new Wrap(
                                        //                         children: [
                                        //                           Padding(
                                        //                             padding:
                                        //                             const EdgeInsets
                                        //                                 .all(8.0),
                                        //                             child: Text(
                                        //                               "Do you want to delete this Folder?",
                                        //                               style: TextStyle(
                                        //                                   fontSize: 20,
                                        //                                   color: Theme.of(
                                        //                                       context)
                                        //                                       .primaryColor),
                                        //                             ),
                                        //                           ),
                                        //                           Row(
                                        //                             children: [
                                        //                               Expanded(
                                        //                                   child:
                                        //                                   InkWell(
                                        //                                     onTap: () {
                                        //                                       Navigator.of(
                                        //                                           context)
                                        //                                           .pop();
                                        //                                     },
                                        //                                     child: Padding(
                                        //                                       padding:
                                        //                                       const EdgeInsets
                                        //                                           .all(
                                        //                                           8.0),
                                        //                                       child: Card(
                                        //                                         elevation:
                                        //                                         8,
                                        //                                         color: Colors
                                        //                                             .grey,
                                        //                                         child: Center(
                                        //                                             child: Padding(
                                        //                                               padding: const EdgeInsets
                                        //                                                   .all(
                                        //                                                   15.0),
                                        //                                               child:
                                        //                                               Text(
                                        //                                                 "Cancel",
                                        //                                                 style: TextStyle(
                                        //                                                     color:
                                        //                                                     Colors.white,
                                        //                                                     fontWeight: FontWeight.bold),
                                        //                                               ),
                                        //                                             )),
                                        //                                       ),
                                        //                                     ),
                                        //                                   )),
                                        //                               Expanded(
                                        //                                   child:
                                        //                                   InkWell(
                                        //                                     onTap: () {
                                        //                                       widget
                                        //                                           .customerFirestore
                                        //                                           .collection(
                                        //                                           "folders")
                                        //                                           .doc(snapshot.data!.docs[index].id)
                                        //                                           .delete()
                                        //                                           .then(
                                        //                                               (value) {
                                        //                                             Navigator.pop(
                                        //                                                 context);
                                        //                                           });
                                        //                                     },
                                        //                                     child: Padding(
                                        //                                       padding:
                                        //                                       const EdgeInsets
                                        //                                           .all(
                                        //                                           8.0),
                                        //                                       child: Card(
                                        //                                         elevation:
                                        //                                         8,
                                        //                                         color: Theme.of(
                                        //                                             context)
                                        //                                             .primaryColor,
                                        //                                         child: Center(
                                        //                                             child: Padding(
                                        //                                               padding: const EdgeInsets
                                        //                                                   .all(
                                        //                                                   15.0),
                                        //                                               child:
                                        //                                               Text(
                                        //                                                 "Delete",
                                        //                                                 style: TextStyle(
                                        //                                                     color:
                                        //                                                     Colors.white,
                                        //                                                     fontWeight: FontWeight.bold),
                                        //                                               ),
                                        //                                             )),
                                        //                                       ),
                                        //                                     ),
                                        //                                   )),
                                        //                             ],
                                        //                           ),
                                        //                         ],
                                        //                       );
                                        //                     });
                                        //               }
                                        //
                                        //               if (value == folderAction.move) {
                                        //                 //rename folder
                                        //                 showModalBottomSheet(
                                        //                     context: context,
                                        //                     builder: (builder) {
                                        //                       return new Wrap(
                                        //                         children: [
                                        //                           ListTile(
                                        //                             title: Text(
                                        //                               "Move Folder",
                                        //                               style: TextStyle(
                                        //                                   fontSize: 20,
                                        //                                   color: Theme.of(
                                        //                                       context)
                                        //                                       .primaryColor),
                                        //                             ),
                                        //                             trailing: Padding(
                                        //                               padding:
                                        //                               const EdgeInsets
                                        //                                   .all(8.0),
                                        //                               child: InkWell(
                                        //                                 onTap: () {
                                        //                                   Navigator.of(
                                        //                                       context)
                                        //                                       .pop();
                                        //                                 },
                                        //                                 child: Icon(
                                        //                                     Icons
                                        //                                         .close),
                                        //                               ),
                                        //                             ),
                                        //                           ),
                                        //                           Padding(
                                        //                             padding:
                                        //                             const EdgeInsets
                                        //                                 .all(8.0),
                                        //                             child: Text(
                                        //                               "Move Folder",
                                        //                               style: TextStyle(
                                        //                                   fontSize: 20,
                                        //                                   color: Theme.of(
                                        //                                       context)
                                        //                                       .primaryColor),
                                        //                             ),
                                        //                           ),
                                        //
                                        //                           MoveFolderActivity(
                                        //                             customerId: widget
                                        //                                 .customerId,
                                        //                             customerFirestore:
                                        //                             widget
                                        //                                 .customerFirestore,
                                        //                             curentFolderID:snapshot.data!.docs[index].id,locale: widget.locale,
                                        //                           ),
                                        //                           //here show move folder target
                                        //                         ],
                                        //                       );
                                        //                     });
                                        //               }
                                        //             },
                                        //             child:
                                        //             Center(child: Icon(Icons.menu)),
                                        //             itemBuilder: (BuildContext
                                        //             context) =>
                                        //             <PopupMenuEntry<folderAction>>[
                                        //               PopupMenuItem<folderAction>(
                                        //                 value: folderAction.rename,
                                        //                 child: Text('Rename'),
                                        //               ),
                                        //               PopupMenuItem<folderAction>(
                                        //                 value: folderAction.delete,
                                        //                 child: Text('Delete'),
                                        //               ),
                                        //               PopupMenuItem<folderAction>(
                                        //                 value: folderAction.move,
                                        //                 child: Text('Move'),
                                        //               ),
                                        //             ],
                                        //           ),
                                        //         ),
                                        //       ),
                                        //     ],
                                        //   ),
                                        // ),
                                        // Container(
                                        //
                                        //  // width: MediaQuery.of(context).size.width,
                                        //   child:showNextLevelFolder(snapshot.data!.docs[index].id),)

                                      ],
                                    ),
                                  ),



                                  // if(widget.isExpanded) showNextLevelFolder(snapshot.data!.docs[index].id),

                                  if(expand)  showTestItemsInFolderForReporting(filteredData[index].id,widget.customerFirestore,widget.customerId,widget.locale),
                                  if(expand) Padding(
                                    padding: indendfolderPadding,
                                    child: ExpandenFolderActivityLevel1Reporting(parentFolder:filteredData[index].id, customerId: widget.customerId,locale: widget.locale, customerFirestore: widget.customerFirestore, expand: false,),
                                  ),

                                ],
                              ),),



                             // Align(alignment: Alignment.centerRight,child: addOrDeletePopMenuBox(filteredData[index].id,filteredData[index].get("name")),),
                             Align(alignment: Alignment.centerRight,child: Padding(
                               padding: EdgeInsets.only(right: width*0.01),
                               child: StreamBuilder<List>(
                                   stream:ReportingsLogics().folderSelectedForReportStream().outData,

                                   builder: (context, snapshotFolders) {
                                     if(snapshotFolders.hasData)
                                     return  InkWell(onTap: (){
                                       FolderClickedForReportingAsStream.getInstance().dataReload(id);
                                     },
                                       child: Text(snapshotFolders.data!.contains(id)? "Remove" : "Select",
                                         style: TextStyle(color:snapshotFolders.data!.contains(id)?ThemeManager().getDarkGreenColor:ThemeManager().getBlackColor, fontWeight: FontWeight.bold),
                                       ),
                                     );else{
                                       return  InkWell(onTap: (){
                                         FolderClickedForReportingAsStream.getInstance().dataReload(id);
                                       },
                                         child: Text( "Select",
                                           style: TextStyle(color: ThemeManager().getBlackColor, fontWeight: FontWeight.bold),
                                         ),
                                       );
                                     }

                                   }),
                             ) ,),
                            ],
                          ),
                          // if(widget.isExpanded)   Padding(padding: EdgeInsets.fromLTRB(40,0,0,0),child:  showTestItemsInFolder(snapshot.data!.docs[index].id),),
                          // if(widget.isExpanded)   Padding(padding: EdgeInsets.fromLTRB(40,0,0,0),child:ExpandedFiles(parentFolder: snapshot.data!.docs[index].id, customerId: widget.customerId,locale: widget.locale, customerFirestore: widget.customerFirestore,),),

                        ],
                      ),
                    );
                  }
                  // return   Padding(
                  //   padding:  EdgeInsets.fromLTRB((step* 20), 2, 0, 2),
                  //   child: Column(
                  //     children: [
                  //       Stack(
                  //         children: [
                  //           Align(alignment: Alignment.centerLeft,child: Padding(
                  //             padding:  EdgeInsets.fromLTRB(0, 0, 0, 0),
                  //             child: Column(
                  //               children: [
                  //                 Row(
                  //                   children: [
                  //                     GestureDetector(
                  //                       onTap: () {
                  //
                  //                         setState(() {
                  //                           expand = !expand;
                  //                         });
                  //
                  //                         // try{
                  //                         //   ExpandFolderStream.getInstance().dataReload({"id":snapshot.data!.docs[index].id,"expand":!expand});
                  //                         // }catch(e){
                  //                         //   print("enpand er");
                  //                         //   print(e);
                  //                         // }
                  //                       },
                  //                       //newFolder.isExpanded == fals
                  //                       child: expand
                  //                           ? Icon(
                  //                         Icons.keyboard_arrow_up_outlined,
                  //                         size: width * 0.085,
                  //                         color: ThemeManager().getDarkGrey2Color,
                  //                       )
                  //                           : Icon(
                  //                         Icons.keyboard_arrow_down_outlined,
                  //                         size: width * 0.085,
                  //                         color: ThemeManager().getDarkGrey2Color,
                  //                       ),
                  //                     ),
                  //                     Container(
                  //                       margin: EdgeInsets.only(
                  //                         left: width * 0.02,
                  //                       ),
                  //                       child: SvgPicture.asset(
                  //                         ("assets/svg/folderIcon.svg"),
                  //                         fit: BoxFit.cover,
                  //                       ),
                  //                     ),
                  //                     Container(
                  //                         margin: EdgeInsets.only(
                  //                           left: width * 0.03,
                  //                         ),
                  //                         child: Text(
                  //                           snapshot.data!.docs[index]["name"],
                  //                           style: interRegular.copyWith(
                  //                             color: ThemeManager().getBlackColor,
                  //                             fontSize: width * 0.045,
                  //                           ),
                  //                         )),
                  //
                  //                     // Container(
                  //                     // //  height: 50,
                  //                     //   width: MediaQuery.of(context).size.width,
                  //                     //   child: Stack(
                  //                     //     children: [
                  //                     //       Align(
                  //                     //         alignment: Alignment.centerLeft,
                  //                     //         child: Row(
                  //                     //           children: [
                  //                     //             GestureDetector(
                  //                     //               onTap: () {
                  //                     //                 // setState(() {
                  //                     //                 //   newFolder.isExpanded = !(newFolder.isExpanded);
                  //                     //                 //   newFolder.isVisible = !newFolder.isVisible;
                  //                     //                 // });
                  //                     //               },
                  //                     //               //newFolder.isExpanded == fals
                  //                     //               child: false
                  //                     //                   ? Icon(
                  //                     //                 Icons.keyboard_arrow_up_outlined,
                  //                     //                 size: width * 0.085,
                  //                     //                 color: ThemeManager().getDarkGrey2Color,
                  //                     //               )
                  //                     //                   : Icon(
                  //                     //                 Icons.keyboard_arrow_down_outlined,
                  //                     //                 size: width * 0.085,
                  //                     //                 color: ThemeManager().getDarkGrey2Color,
                  //                     //               ),
                  //                     //             ),
                  //                     //             Container(
                  //                     //               margin: EdgeInsets.only(
                  //                     //                 left: width * 0.02,
                  //                     //               ),
                  //                     //               child: SvgPicture.asset(
                  //                     //                 ("assets/svg/folderIcon.svg"),
                  //                     //                 fit: BoxFit.cover,
                  //                     //               ),
                  //                     //             ),
                  //                     //             Container(
                  //                     //                 margin: EdgeInsets.only(
                  //                     //                   left: width * 0.03,
                  //                     //                 ),
                  //                     //                 child: Text(
                  //                     //                   snapshot.data!.docs[index]["name"],
                  //                     //                   style: interRegular.copyWith(
                  //                     //                     color: ThemeManager().getBlackColor,
                  //                     //                     fontSize: width * 0.045,
                  //                     //                   ),
                  //                     //                 ))
                  //                     //             // Column(
                  //                     //             //   mainAxisAlignment:
                  //                     //             //   MainAxisAlignment.center,
                  //                     //             //   crossAxisAlignment:
                  //                     //             //   CrossAxisAlignment.start,
                  //                     //             //   children: [
                  //                     //             //
                  //                     //             //     Text(
                  //                     //             //       snapshot.data!.docs[index]["name"]
                  //                     //             //           .toString(),
                  //                     //             //       style: TextStyle(
                  //                     //             //           fontWeight:
                  //                     //             //           FontWeight.bold,
                  //                     //             //           color: Colors.black),
                  //                     //             //     ),
                  //                     //             //     timeFormate(snapshot.data!.docs[index]["created_at"]),
                  //                     //             //   ],
                  //                     //             // ),
                  //                     //           ],
                  //                     //         ),
                  //                     //       ),
                  //                     //       Align(
                  //                     //         alignment: Alignment.centerRight,
                  //                     //         child: Container(
                  //                     //           height: MediaQuery.of(context)
                  //                     //               .size
                  //                     //               .height,
                  //                     //           width: 50,
                  //                     //           child: PopupMenuButton<folderAction>(
                  //                     //             onSelected: (folderAction value) {
                  //                     //               if (value ==
                  //                     //                   folderAction.rename) {
                  //                     //                 //rename folder
                  //                     //                 TextEditingController
                  //                     //                 controller =
                  //                     //                 TextEditingController(
                  //                     //                     text: snapshot.data!.docs[index]
                  //                     //                     ["name"]
                  //                     //                         .toString());
                  //                     //
                  //                     //                 Navigator.of(context)
                  //                     //                     .push(
                  //                     //                     new MaterialPageRoute<
                  //                     //                         Null>(
                  //                     //                         builder:
                  //                     //                             (BuildContext
                  //                     //                         context) {
                  //                     //                           return Scaffold(
                  //                     //                             appBar: AppBar(
                  //                     //                               title: Text(
                  //                     //                                   "Rename Folder"),
                  //                     //                             ),
                  //                     //                             body: Container(
                  //                     //                               decoration:
                  //                     //                               BoxDecoration(
                  //                     //                                 color: Color
                  //                     //                                     .fromARGB(
                  //                     //                                     255,
                  //                     //                                     247,
                  //                     //                                     247,
                  //                     //                                     247),
                  //                     //                                 borderRadius: BorderRadius.only(
                  //                     //                                     topLeft:
                  //                     //                                     Radius.circular(
                  //                     //                                         10.0),
                  //                     //                                     topRight:
                  //                     //                                     Radius.circular(10.0)),
                  //                     //                               ),
                  //                     //                               child:
                  //                     //                               Padding(
                  //                     //                                 padding: const EdgeInsets
                  //                     //                                     .all(
                  //                     //                                     15.0),
                  //                     //                                 child: Wrap(
                  //                     //                                   children: [
                  //                     //                                     Padding(
                  //                     //                                       padding:
                  //                     //                                       const EdgeInsets.all(8.0),
                  //                     //                                       child:
                  //                     //                                       TextFormField(
                  //                     //                                         controller:
                  //                     //                                         controller,
                  //                     //                                         autofocus:
                  //                     //                                         true,
                  //                     //                                         decoration:
                  //                     //                                         InputDecoration(
                  //                     //                                           labelText: 'Folder Name',
                  //                     //                                           border: OutlineInputBorder(),
                  //                     //                                         ),
                  //                     //                                       ),
                  //                     //                                     ),
                  //                     //                                     InkWell(
                  //                     //                                       onTap:
                  //                     //                                           () {
                  //                     //                                         widget.customerFirestore.collection("folders").doc(snapshot.data!.docs[index].id).update({
                  //                     //                                           "name": controller.text
                  //                     //                                         }).then((value) {
                  //                     //                                           Navigator.pop(context);
                  //                     //                                         });
                  //                     //                                       },
                  //                     //                                       child:
                  //                     //                                       Card(
                  //                     //                                         color:
                  //                     //                                         Theme.of(context).primaryColor,
                  //                     //                                         child: Center(
                  //                     //                                             child: Padding(
                  //                     //                                               padding: const EdgeInsets.all(10.0),
                  //                     //                                               child: Text(
                  //                     //                                                 "Submit",
                  //                     //                                                 style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold),
                  //                     //                                               ),
                  //                     //                                             )),
                  //                     //                                       ),
                  //                     //                                     )
                  //                     //                                   ],
                  //                     //                                 ),
                  //                     //                               ),
                  //                     //                             ),
                  //                     //                           );
                  //                     //                         },
                  //                     //                         fullscreenDialog:
                  //                     //                         true));
                  //                     //               }
                  //                     //               if (value ==
                  //                     //                   folderAction.delete) {
                  //                     //                 //rename folder
                  //                     //                 showModalBottomSheet(
                  //                     //                     context: context,
                  //                     //                     builder: (builder) {
                  //                     //                       return new Wrap(
                  //                     //                         children: [
                  //                     //                           Padding(
                  //                     //                             padding:
                  //                     //                             const EdgeInsets
                  //                     //                                 .all(8.0),
                  //                     //                             child: Text(
                  //                     //                               "Do you want to delete this Folder?",
                  //                     //                               style: TextStyle(
                  //                     //                                   fontSize: 20,
                  //                     //                                   color: Theme.of(
                  //                     //                                       context)
                  //                     //                                       .primaryColor),
                  //                     //                             ),
                  //                     //                           ),
                  //                     //                           Row(
                  //                     //                             children: [
                  //                     //                               Expanded(
                  //                     //                                   child:
                  //                     //                                   InkWell(
                  //                     //                                     onTap: () {
                  //                     //                                       Navigator.of(
                  //                     //                                           context)
                  //                     //                                           .pop();
                  //                     //                                     },
                  //                     //                                     child: Padding(
                  //                     //                                       padding:
                  //                     //                                       const EdgeInsets
                  //                     //                                           .all(
                  //                     //                                           8.0),
                  //                     //                                       child: Card(
                  //                     //                                         elevation:
                  //                     //                                         8,
                  //                     //                                         color: Colors
                  //                     //                                             .grey,
                  //                     //                                         child: Center(
                  //                     //                                             child: Padding(
                  //                     //                                               padding: const EdgeInsets
                  //                     //                                                   .all(
                  //                     //                                                   15.0),
                  //                     //                                               child:
                  //                     //                                               Text(
                  //                     //                                                 "Cancel",
                  //                     //                                                 style: TextStyle(
                  //                     //                                                     color:
                  //                     //                                                     Colors.white,
                  //                     //                                                     fontWeight: FontWeight.bold),
                  //                     //                                               ),
                  //                     //                                             )),
                  //                     //                                       ),
                  //                     //                                     ),
                  //                     //                                   )),
                  //                     //                               Expanded(
                  //                     //                                   child:
                  //                     //                                   InkWell(
                  //                     //                                     onTap: () {
                  //                     //                                       widget
                  //                     //                                           .customerFirestore
                  //                     //                                           .collection(
                  //                     //                                           "folders")
                  //                     //                                           .doc(snapshot.data!.docs[index].id)
                  //                     //                                           .delete()
                  //                     //                                           .then(
                  //                     //                                               (value) {
                  //                     //                                             Navigator.pop(
                  //                     //                                                 context);
                  //                     //                                           });
                  //                     //                                     },
                  //                     //                                     child: Padding(
                  //                     //                                       padding:
                  //                     //                                       const EdgeInsets
                  //                     //                                           .all(
                  //                     //                                           8.0),
                  //                     //                                       child: Card(
                  //                     //                                         elevation:
                  //                     //                                         8,
                  //                     //                                         color: Theme.of(
                  //                     //                                             context)
                  //                     //                                             .primaryColor,
                  //                     //                                         child: Center(
                  //                     //                                             child: Padding(
                  //                     //                                               padding: const EdgeInsets
                  //                     //                                                   .all(
                  //                     //                                                   15.0),
                  //                     //                                               child:
                  //                     //                                               Text(
                  //                     //                                                 "Delete",
                  //                     //                                                 style: TextStyle(
                  //                     //                                                     color:
                  //                     //                                                     Colors.white,
                  //                     //                                                     fontWeight: FontWeight.bold),
                  //                     //                                               ),
                  //                     //                                             )),
                  //                     //                                       ),
                  //                     //                                     ),
                  //                     //                                   )),
                  //                     //                             ],
                  //                     //                           ),
                  //                     //                         ],
                  //                     //                       );
                  //                     //                     });
                  //                     //               }
                  //                     //
                  //                     //               if (value == folderAction.move) {
                  //                     //                 //rename folder
                  //                     //                 showModalBottomSheet(
                  //                     //                     context: context,
                  //                     //                     builder: (builder) {
                  //                     //                       return new Wrap(
                  //                     //                         children: [
                  //                     //                           ListTile(
                  //                     //                             title: Text(
                  //                     //                               "Move Folder",
                  //                     //                               style: TextStyle(
                  //                     //                                   fontSize: 20,
                  //                     //                                   color: Theme.of(
                  //                     //                                       context)
                  //                     //                                       .primaryColor),
                  //                     //                             ),
                  //                     //                             trailing: Padding(
                  //                     //                               padding:
                  //                     //                               const EdgeInsets
                  //                     //                                   .all(8.0),
                  //                     //                               child: InkWell(
                  //                     //                                 onTap: () {
                  //                     //                                   Navigator.of(
                  //                     //                                       context)
                  //                     //                                       .pop();
                  //                     //                                 },
                  //                     //                                 child: Icon(
                  //                     //                                     Icons
                  //                     //                                         .close),
                  //                     //                               ),
                  //                     //                             ),
                  //                     //                           ),
                  //                     //                           Padding(
                  //                     //                             padding:
                  //                     //                             const EdgeInsets
                  //                     //                                 .all(8.0),
                  //                     //                             child: Text(
                  //                     //                               "Move Folder",
                  //                     //                               style: TextStyle(
                  //                     //                                   fontSize: 20,
                  //                     //                                   color: Theme.of(
                  //                     //                                       context)
                  //                     //                                       .primaryColor),
                  //                     //                             ),
                  //                     //                           ),
                  //                     //
                  //                     //                           MoveFolderActivity(
                  //                     //                             customerId: widget
                  //                     //                                 .customerId,
                  //                     //                             customerFirestore:
                  //                     //                             widget
                  //                     //                                 .customerFirestore,
                  //                     //                             curentFolderID:snapshot.data!.docs[index].id,locale: widget.locale,
                  //                     //                           ),
                  //                     //                           //here show move folder target
                  //                     //                         ],
                  //                     //                       );
                  //                     //                     });
                  //                     //               }
                  //                     //             },
                  //                     //             child:
                  //                     //             Center(child: Icon(Icons.menu)),
                  //                     //             itemBuilder: (BuildContext
                  //                     //             context) =>
                  //                     //             <PopupMenuEntry<folderAction>>[
                  //                     //               PopupMenuItem<folderAction>(
                  //                     //                 value: folderAction.rename,
                  //                     //                 child: Text('Rename'),
                  //                     //               ),
                  //                     //               PopupMenuItem<folderAction>(
                  //                     //                 value: folderAction.delete,
                  //                     //                 child: Text('Delete'),
                  //                     //               ),
                  //                     //               PopupMenuItem<folderAction>(
                  //                     //                 value: folderAction.move,
                  //                     //                 child: Text('Move'),
                  //                     //               ),
                  //                     //             ],
                  //                     //           ),
                  //                     //         ),
                  //                     //       ),
                  //                     //     ],
                  //                     //   ),
                  //                     // ),
                  //                     // Container(
                  //                     //
                  //                     //  // width: MediaQuery.of(context).size.width,
                  //                     //   child:showNextLevelFolder(snapshot.data!.docs[index].id),)
                  //
                  //                   ],
                  //                 ),
                  //
                  //                 // if(widget.isExpanded) showNextLevelFolder(snapshot.data!.docs[index].id),
                  //                 if(true) ExpandenFolderActivityLevel1(expand: expand,parentFolder: snapshot.data!.docs[index].id, customerId: widget.customerId,locale: widget.locale, customerFirestore: widget.customerFirestore,),
                  //                 //showTestItemsInFolder(snapshot.data!.docs[index].id),
                  //
                  //               ],
                  //             ),
                  //           ),),
                  //           // Align(alignment: Alignment.centerRight,child: addOrDeletePopMenuBox(snapshot.data!.docs[index].id),),
                  //         ],
                  //       ),
                  //       // if(widget.isExpanded)   Padding(padding: EdgeInsets.fromLTRB(40,0,0,0),child:  showTestItemsInFolder(snapshot.data!.docs[index].id),),
                  //       // if(widget.isExpanded)   Padding(padding: EdgeInsets.fromLTRB(40,0,0,0),child:ExpandedFiles(parentFolder: snapshot.data!.docs[index].id, customerId: widget.customerId,locale: widget.locale, customerFirestore: widget.customerFirestore,),),
                  //
                  //     ],
                  //   ),
                  // );
                  return  StreamBuilder<dynamic>(
                      stream: ExpandFolderStream.getInstance().outData,
                      builder: (c, snapshotEx) {
                        if(snapshotEx.hasData && snapshotEx.data["id"] == filteredData[index].id )
                          return show(snapshotEx.data["expand"],filteredData[index].id);
                        else{
                          return show(false,filteredData[index].id);
                        }

                      });





                });


            return Text( snapshot.data!.docs.length.toString());
          }else return ConstantWidget().notFolders();
        });
  }
  @override
  Widget build(BuildContext context) {
    return Column(children: [
      showNextLevelFolder(widget.parentFolder),
      // ExpandedFolders(parentFolder: widget.parentFolder, customerId: widget.customerId,locale: widget.locale, customerFirestore: widget.customerFirestore,),
      // ExpandedFiles(parentFolder: widget.parentFolder, customerId: widget.customerId,locale: widget.locale, customerFirestore: widget.customerFirestore,),

    ],);
  }

  addOrDeletePopMenuBox(String id,String title) {
    addNewFolderNamePopUp(String id) {
      final _formKey = GlobalKey<FormState>();
      showDialog(
          context: context,
          builder: (
              context,
              ) {
            return StatefulBuilder(builder: (context, setState) {
              return AlertDialog(
                scrollable: true,
                shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.all(Radius.circular(10))),
                contentPadding: EdgeInsets.only(top: 10.0),
                content: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Container(
                      margin: EdgeInsets.only(
                          top: height * 0.01,
                          left: width * 0.04,
                          right: width * 0.04),
                      child: Row(
                        mainAxisAlignment: MainAxisAlignment.spaceBetween,
                        children: [
                          Text("Add new Subfolder",
                            style: interSemiBold.copyWith(
                              color: ThemeManager().getBlackColor,
                              fontSize: width * 0.04,
                            ),
                          ),
                          InkWell(
                              onTap: () {
                                Navigator.of(context).pop();
                              },
                              child: Icon(
                                Icons.clear,
                                size: width * 0.06,
                                color: ThemeManager().getLightGrey4Color,
                              )),
                        ],
                      ),
                    ),
                    Container(
                      margin: EdgeInsets.only(top: height * 0.015),
                      height: height * 0.001,
                      color: ThemeManager().getBlackColor.withOpacity(0.19),
                    ),
                    Container(
                      margin: EdgeInsets.only(
                          top: height * 0.02,
                          left: width * 0.04,
                          right: width * 0.04),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text("Subfolder Name",
                            style: interMedium.copyWith(
                              color: ThemeManager().getPopUpTextGreyColor,
                              fontSize: width * 0.036,
                            ),
                          ),
                          Container(
                            margin: EdgeInsets.only(top: height * 0.015),
                            child: Form(
                              key: _formKey,
                              child: TextFormField(
                                controller: _folderNameController,
                                maxLength: 22,
                                autovalidateMode: AutovalidateMode.onUserInteraction,
                                keyboardType: TextInputType.text,
                                decoration: InputDecoration(
                                  counterText: "",
                                  border: InputBorder.none,
                                  hintText: TextConst.textFieldFolderText,
                                  hintStyle: interMedium.copyWith(
                                    color: ThemeManager().getLightGrey4Color,
                                    fontSize: width * 0.036,
                                  ),
                                  enabledBorder: OutlineInputBorder(
                                      borderSide: BorderSide(
                                        color: Colors.transparent,
                                      ),
                                      borderRadius:
                                      BorderRadius.circular(width * 0.014)),
                                  contentPadding: EdgeInsets.symmetric(
                                      vertical: height * 0.0,
                                      horizontal: width * 0.045),
                                  fillColor:
                                  ThemeManager().getLightGreenTextFieldColor,
                                  filled: true,
                                ),
                                validator: (value) {
                                  if (value!.isEmpty) {
                                    return "Please enter folder name";
                                  } else if (_folderNameController.text.length > 22) {
                                    return "Name should be 22 character only";
                                  }
                                },
                              ),
                            ),
                          ),
                          // Container(
                          //   margin: EdgeInsets.only(top: height * 0.015),
                          //   child: Text(
                          //     "*Name must be within 10 characters.",
                          //     style: interMedium.copyWith(
                          //       color: ThemeManager().getPopUpTextGreyColor,
                          //       fontSize: width * 0.03,
                          //     ),
                          //   ),
                          // ),
                          InkWell(
                            onTap: () async {
                              if (_formKey.currentState!.validate()) {


                                var r = await  AppFirestore(firestore: widget.customerFirestore, projectId: '', auth: FirebaseAuth.instance).createFolders(name:_folderNameController.text,parent: id );

                                if(r == true) {
                                  _folderNameController.clear();
                                  Navigator.of(context).pop();
                                }else{
                                  _folderNameController.clear();
                                  Navigator.of(context).pop();
                                  showDialog(context: context,
                                      builder: (BuildContext context){
                                        return FolderExistsPopUp();
                                      });
                                }



                              } else {}
                            },
                            child: Container(
                                margin: EdgeInsets.only(
                                    top: height * 0.04, bottom: height * 0.02),
                                child: ButtonView(
                                    buttonLabel: TextConst.saveButtonText)
                            ),
                          ),
                        ],
                      ),
                    ),
                  ],
                ),
              );
            });
          });
    }
    renameFolderNamePopUp(String id,String oldName) {
      _folderNameController = TextEditingController(text: title);
      final _formKey = GlobalKey<FormState>();
      showDialog(
          context: context,
          builder: (
              context,
              ) {
            return StatefulBuilder(builder: (context, setState) {
              return AlertDialog(
                scrollable: true,
                shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.all(Radius.circular(10))),
                contentPadding: EdgeInsets.only(top: 10.0),
                content: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Container(
                      margin: EdgeInsets.only(
                          top: height * 0.01,
                          left: width * 0.04,
                          right: width * 0.04),
                      child: Row(
                        mainAxisAlignment: MainAxisAlignment.spaceBetween,
                        children: [
                          Text("Rename",
                            style: interSemiBold.copyWith(
                              color: ThemeManager().getBlackColor,
                              fontSize: width * 0.04,
                            ),
                          ),
                          InkWell(
                              onTap: () {
                                Navigator.of(context).pop();
                              },
                              child: Icon(
                                Icons.clear,
                                size: width * 0.06,
                                color: ThemeManager().getLightGrey4Color,
                              )),
                        ],
                      ),
                    ),
                    Container(
                      margin: EdgeInsets.only(top: height * 0.015),
                      height: height * 0.001,
                      color: ThemeManager().getBlackColor.withOpacity(0.19),
                    ),
                    Container(
                      margin: EdgeInsets.only(
                          top: height * 0.02,
                          left: width * 0.04,
                          right: width * 0.04),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text("Subfolder Name",
                            style: interMedium.copyWith(
                              color: ThemeManager().getPopUpTextGreyColor,
                              fontSize: width * 0.036,
                            ),
                          ),
                          Container(
                            margin: EdgeInsets.only(top: height * 0.015),
                            child: Form(
                              key: _formKey,
                              child: TextFormField(

                                controller: _folderNameController,
                                maxLength: 22,
                                autovalidateMode: AutovalidateMode.onUserInteraction,
                                keyboardType: TextInputType.text,
                                decoration: InputDecoration(
                                  counterText: "",
                                  border: InputBorder.none,
                                  hintText: TextConst.textFieldFolderText,
                                  hintStyle: interMedium.copyWith(
                                    color: ThemeManager().getLightGrey4Color,
                                    fontSize: width * 0.036,
                                  ),
                                  enabledBorder: OutlineInputBorder(
                                      borderSide: BorderSide(
                                        color: Colors.transparent,
                                      ),
                                      borderRadius:
                                      BorderRadius.circular(width * 0.014)),
                                  contentPadding: EdgeInsets.symmetric(
                                      vertical: height * 0.0,
                                      horizontal: width * 0.045),
                                  fillColor:
                                  ThemeManager().getLightGreenTextFieldColor,
                                  filled: true,
                                ),
                                validator: (value) {
                                  if (value!.isEmpty) {
                                    return "Please enter folder name";
                                  } else if (_folderNameController.text.length > 22) {
                                    return "Name should be 22 character only";
                                  }
                                },
                              ),
                            ),
                          ),
                          // Container(
                          //   margin: EdgeInsets.only(top: height * 0.015),
                          //   child: Text(
                          //     "*Name must be within 10 characters.",
                          //     style: interMedium.copyWith(
                          //       color: ThemeManager().getPopUpTextGreyColor,
                          //       fontSize: width * 0.03,
                          //     ),
                          //   ),
                          // ),
                          InkWell(
                            onTap: () async {
                              if (_formKey.currentState!.validate()) {
                                AppFirestore(firestore: widget.customerFirestore, projectId: '', auth: FirebaseAuth.instance).renameFolders(name:_folderNameController.text,parent: id );
                                //  Navigator.pop(context);
                                _folderNameController.clear();
                                Navigator.of(context).pop();
// Close progress dialog
//                                 final dialogContextCompleter = Completer<BuildContext>();
//                                 final dialogContext = await dialogContextCompleter.future;
//                                 Navigator.pop(dialogContext);
//                                 Navigator.of(context).pop();
                              } else {}
                            },
                            child: Container(
                                margin: EdgeInsets.only(
                                    top: height * 0.04, bottom: height * 0.02),
                                child: ButtonView(
                                    buttonLabel: TextConst.saveButtonText)
                            ),
                          ),
                        ],
                      ),
                    ),
                  ],
                ),
              );
            });
          });
    }
    return PopupMenuButton(
      elevation: 1,
      icon: Icon(Icons.more_horiz),

      itemBuilder: (context) => [
        PopupMenuItem(
          // padding: EdgeInsets.only(top: height * 0.01, left: width * 0.0065, right: width * 0.0065),

          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [

              InkWell(
                onTap: () {
                  Navigator.of(context).pop();
                  addNewFolderNamePopUp(id);
                },
                child: Container(
                  margin: EdgeInsets.only(
                      left: width * 0.005, right: width * 0.005),
                  alignment: Alignment.center,
                  child: Text(
                    TextConst.addNewFolderPopUpText,
                    style: interRegular.copyWith(
                        color: ThemeManager().getBlackColor,
                        fontSize: width * 0.035),
                  ),
                ),
              ),
              Container(
                margin: EdgeInsets.only(
                    top: height * 0.01, bottom: height * 0.01),
                height: height * 0.001,
                width: double.infinity,
                color: ThemeManager().getBlackColor.withOpacity(0.19),
              ),
              InkWell(
                onTap: () {
                  Navigator.of(context).pop();
                  renameFolderNamePopUp(id,title);
                },
                child: Container(
                  margin: EdgeInsets.only(
                      left: width * 0.005, right: width * 0.005),
                  alignment: Alignment.center,
                  child: Text("Rename",
                    style: interRegular.copyWith(
                        color: ThemeManager().getBlackColor,
                        fontSize: width * 0.035),
                  ),
                ),
              ),
              Container(
                margin: EdgeInsets.only(
                    top: height * 0.01, bottom: height * 0.01),
                height: height * 0.001,
                width: double.infinity,
                color: ThemeManager().getBlackColor.withOpacity(0.19),
              ),
              InkWell(
                onTap: () {
                  //delete

                  showDialog(context: context,
                      builder: (BuildContext context){
                        return DeleteFolderPopUp(title:title, onClickAction: (answer ) {
                          print("delete actin found");
                          print(answer);
                          if(answer == true){

                            widget.customerFirestore.collection("folders").doc(id).delete();
                            Navigator.of(context).pop();

                          }else{
                            Navigator.of(context).pop();
                          }
                        },);
                      }
                  );



                },
                child: Container(
                    alignment: Alignment.center,
                    child: Text(
                      TextConst.deleteFolderPopUpText,
                      style: interRegular.copyWith(
                          color: ThemeManager().getBlackColor,
                          fontSize: width * 0.035),
                    )),
              )
            ],
          ),
          // value: 1,
        ),
      ],
    );
  }
}



class ExpandenFolderActivityLevel1 extends StatefulWidget {
  String parentFolder;
  String customerId;

  FirebaseFirestore customerFirestore;
  Locale locale;
  bool expand;
  ExpandenFolderActivityLevel1({required this.expand,required this.parentFolder,required this.customerFirestore,required this.customerId,required this.locale});

  @override
  _ExpandenFolderActivityLevel1State createState() => _ExpandenFolderActivityLevel1State();
}

class _ExpandenFolderActivityLevel1State extends State<ExpandenFolderActivityLevel1> {

  showNextLevelFolder(String data) {
    int step = 0;

    try{
      return StreamBuilder<QuerySnapshot>(
          stream: AppFirestore(firestore: widget.customerFirestore,projectId: "",auth: FirebaseAuth.instance).getFolders(parentFolder: data),
          builder: (context, snapshot) {
            if (snapshot.hasData && snapshot.data!.docs.length>0) {
              step++;

              List<QueryDocumentSnapshot> filteredData = [];
              filteredData = snapshot.data!.docs;
              filteredData.sort((a, b) {
                return a
                    .get("name")
                    .toString()
                    .toLowerCase()
                    .compareTo(b.get("name").toString().toLowerCase());
              });

              return   ListView.builder(
                  physics: NeverScrollableScrollPhysics(),
                 // separatorBuilder: (context, index) {return Divider();},
                  shrinkWrap: true,
                  padding: EdgeInsets.zero,
                  itemCount: filteredData.length,
                  itemBuilder: (_, index) {

                    show(bool expand,String id){
                      return   Stack(
                        children: [
                          Align(alignment: Alignment.centerLeft,child: InkWell(onTap: (){
                            try{

                              ExpandFolderStreamL1.getInstance().dataReload({"id":filteredData[index].id,"expand":!expand});
                            }catch(e){
                              print("enpand er");
                              print(e);
                            }
                          },
                            child: Column(
                              children: [
                                Container(
                                  //color: expand?ThemeManager().getLightYellowColor:Colors.white,
                                  child: Row(
                                    children: [
                                      Padding(padding: indendfolderPadding),
                                      GestureDetector(
                                        onTap: () {
                                          try{

                                            ExpandFolderStreamL1.getInstance().dataReload({"id":filteredData[index].id,"expand":!expand});
                                          }catch(e){
                                            print("enpand er");
                                            print(e);
                                          }
                                        },
                                        //newFolder.isExpanded == fals
                                        child: expand
                                            ? Icon(
                                          Icons.keyboard_arrow_up_outlined,
                                          size: width * 0.085,
                                          color: AppThemeManager(). getTextColor1(),
                                        )
                                            : Icon(
                                          Icons.keyboard_arrow_down_outlined,
                                          size: width * 0.085,
                                          color: AppThemeManager(). getTextColor1(),
                                        ),
                                      ),
                                      GestureDetector(
                                        onTap: () {
                                          try{

                                            ExpandFolderStreamL1.getInstance().dataReload({"id":filteredData[index].id,"expand":!expand});
                                          }catch(e){
                                            print("enpand er");
                                            print(e);
                                          }
                                        },
                                        child: Container(
                                          margin: EdgeInsets.only(
                                            left: width * 0.02,
                                          ),
                                          child: SvgPicture.asset(
                                            (expand?"assets/svg/folder_open.svg": "assets/svg/folder_close.svg"),
                                            fit: BoxFit.cover,width:width * 0.075,
                                          ),
                                        ),
                                      ),
                                      GestureDetector(  onTap: () {
                                        try{

                                          ExpandFolderStreamL1.getInstance().dataReload({"id":filteredData[index].id,"expand":!expand});
                                        }catch(e){
                                          print("enpand er");
                                          print(e);
                                        }
                                      },
                                        child: Container(
                                            margin: EdgeInsets.only(
                                              left: width * 0.03,
                                            ),
                                            child: Text(filteredData[index]["name"],
                                              style: interRegular.copyWith(
                                                color: AppThemeManager(). getTextColor2(),
                                                fontSize: width * 0.045,
                                              ),
                                            )),
                                      ),

                                      // Container(
                                      // //  height: 50,
                                      //   width: MediaQuery.of(context).size.width,
                                      //   child: Stack(
                                      //     children: [
                                      //       Align(
                                      //         alignment: Alignment.centerLeft,
                                      //         child: Row(
                                      //           children: [
                                      //             GestureDetector(
                                      //               onTap: () {
                                      //                 // setState(() {
                                      //                 //   newFolder.isExpanded = !(newFolder.isExpanded);
                                      //                 //   newFolder.isVisible = !newFolder.isVisible;
                                      //                 // });
                                      //               },
                                      //               //newFolder.isExpanded == fals
                                      //               child: false
                                      //                   ? Icon(
                                      //                 Icons.keyboard_arrow_up_outlined,
                                      //                 size: width * 0.085,
                                      //                 color: ThemeManager().getDarkGrey2Color,
                                      //               )
                                      //                   : Icon(
                                      //                 Icons.keyboard_arrow_down_outlined,
                                      //                 size: width * 0.085,
                                      //                 color: ThemeManager().getDarkGrey2Color,
                                      //               ),
                                      //             ),
                                      //             Container(
                                      //               margin: EdgeInsets.only(
                                      //                 left: width * 0.02,
                                      //               ),
                                      //               child: SvgPicture.asset(
                                      //                 ("assets/svg/folderIcon.svg"),
                                      //                 fit: BoxFit.cover,
                                      //               ),
                                      //             ),
                                      //             Container(
                                      //                 margin: EdgeInsets.only(
                                      //                   left: width * 0.03,
                                      //                 ),
                                      //                 child: Text(
                                      //                   snapshot.data!.docs[index]["name"],
                                      //                   style: interRegular.copyWith(
                                      //                     color: ThemeManager().getBlackColor,
                                      //                     fontSize: width * 0.045,
                                      //                   ),
                                      //                 ))
                                      //             // Column(
                                      //             //   mainAxisAlignment:
                                      //             //   MainAxisAlignment.center,
                                      //             //   crossAxisAlignment:
                                      //             //   CrossAxisAlignment.start,
                                      //             //   children: [
                                      //             //
                                      //             //     Text(
                                      //             //       snapshot.data!.docs[index]["name"]
                                      //             //           .toString(),
                                      //             //       style: TextStyle(
                                      //             //           fontWeight:
                                      //             //           FontWeight.bold,
                                      //             //           color: Colors.black),
                                      //             //     ),
                                      //             //     timeFormate(snapshot.data!.docs[index]["created_at"]),
                                      //             //   ],
                                      //             // ),
                                      //           ],
                                      //         ),
                                      //       ),
                                      //       Align(
                                      //         alignment: Alignment.centerRight,
                                      //         child: Container(
                                      //           height: MediaQuery.of(context)
                                      //               .size
                                      //               .height,
                                      //           width: 50,
                                      //           child: PopupMenuButton<folderAction>(
                                      //             onSelected: (folderAction value) {
                                      //               if (value ==
                                      //                   folderAction.rename) {
                                      //                 //rename folder
                                      //                 TextEditingController
                                      //                 controller =
                                      //                 TextEditingController(
                                      //                     text: snapshot.data!.docs[index]
                                      //                     ["name"]
                                      //                         .toString());
                                      //
                                      //                 Navigator.of(context)
                                      //                     .push(
                                      //                     new MaterialPageRoute<
                                      //                         Null>(
                                      //                         builder:
                                      //                             (BuildContext
                                      //                         context) {
                                      //                           return Scaffold(
                                      //                             appBar: AppBar(
                                      //                               title: Text(
                                      //                                   "Rename Folder"),
                                      //                             ),
                                      //                             body: Container(
                                      //                               decoration:
                                      //                               BoxDecoration(
                                      //                                 color: Color
                                      //                                     .fromARGB(
                                      //                                     255,
                                      //                                     247,
                                      //                                     247,
                                      //                                     247),
                                      //                                 borderRadius: BorderRadius.only(
                                      //                                     topLeft:
                                      //                                     Radius.circular(
                                      //                                         10.0),
                                      //                                     topRight:
                                      //                                     Radius.circular(10.0)),
                                      //                               ),
                                      //                               child:
                                      //                               Padding(
                                      //                                 padding: const EdgeInsets
                                      //                                     .all(
                                      //                                     15.0),
                                      //                                 child: Wrap(
                                      //                                   children: [
                                      //                                     Padding(
                                      //                                       padding:
                                      //                                       const EdgeInsets.all(8.0),
                                      //                                       child:
                                      //                                       TextFormField(
                                      //                                         controller:
                                      //                                         controller,
                                      //                                         autofocus:
                                      //                                         true,
                                      //                                         decoration:
                                      //                                         InputDecoration(
                                      //                                           labelText: 'Folder Name',
                                      //                                           border: OutlineInputBorder(),
                                      //                                         ),
                                      //                                       ),
                                      //                                     ),
                                      //                                     InkWell(
                                      //                                       onTap:
                                      //                                           () {
                                      //                                         widget.customerFirestore.collection("folders").doc(snapshot.data!.docs[index].id).update({
                                      //                                           "name": controller.text
                                      //                                         }).then((value) {
                                      //                                           Navigator.pop(context);
                                      //                                         });
                                      //                                       },
                                      //                                       child:
                                      //                                       Card(
                                      //                                         color:
                                      //                                         Theme.of(context).primaryColor,
                                      //                                         child: Center(
                                      //                                             child: Padding(
                                      //                                               padding: const EdgeInsets.all(10.0),
                                      //                                               child: Text(
                                      //                                                 "Submit",
                                      //                                                 style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold),
                                      //                                               ),
                                      //                                             )),
                                      //                                       ),
                                      //                                     )
                                      //                                   ],
                                      //                                 ),
                                      //                               ),
                                      //                             ),
                                      //                           );
                                      //                         },
                                      //                         fullscreenDialog:
                                      //                         true));
                                      //               }
                                      //               if (value ==
                                      //                   folderAction.delete) {
                                      //                 //rename folder
                                      //                 showModalBottomSheet(
                                      //                     context: context,
                                      //                     builder: (builder) {
                                      //                       return new Wrap(
                                      //                         children: [
                                      //                           Padding(
                                      //                             padding:
                                      //                             const EdgeInsets
                                      //                                 .all(8.0),
                                      //                             child: Text(
                                      //                               "Do you want to delete this Folder?",
                                      //                               style: TextStyle(
                                      //                                   fontSize: 20,
                                      //                                   color: Theme.of(
                                      //                                       context)
                                      //                                       .primaryColor),
                                      //                             ),
                                      //                           ),
                                      //                           Row(
                                      //                             children: [
                                      //                               Expanded(
                                      //                                   child:
                                      //                                   InkWell(
                                      //                                     onTap: () {
                                      //                                       Navigator.of(
                                      //                                           context)
                                      //                                           .pop();
                                      //                                     },
                                      //                                     child: Padding(
                                      //                                       padding:
                                      //                                       const EdgeInsets
                                      //                                           .all(
                                      //                                           8.0),
                                      //                                       child: Card(
                                      //                                         elevation:
                                      //                                         8,
                                      //                                         color: Colors
                                      //                                             .grey,
                                      //                                         child: Center(
                                      //                                             child: Padding(
                                      //                                               padding: const EdgeInsets
                                      //                                                   .all(
                                      //                                                   15.0),
                                      //                                               child:
                                      //                                               Text(
                                      //                                                 "Cancel",
                                      //                                                 style: TextStyle(
                                      //                                                     color:
                                      //                                                     Colors.white,
                                      //                                                     fontWeight: FontWeight.bold),
                                      //                                               ),
                                      //                                             )),
                                      //                                       ),
                                      //                                     ),
                                      //                                   )),
                                      //                               Expanded(
                                      //                                   child:
                                      //                                   InkWell(
                                      //                                     onTap: () {
                                      //                                       widget
                                      //                                           .customerFirestore
                                      //                                           .collection(
                                      //                                           "folders")
                                      //                                           .doc(snapshot.data!.docs[index].id)
                                      //                                           .delete()
                                      //                                           .then(
                                      //                                               (value) {
                                      //                                             Navigator.pop(
                                      //                                                 context);
                                      //                                           });
                                      //                                     },
                                      //                                     child: Padding(
                                      //                                       padding:
                                      //                                       const EdgeInsets
                                      //                                           .all(
                                      //                                           8.0),
                                      //                                       child: Card(
                                      //                                         elevation:
                                      //                                         8,
                                      //                                         color: Theme.of(
                                      //                                             context)
                                      //                                             .primaryColor,
                                      //                                         child: Center(
                                      //                                             child: Padding(
                                      //                                               padding: const EdgeInsets
                                      //                                                   .all(
                                      //                                                   15.0),
                                      //                                               child:
                                      //                                               Text(
                                      //                                                 "Delete",
                                      //                                                 style: TextStyle(
                                      //                                                     color:
                                      //                                                     Colors.white,
                                      //                                                     fontWeight: FontWeight.bold),
                                      //                                               ),
                                      //                                             )),
                                      //                                       ),
                                      //                                     ),
                                      //                                   )),
                                      //                             ],
                                      //                           ),
                                      //                         ],
                                      //                       );
                                      //                     });
                                      //               }
                                      //
                                      //               if (value == folderAction.move) {
                                      //                 //rename folder
                                      //                 showModalBottomSheet(
                                      //                     context: context,
                                      //                     builder: (builder) {
                                      //                       return new Wrap(
                                      //                         children: [
                                      //                           ListTile(
                                      //                             title: Text(
                                      //                               "Move Folder",
                                      //                               style: TextStyle(
                                      //                                   fontSize: 20,
                                      //                                   color: Theme.of(
                                      //                                       context)
                                      //                                       .primaryColor),
                                      //                             ),
                                      //                             trailing: Padding(
                                      //                               padding:
                                      //                               const EdgeInsets
                                      //                                   .all(8.0),
                                      //                               child: InkWell(
                                      //                                 onTap: () {
                                      //                                   Navigator.of(
                                      //                                       context)
                                      //                                       .pop();
                                      //                                 },
                                      //                                 child: Icon(
                                      //                                     Icons
                                      //                                         .close),
                                      //                               ),
                                      //                             ),
                                      //                           ),
                                      //                           Padding(
                                      //                             padding:
                                      //                             const EdgeInsets
                                      //                                 .all(8.0),
                                      //                             child: Text(
                                      //                               "Move Folder",
                                      //                               style: TextStyle(
                                      //                                   fontSize: 20,
                                      //                                   color: Theme.of(
                                      //                                       context)
                                      //                                       .primaryColor),
                                      //                             ),
                                      //                           ),
                                      //
                                      //                           MoveFolderActivity(
                                      //                             customerId: widget
                                      //                                 .customerId,
                                      //                             customerFirestore:
                                      //                             widget
                                      //                                 .customerFirestore,
                                      //                             curentFolderID:snapshot.data!.docs[index].id,locale: widget.locale,
                                      //                           ),
                                      //                           //here show move folder target
                                      //                         ],
                                      //                       );
                                      //                     });
                                      //               }
                                      //             },
                                      //             child:
                                      //             Center(child: Icon(Icons.menu)),
                                      //             itemBuilder: (BuildContext
                                      //             context) =>
                                      //             <PopupMenuEntry<folderAction>>[
                                      //               PopupMenuItem<folderAction>(
                                      //                 value: folderAction.rename,
                                      //                 child: Text('Rename'),
                                      //               ),
                                      //               PopupMenuItem<folderAction>(
                                      //                 value: folderAction.delete,
                                      //                 child: Text('Delete'),
                                      //               ),
                                      //               PopupMenuItem<folderAction>(
                                      //                 value: folderAction.move,
                                      //                 child: Text('Move'),
                                      //               ),
                                      //             ],
                                      //           ),
                                      //         ),
                                      //       ),
                                      //     ],
                                      //   ),
                                      // ),
                                      // Container(
                                      //
                                      //  // width: MediaQuery.of(context).size.width,
                                      //   child:showNextLevelFolder(snapshot.data!.docs[index].id),)

                                    ],
                                  ),
                                ),

                                // if(widget.isExpanded) showNextLevelFolder(snapshot.data!.docs[index].id),
                                false? Padding(
                                  padding:  indendfolderPadding,
                                  child: ExpandenFolderActivityLevel2(parentFolder: snapshot.data!.docs[index].id, customerId: widget.customerId,locale: widget.locale, customerFirestore: widget.customerFirestore, expand: false,),
                                ):Container(height: 0,width: 0,),
                                if(expand) Padding(
                                  padding: indendfolderPadding,
                                  child:  showTestItemsInFolder(snapshot.data!.docs[index].id,widget.customerFirestore,widget.customerId,widget.locale),
                                ),

                              ],
                            ),
                          ),),
                          Align(alignment: Alignment.centerRight,child: addOrDeletePopMenuBox(snapshot.data!.docs[index].id,widget.customerFirestore,snapshot.data!.docs[index].get("name")),),
                        ],
                      );

                      return   Column(
                        children: [
                          Stack(
                            children: [
                              Align(alignment: Alignment.centerLeft,child: Column(
                                children: [
                                  Container(
                                    //color: expand?ThemeManager().getLightYellowColor:Colors.white,
                                    child: Row(
                                      children: [
                                        GestureDetector(
                                          onTap: () {
                                            try{

                                              ExpandFolderStreamL1.getInstance().dataReload({"id":filteredData[index].id,"expand":!expand});
                                            }catch(e){
                                              print("enpand er");
                                              print(e);
                                            }
                                          },
                                          //newFolder.isExpanded == fals
                                          child: expand
                                              ? Icon(
                                            Icons.keyboard_arrow_up_outlined,
                                            size: width * 0.085,
                                            color: ThemeManager().getDarkGrey2Color,
                                          )
                                              : Icon(
                                            Icons.keyboard_arrow_down_outlined,
                                            size: width * 0.085,
                                            color: ThemeManager().getDarkGrey2Color,
                                          ),
                                        ),
                                        GestureDetector(
                                          onTap: () {
                                            try{

                                              ExpandFolderStreamL1.getInstance().dataReload({"id":filteredData[index].id,"expand":!expand});
                                            }catch(e){
                                              print("enpand er");
                                              print(e);
                                            }
                                          },
                                          child: Container(
                                            margin: EdgeInsets.only(
                                              left: width * 0.02,
                                            ),
                                            child: SvgPicture.asset(
                                              ("assets/svg/folderIcon.svg"),
                                              fit: BoxFit.cover,
                                            ),
                                          ),
                                        ),
                                        GestureDetector(  onTap: () {
                                          try{

                                            ExpandFolderStreamL1.getInstance().dataReload({"id":filteredData[index].id,"expand":!expand});
                                          }catch(e){
                                            print("enpand er");
                                            print(e);
                                          }
                                        },
                                          child: Container(
                                              margin: EdgeInsets.only(
                                                left: width * 0.03,
                                              ),
                                              child: Text(filteredData[index]["name"],
                                                style: interRegular.copyWith(
                                                  color: ThemeManager().getBlackColor,
                                                  fontSize: width * 0.045,
                                                ),
                                              )),
                                        ),

                                        // Container(
                                        // //  height: 50,
                                        //   width: MediaQuery.of(context).size.width,
                                        //   child: Stack(
                                        //     children: [
                                        //       Align(
                                        //         alignment: Alignment.centerLeft,
                                        //         child: Row(
                                        //           children: [
                                        //             GestureDetector(
                                        //               onTap: () {
                                        //                 // setState(() {
                                        //                 //   newFolder.isExpanded = !(newFolder.isExpanded);
                                        //                 //   newFolder.isVisible = !newFolder.isVisible;
                                        //                 // });
                                        //               },
                                        //               //newFolder.isExpanded == fals
                                        //               child: false
                                        //                   ? Icon(
                                        //                 Icons.keyboard_arrow_up_outlined,
                                        //                 size: width * 0.085,
                                        //                 color: ThemeManager().getDarkGrey2Color,
                                        //               )
                                        //                   : Icon(
                                        //                 Icons.keyboard_arrow_down_outlined,
                                        //                 size: width * 0.085,
                                        //                 color: ThemeManager().getDarkGrey2Color,
                                        //               ),
                                        //             ),
                                        //             Container(
                                        //               margin: EdgeInsets.only(
                                        //                 left: width * 0.02,
                                        //               ),
                                        //               child: SvgPicture.asset(
                                        //                 ("assets/svg/folderIcon.svg"),
                                        //                 fit: BoxFit.cover,
                                        //               ),
                                        //             ),
                                        //             Container(
                                        //                 margin: EdgeInsets.only(
                                        //                   left: width * 0.03,
                                        //                 ),
                                        //                 child: Text(
                                        //                   snapshot.data!.docs[index]["name"],
                                        //                   style: interRegular.copyWith(
                                        //                     color: ThemeManager().getBlackColor,
                                        //                     fontSize: width * 0.045,
                                        //                   ),
                                        //                 ))
                                        //             // Column(
                                        //             //   mainAxisAlignment:
                                        //             //   MainAxisAlignment.center,
                                        //             //   crossAxisAlignment:
                                        //             //   CrossAxisAlignment.start,
                                        //             //   children: [
                                        //             //
                                        //             //     Text(
                                        //             //       snapshot.data!.docs[index]["name"]
                                        //             //           .toString(),
                                        //             //       style: TextStyle(
                                        //             //           fontWeight:
                                        //             //           FontWeight.bold,
                                        //             //           color: Colors.black),
                                        //             //     ),
                                        //             //     timeFormate(snapshot.data!.docs[index]["created_at"]),
                                        //             //   ],
                                        //             // ),
                                        //           ],
                                        //         ),
                                        //       ),
                                        //       Align(
                                        //         alignment: Alignment.centerRight,
                                        //         child: Container(
                                        //           height: MediaQuery.of(context)
                                        //               .size
                                        //               .height,
                                        //           width: 50,
                                        //           child: PopupMenuButton<folderAction>(
                                        //             onSelected: (folderAction value) {
                                        //               if (value ==
                                        //                   folderAction.rename) {
                                        //                 //rename folder
                                        //                 TextEditingController
                                        //                 controller =
                                        //                 TextEditingController(
                                        //                     text: snapshot.data!.docs[index]
                                        //                     ["name"]
                                        //                         .toString());
                                        //
                                        //                 Navigator.of(context)
                                        //                     .push(
                                        //                     new MaterialPageRoute<
                                        //                         Null>(
                                        //                         builder:
                                        //                             (BuildContext
                                        //                         context) {
                                        //                           return Scaffold(
                                        //                             appBar: AppBar(
                                        //                               title: Text(
                                        //                                   "Rename Folder"),
                                        //                             ),
                                        //                             body: Container(
                                        //                               decoration:
                                        //                               BoxDecoration(
                                        //                                 color: Color
                                        //                                     .fromARGB(
                                        //                                     255,
                                        //                                     247,
                                        //                                     247,
                                        //                                     247),
                                        //                                 borderRadius: BorderRadius.only(
                                        //                                     topLeft:
                                        //                                     Radius.circular(
                                        //                                         10.0),
                                        //                                     topRight:
                                        //                                     Radius.circular(10.0)),
                                        //                               ),
                                        //                               child:
                                        //                               Padding(
                                        //                                 padding: const EdgeInsets
                                        //                                     .all(
                                        //                                     15.0),
                                        //                                 child: Wrap(
                                        //                                   children: [
                                        //                                     Padding(
                                        //                                       padding:
                                        //                                       const EdgeInsets.all(8.0),
                                        //                                       child:
                                        //                                       TextFormField(
                                        //                                         controller:
                                        //                                         controller,
                                        //                                         autofocus:
                                        //                                         true,
                                        //                                         decoration:
                                        //                                         InputDecoration(
                                        //                                           labelText: 'Folder Name',
                                        //                                           border: OutlineInputBorder(),
                                        //                                         ),
                                        //                                       ),
                                        //                                     ),
                                        //                                     InkWell(
                                        //                                       onTap:
                                        //                                           () {
                                        //                                         widget.customerFirestore.collection("folders").doc(snapshot.data!.docs[index].id).update({
                                        //                                           "name": controller.text
                                        //                                         }).then((value) {
                                        //                                           Navigator.pop(context);
                                        //                                         });
                                        //                                       },
                                        //                                       child:
                                        //                                       Card(
                                        //                                         color:
                                        //                                         Theme.of(context).primaryColor,
                                        //                                         child: Center(
                                        //                                             child: Padding(
                                        //                                               padding: const EdgeInsets.all(10.0),
                                        //                                               child: Text(
                                        //                                                 "Submit",
                                        //                                                 style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold),
                                        //                                               ),
                                        //                                             )),
                                        //                                       ),
                                        //                                     )
                                        //                                   ],
                                        //                                 ),
                                        //                               ),
                                        //                             ),
                                        //                           );
                                        //                         },
                                        //                         fullscreenDialog:
                                        //                         true));
                                        //               }
                                        //               if (value ==
                                        //                   folderAction.delete) {
                                        //                 //rename folder
                                        //                 showModalBottomSheet(
                                        //                     context: context,
                                        //                     builder: (builder) {
                                        //                       return new Wrap(
                                        //                         children: [
                                        //                           Padding(
                                        //                             padding:
                                        //                             const EdgeInsets
                                        //                                 .all(8.0),
                                        //                             child: Text(
                                        //                               "Do you want to delete this Folder?",
                                        //                               style: TextStyle(
                                        //                                   fontSize: 20,
                                        //                                   color: Theme.of(
                                        //                                       context)
                                        //                                       .primaryColor),
                                        //                             ),
                                        //                           ),
                                        //                           Row(
                                        //                             children: [
                                        //                               Expanded(
                                        //                                   child:
                                        //                                   InkWell(
                                        //                                     onTap: () {
                                        //                                       Navigator.of(
                                        //                                           context)
                                        //                                           .pop();
                                        //                                     },
                                        //                                     child: Padding(
                                        //                                       padding:
                                        //                                       const EdgeInsets
                                        //                                           .all(
                                        //                                           8.0),
                                        //                                       child: Card(
                                        //                                         elevation:
                                        //                                         8,
                                        //                                         color: Colors
                                        //                                             .grey,
                                        //                                         child: Center(
                                        //                                             child: Padding(
                                        //                                               padding: const EdgeInsets
                                        //                                                   .all(
                                        //                                                   15.0),
                                        //                                               child:
                                        //                                               Text(
                                        //                                                 "Cancel",
                                        //                                                 style: TextStyle(
                                        //                                                     color:
                                        //                                                     Colors.white,
                                        //                                                     fontWeight: FontWeight.bold),
                                        //                                               ),
                                        //                                             )),
                                        //                                       ),
                                        //                                     ),
                                        //                                   )),
                                        //                               Expanded(
                                        //                                   child:
                                        //                                   InkWell(
                                        //                                     onTap: () {
                                        //                                       widget
                                        //                                           .customerFirestore
                                        //                                           .collection(
                                        //                                           "folders")
                                        //                                           .doc(snapshot.data!.docs[index].id)
                                        //                                           .delete()
                                        //                                           .then(
                                        //                                               (value) {
                                        //                                             Navigator.pop(
                                        //                                                 context);
                                        //                                           });
                                        //                                     },
                                        //                                     child: Padding(
                                        //                                       padding:
                                        //                                       const EdgeInsets
                                        //                                           .all(
                                        //                                           8.0),
                                        //                                       child: Card(
                                        //                                         elevation:
                                        //                                         8,
                                        //                                         color: Theme.of(
                                        //                                             context)
                                        //                                             .primaryColor,
                                        //                                         child: Center(
                                        //                                             child: Padding(
                                        //                                               padding: const EdgeInsets
                                        //                                                   .all(
                                        //                                                   15.0),
                                        //                                               child:
                                        //                                               Text(
                                        //                                                 "Delete",
                                        //                                                 style: TextStyle(
                                        //                                                     color:
                                        //                                                     Colors.white,
                                        //                                                     fontWeight: FontWeight.bold),
                                        //                                               ),
                                        //                                             )),
                                        //                                       ),
                                        //                                     ),
                                        //                                   )),
                                        //                             ],
                                        //                           ),
                                        //                         ],
                                        //                       );
                                        //                     });
                                        //               }
                                        //
                                        //               if (value == folderAction.move) {
                                        //                 //rename folder
                                        //                 showModalBottomSheet(
                                        //                     context: context,
                                        //                     builder: (builder) {
                                        //                       return new Wrap(
                                        //                         children: [
                                        //                           ListTile(
                                        //                             title: Text(
                                        //                               "Move Folder",
                                        //                               style: TextStyle(
                                        //                                   fontSize: 20,
                                        //                                   color: Theme.of(
                                        //                                       context)
                                        //                                       .primaryColor),
                                        //                             ),
                                        //                             trailing: Padding(
                                        //                               padding:
                                        //                               const EdgeInsets
                                        //                                   .all(8.0),
                                        //                               child: InkWell(
                                        //                                 onTap: () {
                                        //                                   Navigator.of(
                                        //                                       context)
                                        //                                       .pop();
                                        //                                 },
                                        //                                 child: Icon(
                                        //                                     Icons
                                        //                                         .close),
                                        //                               ),
                                        //                             ),
                                        //                           ),
                                        //                           Padding(
                                        //                             padding:
                                        //                             const EdgeInsets
                                        //                                 .all(8.0),
                                        //                             child: Text(
                                        //                               "Move Folder",
                                        //                               style: TextStyle(
                                        //                                   fontSize: 20,
                                        //                                   color: Theme.of(
                                        //                                       context)
                                        //                                       .primaryColor),
                                        //                             ),
                                        //                           ),
                                        //
                                        //                           MoveFolderActivity(
                                        //                             customerId: widget
                                        //                                 .customerId,
                                        //                             customerFirestore:
                                        //                             widget
                                        //                                 .customerFirestore,
                                        //                             curentFolderID:snapshot.data!.docs[index].id,locale: widget.locale,
                                        //                           ),
                                        //                           //here show move folder target
                                        //                         ],
                                        //                       );
                                        //                     });
                                        //               }
                                        //             },
                                        //             child:
                                        //             Center(child: Icon(Icons.menu)),
                                        //             itemBuilder: (BuildContext
                                        //             context) =>
                                        //             <PopupMenuEntry<folderAction>>[
                                        //               PopupMenuItem<folderAction>(
                                        //                 value: folderAction.rename,
                                        //                 child: Text('Rename'),
                                        //               ),
                                        //               PopupMenuItem<folderAction>(
                                        //                 value: folderAction.delete,
                                        //                 child: Text('Delete'),
                                        //               ),
                                        //               PopupMenuItem<folderAction>(
                                        //                 value: folderAction.move,
                                        //                 child: Text('Move'),
                                        //               ),
                                        //             ],
                                        //           ),
                                        //         ),
                                        //       ),
                                        //     ],
                                        //   ),
                                        // ),
                                        // Container(
                                        //
                                        //  // width: MediaQuery.of(context).size.width,
                                        //   child:showNextLevelFolder(snapshot.data!.docs[index].id),)

                                      ],
                                    ),
                                  ),

                                  // if(widget.isExpanded) showNextLevelFolder(snapshot.data!.docs[index].id),
                                  if(false) Padding(
                                    padding:  indendfolderPadding,
                                    child: ExpandenFolderActivityLevel2(parentFolder: snapshot.data!.docs[index].id, customerId: widget.customerId,locale: widget.locale, customerFirestore: widget.customerFirestore, expand: false,),
                                  ),
                                  if(expand) Padding(
                                    padding: indendfolderPadding,
                                    child:  showTestItemsInFolder(snapshot.data!.docs[index].id,widget.customerFirestore,widget.customerId,widget.locale),
                                  ),

                                ],
                              ),),
                              Align(alignment: Alignment.centerRight,child: addOrDeletePopMenuBox(snapshot.data!.docs[index].id,widget.customerFirestore,snapshot.data!.docs[index].get("name")),),
                            ],
                          ),
                          // if(widget.isExpanded)   Padding(padding: EdgeInsets.fromLTRB(40,0,0,0),child:  showTestItemsInFolder(snapshot.data!.docs[index].id),),
                          // if(widget.isExpanded)   Padding(padding: EdgeInsets.fromLTRB(40,0,0,0),child:ExpandedFiles(parentFolder: snapshot.data!.docs[index].id, customerId: widget.customerId,locale: widget.locale, customerFirestore: widget.customerFirestore,),),

                        ],
                      );
                    }
                    // return   Padding(
                    //   padding:  EdgeInsets.fromLTRB((step* 20), 2, 0, 2),
                    //   child: Column(
                    //     children: [
                    //       Stack(
                    //         children: [
                    //           Align(alignment: Alignment.centerLeft,child: Padding(
                    //             padding:  EdgeInsets.fromLTRB(0, 0, 0, 0),
                    //             child: Column(
                    //               children: [
                    //                 Row(
                    //                   children: [
                    //                     GestureDetector(
                    //                       onTap: () {
                    //
                    //                         setState(() {
                    //                           expand = !expand;
                    //                         });
                    //
                    //                         // try{
                    //                         //   ExpandFolderStream.getInstance().dataReload({"id":snapshot.data!.docs[index].id,"expand":!expand});
                    //                         // }catch(e){
                    //                         //   print("enpand er");
                    //                         //   print(e);
                    //                         // }
                    //                       },
                    //                       //newFolder.isExpanded == fals
                    //                       child: expand
                    //                           ? Icon(
                    //                         Icons.keyboard_arrow_up_outlined,
                    //                         size: width * 0.085,
                    //                         color: ThemeManager().getDarkGrey2Color,
                    //                       )
                    //                           : Icon(
                    //                         Icons.keyboard_arrow_down_outlined,
                    //                         size: width * 0.085,
                    //                         color: ThemeManager().getDarkGrey2Color,
                    //                       ),
                    //                     ),
                    //                     Container(
                    //                       margin: EdgeInsets.only(
                    //                         left: width * 0.02,
                    //                       ),
                    //                       child: SvgPicture.asset(
                    //                         ("assets/svg/folderIcon.svg"),
                    //                         fit: BoxFit.cover,
                    //                       ),
                    //                     ),
                    //                     Container(
                    //                         margin: EdgeInsets.only(
                    //                           left: width * 0.03,
                    //                         ),
                    //                         child: Text(
                    //                           snapshot.data!.docs[index]["name"],
                    //                           style: interRegular.copyWith(
                    //                             color: ThemeManager().getBlackColor,
                    //                             fontSize: width * 0.045,
                    //                           ),
                    //                         )),
                    //
                    //                     // Container(
                    //                     // //  height: 50,
                    //                     //   width: MediaQuery.of(context).size.width,
                    //                     //   child: Stack(
                    //                     //     children: [
                    //                     //       Align(
                    //                     //         alignment: Alignment.centerLeft,
                    //                     //         child: Row(
                    //                     //           children: [
                    //                     //             GestureDetector(
                    //                     //               onTap: () {
                    //                     //                 // setState(() {
                    //                     //                 //   newFolder.isExpanded = !(newFolder.isExpanded);
                    //                     //                 //   newFolder.isVisible = !newFolder.isVisible;
                    //                     //                 // });
                    //                     //               },
                    //                     //               //newFolder.isExpanded == fals
                    //                     //               child: false
                    //                     //                   ? Icon(
                    //                     //                 Icons.keyboard_arrow_up_outlined,
                    //                     //                 size: width * 0.085,
                    //                     //                 color: ThemeManager().getDarkGrey2Color,
                    //                     //               )
                    //                     //                   : Icon(
                    //                     //                 Icons.keyboard_arrow_down_outlined,
                    //                     //                 size: width * 0.085,
                    //                     //                 color: ThemeManager().getDarkGrey2Color,
                    //                     //               ),
                    //                     //             ),
                    //                     //             Container(
                    //                     //               margin: EdgeInsets.only(
                    //                     //                 left: width * 0.02,
                    //                     //               ),
                    //                     //               child: SvgPicture.asset(
                    //                     //                 ("assets/svg/folderIcon.svg"),
                    //                     //                 fit: BoxFit.cover,
                    //                     //               ),
                    //                     //             ),
                    //                     //             Container(
                    //                     //                 margin: EdgeInsets.only(
                    //                     //                   left: width * 0.03,
                    //                     //                 ),
                    //                     //                 child: Text(
                    //                     //                   snapshot.data!.docs[index]["name"],
                    //                     //                   style: interRegular.copyWith(
                    //                     //                     color: ThemeManager().getBlackColor,
                    //                     //                     fontSize: width * 0.045,
                    //                     //                   ),
                    //                     //                 ))
                    //                     //             // Column(
                    //                     //             //   mainAxisAlignment:
                    //                     //             //   MainAxisAlignment.center,
                    //                     //             //   crossAxisAlignment:
                    //                     //             //   CrossAxisAlignment.start,
                    //                     //             //   children: [
                    //                     //             //
                    //                     //             //     Text(
                    //                     //             //       snapshot.data!.docs[index]["name"]
                    //                     //             //           .toString(),
                    //                     //             //       style: TextStyle(
                    //                     //             //           fontWeight:
                    //                     //             //           FontWeight.bold,
                    //                     //             //           color: Colors.black),
                    //                     //             //     ),
                    //                     //             //     timeFormate(snapshot.data!.docs[index]["created_at"]),
                    //                     //             //   ],
                    //                     //             // ),
                    //                     //           ],
                    //                     //         ),
                    //                     //       ),
                    //                     //       Align(
                    //                     //         alignment: Alignment.centerRight,
                    //                     //         child: Container(
                    //                     //           height: MediaQuery.of(context)
                    //                     //               .size
                    //                     //               .height,
                    //                     //           width: 50,
                    //                     //           child: PopupMenuButton<folderAction>(
                    //                     //             onSelected: (folderAction value) {
                    //                     //               if (value ==
                    //                     //                   folderAction.rename) {
                    //                     //                 //rename folder
                    //                     //                 TextEditingController
                    //                     //                 controller =
                    //                     //                 TextEditingController(
                    //                     //                     text: snapshot.data!.docs[index]
                    //                     //                     ["name"]
                    //                     //                         .toString());
                    //                     //
                    //                     //                 Navigator.of(context)
                    //                     //                     .push(
                    //                     //                     new MaterialPageRoute<
                    //                     //                         Null>(
                    //                     //                         builder:
                    //                     //                             (BuildContext
                    //                     //                         context) {
                    //                     //                           return Scaffold(
                    //                     //                             appBar: AppBar(
                    //                     //                               title: Text(
                    //                     //                                   "Rename Folder"),
                    //                     //                             ),
                    //                     //                             body: Container(
                    //                     //                               decoration:
                    //                     //                               BoxDecoration(
                    //                     //                                 color: Color
                    //                     //                                     .fromARGB(
                    //                     //                                     255,
                    //                     //                                     247,
                    //                     //                                     247,
                    //                     //                                     247),
                    //                     //                                 borderRadius: BorderRadius.only(
                    //                     //                                     topLeft:
                    //                     //                                     Radius.circular(
                    //                     //                                         10.0),
                    //                     //                                     topRight:
                    //                     //                                     Radius.circular(10.0)),
                    //                     //                               ),
                    //                     //                               child:
                    //                     //                               Padding(
                    //                     //                                 padding: const EdgeInsets
                    //                     //                                     .all(
                    //                     //                                     15.0),
                    //                     //                                 child: Wrap(
                    //                     //                                   children: [
                    //                     //                                     Padding(
                    //                     //                                       padding:
                    //                     //                                       const EdgeInsets.all(8.0),
                    //                     //                                       child:
                    //                     //                                       TextFormField(
                    //                     //                                         controller:
                    //                     //                                         controller,
                    //                     //                                         autofocus:
                    //                     //                                         true,
                    //                     //                                         decoration:
                    //                     //                                         InputDecoration(
                    //                     //                                           labelText: 'Folder Name',
                    //                     //                                           border: OutlineInputBorder(),
                    //                     //                                         ),
                    //                     //                                       ),
                    //                     //                                     ),
                    //                     //                                     InkWell(
                    //                     //                                       onTap:
                    //                     //                                           () {
                    //                     //                                         widget.customerFirestore.collection("folders").doc(snapshot.data!.docs[index].id).update({
                    //                     //                                           "name": controller.text
                    //                     //                                         }).then((value) {
                    //                     //                                           Navigator.pop(context);
                    //                     //                                         });
                    //                     //                                       },
                    //                     //                                       child:
                    //                     //                                       Card(
                    //                     //                                         color:
                    //                     //                                         Theme.of(context).primaryColor,
                    //                     //                                         child: Center(
                    //                     //                                             child: Padding(
                    //                     //                                               padding: const EdgeInsets.all(10.0),
                    //                     //                                               child: Text(
                    //                     //                                                 "Submit",
                    //                     //                                                 style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold),
                    //                     //                                               ),
                    //                     //                                             )),
                    //                     //                                       ),
                    //                     //                                     )
                    //                     //                                   ],
                    //                     //                                 ),
                    //                     //                               ),
                    //                     //                             ),
                    //                     //                           );
                    //                     //                         },
                    //                     //                         fullscreenDialog:
                    //                     //                         true));
                    //                     //               }
                    //                     //               if (value ==
                    //                     //                   folderAction.delete) {
                    //                     //                 //rename folder
                    //                     //                 showModalBottomSheet(
                    //                     //                     context: context,
                    //                     //                     builder: (builder) {
                    //                     //                       return new Wrap(
                    //                     //                         children: [
                    //                     //                           Padding(
                    //                     //                             padding:
                    //                     //                             const EdgeInsets
                    //                     //                                 .all(8.0),
                    //                     //                             child: Text(
                    //                     //                               "Do you want to delete this Folder?",
                    //                     //                               style: TextStyle(
                    //                     //                                   fontSize: 20,
                    //                     //                                   color: Theme.of(
                    //                     //                                       context)
                    //                     //                                       .primaryColor),
                    //                     //                             ),
                    //                     //                           ),
                    //                     //                           Row(
                    //                     //                             children: [
                    //                     //                               Expanded(
                    //                     //                                   child:
                    //                     //                                   InkWell(
                    //                     //                                     onTap: () {
                    //                     //                                       Navigator.of(
                    //                     //                                           context)
                    //                     //                                           .pop();
                    //                     //                                     },
                    //                     //                                     child: Padding(
                    //                     //                                       padding:
                    //                     //                                       const EdgeInsets
                    //                     //                                           .all(
                    //                     //                                           8.0),
                    //                     //                                       child: Card(
                    //                     //                                         elevation:
                    //                     //                                         8,
                    //                     //                                         color: Colors
                    //                     //                                             .grey,
                    //                     //                                         child: Center(
                    //                     //                                             child: Padding(
                    //                     //                                               padding: const EdgeInsets
                    //                     //                                                   .all(
                    //                     //                                                   15.0),
                    //                     //                                               child:
                    //                     //                                               Text(
                    //                     //                                                 "Cancel",
                    //                     //                                                 style: TextStyle(
                    //                     //                                                     color:
                    //                     //                                                     Colors.white,
                    //                     //                                                     fontWeight: FontWeight.bold),
                    //                     //                                               ),
                    //                     //                                             )),
                    //                     //                                       ),
                    //                     //                                     ),
                    //                     //                                   )),
                    //                     //                               Expanded(
                    //                     //                                   child:
                    //                     //                                   InkWell(
                    //                     //                                     onTap: () {
                    //                     //                                       widget
                    //                     //                                           .customerFirestore
                    //                     //                                           .collection(
                    //                     //                                           "folders")
                    //                     //                                           .doc(snapshot.data!.docs[index].id)
                    //                     //                                           .delete()
                    //                     //                                           .then(
                    //                     //                                               (value) {
                    //                     //                                             Navigator.pop(
                    //                     //                                                 context);
                    //                     //                                           });
                    //                     //                                     },
                    //                     //                                     child: Padding(
                    //                     //                                       padding:
                    //                     //                                       const EdgeInsets
                    //                     //                                           .all(
                    //                     //                                           8.0),
                    //                     //                                       child: Card(
                    //                     //                                         elevation:
                    //                     //                                         8,
                    //                     //                                         color: Theme.of(
                    //                     //                                             context)
                    //                     //                                             .primaryColor,
                    //                     //                                         child: Center(
                    //                     //                                             child: Padding(
                    //                     //                                               padding: const EdgeInsets
                    //                     //                                                   .all(
                    //                     //                                                   15.0),
                    //                     //                                               child:
                    //                     //                                               Text(
                    //                     //                                                 "Delete",
                    //                     //                                                 style: TextStyle(
                    //                     //                                                     color:
                    //                     //                                                     Colors.white,
                    //                     //                                                     fontWeight: FontWeight.bold),
                    //                     //                                               ),
                    //                     //                                             )),
                    //                     //                                       ),
                    //                     //                                     ),
                    //                     //                                   )),
                    //                     //                             ],
                    //                     //                           ),
                    //                     //                         ],
                    //                     //                       );
                    //                     //                     });
                    //                     //               }
                    //                     //
                    //                     //               if (value == folderAction.move) {
                    //                     //                 //rename folder
                    //                     //                 showModalBottomSheet(
                    //                     //                     context: context,
                    //                     //                     builder: (builder) {
                    //                     //                       return new Wrap(
                    //                     //                         children: [
                    //                     //                           ListTile(
                    //                     //                             title: Text(
                    //                     //                               "Move Folder",
                    //                     //                               style: TextStyle(
                    //                     //                                   fontSize: 20,
                    //                     //                                   color: Theme.of(
                    //                     //                                       context)
                    //                     //                                       .primaryColor),
                    //                     //                             ),
                    //                     //                             trailing: Padding(
                    //                     //                               padding:
                    //                     //                               const EdgeInsets
                    //                     //                                   .all(8.0),
                    //                     //                               child: InkWell(
                    //                     //                                 onTap: () {
                    //                     //                                   Navigator.of(
                    //                     //                                       context)
                    //                     //                                       .pop();
                    //                     //                                 },
                    //                     //                                 child: Icon(
                    //                     //                                     Icons
                    //                     //                                         .close),
                    //                     //                               ),
                    //                     //                             ),
                    //                     //                           ),
                    //                     //                           Padding(
                    //                     //                             padding:
                    //                     //                             const EdgeInsets
                    //                     //                                 .all(8.0),
                    //                     //                             child: Text(
                    //                     //                               "Move Folder",
                    //                     //                               style: TextStyle(
                    //                     //                                   fontSize: 20,
                    //                     //                                   color: Theme.of(
                    //                     //                                       context)
                    //                     //                                       .primaryColor),
                    //                     //                             ),
                    //                     //                           ),
                    //                     //
                    //                     //                           MoveFolderActivity(
                    //                     //                             customerId: widget
                    //                     //                                 .customerId,
                    //                     //                             customerFirestore:
                    //                     //                             widget
                    //                     //                                 .customerFirestore,
                    //                     //                             curentFolderID:snapshot.data!.docs[index].id,locale: widget.locale,
                    //                     //                           ),
                    //                     //                           //here show move folder target
                    //                     //                         ],
                    //                     //                       );
                    //                     //                     });
                    //                     //               }
                    //                     //             },
                    //                     //             child:
                    //                     //             Center(child: Icon(Icons.menu)),
                    //                     //             itemBuilder: (BuildContext
                    //                     //             context) =>
                    //                     //             <PopupMenuEntry<folderAction>>[
                    //                     //               PopupMenuItem<folderAction>(
                    //                     //                 value: folderAction.rename,
                    //                     //                 child: Text('Rename'),
                    //                     //               ),
                    //                     //               PopupMenuItem<folderAction>(
                    //                     //                 value: folderAction.delete,
                    //                     //                 child: Text('Delete'),
                    //                     //               ),
                    //                     //               PopupMenuItem<folderAction>(
                    //                     //                 value: folderAction.move,
                    //                     //                 child: Text('Move'),
                    //                     //               ),
                    //                     //             ],
                    //                     //           ),
                    //                     //         ),
                    //                     //       ),
                    //                     //     ],
                    //                     //   ),
                    //                     // ),
                    //                     // Container(
                    //                     //
                    //                     //  // width: MediaQuery.of(context).size.width,
                    //                     //   child:showNextLevelFolder(snapshot.data!.docs[index].id),)
                    //
                    //                   ],
                    //                 ),
                    //
                    //                 // if(widget.isExpanded) showNextLevelFolder(snapshot.data!.docs[index].id),
                    //                 if(true) ExpandenFolderActivityLevel1(expand: expand,parentFolder: snapshot.data!.docs[index].id, customerId: widget.customerId,locale: widget.locale, customerFirestore: widget.customerFirestore,),
                    //                 //showTestItemsInFolder(snapshot.data!.docs[index].id),
                    //
                    //               ],
                    //             ),
                    //           ),),
                    //           // Align(alignment: Alignment.centerRight,child: addOrDeletePopMenuBox(snapshot.data!.docs[index].id),),
                    //         ],
                    //       ),
                    //       // if(widget.isExpanded)   Padding(padding: EdgeInsets.fromLTRB(40,0,0,0),child:  showTestItemsInFolder(snapshot.data!.docs[index].id),),
                    //       // if(widget.isExpanded)   Padding(padding: EdgeInsets.fromLTRB(40,0,0,0),child:ExpandedFiles(parentFolder: snapshot.data!.docs[index].id, customerId: widget.customerId,locale: widget.locale, customerFirestore: widget.customerFirestore,),),
                    //
                    //     ],
                    //   ),
                    // );
                    return  StreamBuilder<dynamic>(
                        stream: ExpandFolderStreamL1.getInstance().outData,
                        builder: (c, snapshotEx) {
                          if(snapshotEx.hasData && snapshotEx.data["id"] == filteredData[index].id )
                            return show(snapshotEx.data["expand"],filteredData[index].id);
                          else{
                            return show(false,filteredData[index].id);
                          }

                        });

                  });


              return Text( snapshot.data!.docs.length.toString());
            }else return Container(width: 0,height: 0,);
          });
    }catch(e){
      return Center(child:  Text("Something wrong"),);
    }


  }
  @override
  Widget build(BuildContext context) {
    return Column(children: [
      showNextLevelFolder(widget.parentFolder),
      // ExpandedFolders(parentFolder: widget.parentFolder, customerId: widget.customerId,locale: widget.locale, customerFirestore: widget.customerFirestore,),
      // ExpandedFiles(parentFolder: widget.parentFolder, customerId: widget.customerId,locale: widget.locale, customerFirestore: widget.customerFirestore,),

    ],);
  }

  addOrDeletePopMenuBox(String id,FirebaseFirestore firestore,String title) {
    addNewFolderNamePopUp(String id) {
      final _formKey = GlobalKey<FormState>();
      showDialog(
          context: context,
          builder: (
              context,
              ) {
            return StatefulBuilder(builder: (context, setState) {
              return AlertDialog(
                scrollable: true,
                shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.all(Radius.circular(10))),
                contentPadding: EdgeInsets.only(top: 10.0),
                content: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Container(
                      margin: EdgeInsets.only(
                          top: height * 0.01,
                          left: width * 0.04,
                          right: width * 0.04),
                      child: Row(
                        mainAxisAlignment: MainAxisAlignment.spaceBetween,
                        children: [
                          Text(
                            TextConst.addSubFolderText,
                            style: interSemiBold.copyWith(
                              color: ThemeManager().getBlackColor,
                              fontSize: width * 0.04,
                            ),
                          ),
                          InkWell(
                              onTap: () {
                                Navigator.of(context).pop();
                              },
                              child: Icon(
                                Icons.clear,
                                size: width * 0.06,
                                color: ThemeManager().getLightGrey4Color,
                              )),
                        ],
                      ),
                    ),
                    Container(
                      margin: EdgeInsets.only(top: height * 0.015),
                      height: height * 0.001,
                      color: ThemeManager().getBlackColor.withOpacity(0.19),
                    ),
                    Container(
                      margin: EdgeInsets.only(
                          top: height * 0.02,
                          left: width * 0.04,
                          right: width * 0.04),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text(
                            TextConst.folderNameText,
                            style: interMedium.copyWith(
                              color: ThemeManager().getPopUpTextGreyColor,
                              fontSize: width * 0.036,
                            ),
                          ),
                          Container(
                            margin: EdgeInsets.only(top: height * 0.015),
                            child: Form(
                              key: _formKey,
                              child: TextFormField(
                                controller: _folderNameController,
                                maxLength: 22,
                                autovalidateMode: AutovalidateMode.onUserInteraction,
                                keyboardType: TextInputType.text,
                                decoration: InputDecoration(
                                  counterText: "",
                                  border: InputBorder.none,
                                  hintText: TextConst.textFieldFolderText,
                                  hintStyle: interMedium.copyWith(
                                    color: ThemeManager().getLightGrey4Color,
                                    fontSize: width * 0.036,
                                  ),
                                  enabledBorder: OutlineInputBorder(
                                      borderSide: BorderSide(
                                        color: Colors.transparent,
                                      ),
                                      borderRadius:
                                      BorderRadius.circular(width * 0.014)),
                                  contentPadding: EdgeInsets.symmetric(
                                      vertical: height * 0.0,
                                      horizontal: width * 0.045),
                                  fillColor:
                                  ThemeManager().getLightGreenTextFieldColor,
                                  filled: true,
                                ),
                                validator: (value) {
                                  if (value!.isEmpty) {
                                    return "Please enter folder name";
                                  } else if (_folderNameController.text.length > 22) {
                                    return "Name should be 22 character only";
                                  }
                                },
                              ),
                            ),
                          ),
                          Container(
                            margin: EdgeInsets.only(top: height * 0.015),
                            child: Text(
                              "*Name must be within 10 characters.",
                              style: interMedium.copyWith(
                                color: ThemeManager().getPopUpTextGreyColor,
                                fontSize: width * 0.03,
                              ),
                            ),
                          ),
                          InkWell(
                            onTap: () async {
                              if (_formKey.currentState!.validate()) {


                                var r = await  AppFirestore(firestore: widget.customerFirestore, projectId: '', auth: FirebaseAuth.instance).createFolders(name:_folderNameController.text,parent: id );

                                if(r == true) {
                                  _folderNameController.clear();
                                  Navigator.of(context).pop();

                                  final dialogContextCompleter = Completer<BuildContext>();
                                  final dialogContext = await dialogContextCompleter.future;
                                  Navigator.pop(dialogContext);

                                }else{
                                  _folderNameController.clear();
                                  Navigator.of(context).pop();
                                  showDialog(context: context,
                                      builder: (BuildContext context){
                                        return FolderExistsPopUp();
                                      });
                                }










// Close progress dialog

                              } else {}
                            },
                            child: Container(
                                margin: EdgeInsets.only(
                                    top: height * 0.04, bottom: height * 0.02),
                                child: ButtonView(
                                    buttonLabel: TextConst.saveButtonText)
                            ),
                          ),
                        ],
                      ),
                    ),
                  ],
                ),
              );
            });
          });
    }
    renameFolderNamePopUp(String id,String oldName) {
      _folderNameController = TextEditingController(text: title);
      final _formKey = GlobalKey<FormState>();
      showDialog(
          context: context,
          builder: (
              context,
              ) {
            return StatefulBuilder(builder: (context, setState) {
              return AlertDialog(
                scrollable: true,
                shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.all(Radius.circular(10))),
                contentPadding: EdgeInsets.only(top: 10.0),
                content: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Container(
                      margin: EdgeInsets.only(
                          top: height * 0.01,
                          left: width * 0.04,
                          right: width * 0.04),
                      child: Row(
                        mainAxisAlignment: MainAxisAlignment.spaceBetween,
                        children: [
                          Text("Rename",
                            style: interSemiBold.copyWith(
                              color: ThemeManager().getBlackColor,
                              fontSize: width * 0.04,
                            ),
                          ),
                          InkWell(
                              onTap: () {
                                Navigator.of(context).pop();
                              },
                              child: Icon(
                                Icons.clear,
                                size: width * 0.06,
                                color: ThemeManager().getLightGrey4Color,
                              )),
                        ],
                      ),
                    ),
                    Container(
                      margin: EdgeInsets.only(top: height * 0.015),
                      height: height * 0.001,
                      color: ThemeManager().getBlackColor.withOpacity(0.19),
                    ),
                    Container(
                      margin: EdgeInsets.only(
                          top: height * 0.02,
                          left: width * 0.04,
                          right: width * 0.04),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text("Subfolder Name",
                            style: interMedium.copyWith(
                              color: ThemeManager().getPopUpTextGreyColor,
                              fontSize: width * 0.036,
                            ),
                          ),
                          Container(
                            margin: EdgeInsets.only(top: height * 0.015),
                            child: Form(
                              key: _formKey,
                              child: TextFormField(
                                //initialValue: oldName,
                                controller: _folderNameController,
                                maxLength: 22,
                                autovalidateMode: AutovalidateMode.onUserInteraction,
                                keyboardType: TextInputType.text,
                                decoration: InputDecoration(
                                  counterText: "",
                                  border: InputBorder.none,
                                  hintText: TextConst.textFieldFolderText,
                                  hintStyle: interMedium.copyWith(
                                    color: ThemeManager().getLightGrey4Color,
                                    fontSize: width * 0.036,
                                  ),
                                  enabledBorder: OutlineInputBorder(
                                      borderSide: BorderSide(
                                        color: Colors.transparent,
                                      ),
                                      borderRadius:
                                      BorderRadius.circular(width * 0.014)),
                                  contentPadding: EdgeInsets.symmetric(
                                      vertical: height * 0.0,
                                      horizontal: width * 0.045),
                                  fillColor:
                                  ThemeManager().getLightGreenTextFieldColor,
                                  filled: true,
                                ),
                                validator: (value) {
                                  if (value!.isEmpty) {
                                    return "Please enter folder name";
                                  } else if (_folderNameController.text.length > 22) {
                                    return "Name should be 22 character only";
                                  }
                                },
                              ),
                            ),
                          ),
                          // Container(
                          //   margin: EdgeInsets.only(top: height * 0.015),
                          //   child: Text(
                          //     "*Name must be within 10 characters.",
                          //     style: interMedium.copyWith(
                          //       color: ThemeManager().getPopUpTextGreyColor,
                          //       fontSize: width * 0.03,
                          //     ),
                          //   ),
                          // ),
                          InkWell(
                            onTap: () async {
                              if (_formKey.currentState!.validate()) {
                                AppFirestore(firestore: widget.customerFirestore, projectId: '', auth: FirebaseAuth.instance).renameFolders(name:_folderNameController.text,parent: id );
                                //  Navigator.pop(context);
                                _folderNameController.clear();
                                Navigator.of(context).pop();
// Close progress dialog
//                                 final dialogContextCompleter = Completer<BuildContext>();
//                                 final dialogContext = await dialogContextCompleter.future;
//                                 Navigator.pop(dialogContext);
//                                 Navigator.of(context).pop();
                              } else {}
                            },
                            child: Container(
                                margin: EdgeInsets.only(
                                    top: height * 0.04, bottom: height * 0.02),
                                child: ButtonView(
                                    buttonLabel: TextConst.saveButtonText)
                            ),
                          ),
                        ],
                      ),
                    ),
                  ],
                ),
              );
            });
          });
    }
    return PopupMenuButton(
      elevation: 1,
      icon: Icon(Icons.more_horiz),

      itemBuilder: (context) => [
        PopupMenuItem(
         // padding: EdgeInsets.only(top: height * 0.01, left: width * 0.0065, right: width * 0.0065),

          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [

              InkWell(
                onTap: () {
                  //Navigator.of(context).pop();
                  //addNewFolderNamePopUp(id);
                },
                child: Container(
                  margin: EdgeInsets.only(
                      left: width * 0.005, right: width * 0.005),
                  alignment: Alignment.center,
                  child: Text(
                    TextConst.addNewFolderPopUpText,
                    style: interRegular.copyWith(
                        color: ThemeManager().getLightGrey1Color,
                        fontSize: width * 0.035),
                  ),
                ),
              ),

              Container(
                margin: EdgeInsets.only(
                    top: height * 0.01, bottom: height * 0.01),
                height: height * 0.001,
                width: double.infinity,
                color: ThemeManager().getBlackColor.withOpacity(0.19),
              ),
              InkWell(
                onTap: () {
                  renameFolderNamePopUp(id,title);

                },
                child: Container(
                    alignment: Alignment.center,
                    child: Text("Rename",
                      style: interRegular.copyWith(
                          color: ThemeManager().getBlackColor,
                          fontSize: width * 0.035),
                    )),
              ),
              Container(
                margin: EdgeInsets.only(
                    top: height * 0.01, bottom: height * 0.01),
                height: height * 0.001,
                width: double.infinity,
                color: ThemeManager().getBlackColor.withOpacity(0.19),
              ),
              InkWell(
                onTap: () {
                  showDialog(context: context,
                      builder: (BuildContext context){
                        return DeleteFolderPopUp(title:title, onClickAction: (answer ) {
                          if(answer == true){
                            widget.customerFirestore.collection("folders").doc(id).delete();
                            Navigator.of(context).pop();

                          }else{
                            Navigator.of(context).pop();
                          }
                        },);
                      }
                  );

                },
                child: Container(
                    alignment: Alignment.center,
                    child: Text(
                      TextConst.deleteFolderPopUpText,
                      style: interRegular.copyWith(
                          color: ThemeManager().getBlackColor,
                          fontSize: width * 0.035),
                    )),
              )
            ],
          ),
          // value: 1,
        ),
      ],
    );
  }
}


class ExpandenFolderActivityLevel1Reporting extends StatefulWidget {
  String parentFolder;
  String customerId;

  FirebaseFirestore customerFirestore;
  Locale locale;
  bool expand;
  ExpandenFolderActivityLevel1Reporting({required this.expand,required this.parentFolder,required this.customerFirestore,required this.customerId,required this.locale});

  @override
  _ExpandenFolderActivityLevel1ReportingState createState() => _ExpandenFolderActivityLevel1ReportingState();
}

class _ExpandenFolderActivityLevel1ReportingState extends State<ExpandenFolderActivityLevel1Reporting> {

  showNextLevelFolder(String data) {
    int step = 0;

    try{
      return StreamBuilder<QuerySnapshot>(
          stream: AppFirestore(firestore: widget.customerFirestore,projectId: "",auth: FirebaseAuth.instance).getFolders(parentFolder: data),
          builder: (context, snapshot) {
            if (snapshot.hasData && snapshot.data!.docs.length>0) {
              step++;

              List<QueryDocumentSnapshot> filteredData = [];
              filteredData = snapshot.data!.docs;
              filteredData.sort((a, b) {
                return a
                    .get("name")
                    .toString()
                    .toLowerCase()
                    .compareTo(b.get("name").toString().toLowerCase());
              });

              return   ListView.builder(
                  physics: NeverScrollableScrollPhysics(),
                  // separatorBuilder: (context, index) {
                  //   return Divider();
                  // },
                  shrinkWrap: true,
                  padding: EdgeInsets.zero,
                  itemCount: filteredData.length,
                  itemBuilder: (_, index) {

                    show(bool expand,String id){
                      return   Stack(
                        children: [
                          Align(alignment: Alignment.centerLeft,child: Column(
                            children: [
                              Container(
                                //color: expand?ThemeManager().getLightYellowColor:Colors.white,
                                child: Row(
                                  children: [
                                    GestureDetector(
                                      onTap: () {
                                        try{

                                          ExpandFolderStreamL1.getInstance().dataReload({"id":filteredData[index].id,"expand":!expand});
                                          Future.delayed(Duration(seconds: 1)).then((value) {
                                            NeedToRefreshFilesNameAsStream.getInstance().dataReload(true);
                                          });
                                        }catch(e){
                                          print("enpand er");
                                          print(e);
                                        }
                                      },
                                      //newFolder.isExpanded == fals
                                      child: expand
                                          ? Icon(
                                        Icons.keyboard_arrow_up_outlined,
                                        size: width * 0.085,
                                        color: ThemeManager().getDarkGrey2Color,
                                      )
                                          : Icon(
                                        Icons.keyboard_arrow_down_outlined,
                                        size: width * 0.085,
                                        color: ThemeManager().getDarkGrey2Color,
                                      ),
                                    ),
                                    GestureDetector(
                                      onTap: () {
                                        try{

                                          ExpandFolderStreamL1.getInstance().dataReload({"id":filteredData[index].id,"expand":!expand});
                                          Future.delayed(Duration(seconds: 1)).then((value) {
                                            NeedToRefreshFilesNameAsStream.getInstance().dataReload(true);
                                          });
                                        }catch(e){
                                          print("enpand er");
                                          print(e);
                                        }
                                      },
                                      child: Container(
                                        margin: EdgeInsets.only(
                                          left: width * 0.02,
                                        ),
                                        child: SvgPicture.asset(
                                          ("assets/svg/folderIcon.svg"),
                                          fit: BoxFit.cover,
                                        ),
                                      ),
                                    ),
                                    GestureDetector(  onTap: () {
                                      try{

                                        ExpandFolderStreamL1.getInstance().dataReload({"id":filteredData[index].id,"expand":!expand});
                                        Future.delayed(Duration(seconds: 1)).then((value) {
                                          NeedToRefreshFilesNameAsStream.getInstance().dataReload(true);
                                        });
                                      }catch(e){
                                        print("enpand er");
                                        print(e);
                                      }
                                    },
                                      child: Container(
                                          margin: EdgeInsets.only(
                                            left: width * 0.03,
                                          ),
                                          child: Text(filteredData[index]["name"],
                                            style: interRegular.copyWith(
                                              color: ThemeManager().getBlackColor,
                                              fontSize: width * 0.045,
                                            ),
                                          )),
                                    ),

                                    // Container(
                                    // //  height: 50,
                                    //   width: MediaQuery.of(context).size.width,
                                    //   child: Stack(
                                    //     children: [
                                    //       Align(
                                    //         alignment: Alignment.centerLeft,
                                    //         child: Row(
                                    //           children: [
                                    //             GestureDetector(
                                    //               onTap: () {
                                    //                 // setState(() {
                                    //                 //   newFolder.isExpanded = !(newFolder.isExpanded);
                                    //                 //   newFolder.isVisible = !newFolder.isVisible;
                                    //                 // });
                                    //               },
                                    //               //newFolder.isExpanded == fals
                                    //               child: false
                                    //                   ? Icon(
                                    //                 Icons.keyboard_arrow_up_outlined,
                                    //                 size: width * 0.085,
                                    //                 color: ThemeManager().getDarkGrey2Color,
                                    //               )
                                    //                   : Icon(
                                    //                 Icons.keyboard_arrow_down_outlined,
                                    //                 size: width * 0.085,
                                    //                 color: ThemeManager().getDarkGrey2Color,
                                    //               ),
                                    //             ),
                                    //             Container(
                                    //               margin: EdgeInsets.only(
                                    //                 left: width * 0.02,
                                    //               ),
                                    //               child: SvgPicture.asset(
                                    //                 ("assets/svg/folderIcon.svg"),
                                    //                 fit: BoxFit.cover,
                                    //               ),
                                    //             ),
                                    //             Container(
                                    //                 margin: EdgeInsets.only(
                                    //                   left: width * 0.03,
                                    //                 ),
                                    //                 child: Text(
                                    //                   snapshot.data!.docs[index]["name"],
                                    //                   style: interRegular.copyWith(
                                    //                     color: ThemeManager().getBlackColor,
                                    //                     fontSize: width * 0.045,
                                    //                   ),
                                    //                 ))
                                    //             // Column(
                                    //             //   mainAxisAlignment:
                                    //             //   MainAxisAlignment.center,
                                    //             //   crossAxisAlignment:
                                    //             //   CrossAxisAlignment.start,
                                    //             //   children: [
                                    //             //
                                    //             //     Text(
                                    //             //       snapshot.data!.docs[index]["name"]
                                    //             //           .toString(),
                                    //             //       style: TextStyle(
                                    //             //           fontWeight:
                                    //             //           FontWeight.bold,
                                    //             //           color: Colors.black),
                                    //             //     ),
                                    //             //     timeFormate(snapshot.data!.docs[index]["created_at"]),
                                    //             //   ],
                                    //             // ),
                                    //           ],
                                    //         ),
                                    //       ),
                                    //       Align(
                                    //         alignment: Alignment.centerRight,
                                    //         child: Container(
                                    //           height: MediaQuery.of(context)
                                    //               .size
                                    //               .height,
                                    //           width: 50,
                                    //           child: PopupMenuButton<folderAction>(
                                    //             onSelected: (folderAction value) {
                                    //               if (value ==
                                    //                   folderAction.rename) {
                                    //                 //rename folder
                                    //                 TextEditingController
                                    //                 controller =
                                    //                 TextEditingController(
                                    //                     text: snapshot.data!.docs[index]
                                    //                     ["name"]
                                    //                         .toString());
                                    //
                                    //                 Navigator.of(context)
                                    //                     .push(
                                    //                     new MaterialPageRoute<
                                    //                         Null>(
                                    //                         builder:
                                    //                             (BuildContext
                                    //                         context) {
                                    //                           return Scaffold(
                                    //                             appBar: AppBar(
                                    //                               title: Text(
                                    //                                   "Rename Folder"),
                                    //                             ),
                                    //                             body: Container(
                                    //                               decoration:
                                    //                               BoxDecoration(
                                    //                                 color: Color
                                    //                                     .fromARGB(
                                    //                                     255,
                                    //                                     247,
                                    //                                     247,
                                    //                                     247),
                                    //                                 borderRadius: BorderRadius.only(
                                    //                                     topLeft:
                                    //                                     Radius.circular(
                                    //                                         10.0),
                                    //                                     topRight:
                                    //                                     Radius.circular(10.0)),
                                    //                               ),
                                    //                               child:
                                    //                               Padding(
                                    //                                 padding: const EdgeInsets
                                    //                                     .all(
                                    //                                     15.0),
                                    //                                 child: Wrap(
                                    //                                   children: [
                                    //                                     Padding(
                                    //                                       padding:
                                    //                                       const EdgeInsets.all(8.0),
                                    //                                       child:
                                    //                                       TextFormField(
                                    //                                         controller:
                                    //                                         controller,
                                    //                                         autofocus:
                                    //                                         true,
                                    //                                         decoration:
                                    //                                         InputDecoration(
                                    //                                           labelText: 'Folder Name',
                                    //                                           border: OutlineInputBorder(),
                                    //                                         ),
                                    //                                       ),
                                    //                                     ),
                                    //                                     InkWell(
                                    //                                       onTap:
                                    //                                           () {
                                    //                                         widget.customerFirestore.collection("folders").doc(snapshot.data!.docs[index].id).update({
                                    //                                           "name": controller.text
                                    //                                         }).then((value) {
                                    //                                           Navigator.pop(context);
                                    //                                         });
                                    //                                       },
                                    //                                       child:
                                    //                                       Card(
                                    //                                         color:
                                    //                                         Theme.of(context).primaryColor,
                                    //                                         child: Center(
                                    //                                             child: Padding(
                                    //                                               padding: const EdgeInsets.all(10.0),
                                    //                                               child: Text(
                                    //                                                 "Submit",
                                    //                                                 style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold),
                                    //                                               ),
                                    //                                             )),
                                    //                                       ),
                                    //                                     )
                                    //                                   ],
                                    //                                 ),
                                    //                               ),
                                    //                             ),
                                    //                           );
                                    //                         },
                                    //                         fullscreenDialog:
                                    //                         true));
                                    //               }
                                    //               if (value ==
                                    //                   folderAction.delete) {
                                    //                 //rename folder
                                    //                 showModalBottomSheet(
                                    //                     context: context,
                                    //                     builder: (builder) {
                                    //                       return new Wrap(
                                    //                         children: [
                                    //                           Padding(
                                    //                             padding:
                                    //                             const EdgeInsets
                                    //                                 .all(8.0),
                                    //                             child: Text(
                                    //                               "Do you want to delete this Folder?",
                                    //                               style: TextStyle(
                                    //                                   fontSize: 20,
                                    //                                   color: Theme.of(
                                    //                                       context)
                                    //                                       .primaryColor),
                                    //                             ),
                                    //                           ),
                                    //                           Row(
                                    //                             children: [
                                    //                               Expanded(
                                    //                                   child:
                                    //                                   InkWell(
                                    //                                     onTap: () {
                                    //                                       Navigator.of(
                                    //                                           context)
                                    //                                           .pop();
                                    //                                     },
                                    //                                     child: Padding(
                                    //                                       padding:
                                    //                                       const EdgeInsets
                                    //                                           .all(
                                    //                                           8.0),
                                    //                                       child: Card(
                                    //                                         elevation:
                                    //                                         8,
                                    //                                         color: Colors
                                    //                                             .grey,
                                    //                                         child: Center(
                                    //                                             child: Padding(
                                    //                                               padding: const EdgeInsets
                                    //                                                   .all(
                                    //                                                   15.0),
                                    //                                               child:
                                    //                                               Text(
                                    //                                                 "Cancel",
                                    //                                                 style: TextStyle(
                                    //                                                     color:
                                    //                                                     Colors.white,
                                    //                                                     fontWeight: FontWeight.bold),
                                    //                                               ),
                                    //                                             )),
                                    //                                       ),
                                    //                                     ),
                                    //                                   )),
                                    //                               Expanded(
                                    //                                   child:
                                    //                                   InkWell(
                                    //                                     onTap: () {
                                    //                                       widget
                                    //                                           .customerFirestore
                                    //                                           .collection(
                                    //                                           "folders")
                                    //                                           .doc(snapshot.data!.docs[index].id)
                                    //                                           .delete()
                                    //                                           .then(
                                    //                                               (value) {
                                    //                                             Navigator.pop(
                                    //                                                 context);
                                    //                                           });
                                    //                                     },
                                    //                                     child: Padding(
                                    //                                       padding:
                                    //                                       const EdgeInsets
                                    //                                           .all(
                                    //                                           8.0),
                                    //                                       child: Card(
                                    //                                         elevation:
                                    //                                         8,
                                    //                                         color: Theme.of(
                                    //                                             context)
                                    //                                             .primaryColor,
                                    //                                         child: Center(
                                    //                                             child: Padding(
                                    //                                               padding: const EdgeInsets
                                    //                                                   .all(
                                    //                                                   15.0),
                                    //                                               child:
                                    //                                               Text(
                                    //                                                 "Delete",
                                    //                                                 style: TextStyle(
                                    //                                                     color:
                                    //                                                     Colors.white,
                                    //                                                     fontWeight: FontWeight.bold),
                                    //                                               ),
                                    //                                             )),
                                    //                                       ),
                                    //                                     ),
                                    //                                   )),
                                    //                             ],
                                    //                           ),
                                    //                         ],
                                    //                       );
                                    //                     });
                                    //               }
                                    //
                                    //               if (value == folderAction.move) {
                                    //                 //rename folder
                                    //                 showModalBottomSheet(
                                    //                     context: context,
                                    //                     builder: (builder) {
                                    //                       return new Wrap(
                                    //                         children: [
                                    //                           ListTile(
                                    //                             title: Text(
                                    //                               "Move Folder",
                                    //                               style: TextStyle(
                                    //                                   fontSize: 20,
                                    //                                   color: Theme.of(
                                    //                                       context)
                                    //                                       .primaryColor),
                                    //                             ),
                                    //                             trailing: Padding(
                                    //                               padding:
                                    //                               const EdgeInsets
                                    //                                   .all(8.0),
                                    //                               child: InkWell(
                                    //                                 onTap: () {
                                    //                                   Navigator.of(
                                    //                                       context)
                                    //                                       .pop();
                                    //                                 },
                                    //                                 child: Icon(
                                    //                                     Icons
                                    //                                         .close),
                                    //                               ),
                                    //                             ),
                                    //                           ),
                                    //                           Padding(
                                    //                             padding:
                                    //                             const EdgeInsets
                                    //                                 .all(8.0),
                                    //                             child: Text(
                                    //                               "Move Folder",
                                    //                               style: TextStyle(
                                    //                                   fontSize: 20,
                                    //                                   color: Theme.of(
                                    //                                       context)
                                    //                                       .primaryColor),
                                    //                             ),
                                    //                           ),
                                    //
                                    //                           MoveFolderActivity(
                                    //                             customerId: widget
                                    //                                 .customerId,
                                    //                             customerFirestore:
                                    //                             widget
                                    //                                 .customerFirestore,
                                    //                             curentFolderID:snapshot.data!.docs[index].id,locale: widget.locale,
                                    //                           ),
                                    //                           //here show move folder target
                                    //                         ],
                                    //                       );
                                    //                     });
                                    //               }
                                    //             },
                                    //             child:
                                    //             Center(child: Icon(Icons.menu)),
                                    //             itemBuilder: (BuildContext
                                    //             context) =>
                                    //             <PopupMenuEntry<folderAction>>[
                                    //               PopupMenuItem<folderAction>(
                                    //                 value: folderAction.rename,
                                    //                 child: Text('Rename'),
                                    //               ),
                                    //               PopupMenuItem<folderAction>(
                                    //                 value: folderAction.delete,
                                    //                 child: Text('Delete'),
                                    //               ),
                                    //               PopupMenuItem<folderAction>(
                                    //                 value: folderAction.move,
                                    //                 child: Text('Move'),
                                    //               ),
                                    //             ],
                                    //           ),
                                    //         ),
                                    //       ),
                                    //     ],
                                    //   ),
                                    // ),
                                    // Container(
                                    //
                                    //  // width: MediaQuery.of(context).size.width,
                                    //   child:showNextLevelFolder(snapshot.data!.docs[index].id),)

                                  ],
                                ),
                              ),

                              // if(widget.isExpanded) showNextLevelFolder(snapshot.data!.docs[index].id),
                              false? Padding(
                                padding:  indendfolderPadding,
                                child: ExpandenFolderActivityLevel2(parentFolder: snapshot.data!.docs[index].id, customerId: widget.customerId,locale: widget.locale, customerFirestore: widget.customerFirestore, expand: false,),
                              ):Container(height: 0,width: 0,),
                              if(expand) Padding(
                                padding: indendfolderPadding,
                                child:  showTestItemsInFolderForReporting(snapshot.data!.docs[index].id,widget.customerFirestore,widget.customerId,widget.locale),
                              ),

                            ],
                          ),),
                          //Align(alignment: Alignment.centerRight,child: addOrDeletePopMenuBox(snapshot.data!.docs[index].id,widget.customerFirestore,snapshot.data!.docs[index].get("name")),),
                        ],
                      );

                      return   Column(
                        children: [
                          Stack(
                            children: [
                              Align(alignment: Alignment.centerLeft,child: Column(
                                children: [
                                  Container(
                                    //color: expand?ThemeManager().getLightYellowColor:Colors.white,
                                    child: Row(
                                      children: [
                                        GestureDetector(
                                          onTap: () {
                                            try{

                                              ExpandFolderStreamL1.getInstance().dataReload({"id":filteredData[index].id,"expand":!expand});
                                            }catch(e){
                                              print("enpand er");
                                              print(e);
                                            }
                                          },
                                          //newFolder.isExpanded == fals
                                          child: expand
                                              ? Icon(
                                            Icons.keyboard_arrow_up_outlined,
                                            size: width * 0.085,
                                            color: ThemeManager().getDarkGrey2Color,
                                          )
                                              : Icon(
                                            Icons.keyboard_arrow_down_outlined,
                                            size: width * 0.085,
                                            color: ThemeManager().getDarkGrey2Color,
                                          ),
                                        ),
                                        GestureDetector(
                                          onTap: () {
                                            try{

                                              ExpandFolderStreamL1.getInstance().dataReload({"id":filteredData[index].id,"expand":!expand});
                                            }catch(e){
                                              print("enpand er");
                                              print(e);
                                            }
                                          },
                                          child: Container(
                                            margin: EdgeInsets.only(
                                              left: width * 0.02,
                                            ),
                                            child: SvgPicture.asset(
                                              ("assets/svg/folderIcon.svg"),
                                              fit: BoxFit.cover,
                                            ),
                                          ),
                                        ),
                                        GestureDetector(  onTap: () {
                                          try{

                                            ExpandFolderStreamL1.getInstance().dataReload({"id":filteredData[index].id,"expand":!expand});
                                          }catch(e){
                                            print("enpand er");
                                            print(e);
                                          }
                                        },
                                          child: Container(
                                              margin: EdgeInsets.only(
                                                left: width * 0.03,
                                              ),
                                              child: Text(filteredData[index]["name"],
                                                style: interRegular.copyWith(
                                                  color: ThemeManager().getBlackColor,
                                                  fontSize: width * 0.045,
                                                ),
                                              )),
                                        ),

                                        // Container(
                                        // //  height: 50,
                                        //   width: MediaQuery.of(context).size.width,
                                        //   child: Stack(
                                        //     children: [
                                        //       Align(
                                        //         alignment: Alignment.centerLeft,
                                        //         child: Row(
                                        //           children: [
                                        //             GestureDetector(
                                        //               onTap: () {
                                        //                 // setState(() {
                                        //                 //   newFolder.isExpanded = !(newFolder.isExpanded);
                                        //                 //   newFolder.isVisible = !newFolder.isVisible;
                                        //                 // });
                                        //               },
                                        //               //newFolder.isExpanded == fals
                                        //               child: false
                                        //                   ? Icon(
                                        //                 Icons.keyboard_arrow_up_outlined,
                                        //                 size: width * 0.085,
                                        //                 color: ThemeManager().getDarkGrey2Color,
                                        //               )
                                        //                   : Icon(
                                        //                 Icons.keyboard_arrow_down_outlined,
                                        //                 size: width * 0.085,
                                        //                 color: ThemeManager().getDarkGrey2Color,
                                        //               ),
                                        //             ),
                                        //             Container(
                                        //               margin: EdgeInsets.only(
                                        //                 left: width * 0.02,
                                        //               ),
                                        //               child: SvgPicture.asset(
                                        //                 ("assets/svg/folderIcon.svg"),
                                        //                 fit: BoxFit.cover,
                                        //               ),
                                        //             ),
                                        //             Container(
                                        //                 margin: EdgeInsets.only(
                                        //                   left: width * 0.03,
                                        //                 ),
                                        //                 child: Text(
                                        //                   snapshot.data!.docs[index]["name"],
                                        //                   style: interRegular.copyWith(
                                        //                     color: ThemeManager().getBlackColor,
                                        //                     fontSize: width * 0.045,
                                        //                   ),
                                        //                 ))
                                        //             // Column(
                                        //             //   mainAxisAlignment:
                                        //             //   MainAxisAlignment.center,
                                        //             //   crossAxisAlignment:
                                        //             //   CrossAxisAlignment.start,
                                        //             //   children: [
                                        //             //
                                        //             //     Text(
                                        //             //       snapshot.data!.docs[index]["name"]
                                        //             //           .toString(),
                                        //             //       style: TextStyle(
                                        //             //           fontWeight:
                                        //             //           FontWeight.bold,
                                        //             //           color: Colors.black),
                                        //             //     ),
                                        //             //     timeFormate(snapshot.data!.docs[index]["created_at"]),
                                        //             //   ],
                                        //             // ),
                                        //           ],
                                        //         ),
                                        //       ),
                                        //       Align(
                                        //         alignment: Alignment.centerRight,
                                        //         child: Container(
                                        //           height: MediaQuery.of(context)
                                        //               .size
                                        //               .height,
                                        //           width: 50,
                                        //           child: PopupMenuButton<folderAction>(
                                        //             onSelected: (folderAction value) {
                                        //               if (value ==
                                        //                   folderAction.rename) {
                                        //                 //rename folder
                                        //                 TextEditingController
                                        //                 controller =
                                        //                 TextEditingController(
                                        //                     text: snapshot.data!.docs[index]
                                        //                     ["name"]
                                        //                         .toString());
                                        //
                                        //                 Navigator.of(context)
                                        //                     .push(
                                        //                     new MaterialPageRoute<
                                        //                         Null>(
                                        //                         builder:
                                        //                             (BuildContext
                                        //                         context) {
                                        //                           return Scaffold(
                                        //                             appBar: AppBar(
                                        //                               title: Text(
                                        //                                   "Rename Folder"),
                                        //                             ),
                                        //                             body: Container(
                                        //                               decoration:
                                        //                               BoxDecoration(
                                        //                                 color: Color
                                        //                                     .fromARGB(
                                        //                                     255,
                                        //                                     247,
                                        //                                     247,
                                        //                                     247),
                                        //                                 borderRadius: BorderRadius.only(
                                        //                                     topLeft:
                                        //                                     Radius.circular(
                                        //                                         10.0),
                                        //                                     topRight:
                                        //                                     Radius.circular(10.0)),
                                        //                               ),
                                        //                               child:
                                        //                               Padding(
                                        //                                 padding: const EdgeInsets
                                        //                                     .all(
                                        //                                     15.0),
                                        //                                 child: Wrap(
                                        //                                   children: [
                                        //                                     Padding(
                                        //                                       padding:
                                        //                                       const EdgeInsets.all(8.0),
                                        //                                       child:
                                        //                                       TextFormField(
                                        //                                         controller:
                                        //                                         controller,
                                        //                                         autofocus:
                                        //                                         true,
                                        //                                         decoration:
                                        //                                         InputDecoration(
                                        //                                           labelText: 'Folder Name',
                                        //                                           border: OutlineInputBorder(),
                                        //                                         ),
                                        //                                       ),
                                        //                                     ),
                                        //                                     InkWell(
                                        //                                       onTap:
                                        //                                           () {
                                        //                                         widget.customerFirestore.collection("folders").doc(snapshot.data!.docs[index].id).update({
                                        //                                           "name": controller.text
                                        //                                         }).then((value) {
                                        //                                           Navigator.pop(context);
                                        //                                         });
                                        //                                       },
                                        //                                       child:
                                        //                                       Card(
                                        //                                         color:
                                        //                                         Theme.of(context).primaryColor,
                                        //                                         child: Center(
                                        //                                             child: Padding(
                                        //                                               padding: const EdgeInsets.all(10.0),
                                        //                                               child: Text(
                                        //                                                 "Submit",
                                        //                                                 style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold),
                                        //                                               ),
                                        //                                             )),
                                        //                                       ),
                                        //                                     )
                                        //                                   ],
                                        //                                 ),
                                        //                               ),
                                        //                             ),
                                        //                           );
                                        //                         },
                                        //                         fullscreenDialog:
                                        //                         true));
                                        //               }
                                        //               if (value ==
                                        //                   folderAction.delete) {
                                        //                 //rename folder
                                        //                 showModalBottomSheet(
                                        //                     context: context,
                                        //                     builder: (builder) {
                                        //                       return new Wrap(
                                        //                         children: [
                                        //                           Padding(
                                        //                             padding:
                                        //                             const EdgeInsets
                                        //                                 .all(8.0),
                                        //                             child: Text(
                                        //                               "Do you want to delete this Folder?",
                                        //                               style: TextStyle(
                                        //                                   fontSize: 20,
                                        //                                   color: Theme.of(
                                        //                                       context)
                                        //                                       .primaryColor),
                                        //                             ),
                                        //                           ),
                                        //                           Row(
                                        //                             children: [
                                        //                               Expanded(
                                        //                                   child:
                                        //                                   InkWell(
                                        //                                     onTap: () {
                                        //                                       Navigator.of(
                                        //                                           context)
                                        //                                           .pop();
                                        //                                     },
                                        //                                     child: Padding(
                                        //                                       padding:
                                        //                                       const EdgeInsets
                                        //                                           .all(
                                        //                                           8.0),
                                        //                                       child: Card(
                                        //                                         elevation:
                                        //                                         8,
                                        //                                         color: Colors
                                        //                                             .grey,
                                        //                                         child: Center(
                                        //                                             child: Padding(
                                        //                                               padding: const EdgeInsets
                                        //                                                   .all(
                                        //                                                   15.0),
                                        //                                               child:
                                        //                                               Text(
                                        //                                                 "Cancel",
                                        //                                                 style: TextStyle(
                                        //                                                     color:
                                        //                                                     Colors.white,
                                        //                                                     fontWeight: FontWeight.bold),
                                        //                                               ),
                                        //                                             )),
                                        //                                       ),
                                        //                                     ),
                                        //                                   )),
                                        //                               Expanded(
                                        //                                   child:
                                        //                                   InkWell(
                                        //                                     onTap: () {
                                        //                                       widget
                                        //                                           .customerFirestore
                                        //                                           .collection(
                                        //                                           "folders")
                                        //                                           .doc(snapshot.data!.docs[index].id)
                                        //                                           .delete()
                                        //                                           .then(
                                        //                                               (value) {
                                        //                                             Navigator.pop(
                                        //                                                 context);
                                        //                                           });
                                        //                                     },
                                        //                                     child: Padding(
                                        //                                       padding:
                                        //                                       const EdgeInsets
                                        //                                           .all(
                                        //                                           8.0),
                                        //                                       child: Card(
                                        //                                         elevation:
                                        //                                         8,
                                        //                                         color: Theme.of(
                                        //                                             context)
                                        //                                             .primaryColor,
                                        //                                         child: Center(
                                        //                                             child: Padding(
                                        //                                               padding: const EdgeInsets
                                        //                                                   .all(
                                        //                                                   15.0),
                                        //                                               child:
                                        //                                               Text(
                                        //                                                 "Delete",
                                        //                                                 style: TextStyle(
                                        //                                                     color:
                                        //                                                     Colors.white,
                                        //                                                     fontWeight: FontWeight.bold),
                                        //                                               ),
                                        //                                             )),
                                        //                                       ),
                                        //                                     ),
                                        //                                   )),
                                        //                             ],
                                        //                           ),
                                        //                         ],
                                        //                       );
                                        //                     });
                                        //               }
                                        //
                                        //               if (value == folderAction.move) {
                                        //                 //rename folder
                                        //                 showModalBottomSheet(
                                        //                     context: context,
                                        //                     builder: (builder) {
                                        //                       return new Wrap(
                                        //                         children: [
                                        //                           ListTile(
                                        //                             title: Text(
                                        //                               "Move Folder",
                                        //                               style: TextStyle(
                                        //                                   fontSize: 20,
                                        //                                   color: Theme.of(
                                        //                                       context)
                                        //                                       .primaryColor),
                                        //                             ),
                                        //                             trailing: Padding(
                                        //                               padding:
                                        //                               const EdgeInsets
                                        //                                   .all(8.0),
                                        //                               child: InkWell(
                                        //                                 onTap: () {
                                        //                                   Navigator.of(
                                        //                                       context)
                                        //                                       .pop();
                                        //                                 },
                                        //                                 child: Icon(
                                        //                                     Icons
                                        //                                         .close),
                                        //                               ),
                                        //                             ),
                                        //                           ),
                                        //                           Padding(
                                        //                             padding:
                                        //                             const EdgeInsets
                                        //                                 .all(8.0),
                                        //                             child: Text(
                                        //                               "Move Folder",
                                        //                               style: TextStyle(
                                        //                                   fontSize: 20,
                                        //                                   color: Theme.of(
                                        //                                       context)
                                        //                                       .primaryColor),
                                        //                             ),
                                        //                           ),
                                        //
                                        //                           MoveFolderActivity(
                                        //                             customerId: widget
                                        //                                 .customerId,
                                        //                             customerFirestore:
                                        //                             widget
                                        //                                 .customerFirestore,
                                        //                             curentFolderID:snapshot.data!.docs[index].id,locale: widget.locale,
                                        //                           ),
                                        //                           //here show move folder target
                                        //                         ],
                                        //                       );
                                        //                     });
                                        //               }
                                        //             },
                                        //             child:
                                        //             Center(child: Icon(Icons.menu)),
                                        //             itemBuilder: (BuildContext
                                        //             context) =>
                                        //             <PopupMenuEntry<folderAction>>[
                                        //               PopupMenuItem<folderAction>(
                                        //                 value: folderAction.rename,
                                        //                 child: Text('Rename'),
                                        //               ),
                                        //               PopupMenuItem<folderAction>(
                                        //                 value: folderAction.delete,
                                        //                 child: Text('Delete'),
                                        //               ),
                                        //               PopupMenuItem<folderAction>(
                                        //                 value: folderAction.move,
                                        //                 child: Text('Move'),
                                        //               ),
                                        //             ],
                                        //           ),
                                        //         ),
                                        //       ),
                                        //     ],
                                        //   ),
                                        // ),
                                        // Container(
                                        //
                                        //  // width: MediaQuery.of(context).size.width,
                                        //   child:showNextLevelFolder(snapshot.data!.docs[index].id),)

                                      ],
                                    ),
                                  ),

                                  // if(widget.isExpanded) showNextLevelFolder(snapshot.data!.docs[index].id),
                                  if(false) Padding(
                                    padding:  indendfolderPadding,
                                    child: ExpandenFolderActivityLevel2(parentFolder: snapshot.data!.docs[index].id, customerId: widget.customerId,locale: widget.locale, customerFirestore: widget.customerFirestore, expand: false,),
                                  ),
                                  if(expand) Padding(
                                    padding: indendfolderPadding,
                                    child:  showTestItemsInFolder(snapshot.data!.docs[index].id,widget.customerFirestore,widget.customerId,widget.locale),
                                  ),

                                ],
                              ),),
                              Align(alignment: Alignment.centerRight,child: addOrDeletePopMenuBox(snapshot.data!.docs[index].id,widget.customerFirestore,snapshot.data!.docs[index].get("name")),),
                            ],
                          ),
                          // if(widget.isExpanded)   Padding(padding: EdgeInsets.fromLTRB(40,0,0,0),child:  showTestItemsInFolder(snapshot.data!.docs[index].id),),
                          // if(widget.isExpanded)   Padding(padding: EdgeInsets.fromLTRB(40,0,0,0),child:ExpandedFiles(parentFolder: snapshot.data!.docs[index].id, customerId: widget.customerId,locale: widget.locale, customerFirestore: widget.customerFirestore,),),

                        ],
                      );
                    }
                    // return   Padding(
                    //   padding:  EdgeInsets.fromLTRB((step* 20), 2, 0, 2),
                    //   child: Column(
                    //     children: [
                    //       Stack(
                    //         children: [
                    //           Align(alignment: Alignment.centerLeft,child: Padding(
                    //             padding:  EdgeInsets.fromLTRB(0, 0, 0, 0),
                    //             child: Column(
                    //               children: [
                    //                 Row(
                    //                   children: [
                    //                     GestureDetector(
                    //                       onTap: () {
                    //
                    //                         setState(() {
                    //                           expand = !expand;
                    //                         });
                    //
                    //                         // try{
                    //                         //   ExpandFolderStream.getInstance().dataReload({"id":snapshot.data!.docs[index].id,"expand":!expand});
                    //                         // }catch(e){
                    //                         //   print("enpand er");
                    //                         //   print(e);
                    //                         // }
                    //                       },
                    //                       //newFolder.isExpanded == fals
                    //                       child: expand
                    //                           ? Icon(
                    //                         Icons.keyboard_arrow_up_outlined,
                    //                         size: width * 0.085,
                    //                         color: ThemeManager().getDarkGrey2Color,
                    //                       )
                    //                           : Icon(
                    //                         Icons.keyboard_arrow_down_outlined,
                    //                         size: width * 0.085,
                    //                         color: ThemeManager().getDarkGrey2Color,
                    //                       ),
                    //                     ),
                    //                     Container(
                    //                       margin: EdgeInsets.only(
                    //                         left: width * 0.02,
                    //                       ),
                    //                       child: SvgPicture.asset(
                    //                         ("assets/svg/folderIcon.svg"),
                    //                         fit: BoxFit.cover,
                    //                       ),
                    //                     ),
                    //                     Container(
                    //                         margin: EdgeInsets.only(
                    //                           left: width * 0.03,
                    //                         ),
                    //                         child: Text(
                    //                           snapshot.data!.docs[index]["name"],
                    //                           style: interRegular.copyWith(
                    //                             color: ThemeManager().getBlackColor,
                    //                             fontSize: width * 0.045,
                    //                           ),
                    //                         )),
                    //
                    //                     // Container(
                    //                     // //  height: 50,
                    //                     //   width: MediaQuery.of(context).size.width,
                    //                     //   child: Stack(
                    //                     //     children: [
                    //                     //       Align(
                    //                     //         alignment: Alignment.centerLeft,
                    //                     //         child: Row(
                    //                     //           children: [
                    //                     //             GestureDetector(
                    //                     //               onTap: () {
                    //                     //                 // setState(() {
                    //                     //                 //   newFolder.isExpanded = !(newFolder.isExpanded);
                    //                     //                 //   newFolder.isVisible = !newFolder.isVisible;
                    //                     //                 // });
                    //                     //               },
                    //                     //               //newFolder.isExpanded == fals
                    //                     //               child: false
                    //                     //                   ? Icon(
                    //                     //                 Icons.keyboard_arrow_up_outlined,
                    //                     //                 size: width * 0.085,
                    //                     //                 color: ThemeManager().getDarkGrey2Color,
                    //                     //               )
                    //                     //                   : Icon(
                    //                     //                 Icons.keyboard_arrow_down_outlined,
                    //                     //                 size: width * 0.085,
                    //                     //                 color: ThemeManager().getDarkGrey2Color,
                    //                     //               ),
                    //                     //             ),
                    //                     //             Container(
                    //                     //               margin: EdgeInsets.only(
                    //                     //                 left: width * 0.02,
                    //                     //               ),
                    //                     //               child: SvgPicture.asset(
                    //                     //                 ("assets/svg/folderIcon.svg"),
                    //                     //                 fit: BoxFit.cover,
                    //                     //               ),
                    //                     //             ),
                    //                     //             Container(
                    //                     //                 margin: EdgeInsets.only(
                    //                     //                   left: width * 0.03,
                    //                     //                 ),
                    //                     //                 child: Text(
                    //                     //                   snapshot.data!.docs[index]["name"],
                    //                     //                   style: interRegular.copyWith(
                    //                     //                     color: ThemeManager().getBlackColor,
                    //                     //                     fontSize: width * 0.045,
                    //                     //                   ),
                    //                     //                 ))
                    //                     //             // Column(
                    //                     //             //   mainAxisAlignment:
                    //                     //             //   MainAxisAlignment.center,
                    //                     //             //   crossAxisAlignment:
                    //                     //             //   CrossAxisAlignment.start,
                    //                     //             //   children: [
                    //                     //             //
                    //                     //             //     Text(
                    //                     //             //       snapshot.data!.docs[index]["name"]
                    //                     //             //           .toString(),
                    //                     //             //       style: TextStyle(
                    //                     //             //           fontWeight:
                    //                     //             //           FontWeight.bold,
                    //                     //             //           color: Colors.black),
                    //                     //             //     ),
                    //                     //             //     timeFormate(snapshot.data!.docs[index]["created_at"]),
                    //                     //             //   ],
                    //                     //             // ),
                    //                     //           ],
                    //                     //         ),
                    //                     //       ),
                    //                     //       Align(
                    //                     //         alignment: Alignment.centerRight,
                    //                     //         child: Container(
                    //                     //           height: MediaQuery.of(context)
                    //                     //               .size
                    //                     //               .height,
                    //                     //           width: 50,
                    //                     //           child: PopupMenuButton<folderAction>(
                    //                     //             onSelected: (folderAction value) {
                    //                     //               if (value ==
                    //                     //                   folderAction.rename) {
                    //                     //                 //rename folder
                    //                     //                 TextEditingController
                    //                     //                 controller =
                    //                     //                 TextEditingController(
                    //                     //                     text: snapshot.data!.docs[index]
                    //                     //                     ["name"]
                    //                     //                         .toString());
                    //                     //
                    //                     //                 Navigator.of(context)
                    //                     //                     .push(
                    //                     //                     new MaterialPageRoute<
                    //                     //                         Null>(
                    //                     //                         builder:
                    //                     //                             (BuildContext
                    //                     //                         context) {
                    //                     //                           return Scaffold(
                    //                     //                             appBar: AppBar(
                    //                     //                               title: Text(
                    //                     //                                   "Rename Folder"),
                    //                     //                             ),
                    //                     //                             body: Container(
                    //                     //                               decoration:
                    //                     //                               BoxDecoration(
                    //                     //                                 color: Color
                    //                     //                                     .fromARGB(
                    //                     //                                     255,
                    //                     //                                     247,
                    //                     //                                     247,
                    //                     //                                     247),
                    //                     //                                 borderRadius: BorderRadius.only(
                    //                     //                                     topLeft:
                    //                     //                                     Radius.circular(
                    //                     //                                         10.0),
                    //                     //                                     topRight:
                    //                     //                                     Radius.circular(10.0)),
                    //                     //                               ),
                    //                     //                               child:
                    //                     //                               Padding(
                    //                     //                                 padding: const EdgeInsets
                    //                     //                                     .all(
                    //                     //                                     15.0),
                    //                     //                                 child: Wrap(
                    //                     //                                   children: [
                    //                     //                                     Padding(
                    //                     //                                       padding:
                    //                     //                                       const EdgeInsets.all(8.0),
                    //                     //                                       child:
                    //                     //                                       TextFormField(
                    //                     //                                         controller:
                    //                     //                                         controller,
                    //                     //                                         autofocus:
                    //                     //                                         true,
                    //                     //                                         decoration:
                    //                     //                                         InputDecoration(
                    //                     //                                           labelText: 'Folder Name',
                    //                     //                                           border: OutlineInputBorder(),
                    //                     //                                         ),
                    //                     //                                       ),
                    //                     //                                     ),
                    //                     //                                     InkWell(
                    //                     //                                       onTap:
                    //                     //                                           () {
                    //                     //                                         widget.customerFirestore.collection("folders").doc(snapshot.data!.docs[index].id).update({
                    //                     //                                           "name": controller.text
                    //                     //                                         }).then((value) {
                    //                     //                                           Navigator.pop(context);
                    //                     //                                         });
                    //                     //                                       },
                    //                     //                                       child:
                    //                     //                                       Card(
                    //                     //                                         color:
                    //                     //                                         Theme.of(context).primaryColor,
                    //                     //                                         child: Center(
                    //                     //                                             child: Padding(
                    //                     //                                               padding: const EdgeInsets.all(10.0),
                    //                     //                                               child: Text(
                    //                     //                                                 "Submit",
                    //                     //                                                 style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold),
                    //                     //                                               ),
                    //                     //                                             )),
                    //                     //                                       ),
                    //                     //                                     )
                    //                     //                                   ],
                    //                     //                                 ),
                    //                     //                               ),
                    //                     //                             ),
                    //                     //                           );
                    //                     //                         },
                    //                     //                         fullscreenDialog:
                    //                     //                         true));
                    //                     //               }
                    //                     //               if (value ==
                    //                     //                   folderAction.delete) {
                    //                     //                 //rename folder
                    //                     //                 showModalBottomSheet(
                    //                     //                     context: context,
                    //                     //                     builder: (builder) {
                    //                     //                       return new Wrap(
                    //                     //                         children: [
                    //                     //                           Padding(
                    //                     //                             padding:
                    //                     //                             const EdgeInsets
                    //                     //                                 .all(8.0),
                    //                     //                             child: Text(
                    //                     //                               "Do you want to delete this Folder?",
                    //                     //                               style: TextStyle(
                    //                     //                                   fontSize: 20,
                    //                     //                                   color: Theme.of(
                    //                     //                                       context)
                    //                     //                                       .primaryColor),
                    //                     //                             ),
                    //                     //                           ),
                    //                     //                           Row(
                    //                     //                             children: [
                    //                     //                               Expanded(
                    //                     //                                   child:
                    //                     //                                   InkWell(
                    //                     //                                     onTap: () {
                    //                     //                                       Navigator.of(
                    //                     //                                           context)
                    //                     //                                           .pop();
                    //                     //                                     },
                    //                     //                                     child: Padding(
                    //                     //                                       padding:
                    //                     //                                       const EdgeInsets
                    //                     //                                           .all(
                    //                     //                                           8.0),
                    //                     //                                       child: Card(
                    //                     //                                         elevation:
                    //                     //                                         8,
                    //                     //                                         color: Colors
                    //                     //                                             .grey,
                    //                     //                                         child: Center(
                    //                     //                                             child: Padding(
                    //                     //                                               padding: const EdgeInsets
                    //                     //                                                   .all(
                    //                     //                                                   15.0),
                    //                     //                                               child:
                    //                     //                                               Text(
                    //                     //                                                 "Cancel",
                    //                     //                                                 style: TextStyle(
                    //                     //                                                     color:
                    //                     //                                                     Colors.white,
                    //                     //                                                     fontWeight: FontWeight.bold),
                    //                     //                                               ),
                    //                     //                                             )),
                    //                     //                                       ),
                    //                     //                                     ),
                    //                     //                                   )),
                    //                     //                               Expanded(
                    //                     //                                   child:
                    //                     //                                   InkWell(
                    //                     //                                     onTap: () {
                    //                     //                                       widget
                    //                     //                                           .customerFirestore
                    //                     //                                           .collection(
                    //                     //                                           "folders")
                    //                     //                                           .doc(snapshot.data!.docs[index].id)
                    //                     //                                           .delete()
                    //                     //                                           .then(
                    //                     //                                               (value) {
                    //                     //                                             Navigator.pop(
                    //                     //                                                 context);
                    //                     //                                           });
                    //                     //                                     },
                    //                     //                                     child: Padding(
                    //                     //                                       padding:
                    //                     //                                       const EdgeInsets
                    //                     //                                           .all(
                    //                     //                                           8.0),
                    //                     //                                       child: Card(
                    //                     //                                         elevation:
                    //                     //                                         8,
                    //                     //                                         color: Theme.of(
                    //                     //                                             context)
                    //                     //                                             .primaryColor,
                    //                     //                                         child: Center(
                    //                     //                                             child: Padding(
                    //                     //                                               padding: const EdgeInsets
                    //                     //                                                   .all(
                    //                     //                                                   15.0),
                    //                     //                                               child:
                    //                     //                                               Text(
                    //                     //                                                 "Delete",
                    //                     //                                                 style: TextStyle(
                    //                     //                                                     color:
                    //                     //                                                     Colors.white,
                    //                     //                                                     fontWeight: FontWeight.bold),
                    //                     //                                               ),
                    //                     //                                             )),
                    //                     //                                       ),
                    //                     //                                     ),
                    //                     //                                   )),
                    //                     //                             ],
                    //                     //                           ),
                    //                     //                         ],
                    //                     //                       );
                    //                     //                     });
                    //                     //               }
                    //                     //
                    //                     //               if (value == folderAction.move) {
                    //                     //                 //rename folder
                    //                     //                 showModalBottomSheet(
                    //                     //                     context: context,
                    //                     //                     builder: (builder) {
                    //                     //                       return new Wrap(
                    //                     //                         children: [
                    //                     //                           ListTile(
                    //                     //                             title: Text(
                    //                     //                               "Move Folder",
                    //                     //                               style: TextStyle(
                    //                     //                                   fontSize: 20,
                    //                     //                                   color: Theme.of(
                    //                     //                                       context)
                    //                     //                                       .primaryColor),
                    //                     //                             ),
                    //                     //                             trailing: Padding(
                    //                     //                               padding:
                    //                     //                               const EdgeInsets
                    //                     //                                   .all(8.0),
                    //                     //                               child: InkWell(
                    //                     //                                 onTap: () {
                    //                     //                                   Navigator.of(
                    //                     //                                       context)
                    //                     //                                       .pop();
                    //                     //                                 },
                    //                     //                                 child: Icon(
                    //                     //                                     Icons
                    //                     //                                         .close),
                    //                     //                               ),
                    //                     //                             ),
                    //                     //                           ),
                    //                     //                           Padding(
                    //                     //                             padding:
                    //                     //                             const EdgeInsets
                    //                     //                                 .all(8.0),
                    //                     //                             child: Text(
                    //                     //                               "Move Folder",
                    //                     //                               style: TextStyle(
                    //                     //                                   fontSize: 20,
                    //                     //                                   color: Theme.of(
                    //                     //                                       context)
                    //                     //                                       .primaryColor),
                    //                     //                             ),
                    //                     //                           ),
                    //                     //
                    //                     //                           MoveFolderActivity(
                    //                     //                             customerId: widget
                    //                     //                                 .customerId,
                    //                     //                             customerFirestore:
                    //                     //                             widget
                    //                     //                                 .customerFirestore,
                    //                     //                             curentFolderID:snapshot.data!.docs[index].id,locale: widget.locale,
                    //                     //                           ),
                    //                     //                           //here show move folder target
                    //                     //                         ],
                    //                     //                       );
                    //                     //                     });
                    //                     //               }
                    //                     //             },
                    //                     //             child:
                    //                     //             Center(child: Icon(Icons.menu)),
                    //                     //             itemBuilder: (BuildContext
                    //                     //             context) =>
                    //                     //             <PopupMenuEntry<folderAction>>[
                    //                     //               PopupMenuItem<folderAction>(
                    //                     //                 value: folderAction.rename,
                    //                     //                 child: Text('Rename'),
                    //                     //               ),
                    //                     //               PopupMenuItem<folderAction>(
                    //                     //                 value: folderAction.delete,
                    //                     //                 child: Text('Delete'),
                    //                     //               ),
                    //                     //               PopupMenuItem<folderAction>(
                    //                     //                 value: folderAction.move,
                    //                     //                 child: Text('Move'),
                    //                     //               ),
                    //                     //             ],
                    //                     //           ),
                    //                     //         ),
                    //                     //       ),
                    //                     //     ],
                    //                     //   ),
                    //                     // ),
                    //                     // Container(
                    //                     //
                    //                     //  // width: MediaQuery.of(context).size.width,
                    //                     //   child:showNextLevelFolder(snapshot.data!.docs[index].id),)
                    //
                    //                   ],
                    //                 ),
                    //
                    //                 // if(widget.isExpanded) showNextLevelFolder(snapshot.data!.docs[index].id),
                    //                 if(true) ExpandenFolderActivityLevel1(expand: expand,parentFolder: snapshot.data!.docs[index].id, customerId: widget.customerId,locale: widget.locale, customerFirestore: widget.customerFirestore,),
                    //                 //showTestItemsInFolder(snapshot.data!.docs[index].id),
                    //
                    //               ],
                    //             ),
                    //           ),),
                    //           // Align(alignment: Alignment.centerRight,child: addOrDeletePopMenuBox(snapshot.data!.docs[index].id),),
                    //         ],
                    //       ),
                    //       // if(widget.isExpanded)   Padding(padding: EdgeInsets.fromLTRB(40,0,0,0),child:  showTestItemsInFolder(snapshot.data!.docs[index].id),),
                    //       // if(widget.isExpanded)   Padding(padding: EdgeInsets.fromLTRB(40,0,0,0),child:ExpandedFiles(parentFolder: snapshot.data!.docs[index].id, customerId: widget.customerId,locale: widget.locale, customerFirestore: widget.customerFirestore,),),
                    //
                    //     ],
                    //   ),
                    // );
                    return  StreamBuilder<dynamic>(
                        stream: ExpandFolderStreamL1.getInstance().outData,
                        builder: (c, snapshotEx) {
                          if(snapshotEx.hasData && snapshotEx.data["id"] == filteredData[index].id )
                            return show(snapshotEx.data["expand"],filteredData[index].id);
                          else{
                            return show(false,filteredData[index].id);
                          }

                        });

                  });


              return Text( snapshot.data!.docs.length.toString());
            }else return Container(width: 0,height: 0,);
          });
    }catch(e){
      return Center(child:  Text("Something wrong"),);
    }


  }
  @override
  Widget build(BuildContext context) {
    return Column(children: [
      showNextLevelFolder(widget.parentFolder),
      // ExpandedFolders(parentFolder: widget.parentFolder, customerId: widget.customerId,locale: widget.locale, customerFirestore: widget.customerFirestore,),
      // ExpandedFiles(parentFolder: widget.parentFolder, customerId: widget.customerId,locale: widget.locale, customerFirestore: widget.customerFirestore,),

    ],);
  }

  addOrDeletePopMenuBox(String id,FirebaseFirestore firestore,String title) {
    addNewFolderNamePopUp(String id) {
      final _formKey = GlobalKey<FormState>();
      showDialog(
          context: context,
          builder: (
              context,
              ) {
            return StatefulBuilder(builder: (context, setState) {
              return AlertDialog(
                scrollable: true,
                shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.all(Radius.circular(10))),
                contentPadding: EdgeInsets.only(top: 10.0),
                content: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Container(
                      margin: EdgeInsets.only(
                          top: height * 0.01,
                          left: width * 0.04,
                          right: width * 0.04),
                      child: Row(
                        mainAxisAlignment: MainAxisAlignment.spaceBetween,
                        children: [
                          Text(
                            TextConst.addSubFolderText,
                            style: interSemiBold.copyWith(
                              color: ThemeManager().getBlackColor,
                              fontSize: width * 0.04,
                            ),
                          ),
                          InkWell(
                              onTap: () {
                                Navigator.of(context).pop();
                              },
                              child: Icon(
                                Icons.clear,
                                size: width * 0.06,
                                color: ThemeManager().getLightGrey4Color,
                              )),
                        ],
                      ),
                    ),
                    Container(
                      margin: EdgeInsets.only(top: height * 0.015),
                      height: height * 0.001,
                      color: ThemeManager().getBlackColor.withOpacity(0.19),
                    ),
                    Container(
                      margin: EdgeInsets.only(
                          top: height * 0.02,
                          left: width * 0.04,
                          right: width * 0.04),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text(
                            TextConst.folderNameText,
                            style: interMedium.copyWith(
                              color: ThemeManager().getPopUpTextGreyColor,
                              fontSize: width * 0.036,
                            ),
                          ),
                          Container(
                            margin: EdgeInsets.only(top: height * 0.015),
                            child: Form(
                              key: _formKey,
                              child: TextFormField(
                                controller: _folderNameController,
                                maxLength: 22,
                                autovalidateMode: AutovalidateMode.onUserInteraction,
                                keyboardType: TextInputType.text,
                                decoration: InputDecoration(
                                  counterText: "",
                                  border: InputBorder.none,
                                  hintText: TextConst.textFieldFolderText,
                                  hintStyle: interMedium.copyWith(
                                    color: ThemeManager().getLightGrey4Color,
                                    fontSize: width * 0.036,
                                  ),
                                  enabledBorder: OutlineInputBorder(
                                      borderSide: BorderSide(
                                        color: Colors.transparent,
                                      ),
                                      borderRadius:
                                      BorderRadius.circular(width * 0.014)),
                                  contentPadding: EdgeInsets.symmetric(
                                      vertical: height * 0.0,
                                      horizontal: width * 0.045),
                                  fillColor:
                                  ThemeManager().getLightGreenTextFieldColor,
                                  filled: true,
                                ),
                                validator: (value) {
                                  if (value!.isEmpty) {
                                    return "Please enter folder name";
                                  } else if (_folderNameController.text.length > 22) {
                                    return "Name should be 22 character only";
                                  }
                                },
                              ),
                            ),
                          ),
                          Container(
                            margin: EdgeInsets.only(top: height * 0.015),
                            child: Text(
                              "*Name must be within 10 characters.",
                              style: interMedium.copyWith(
                                color: ThemeManager().getPopUpTextGreyColor,
                                fontSize: width * 0.03,
                              ),
                            ),
                          ),
                          InkWell(
                            onTap: () async {
                              if (_formKey.currentState!.validate()) {

                                var r = await  AppFirestore(firestore: widget.customerFirestore, projectId: '', auth: FirebaseAuth.instance).createFolders(name:_folderNameController.text,parent: id );

                                if(r == true) {
                                  _folderNameController.clear();
                                  Navigator.of(context).pop();



                                }else{
                                  _folderNameController.clear();
                                  Navigator.of(context).pop();
                                  showDialog(context: context,
                                      builder: (BuildContext context){
                                        return FolderExistsPopUp();
                                      });
                                }






                              } else {}
                            },
                            child: Container(
                                margin: EdgeInsets.only(
                                    top: height * 0.04, bottom: height * 0.02),
                                child: ButtonView(
                                    buttonLabel: TextConst.saveButtonText)
                            ),
                          ),
                        ],
                      ),
                    ),
                  ],
                ),
              );
            });
          });
    }
    renameFolderNamePopUp(String id,String oldName) {
      _folderNameController = TextEditingController(text: title);
      final _formKey = GlobalKey<FormState>();
      showDialog(
          context: context,
          builder: (
              context,
              ) {
            return StatefulBuilder(builder: (context, setState) {
              return AlertDialog(
                scrollable: true,
                shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.all(Radius.circular(10))),
                contentPadding: EdgeInsets.only(top: 10.0),
                content: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Container(
                      margin: EdgeInsets.only(
                          top: height * 0.01,
                          left: width * 0.04,
                          right: width * 0.04),
                      child: Row(
                        mainAxisAlignment: MainAxisAlignment.spaceBetween,
                        children: [
                          Text("Rename",
                            style: interSemiBold.copyWith(
                              color: ThemeManager().getBlackColor,
                              fontSize: width * 0.04,
                            ),
                          ),
                          InkWell(
                              onTap: () {
                                Navigator.of(context).pop();
                              },
                              child: Icon(
                                Icons.clear,
                                size: width * 0.06,
                                color: ThemeManager().getLightGrey4Color,
                              )),
                        ],
                      ),
                    ),
                    Container(
                      margin: EdgeInsets.only(top: height * 0.015),
                      height: height * 0.001,
                      color: ThemeManager().getBlackColor.withOpacity(0.19),
                    ),
                    Container(
                      margin: EdgeInsets.only(
                          top: height * 0.02,
                          left: width * 0.04,
                          right: width * 0.04),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text("Subfolder Name",
                            style: interMedium.copyWith(
                              color: ThemeManager().getPopUpTextGreyColor,
                              fontSize: width * 0.036,
                            ),
                          ),
                          Container(
                            margin: EdgeInsets.only(top: height * 0.015),
                            child: Form(
                              key: _formKey,
                              child: TextFormField(
                                //initialValue: oldName,
                                controller: _folderNameController,
                                maxLength: 22,
                                autovalidateMode: AutovalidateMode.onUserInteraction,
                                keyboardType: TextInputType.text,
                                decoration: InputDecoration(
                                  counterText: "",
                                  border: InputBorder.none,
                                  hintText: TextConst.textFieldFolderText,
                                  hintStyle: interMedium.copyWith(
                                    color: ThemeManager().getLightGrey4Color,
                                    fontSize: width * 0.036,
                                  ),
                                  enabledBorder: OutlineInputBorder(
                                      borderSide: BorderSide(
                                        color: Colors.transparent,
                                      ),
                                      borderRadius:
                                      BorderRadius.circular(width * 0.014)),
                                  contentPadding: EdgeInsets.symmetric(
                                      vertical: height * 0.0,
                                      horizontal: width * 0.045),
                                  fillColor:
                                  ThemeManager().getLightGreenTextFieldColor,
                                  filled: true,
                                ),
                                validator: (value) {
                                  if (value!.isEmpty) {
                                    return "Please enter folder name";
                                  } else if (_folderNameController.text.length > 22) {
                                    return "Name should be 22 character only";
                                  }
                                },
                              ),
                            ),
                          ),
                          // Container(
                          //   margin: EdgeInsets.only(top: height * 0.015),
                          //   child: Text(
                          //     "*Name must be within 10 characters.",
                          //     style: interMedium.copyWith(
                          //       color: ThemeManager().getPopUpTextGreyColor,
                          //       fontSize: width * 0.03,
                          //     ),
                          //   ),
                          // ),
                          InkWell(
                            onTap: () async {
                              if (_formKey.currentState!.validate()) {
                                AppFirestore(firestore: widget.customerFirestore, projectId: '', auth: FirebaseAuth.instance).renameFolders(name:_folderNameController.text,parent: id );
                                //  Navigator.pop(context);
                                _folderNameController.clear();
                                Navigator.of(context).pop();
// Close progress dialog
//                                 final dialogContextCompleter = Completer<BuildContext>();
//                                 final dialogContext = await dialogContextCompleter.future;
//                                 Navigator.pop(dialogContext);
//                                 Navigator.of(context).pop();
                              } else {}
                            },
                            child: Container(
                                margin: EdgeInsets.only(
                                    top: height * 0.04, bottom: height * 0.02),
                                child: ButtonView(
                                    buttonLabel: TextConst.saveButtonText)
                            ),
                          ),
                        ],
                      ),
                    ),
                  ],
                ),
              );
            });
          });
    }
    return PopupMenuButton(
      elevation: 1,
      icon: Icon(Icons.more_horiz),

      itemBuilder: (context) => [
        PopupMenuItem(
          // padding: EdgeInsets.only(top: height * 0.01, left: width * 0.0065, right: width * 0.0065),

          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [

              InkWell(
                onTap: () {
                  //Navigator.of(context).pop();
                  //addNewFolderNamePopUp(id);
                },
                child: Container(
                  margin: EdgeInsets.only(
                      left: width * 0.005, right: width * 0.005),
                  alignment: Alignment.center,
                  child: Text(
                    TextConst.addNewFolderPopUpText,
                    style: interRegular.copyWith(
                        color: ThemeManager().getLightGrey1Color,
                        fontSize: width * 0.035),
                  ),
                ),
              ),

              Container(
                margin: EdgeInsets.only(
                    top: height * 0.01, bottom: height * 0.01),
                height: height * 0.001,
                width: double.infinity,
                color: ThemeManager().getBlackColor.withOpacity(0.19),
              ),
              InkWell(
                onTap: () {
                  renameFolderNamePopUp(id,title);

                },
                child: Container(
                    alignment: Alignment.center,
                    child: Text("Rename",
                      style: interRegular.copyWith(
                          color: ThemeManager().getBlackColor,
                          fontSize: width * 0.035),
                    )),
              ),
              Container(
                margin: EdgeInsets.only(
                    top: height * 0.01, bottom: height * 0.01),
                height: height * 0.001,
                width: double.infinity,
                color: ThemeManager().getBlackColor.withOpacity(0.19),
              ),
              InkWell(
                onTap: () {
                  showDialog(context: context,
                      builder: (BuildContext context){
                        return DeleteFolderPopUp(title:title, onClickAction: (answer ) {
                          if(answer == true){
                            widget.customerFirestore.collection("folders").doc(id).delete();
                            Navigator.of(context).pop();

                          }else{
                            Navigator.of(context).pop();
                          }
                        },);
                      }
                  );

                },
                child: Container(
                    alignment: Alignment.center,
                    child: Text(
                      TextConst.deleteFolderPopUpText,
                      style: interRegular.copyWith(
                          color: ThemeManager().getBlackColor,
                          fontSize: width * 0.035),
                    )),
              )
            ],
          ),
          // value: 1,
        ),
      ],
    );
  }
}

class ExpandenFolderActivityLevel2 extends StatefulWidget {
  String parentFolder;
  String customerId;

  FirebaseFirestore customerFirestore;
  Locale locale;
  bool expand;
  ExpandenFolderActivityLevel2({required this.expand,required this.parentFolder,required this.customerFirestore,required this.customerId,required this.locale});

  @override
  _ExpandenFolderActivityLevel2State createState() => _ExpandenFolderActivityLevel2State();
}

class _ExpandenFolderActivityLevel2State extends State<ExpandenFolderActivityLevel2> {

  showNextLevelFolder(String data) {
    int step = 0;

    return StreamBuilder<QuerySnapshot>(
        stream: AppFirestore(firestore: widget.customerFirestore,projectId: "",auth: FirebaseAuth.instance).getFolders(parentFolder: data),
        builder: (context, snapshot) {
          if (snapshot.hasData && snapshot.data!.docs.length>0) {
            step++;
            return   ListView.builder(
                physics: ClampingScrollPhysics(),
                // separatorBuilder: (context, index) {
                //   return Divider();
                // },
                shrinkWrap: true,
                padding: EdgeInsets.zero,
                itemCount: snapshot.data!.docs.length,
                itemBuilder: (_, index) {

                  show(bool expand,String id){

                    return   Column(
                      children: [
                        Stack(
                          children: [
                            Align(alignment: Alignment.centerLeft,child: Column(
                              children: [
                                Container(
                                  //color: expand?ThemeManager().getLightYellowColor:Colors.white,
                                  child: Row(
                                    children: [
                                      GestureDetector(
                                        onTap: () {
                                          try{
                                            print(!expand );
                                            print(snapshot.data!.docs[index].id );
                                            ExpandFolderStreamL2.getInstance().dataReload({"id":snapshot.data!.docs[index].id,"expand":!expand});
                                          }catch(e){
                                            print("enpand er");
                                            print(e);
                                          }
                                        },
                                        //newFolder.isExpanded == fals
                                        child: expand
                                            ? Icon(
                                          Icons.keyboard_arrow_up_outlined,
                                          size: width * 0.085,
                                          color: ThemeManager().getDarkGrey2Color,
                                        )
                                            : Icon(
                                          Icons.keyboard_arrow_down_outlined,
                                          size: width * 0.085,
                                          color: ThemeManager().getDarkGrey2Color,
                                        ),
                                      ),
                                      Container(
                                        margin: EdgeInsets.only(
                                         left: width * 0.02,
                                        ),
                                        child: SvgPicture.asset(
                                          ("assets/svg/folderIcon.svg"),
                                          fit: BoxFit.cover,
                                        ),
                                      ),
                                      Container(
                                          margin: EdgeInsets.only(
                                            left: width * 0.03,
                                          ),
                                          child: Text(
                                            snapshot.data!.docs[index]["name"],
                                            style: interRegular.copyWith(
                                              color: ThemeManager().getBlackColor,
                                              fontSize: width * 0.045,
                                            ),
                                          )),

                                      // Container(
                                      // //  height: 50,
                                      //   width: MediaQuery.of(context).size.width,
                                      //   child: Stack(
                                      //     children: [
                                      //       Align(
                                      //         alignment: Alignment.centerLeft,
                                      //         child: Row(
                                      //           children: [
                                      //             GestureDetector(
                                      //               onTap: () {
                                      //                 // setState(() {
                                      //                 //   newFolder.isExpanded = !(newFolder.isExpanded);
                                      //                 //   newFolder.isVisible = !newFolder.isVisible;
                                      //                 // });
                                      //               },
                                      //               //newFolder.isExpanded == fals
                                      //               child: false
                                      //                   ? Icon(
                                      //                 Icons.keyboard_arrow_up_outlined,
                                      //                 size: width * 0.085,
                                      //                 color: ThemeManager().getDarkGrey2Color,
                                      //               )
                                      //                   : Icon(
                                      //                 Icons.keyboard_arrow_down_outlined,
                                      //                 size: width * 0.085,
                                      //                 color: ThemeManager().getDarkGrey2Color,
                                      //               ),
                                      //             ),
                                      //             Container(
                                      //               margin: EdgeInsets.only(
                                      //                 left: width * 0.02,
                                      //               ),
                                      //               child: SvgPicture.asset(
                                      //                 ("assets/svg/folderIcon.svg"),
                                      //                 fit: BoxFit.cover,
                                      //               ),
                                      //             ),
                                      //             Container(
                                      //                 margin: EdgeInsets.only(
                                      //                   left: width * 0.03,
                                      //                 ),
                                      //                 child: Text(
                                      //                   snapshot.data!.docs[index]["name"],
                                      //                   style: interRegular.copyWith(
                                      //                     color: ThemeManager().getBlackColor,
                                      //                     fontSize: width * 0.045,
                                      //                   ),
                                      //                 ))
                                      //             // Column(
                                      //             //   mainAxisAlignment:
                                      //             //   MainAxisAlignment.center,
                                      //             //   crossAxisAlignment:
                                      //             //   CrossAxisAlignment.start,
                                      //             //   children: [
                                      //             //
                                      //             //     Text(
                                      //             //       snapshot.data!.docs[index]["name"]
                                      //             //           .toString(),
                                      //             //       style: TextStyle(
                                      //             //           fontWeight:
                                      //             //           FontWeight.bold,
                                      //             //           color: Colors.black),
                                      //             //     ),
                                      //             //     timeFormate(snapshot.data!.docs[index]["created_at"]),
                                      //             //   ],
                                      //             // ),
                                      //           ],
                                      //         ),
                                      //       ),
                                      //       Align(
                                      //         alignment: Alignment.centerRight,
                                      //         child: Container(
                                      //           height: MediaQuery.of(context)
                                      //               .size
                                      //               .height,
                                      //           width: 50,
                                      //           child: PopupMenuButton<folderAction>(
                                      //             onSelected: (folderAction value) {
                                      //               if (value ==
                                      //                   folderAction.rename) {
                                      //                 //rename folder
                                      //                 TextEditingController
                                      //                 controller =
                                      //                 TextEditingController(
                                      //                     text: snapshot.data!.docs[index]
                                      //                     ["name"]
                                      //                         .toString());
                                      //
                                      //                 Navigator.of(context)
                                      //                     .push(
                                      //                     new MaterialPageRoute<
                                      //                         Null>(
                                      //                         builder:
                                      //                             (BuildContext
                                      //                         context) {
                                      //                           return Scaffold(
                                      //                             appBar: AppBar(
                                      //                               title: Text(
                                      //                                   "Rename Folder"),
                                      //                             ),
                                      //                             body: Container(
                                      //                               decoration:
                                      //                               BoxDecoration(
                                      //                                 color: Color
                                      //                                     .fromARGB(
                                      //                                     255,
                                      //                                     247,
                                      //                                     247,
                                      //                                     247),
                                      //                                 borderRadius: BorderRadius.only(
                                      //                                     topLeft:
                                      //                                     Radius.circular(
                                      //                                         10.0),
                                      //                                     topRight:
                                      //                                     Radius.circular(10.0)),
                                      //                               ),
                                      //                               child:
                                      //                               Padding(
                                      //                                 padding: const EdgeInsets
                                      //                                     .all(
                                      //                                     15.0),
                                      //                                 child: Wrap(
                                      //                                   children: [
                                      //                                     Padding(
                                      //                                       padding:
                                      //                                       const EdgeInsets.all(8.0),
                                      //                                       child:
                                      //                                       TextFormField(
                                      //                                         controller:
                                      //                                         controller,
                                      //                                         autofocus:
                                      //                                         true,
                                      //                                         decoration:
                                      //                                         InputDecoration(
                                      //                                           labelText: 'Folder Name',
                                      //                                           border: OutlineInputBorder(),
                                      //                                         ),
                                      //                                       ),
                                      //                                     ),
                                      //                                     InkWell(
                                      //                                       onTap:
                                      //                                           () {
                                      //                                         widget.customerFirestore.collection("folders").doc(snapshot.data!.docs[index].id).update({
                                      //                                           "name": controller.text
                                      //                                         }).then((value) {
                                      //                                           Navigator.pop(context);
                                      //                                         });
                                      //                                       },
                                      //                                       child:
                                      //                                       Card(
                                      //                                         color:
                                      //                                         Theme.of(context).primaryColor,
                                      //                                         child: Center(
                                      //                                             child: Padding(
                                      //                                               padding: const EdgeInsets.all(10.0),
                                      //                                               child: Text(
                                      //                                                 "Submit",
                                      //                                                 style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold),
                                      //                                               ),
                                      //                                             )),
                                      //                                       ),
                                      //                                     )
                                      //                                   ],
                                      //                                 ),
                                      //                               ),
                                      //                             ),
                                      //                           );
                                      //                         },
                                      //                         fullscreenDialog:
                                      //                         true));
                                      //               }
                                      //               if (value ==
                                      //                   folderAction.delete) {
                                      //                 //rename folder
                                      //                 showModalBottomSheet(
                                      //                     context: context,
                                      //                     builder: (builder) {
                                      //                       return new Wrap(
                                      //                         children: [
                                      //                           Padding(
                                      //                             padding:
                                      //                             const EdgeInsets
                                      //                                 .all(8.0),
                                      //                             child: Text(
                                      //                               "Do you want to delete this Folder?",
                                      //                               style: TextStyle(
                                      //                                   fontSize: 20,
                                      //                                   color: Theme.of(
                                      //                                       context)
                                      //                                       .primaryColor),
                                      //                             ),
                                      //                           ),
                                      //                           Row(
                                      //                             children: [
                                      //                               Expanded(
                                      //                                   child:
                                      //                                   InkWell(
                                      //                                     onTap: () {
                                      //                                       Navigator.of(
                                      //                                           context)
                                      //                                           .pop();
                                      //                                     },
                                      //                                     child: Padding(
                                      //                                       padding:
                                      //                                       const EdgeInsets
                                      //                                           .all(
                                      //                                           8.0),
                                      //                                       child: Card(
                                      //                                         elevation:
                                      //                                         8,
                                      //                                         color: Colors
                                      //                                             .grey,
                                      //                                         child: Center(
                                      //                                             child: Padding(
                                      //                                               padding: const EdgeInsets
                                      //                                                   .all(
                                      //                                                   15.0),
                                      //                                               child:
                                      //                                               Text(
                                      //                                                 "Cancel",
                                      //                                                 style: TextStyle(
                                      //                                                     color:
                                      //                                                     Colors.white,
                                      //                                                     fontWeight: FontWeight.bold),
                                      //                                               ),
                                      //                                             )),
                                      //                                       ),
                                      //                                     ),
                                      //                                   )),
                                      //                               Expanded(
                                      //                                   child:
                                      //                                   InkWell(
                                      //                                     onTap: () {
                                      //                                       widget
                                      //                                           .customerFirestore
                                      //                                           .collection(
                                      //                                           "folders")
                                      //                                           .doc(snapshot.data!.docs[index].id)
                                      //                                           .delete()
                                      //                                           .then(
                                      //                                               (value) {
                                      //                                             Navigator.pop(
                                      //                                                 context);
                                      //                                           });
                                      //                                     },
                                      //                                     child: Padding(
                                      //                                       padding:
                                      //                                       const EdgeInsets
                                      //                                           .all(
                                      //                                           8.0),
                                      //                                       child: Card(
                                      //                                         elevation:
                                      //                                         8,
                                      //                                         color: Theme.of(
                                      //                                             context)
                                      //                                             .primaryColor,
                                      //                                         child: Center(
                                      //                                             child: Padding(
                                      //                                               padding: const EdgeInsets
                                      //                                                   .all(
                                      //                                                   15.0),
                                      //                                               child:
                                      //                                               Text(
                                      //                                                 "Delete",
                                      //                                                 style: TextStyle(
                                      //                                                     color:
                                      //                                                     Colors.white,
                                      //                                                     fontWeight: FontWeight.bold),
                                      //                                               ),
                                      //                                             )),
                                      //                                       ),
                                      //                                     ),
                                      //                                   )),
                                      //                             ],
                                      //                           ),
                                      //                         ],
                                      //                       );
                                      //                     });
                                      //               }
                                      //
                                      //               if (value == folderAction.move) {
                                      //                 //rename folder
                                      //                 showModalBottomSheet(
                                      //                     context: context,
                                      //                     builder: (builder) {
                                      //                       return new Wrap(
                                      //                         children: [
                                      //                           ListTile(
                                      //                             title: Text(
                                      //                               "Move Folder",
                                      //                               style: TextStyle(
                                      //                                   fontSize: 20,
                                      //                                   color: Theme.of(
                                      //                                       context)
                                      //                                       .primaryColor),
                                      //                             ),
                                      //                             trailing: Padding(
                                      //                               padding:
                                      //                               const EdgeInsets
                                      //                                   .all(8.0),
                                      //                               child: InkWell(
                                      //                                 onTap: () {
                                      //                                   Navigator.of(
                                      //                                       context)
                                      //                                       .pop();
                                      //                                 },
                                      //                                 child: Icon(
                                      //                                     Icons
                                      //                                         .close),
                                      //                               ),
                                      //                             ),
                                      //                           ),
                                      //                           Padding(
                                      //                             padding:
                                      //                             const EdgeInsets
                                      //                                 .all(8.0),
                                      //                             child: Text(
                                      //                               "Move Folder",
                                      //                               style: TextStyle(
                                      //                                   fontSize: 20,
                                      //                                   color: Theme.of(
                                      //                                       context)
                                      //                                       .primaryColor),
                                      //                             ),
                                      //                           ),
                                      //
                                      //                           MoveFolderActivity(
                                      //                             customerId: widget
                                      //                                 .customerId,
                                      //                             customerFirestore:
                                      //                             widget
                                      //                                 .customerFirestore,
                                      //                             curentFolderID:snapshot.data!.docs[index].id,locale: widget.locale,
                                      //                           ),
                                      //                           //here show move folder target
                                      //                         ],
                                      //                       );
                                      //                     });
                                      //               }
                                      //             },
                                      //             child:
                                      //             Center(child: Icon(Icons.menu)),
                                      //             itemBuilder: (BuildContext
                                      //             context) =>
                                      //             <PopupMenuEntry<folderAction>>[
                                      //               PopupMenuItem<folderAction>(
                                      //                 value: folderAction.rename,
                                      //                 child: Text('Rename'),
                                      //               ),
                                      //               PopupMenuItem<folderAction>(
                                      //                 value: folderAction.delete,
                                      //                 child: Text('Delete'),
                                      //               ),
                                      //               PopupMenuItem<folderAction>(
                                      //                 value: folderAction.move,
                                      //                 child: Text('Move'),
                                      //               ),
                                      //             ],
                                      //           ),
                                      //         ),
                                      //       ),
                                      //     ],
                                      //   ),
                                      // ),
                                      // Container(
                                      //
                                      //  // width: MediaQuery.of(context).size.width,
                                      //   child:showNextLevelFolder(snapshot.data!.docs[index].id),)

                                    ],
                                  ),
                                ),

                                // if(widget.isExpanded) showNextLevelFolder(snapshot.data!.docs[index].id),
                                if(expand) Padding(
                                  padding: indendfolderPadding,
                                  child: ExpandenFolderActivityLevel3(parentFolder: snapshot.data!.docs[index].id, customerId: widget.customerId,locale: widget.locale, customerFirestore: widget.customerFirestore,  isExpanded: false,),
                                ),
                                if(expand) Padding(
                                  padding: indendfolderPadding,
                                  child: showTestItemsInFolder(snapshot.data!.docs[index].id,widget.customerFirestore,widget.customerId,widget.locale),
                                ),
                              ],
                            ),),
                             Align(alignment: Alignment.centerRight,child: addOrDeletePopMenuBox(snapshot.data!.docs[index].id),),
                          ],
                        ),
                        // if(widget.isExpanded)   Padding(padding: EdgeInsets.fromLTRB(40,0,0,0),child:  showTestItemsInFolder(snapshot.data!.docs[index].id),),
                        // if(widget.isExpanded)   Padding(padding: EdgeInsets.fromLTRB(40,0,0,0),child:ExpandedFiles(parentFolder: snapshot.data!.docs[index].id, customerId: widget.customerId,locale: widget.locale, customerFirestore: widget.customerFirestore,),),

                      ],
                    );
                  }
                  // return   Padding(
                  //   padding:  EdgeInsets.fromLTRB((step* 20), 2, 0, 2),
                  //   child: Column(
                  //     children: [
                  //       Stack(
                  //         children: [
                  //           Align(alignment: Alignment.centerLeft,child: Padding(
                  //             padding:  EdgeInsets.fromLTRB(0, 0, 0, 0),
                  //             child: Column(
                  //               children: [
                  //                 Row(
                  //                   children: [
                  //                     GestureDetector(
                  //                       onTap: () {
                  //
                  //                         setState(() {
                  //                           expand = !expand;
                  //                         });
                  //
                  //                         // try{
                  //                         //   ExpandFolderStream.getInstance().dataReload({"id":snapshot.data!.docs[index].id,"expand":!expand});
                  //                         // }catch(e){
                  //                         //   print("enpand er");
                  //                         //   print(e);
                  //                         // }
                  //                       },
                  //                       //newFolder.isExpanded == fals
                  //                       child: expand
                  //                           ? Icon(
                  //                         Icons.keyboard_arrow_up_outlined,
                  //                         size: width * 0.085,
                  //                         color: ThemeManager().getDarkGrey2Color,
                  //                       )
                  //                           : Icon(
                  //                         Icons.keyboard_arrow_down_outlined,
                  //                         size: width * 0.085,
                  //                         color: ThemeManager().getDarkGrey2Color,
                  //                       ),
                  //                     ),
                  //                     Container(
                  //                       margin: EdgeInsets.only(
                  //                         left: width * 0.02,
                  //                       ),
                  //                       child: SvgPicture.asset(
                  //                         ("assets/svg/folderIcon.svg"),
                  //                         fit: BoxFit.cover,
                  //                       ),
                  //                     ),
                  //                     Container(
                  //                         margin: EdgeInsets.only(
                  //                           left: width * 0.03,
                  //                         ),
                  //                         child: Text(
                  //                           snapshot.data!.docs[index]["name"],
                  //                           style: interRegular.copyWith(
                  //                             color: ThemeManager().getBlackColor,
                  //                             fontSize: width * 0.045,
                  //                           ),
                  //                         )),
                  //
                  //                     // Container(
                  //                     // //  height: 50,
                  //                     //   width: MediaQuery.of(context).size.width,
                  //                     //   child: Stack(
                  //                     //     children: [
                  //                     //       Align(
                  //                     //         alignment: Alignment.centerLeft,
                  //                     //         child: Row(
                  //                     //           children: [
                  //                     //             GestureDetector(
                  //                     //               onTap: () {
                  //                     //                 // setState(() {
                  //                     //                 //   newFolder.isExpanded = !(newFolder.isExpanded);
                  //                     //                 //   newFolder.isVisible = !newFolder.isVisible;
                  //                     //                 // });
                  //                     //               },
                  //                     //               //newFolder.isExpanded == fals
                  //                     //               child: false
                  //                     //                   ? Icon(
                  //                     //                 Icons.keyboard_arrow_up_outlined,
                  //                     //                 size: width * 0.085,
                  //                     //                 color: ThemeManager().getDarkGrey2Color,
                  //                     //               )
                  //                     //                   : Icon(
                  //                     //                 Icons.keyboard_arrow_down_outlined,
                  //                     //                 size: width * 0.085,
                  //                     //                 color: ThemeManager().getDarkGrey2Color,
                  //                     //               ),
                  //                     //             ),
                  //                     //             Container(
                  //                     //               margin: EdgeInsets.only(
                  //                     //                 left: width * 0.02,
                  //                     //               ),
                  //                     //               child: SvgPicture.asset(
                  //                     //                 ("assets/svg/folderIcon.svg"),
                  //                     //                 fit: BoxFit.cover,
                  //                     //               ),
                  //                     //             ),
                  //                     //             Container(
                  //                     //                 margin: EdgeInsets.only(
                  //                     //                   left: width * 0.03,
                  //                     //                 ),
                  //                     //                 child: Text(
                  //                     //                   snapshot.data!.docs[index]["name"],
                  //                     //                   style: interRegular.copyWith(
                  //                     //                     color: ThemeManager().getBlackColor,
                  //                     //                     fontSize: width * 0.045,
                  //                     //                   ),
                  //                     //                 ))
                  //                     //             // Column(
                  //                     //             //   mainAxisAlignment:
                  //                     //             //   MainAxisAlignment.center,
                  //                     //             //   crossAxisAlignment:
                  //                     //             //   CrossAxisAlignment.start,
                  //                     //             //   children: [
                  //                     //             //
                  //                     //             //     Text(
                  //                     //             //       snapshot.data!.docs[index]["name"]
                  //                     //             //           .toString(),
                  //                     //             //       style: TextStyle(
                  //                     //             //           fontWeight:
                  //                     //             //           FontWeight.bold,
                  //                     //             //           color: Colors.black),
                  //                     //             //     ),
                  //                     //             //     timeFormate(snapshot.data!.docs[index]["created_at"]),
                  //                     //             //   ],
                  //                     //             // ),
                  //                     //           ],
                  //                     //         ),
                  //                     //       ),
                  //                     //       Align(
                  //                     //         alignment: Alignment.centerRight,
                  //                     //         child: Container(
                  //                     //           height: MediaQuery.of(context)
                  //                     //               .size
                  //                     //               .height,
                  //                     //           width: 50,
                  //                     //           child: PopupMenuButton<folderAction>(
                  //                     //             onSelected: (folderAction value) {
                  //                     //               if (value ==
                  //                     //                   folderAction.rename) {
                  //                     //                 //rename folder
                  //                     //                 TextEditingController
                  //                     //                 controller =
                  //                     //                 TextEditingController(
                  //                     //                     text: snapshot.data!.docs[index]
                  //                     //                     ["name"]
                  //                     //                         .toString());
                  //                     //
                  //                     //                 Navigator.of(context)
                  //                     //                     .push(
                  //                     //                     new MaterialPageRoute<
                  //                     //                         Null>(
                  //                     //                         builder:
                  //                     //                             (BuildContext
                  //                     //                         context) {
                  //                     //                           return Scaffold(
                  //                     //                             appBar: AppBar(
                  //                     //                               title: Text(
                  //                     //                                   "Rename Folder"),
                  //                     //                             ),
                  //                     //                             body: Container(
                  //                     //                               decoration:
                  //                     //                               BoxDecoration(
                  //                     //                                 color: Color
                  //                     //                                     .fromARGB(
                  //                     //                                     255,
                  //                     //                                     247,
                  //                     //                                     247,
                  //                     //                                     247),
                  //                     //                                 borderRadius: BorderRadius.only(
                  //                     //                                     topLeft:
                  //                     //                                     Radius.circular(
                  //                     //                                         10.0),
                  //                     //                                     topRight:
                  //                     //                                     Radius.circular(10.0)),
                  //                     //                               ),
                  //                     //                               child:
                  //                     //                               Padding(
                  //                     //                                 padding: const EdgeInsets
                  //                     //                                     .all(
                  //                     //                                     15.0),
                  //                     //                                 child: Wrap(
                  //                     //                                   children: [
                  //                     //                                     Padding(
                  //                     //                                       padding:
                  //                     //                                       const EdgeInsets.all(8.0),
                  //                     //                                       child:
                  //                     //                                       TextFormField(
                  //                     //                                         controller:
                  //                     //                                         controller,
                  //                     //                                         autofocus:
                  //                     //                                         true,
                  //                     //                                         decoration:
                  //                     //                                         InputDecoration(
                  //                     //                                           labelText: 'Folder Name',
                  //                     //                                           border: OutlineInputBorder(),
                  //                     //                                         ),
                  //                     //                                       ),
                  //                     //                                     ),
                  //                     //                                     InkWell(
                  //                     //                                       onTap:
                  //                     //                                           () {
                  //                     //                                         widget.customerFirestore.collection("folders").doc(snapshot.data!.docs[index].id).update({
                  //                     //                                           "name": controller.text
                  //                     //                                         }).then((value) {
                  //                     //                                           Navigator.pop(context);
                  //                     //                                         });
                  //                     //                                       },
                  //                     //                                       child:
                  //                     //                                       Card(
                  //                     //                                         color:
                  //                     //                                         Theme.of(context).primaryColor,
                  //                     //                                         child: Center(
                  //                     //                                             child: Padding(
                  //                     //                                               padding: const EdgeInsets.all(10.0),
                  //                     //                                               child: Text(
                  //                     //                                                 "Submit",
                  //                     //                                                 style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold),
                  //                     //                                               ),
                  //                     //                                             )),
                  //                     //                                       ),
                  //                     //                                     )
                  //                     //                                   ],
                  //                     //                                 ),
                  //                     //                               ),
                  //                     //                             ),
                  //                     //                           );
                  //                     //                         },
                  //                     //                         fullscreenDialog:
                  //                     //                         true));
                  //                     //               }
                  //                     //               if (value ==
                  //                     //                   folderAction.delete) {
                  //                     //                 //rename folder
                  //                     //                 showModalBottomSheet(
                  //                     //                     context: context,
                  //                     //                     builder: (builder) {
                  //                     //                       return new Wrap(
                  //                     //                         children: [
                  //                     //                           Padding(
                  //                     //                             padding:
                  //                     //                             const EdgeInsets
                  //                     //                                 .all(8.0),
                  //                     //                             child: Text(
                  //                     //                               "Do you want to delete this Folder?",
                  //                     //                               style: TextStyle(
                  //                     //                                   fontSize: 20,
                  //                     //                                   color: Theme.of(
                  //                     //                                       context)
                  //                     //                                       .primaryColor),
                  //                     //                             ),
                  //                     //                           ),
                  //                     //                           Row(
                  //                     //                             children: [
                  //                     //                               Expanded(
                  //                     //                                   child:
                  //                     //                                   InkWell(
                  //                     //                                     onTap: () {
                  //                     //                                       Navigator.of(
                  //                     //                                           context)
                  //                     //                                           .pop();
                  //                     //                                     },
                  //                     //                                     child: Padding(
                  //                     //                                       padding:
                  //                     //                                       const EdgeInsets
                  //                     //                                           .all(
                  //                     //                                           8.0),
                  //                     //                                       child: Card(
                  //                     //                                         elevation:
                  //                     //                                         8,
                  //                     //                                         color: Colors
                  //                     //                                             .grey,
                  //                     //                                         child: Center(
                  //                     //                                             child: Padding(
                  //                     //                                               padding: const EdgeInsets
                  //                     //                                                   .all(
                  //                     //                                                   15.0),
                  //                     //                                               child:
                  //                     //                                               Text(
                  //                     //                                                 "Cancel",
                  //                     //                                                 style: TextStyle(
                  //                     //                                                     color:
                  //                     //                                                     Colors.white,
                  //                     //                                                     fontWeight: FontWeight.bold),
                  //                     //                                               ),
                  //                     //                                             )),
                  //                     //                                       ),
                  //                     //                                     ),
                  //                     //                                   )),
                  //                     //                               Expanded(
                  //                     //                                   child:
                  //                     //                                   InkWell(
                  //                     //                                     onTap: () {
                  //                     //                                       widget
                  //                     //                                           .customerFirestore
                  //                     //                                           .collection(
                  //                     //                                           "folders")
                  //                     //                                           .doc(snapshot.data!.docs[index].id)
                  //                     //                                           .delete()
                  //                     //                                           .then(
                  //                     //                                               (value) {
                  //                     //                                             Navigator.pop(
                  //                     //                                                 context);
                  //                     //                                           });
                  //                     //                                     },
                  //                     //                                     child: Padding(
                  //                     //                                       padding:
                  //                     //                                       const EdgeInsets
                  //                     //                                           .all(
                  //                     //                                           8.0),
                  //                     //                                       child: Card(
                  //                     //                                         elevation:
                  //                     //                                         8,
                  //                     //                                         color: Theme.of(
                  //                     //                                             context)
                  //                     //                                             .primaryColor,
                  //                     //                                         child: Center(
                  //                     //                                             child: Padding(
                  //                     //                                               padding: const EdgeInsets
                  //                     //                                                   .all(
                  //                     //                                                   15.0),
                  //                     //                                               child:
                  //                     //                                               Text(
                  //                     //                                                 "Delete",
                  //                     //                                                 style: TextStyle(
                  //                     //                                                     color:
                  //                     //                                                     Colors.white,
                  //                     //                                                     fontWeight: FontWeight.bold),
                  //                     //                                               ),
                  //                     //                                             )),
                  //                     //                                       ),
                  //                     //                                     ),
                  //                     //                                   )),
                  //                     //                             ],
                  //                     //                           ),
                  //                     //                         ],
                  //                     //                       );
                  //                     //                     });
                  //                     //               }
                  //                     //
                  //                     //               if (value == folderAction.move) {
                  //                     //                 //rename folder
                  //                     //                 showModalBottomSheet(
                  //                     //                     context: context,
                  //                     //                     builder: (builder) {
                  //                     //                       return new Wrap(
                  //                     //                         children: [
                  //                     //                           ListTile(
                  //                     //                             title: Text(
                  //                     //                               "Move Folder",
                  //                     //                               style: TextStyle(
                  //                     //                                   fontSize: 20,
                  //                     //                                   color: Theme.of(
                  //                     //                                       context)
                  //                     //                                       .primaryColor),
                  //                     //                             ),
                  //                     //                             trailing: Padding(
                  //                     //                               padding:
                  //                     //                               const EdgeInsets
                  //                     //                                   .all(8.0),
                  //                     //                               child: InkWell(
                  //                     //                                 onTap: () {
                  //                     //                                   Navigator.of(
                  //                     //                                       context)
                  //                     //                                       .pop();
                  //                     //                                 },
                  //                     //                                 child: Icon(
                  //                     //                                     Icons
                  //                     //                                         .close),
                  //                     //                               ),
                  //                     //                             ),
                  //                     //                           ),
                  //                     //                           Padding(
                  //                     //                             padding:
                  //                     //                             const EdgeInsets
                  //                     //                                 .all(8.0),
                  //                     //                             child: Text(
                  //                     //                               "Move Folder",
                  //                     //                               style: TextStyle(
                  //                     //                                   fontSize: 20,
                  //                     //                                   color: Theme.of(
                  //                     //                                       context)
                  //                     //                                       .primaryColor),
                  //                     //                             ),
                  //                     //                           ),
                  //                     //
                  //                     //                           MoveFolderActivity(
                  //                     //                             customerId: widget
                  //                     //                                 .customerId,
                  //                     //                             customerFirestore:
                  //                     //                             widget
                  //                     //                                 .customerFirestore,
                  //                     //                             curentFolderID:snapshot.data!.docs[index].id,locale: widget.locale,
                  //                     //                           ),
                  //                     //                           //here show move folder target
                  //                     //                         ],
                  //                     //                       );
                  //                     //                     });
                  //                     //               }
                  //                     //             },
                  //                     //             child:
                  //                     //             Center(child: Icon(Icons.menu)),
                  //                     //             itemBuilder: (BuildContext
                  //                     //             context) =>
                  //                     //             <PopupMenuEntry<folderAction>>[
                  //                     //               PopupMenuItem<folderAction>(
                  //                     //                 value: folderAction.rename,
                  //                     //                 child: Text('Rename'),
                  //                     //               ),
                  //                     //               PopupMenuItem<folderAction>(
                  //                     //                 value: folderAction.delete,
                  //                     //                 child: Text('Delete'),
                  //                     //               ),
                  //                     //               PopupMenuItem<folderAction>(
                  //                     //                 value: folderAction.move,
                  //                     //                 child: Text('Move'),
                  //                     //               ),
                  //                     //             ],
                  //                     //           ),
                  //                     //         ),
                  //                     //       ),
                  //                     //     ],
                  //                     //   ),
                  //                     // ),
                  //                     // Container(
                  //                     //
                  //                     //  // width: MediaQuery.of(context).size.width,
                  //                     //   child:showNextLevelFolder(snapshot.data!.docs[index].id),)
                  //
                  //                   ],
                  //                 ),
                  //
                  //                 // if(widget.isExpanded) showNextLevelFolder(snapshot.data!.docs[index].id),
                  //                 if(true) ExpandenFolderActivityLevel1(expand: expand,parentFolder: snapshot.data!.docs[index].id, customerId: widget.customerId,locale: widget.locale, customerFirestore: widget.customerFirestore,),
                  //                 //showTestItemsInFolder(snapshot.data!.docs[index].id),
                  //
                  //               ],
                  //             ),
                  //           ),),
                  //           // Align(alignment: Alignment.centerRight,child: addOrDeletePopMenuBox(snapshot.data!.docs[index].id),),
                  //         ],
                  //       ),
                  //       // if(widget.isExpanded)   Padding(padding: EdgeInsets.fromLTRB(40,0,0,0),child:  showTestItemsInFolder(snapshot.data!.docs[index].id),),
                  //       // if(widget.isExpanded)   Padding(padding: EdgeInsets.fromLTRB(40,0,0,0),child:ExpandedFiles(parentFolder: snapshot.data!.docs[index].id, customerId: widget.customerId,locale: widget.locale, customerFirestore: widget.customerFirestore,),),
                  //
                  //     ],
                  //   ),
                  // );
                  return  StreamBuilder<dynamic>(
                      stream: ExpandFolderStreamL2.getInstance().outData,
                      builder: (c, snapshotEx) {
                        if(snapshotEx.hasData && snapshotEx.data["id"] == snapshot.data!.docs[index].id )
                          return show(snapshotEx.data["expand"],snapshot.data!.docs[index].id);
                        else{
                          return show(false,snapshot.data!.docs[index].id);
                        }

                      });

                });


            return Text( snapshot.data!.docs.length.toString());
          }else return Container(width: 0,height: 0,);
        });
  }
  @override
  Widget build(BuildContext context) {
    return Column(children: [
      showNextLevelFolder(widget.parentFolder),
      // ExpandedFolders(parentFolder: widget.parentFolder, customerId: widget.customerId,locale: widget.locale, customerFirestore: widget.customerFirestore,),
      // ExpandedFiles(parentFolder: widget.parentFolder, customerId: widget.customerId,locale: widget.locale, customerFirestore: widget.customerFirestore,),

    ],);
  }

  addOrDeletePopMenuBox(String id) {
    addNewFolderNamePopUp(String id) {
      final _formKey = GlobalKey<FormState>();
      showDialog(
          context: context,
          builder: (
              context,
              ) {
            return StatefulBuilder(builder: (context, setState) {
              return AlertDialog(
                scrollable: true,
                shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.all(Radius.circular(10))),
                contentPadding: EdgeInsets.only(top: 10.0),
                content: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Container(
                      margin: EdgeInsets.only(
                          top: height * 0.01,
                          left: width * 0.04,
                          right: width * 0.04),
                      child: Row(
                        mainAxisAlignment: MainAxisAlignment.spaceBetween,
                        children: [
                          Text(
                            TextConst.addSubFolderText,
                            style: interSemiBold.copyWith(
                              color: ThemeManager().getBlackColor,
                              fontSize: width * 0.04,
                            ),
                          ),
                          InkWell(
                              onTap: () {
                                Navigator.of(context).pop();
                              },
                              child: Icon(
                                Icons.clear,
                                size: width * 0.06,
                                color: ThemeManager().getLightGrey4Color,
                              )),
                        ],
                      ),
                    ),
                    Container(
                      margin: EdgeInsets.only(top: height * 0.015),
                      height: height * 0.001,
                      color: ThemeManager().getBlackColor.withOpacity(0.19),
                    ),
                    Container(
                      margin: EdgeInsets.only(
                          top: height * 0.02,
                          left: width * 0.04,
                          right: width * 0.04),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text(
                            TextConst.folderNameText,
                            style: interMedium.copyWith(
                              color: ThemeManager().getPopUpTextGreyColor,
                              fontSize: width * 0.036,
                            ),
                          ),
                          Container(
                            margin: EdgeInsets.only(top: height * 0.015),
                            child: Form(
                              key: _formKey,
                              child: TextFormField(
                                controller: _folderNameController,
                                maxLength: 22,
                                autovalidateMode: AutovalidateMode.onUserInteraction,
                                keyboardType: TextInputType.text,
                                decoration: InputDecoration(
                                  counterText: "",
                                  border: InputBorder.none,
                                  hintText: TextConst.textFieldFolderText,
                                  hintStyle: interMedium.copyWith(
                                    color: ThemeManager().getLightGrey4Color,
                                    fontSize: width * 0.036,
                                  ),
                                  enabledBorder: OutlineInputBorder(
                                      borderSide: BorderSide(
                                        color: Colors.transparent,
                                      ),
                                      borderRadius:
                                      BorderRadius.circular(width * 0.014)),
                                  contentPadding: EdgeInsets.symmetric(
                                      vertical: height * 0.0,
                                      horizontal: width * 0.045),
                                  fillColor:
                                  ThemeManager().getLightGreenTextFieldColor,
                                  filled: true,
                                ),
                                validator: (value) {
                                  if (value!.isEmpty) {
                                    return "Please enter folder name";
                                  } else if (_folderNameController.text.length > 22) {
                                    return "Name should be 22 character only";
                                  }
                                },
                              ),
                            ),
                          ),
                          Container(
                            margin: EdgeInsets.only(top: height * 0.015),
                            child: Text(
                              "*Name must be within 10 characters.",
                              style: interMedium.copyWith(
                                color: ThemeManager().getPopUpTextGreyColor,
                                fontSize: width * 0.03,
                              ),
                            ),
                          ),
                          InkWell(
                            onTap: () async {
                              if (_formKey.currentState!.validate()) {


                                var r = await  AppFirestore(firestore: widget.customerFirestore, projectId: '', auth: FirebaseAuth.instance).createFolders(name:_folderNameController.text,parent: id );

                                if(r == true) {
                                  _folderNameController.clear();
                                  Navigator.of(context).pop();



                                }else{
                                  _folderNameController.clear();
                                  Navigator.of(context).pop();
                                  showDialog(context: context,
                                      builder: (BuildContext context){
                                        return FolderExistsPopUp();
                                      });
                                }




                              } else {}
                            },
                            child: Container(
                                margin: EdgeInsets.only(
                                    top: height * 0.04, bottom: height * 0.02),
                                child: ButtonView(
                                    buttonLabel: TextConst.saveButtonText)
                            ),
                          ),
                        ],
                      ),
                    ),
                  ],
                ),
              );
            });
          });
    }
    return PopupMenuButton(
      elevation: 1,
      icon: Icon(Icons.more_horiz),

      itemBuilder: (context) => [
        PopupMenuItem(
        //  padding: EdgeInsets.only(top: height * 0.01, left: width * 0.0065, right: width * 0.0065),

          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [

              InkWell(
                onTap: () {
                  Navigator.of(context).pop();
                  addNewFolderNamePopUp(id);
                },
                child: Container(
                  margin: EdgeInsets.only(
                      left: width * 0.005, right: width * 0.005),
                  alignment: Alignment.center,
                  child: Text(
                    TextConst.addNewFolderPopUpText,
                    style: interRegular.copyWith(
                        color: ThemeManager().getBlackColor,
                        fontSize: width * 0.035),
                  ),
                ),
              ), Container(
                margin: EdgeInsets.only(
                    top: height * 0.01, bottom: height * 0.01),
                height: height * 0.001,
                width: double.infinity,
                color: ThemeManager().getBlackColor.withOpacity(0.19),
              ),InkWell(
                onTap: () {
                  Navigator.of(context).pop();
                },
                child: Container(
                    alignment: Alignment.center,
                    child: Text(
                      TextConst.deleteFolderPopUpText,
                      style: interRegular.copyWith(
                          color: ThemeManager().getBlackColor,
                          fontSize: width * 0.035),
                    )),
              )
            ],
          ),
          // value: 1,
        ),
      ],
    );
  }
}


class ExpandenFolderActivityLevel3 extends StatefulWidget {
  String parentFolder;
  String customerId;
  bool isExpanded = false;
  FirebaseFirestore customerFirestore;
  Locale locale;

  ExpandenFolderActivityLevel3({required this.isExpanded,required this.parentFolder,required this.customerFirestore,required this.customerId,required this.locale});

  @override
  _ExpandenFolderActivityLevel3State createState() => _ExpandenFolderActivityLevel3State();
}

class _ExpandenFolderActivityLevel3State extends State<ExpandenFolderActivityLevel3> {

  showNextLevelFolder(String data) {
    int step = 0;

    return StreamBuilder<QuerySnapshot>(
        stream: AppFirestore(firestore: widget.customerFirestore,projectId: "",auth: FirebaseAuth.instance).getFolders(parentFolder: data),
        builder: (context, snapshot) {
          if (snapshot.hasData && snapshot.data!.docs.length>0) {
            step++;
            return   ListView.builder(
                physics: ClampingScrollPhysics(),
                // separatorBuilder: (context, index) {
                //   return Divider();
                // },
                shrinkWrap: true,
                padding: EdgeInsets.zero,
                itemCount: snapshot.data!.docs.length,
                itemBuilder: (_, index) {
                  show(bool expand,String id){

                    return   Column(
                      children: [
                        Stack(
                          children: [
                            Align(alignment: Alignment.centerLeft,child: Column(
                              children: [
                                Container(
                                  //color: expand?ThemeManager().getLightYellowColor:Colors.white,
                                  child: Row(
                                    children: [
                                      GestureDetector(
                                        onTap: () {
                                          try{
                                            print(!expand );
                                            print(snapshot.data!.docs[index].id );
                                            ExpandFolderStreamL3.getInstance().dataReload({"id":snapshot.data!.docs[index].id,"expand":!expand});
                                          }catch(e){
                                            print("enpand er");
                                            print(e);
                                          }
                                        },
                                        //newFolder.isExpanded == fals
                                        child: expand
                                            ? Icon(
                                          Icons.keyboard_arrow_up_outlined,
                                          size: width * 0.085,
                                          color: ThemeManager().getDarkGrey2Color,
                                        )
                                            : Icon(
                                          Icons.keyboard_arrow_down_outlined,
                                          size: width * 0.085,
                                          color: ThemeManager().getDarkGrey2Color,
                                        ),
                                      ),
                                      Container(
                                        margin: EdgeInsets.only(
                                       left: width * 0.02,
                                        ),
                                        child: SvgPicture.asset(
                                          ("assets/svg/folderIcon.svg"),
                                          fit: BoxFit.cover,
                                        ),
                                      ),
                                      Container(
                                          margin: EdgeInsets.only(
                                            left: width * 0.03,
                                          ),
                                          child: Text(
                                            snapshot.data!.docs[index]["name"],
                                            style: interRegular.copyWith(
                                              color: ThemeManager().getBlackColor,
                                              fontSize: width * 0.045,
                                            ),
                                          )),

                                      // Container(
                                      // //  height: 50,
                                      //   width: MediaQuery.of(context).size.width,
                                      //   child: Stack(
                                      //     children: [
                                      //       Align(
                                      //         alignment: Alignment.centerLeft,
                                      //         child: Row(
                                      //           children: [
                                      //             GestureDetector(
                                      //               onTap: () {
                                      //                 // setState(() {
                                      //                 //   newFolder.isExpanded = !(newFolder.isExpanded);
                                      //                 //   newFolder.isVisible = !newFolder.isVisible;
                                      //                 // });
                                      //               },
                                      //               //newFolder.isExpanded == fals
                                      //               child: false
                                      //                   ? Icon(
                                      //                 Icons.keyboard_arrow_up_outlined,
                                      //                 size: width * 0.085,
                                      //                 color: ThemeManager().getDarkGrey2Color,
                                      //               )
                                      //                   : Icon(
                                      //                 Icons.keyboard_arrow_down_outlined,
                                      //                 size: width * 0.085,
                                      //                 color: ThemeManager().getDarkGrey2Color,
                                      //               ),
                                      //             ),
                                      //             Container(
                                      //               margin: EdgeInsets.only(
                                      //                 left: width * 0.02,
                                      //               ),
                                      //               child: SvgPicture.asset(
                                      //                 ("assets/svg/folderIcon.svg"),
                                      //                 fit: BoxFit.cover,
                                      //               ),
                                      //             ),
                                      //             Container(
                                      //                 margin: EdgeInsets.only(
                                      //                   left: width * 0.03,
                                      //                 ),
                                      //                 child: Text(
                                      //                   snapshot.data!.docs[index]["name"],
                                      //                   style: interRegular.copyWith(
                                      //                     color: ThemeManager().getBlackColor,
                                      //                     fontSize: width * 0.045,
                                      //                   ),
                                      //                 ))
                                      //             // Column(
                                      //             //   mainAxisAlignment:
                                      //             //   MainAxisAlignment.center,
                                      //             //   crossAxisAlignment:
                                      //             //   CrossAxisAlignment.start,
                                      //             //   children: [
                                      //             //
                                      //             //     Text(
                                      //             //       snapshot.data!.docs[index]["name"]
                                      //             //           .toString(),
                                      //             //       style: TextStyle(
                                      //             //           fontWeight:
                                      //             //           FontWeight.bold,
                                      //             //           color: Colors.black),
                                      //             //     ),
                                      //             //     timeFormate(snapshot.data!.docs[index]["created_at"]),
                                      //             //   ],
                                      //             // ),
                                      //           ],
                                      //         ),
                                      //       ),
                                      //       Align(
                                      //         alignment: Alignment.centerRight,
                                      //         child: Container(
                                      //           height: MediaQuery.of(context)
                                      //               .size
                                      //               .height,
                                      //           width: 50,
                                      //           child: PopupMenuButton<folderAction>(
                                      //             onSelected: (folderAction value) {
                                      //               if (value ==
                                      //                   folderAction.rename) {
                                      //                 //rename folder
                                      //                 TextEditingController
                                      //                 controller =
                                      //                 TextEditingController(
                                      //                     text: snapshot.data!.docs[index]
                                      //                     ["name"]
                                      //                         .toString());
                                      //
                                      //                 Navigator.of(context)
                                      //                     .push(
                                      //                     new MaterialPageRoute<
                                      //                         Null>(
                                      //                         builder:
                                      //                             (BuildContext
                                      //                         context) {
                                      //                           return Scaffold(
                                      //                             appBar: AppBar(
                                      //                               title: Text(
                                      //                                   "Rename Folder"),
                                      //                             ),
                                      //                             body: Container(
                                      //                               decoration:
                                      //                               BoxDecoration(
                                      //                                 color: Color
                                      //                                     .fromARGB(
                                      //                                     255,
                                      //                                     247,
                                      //                                     247,
                                      //                                     247),
                                      //                                 borderRadius: BorderRadius.only(
                                      //                                     topLeft:
                                      //                                     Radius.circular(
                                      //                                         10.0),
                                      //                                     topRight:
                                      //                                     Radius.circular(10.0)),
                                      //                               ),
                                      //                               child:
                                      //                               Padding(
                                      //                                 padding: const EdgeInsets
                                      //                                     .all(
                                      //                                     15.0),
                                      //                                 child: Wrap(
                                      //                                   children: [
                                      //                                     Padding(
                                      //                                       padding:
                                      //                                       const EdgeInsets.all(8.0),
                                      //                                       child:
                                      //                                       TextFormField(
                                      //                                         controller:
                                      //                                         controller,
                                      //                                         autofocus:
                                      //                                         true,
                                      //                                         decoration:
                                      //                                         InputDecoration(
                                      //                                           labelText: 'Folder Name',
                                      //                                           border: OutlineInputBorder(),
                                      //                                         ),
                                      //                                       ),
                                      //                                     ),
                                      //                                     InkWell(
                                      //                                       onTap:
                                      //                                           () {
                                      //                                         widget.customerFirestore.collection("folders").doc(snapshot.data!.docs[index].id).update({
                                      //                                           "name": controller.text
                                      //                                         }).then((value) {
                                      //                                           Navigator.pop(context);
                                      //                                         });
                                      //                                       },
                                      //                                       child:
                                      //                                       Card(
                                      //                                         color:
                                      //                                         Theme.of(context).primaryColor,
                                      //                                         child: Center(
                                      //                                             child: Padding(
                                      //                                               padding: const EdgeInsets.all(10.0),
                                      //                                               child: Text(
                                      //                                                 "Submit",
                                      //                                                 style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold),
                                      //                                               ),
                                      //                                             )),
                                      //                                       ),
                                      //                                     )
                                      //                                   ],
                                      //                                 ),
                                      //                               ),
                                      //                             ),
                                      //                           );
                                      //                         },
                                      //                         fullscreenDialog:
                                      //                         true));
                                      //               }
                                      //               if (value ==
                                      //                   folderAction.delete) {
                                      //                 //rename folder
                                      //                 showModalBottomSheet(
                                      //                     context: context,
                                      //                     builder: (builder) {
                                      //                       return new Wrap(
                                      //                         children: [
                                      //                           Padding(
                                      //                             padding:
                                      //                             const EdgeInsets
                                      //                                 .all(8.0),
                                      //                             child: Text(
                                      //                               "Do you want to delete this Folder?",
                                      //                               style: TextStyle(
                                      //                                   fontSize: 20,
                                      //                                   color: Theme.of(
                                      //                                       context)
                                      //                                       .primaryColor),
                                      //                             ),
                                      //                           ),
                                      //                           Row(
                                      //                             children: [
                                      //                               Expanded(
                                      //                                   child:
                                      //                                   InkWell(
                                      //                                     onTap: () {
                                      //                                       Navigator.of(
                                      //                                           context)
                                      //                                           .pop();
                                      //                                     },
                                      //                                     child: Padding(
                                      //                                       padding:
                                      //                                       const EdgeInsets
                                      //                                           .all(
                                      //                                           8.0),
                                      //                                       child: Card(
                                      //                                         elevation:
                                      //                                         8,
                                      //                                         color: Colors
                                      //                                             .grey,
                                      //                                         child: Center(
                                      //                                             child: Padding(
                                      //                                               padding: const EdgeInsets
                                      //                                                   .all(
                                      //                                                   15.0),
                                      //                                               child:
                                      //                                               Text(
                                      //                                                 "Cancel",
                                      //                                                 style: TextStyle(
                                      //                                                     color:
                                      //                                                     Colors.white,
                                      //                                                     fontWeight: FontWeight.bold),
                                      //                                               ),
                                      //                                             )),
                                      //                                       ),
                                      //                                     ),
                                      //                                   )),
                                      //                               Expanded(
                                      //                                   child:
                                      //                                   InkWell(
                                      //                                     onTap: () {
                                      //                                       widget
                                      //                                           .customerFirestore
                                      //                                           .collection(
                                      //                                           "folders")
                                      //                                           .doc(snapshot.data!.docs[index].id)
                                      //                                           .delete()
                                      //                                           .then(
                                      //                                               (value) {
                                      //                                             Navigator.pop(
                                      //                                                 context);
                                      //                                           });
                                      //                                     },
                                      //                                     child: Padding(
                                      //                                       padding:
                                      //                                       const EdgeInsets
                                      //                                           .all(
                                      //                                           8.0),
                                      //                                       child: Card(
                                      //                                         elevation:
                                      //                                         8,
                                      //                                         color: Theme.of(
                                      //                                             context)
                                      //                                             .primaryColor,
                                      //                                         child: Center(
                                      //                                             child: Padding(
                                      //                                               padding: const EdgeInsets
                                      //                                                   .all(
                                      //                                                   15.0),
                                      //                                               child:
                                      //                                               Text(
                                      //                                                 "Delete",
                                      //                                                 style: TextStyle(
                                      //                                                     color:
                                      //                                                     Colors.white,
                                      //                                                     fontWeight: FontWeight.bold),
                                      //                                               ),
                                      //                                             )),
                                      //                                       ),
                                      //                                     ),
                                      //                                   )),
                                      //                             ],
                                      //                           ),
                                      //                         ],
                                      //                       );
                                      //                     });
                                      //               }
                                      //
                                      //               if (value == folderAction.move) {
                                      //                 //rename folder
                                      //                 showModalBottomSheet(
                                      //                     context: context,
                                      //                     builder: (builder) {
                                      //                       return new Wrap(
                                      //                         children: [
                                      //                           ListTile(
                                      //                             title: Text(
                                      //                               "Move Folder",
                                      //                               style: TextStyle(
                                      //                                   fontSize: 20,
                                      //                                   color: Theme.of(
                                      //                                       context)
                                      //                                       .primaryColor),
                                      //                             ),
                                      //                             trailing: Padding(
                                      //                               padding:
                                      //                               const EdgeInsets
                                      //                                   .all(8.0),
                                      //                               child: InkWell(
                                      //                                 onTap: () {
                                      //                                   Navigator.of(
                                      //                                       context)
                                      //                                       .pop();
                                      //                                 },
                                      //                                 child: Icon(
                                      //                                     Icons
                                      //                                         .close),
                                      //                               ),
                                      //                             ),
                                      //                           ),
                                      //                           Padding(
                                      //                             padding:
                                      //                             const EdgeInsets
                                      //                                 .all(8.0),
                                      //                             child: Text(
                                      //                               "Move Folder",
                                      //                               style: TextStyle(
                                      //                                   fontSize: 20,
                                      //                                   color: Theme.of(
                                      //                                       context)
                                      //                                       .primaryColor),
                                      //                             ),
                                      //                           ),
                                      //
                                      //                           MoveFolderActivity(
                                      //                             customerId: widget
                                      //                                 .customerId,
                                      //                             customerFirestore:
                                      //                             widget
                                      //                                 .customerFirestore,
                                      //                             curentFolderID:snapshot.data!.docs[index].id,locale: widget.locale,
                                      //                           ),
                                      //                           //here show move folder target
                                      //                         ],
                                      //                       );
                                      //                     });
                                      //               }
                                      //             },
                                      //             child:
                                      //             Center(child: Icon(Icons.menu)),
                                      //             itemBuilder: (BuildContext
                                      //             context) =>
                                      //             <PopupMenuEntry<folderAction>>[
                                      //               PopupMenuItem<folderAction>(
                                      //                 value: folderAction.rename,
                                      //                 child: Text('Rename'),
                                      //               ),
                                      //               PopupMenuItem<folderAction>(
                                      //                 value: folderAction.delete,
                                      //                 child: Text('Delete'),
                                      //               ),
                                      //               PopupMenuItem<folderAction>(
                                      //                 value: folderAction.move,
                                      //                 child: Text('Move'),
                                      //               ),
                                      //             ],
                                      //           ),
                                      //         ),
                                      //       ),
                                      //     ],
                                      //   ),
                                      // ),
                                      // Container(
                                      //
                                      //  // width: MediaQuery.of(context).size.width,
                                      //   child:showNextLevelFolder(snapshot.data!.docs[index].id),)

                                    ],
                                  ),
                                ),

                                // if(widget.isExpanded) showNextLevelFolder(snapshot.data!.docs[index].id),
                               // if(expand) ExpandenFolderActivityLevel4(parentFolder: snapshot.data!.docs[index].id, customerId: widget.customerId,locale: widget.locale, customerFirestore: widget.customerFirestore, expand: false,),
                                Padding(    padding: indendfolderPadding,child:   showTestItemsInFolder(snapshot.data!.docs[index].id,widget.customerFirestore,widget.customerId,widget.locale),)


                              ],
                            ),),
                           Align(alignment: Alignment.centerRight,child: addOrDeletePopMenuBox(snapshot.data!.docs[index].id),),
                          ],
                        ),
                        // if(widget.isExpanded)   Padding(padding: EdgeInsets.fromLTRB(40,0,0,0),child:  showTestItemsInFolder(snapshot.data!.docs[index].id),),
                        // if(widget.isExpanded)   Padding(padding: EdgeInsets.fromLTRB(40,0,0,0),child:ExpandedFiles(parentFolder: snapshot.data!.docs[index].id, customerId: widget.customerId,locale: widget.locale, customerFirestore: widget.customerFirestore,),),

                      ],
                    );
                  }
                  // return   Padding(
                  //   padding:  EdgeInsets.fromLTRB((step* 20), 2, 0, 2),
                  //   child: Column(
                  //     children: [
                  //       Stack(
                  //         children: [
                  //           Align(alignment: Alignment.centerLeft,child: Padding(
                  //             padding:  EdgeInsets.fromLTRB(0, 0, 0, 0),
                  //             child: Column(
                  //               children: [
                  //                 Row(
                  //                   children: [
                  //                     GestureDetector(
                  //                       onTap: () {
                  //
                  //                         setState(() {
                  //                           expand = !expand;
                  //                         });
                  //
                  //                         // try{
                  //                         //   ExpandFolderStream.getInstance().dataReload({"id":snapshot.data!.docs[index].id,"expand":!expand});
                  //                         // }catch(e){
                  //                         //   print("enpand er");
                  //                         //   print(e);
                  //                         // }
                  //                       },
                  //                       //newFolder.isExpanded == fals
                  //                       child: expand
                  //                           ? Icon(
                  //                         Icons.keyboard_arrow_up_outlined,
                  //                         size: width * 0.085,
                  //                         color: ThemeManager().getDarkGrey2Color,
                  //                       )
                  //                           : Icon(
                  //                         Icons.keyboard_arrow_down_outlined,
                  //                         size: width * 0.085,
                  //                         color: ThemeManager().getDarkGrey2Color,
                  //                       ),
                  //                     ),
                  //                     Container(
                  //                       margin: EdgeInsets.only(
                  //                         left: width * 0.02,
                  //                       ),
                  //                       child: SvgPicture.asset(
                  //                         ("assets/svg/folderIcon.svg"),
                  //                         fit: BoxFit.cover,
                  //                       ),
                  //                     ),
                  //                     Container(
                  //                         margin: EdgeInsets.only(
                  //                           left: width * 0.03,
                  //                         ),
                  //                         child: Text(
                  //                           snapshot.data!.docs[index]["name"],
                  //                           style: interRegular.copyWith(
                  //                             color: ThemeManager().getBlackColor,
                  //                             fontSize: width * 0.045,
                  //                           ),
                  //                         )),
                  //
                  //                     // Container(
                  //                     // //  height: 50,
                  //                     //   width: MediaQuery.of(context).size.width,
                  //                     //   child: Stack(
                  //                     //     children: [
                  //                     //       Align(
                  //                     //         alignment: Alignment.centerLeft,
                  //                     //         child: Row(
                  //                     //           children: [
                  //                     //             GestureDetector(
                  //                     //               onTap: () {
                  //                     //                 // setState(() {
                  //                     //                 //   newFolder.isExpanded = !(newFolder.isExpanded);
                  //                     //                 //   newFolder.isVisible = !newFolder.isVisible;
                  //                     //                 // });
                  //                     //               },
                  //                     //               //newFolder.isExpanded == fals
                  //                     //               child: false
                  //                     //                   ? Icon(
                  //                     //                 Icons.keyboard_arrow_up_outlined,
                  //                     //                 size: width * 0.085,
                  //                     //                 color: ThemeManager().getDarkGrey2Color,
                  //                     //               )
                  //                     //                   : Icon(
                  //                     //                 Icons.keyboard_arrow_down_outlined,
                  //                     //                 size: width * 0.085,
                  //                     //                 color: ThemeManager().getDarkGrey2Color,
                  //                     //               ),
                  //                     //             ),
                  //                     //             Container(
                  //                     //               margin: EdgeInsets.only(
                  //                     //                 left: width * 0.02,
                  //                     //               ),
                  //                     //               child: SvgPicture.asset(
                  //                     //                 ("assets/svg/folderIcon.svg"),
                  //                     //                 fit: BoxFit.cover,
                  //                     //               ),
                  //                     //             ),
                  //                     //             Container(
                  //                     //                 margin: EdgeInsets.only(
                  //                     //                   left: width * 0.03,
                  //                     //                 ),
                  //                     //                 child: Text(
                  //                     //                   snapshot.data!.docs[index]["name"],
                  //                     //                   style: interRegular.copyWith(
                  //                     //                     color: ThemeManager().getBlackColor,
                  //                     //                     fontSize: width * 0.045,
                  //                     //                   ),
                  //                     //                 ))
                  //                     //             // Column(
                  //                     //             //   mainAxisAlignment:
                  //                     //             //   MainAxisAlignment.center,
                  //                     //             //   crossAxisAlignment:
                  //                     //             //   CrossAxisAlignment.start,
                  //                     //             //   children: [
                  //                     //             //
                  //                     //             //     Text(
                  //                     //             //       snapshot.data!.docs[index]["name"]
                  //                     //             //           .toString(),
                  //                     //             //       style: TextStyle(
                  //                     //             //           fontWeight:
                  //                     //             //           FontWeight.bold,
                  //                     //             //           color: Colors.black),
                  //                     //             //     ),
                  //                     //             //     timeFormate(snapshot.data!.docs[index]["created_at"]),
                  //                     //             //   ],
                  //                     //             // ),
                  //                     //           ],
                  //                     //         ),
                  //                     //       ),
                  //                     //       Align(
                  //                     //         alignment: Alignment.centerRight,
                  //                     //         child: Container(
                  //                     //           height: MediaQuery.of(context)
                  //                     //               .size
                  //                     //               .height,
                  //                     //           width: 50,
                  //                     //           child: PopupMenuButton<folderAction>(
                  //                     //             onSelected: (folderAction value) {
                  //                     //               if (value ==
                  //                     //                   folderAction.rename) {
                  //                     //                 //rename folder
                  //                     //                 TextEditingController
                  //                     //                 controller =
                  //                     //                 TextEditingController(
                  //                     //                     text: snapshot.data!.docs[index]
                  //                     //                     ["name"]
                  //                     //                         .toString());
                  //                     //
                  //                     //                 Navigator.of(context)
                  //                     //                     .push(
                  //                     //                     new MaterialPageRoute<
                  //                     //                         Null>(
                  //                     //                         builder:
                  //                     //                             (BuildContext
                  //                     //                         context) {
                  //                     //                           return Scaffold(
                  //                     //                             appBar: AppBar(
                  //                     //                               title: Text(
                  //                     //                                   "Rename Folder"),
                  //                     //                             ),
                  //                     //                             body: Container(
                  //                     //                               decoration:
                  //                     //                               BoxDecoration(
                  //                     //                                 color: Color
                  //                     //                                     .fromARGB(
                  //                     //                                     255,
                  //                     //                                     247,
                  //                     //                                     247,
                  //                     //                                     247),
                  //                     //                                 borderRadius: BorderRadius.only(
                  //                     //                                     topLeft:
                  //                     //                                     Radius.circular(
                  //                     //                                         10.0),
                  //                     //                                     topRight:
                  //                     //                                     Radius.circular(10.0)),
                  //                     //                               ),
                  //                     //                               child:
                  //                     //                               Padding(
                  //                     //                                 padding: const EdgeInsets
                  //                     //                                     .all(
                  //                     //                                     15.0),
                  //                     //                                 child: Wrap(
                  //                     //                                   children: [
                  //                     //                                     Padding(
                  //                     //                                       padding:
                  //                     //                                       const EdgeInsets.all(8.0),
                  //                     //                                       child:
                  //                     //                                       TextFormField(
                  //                     //                                         controller:
                  //                     //                                         controller,
                  //                     //                                         autofocus:
                  //                     //                                         true,
                  //                     //                                         decoration:
                  //                     //                                         InputDecoration(
                  //                     //                                           labelText: 'Folder Name',
                  //                     //                                           border: OutlineInputBorder(),
                  //                     //                                         ),
                  //                     //                                       ),
                  //                     //                                     ),
                  //                     //                                     InkWell(
                  //                     //                                       onTap:
                  //                     //                                           () {
                  //                     //                                         widget.customerFirestore.collection("folders").doc(snapshot.data!.docs[index].id).update({
                  //                     //                                           "name": controller.text
                  //                     //                                         }).then((value) {
                  //                     //                                           Navigator.pop(context);
                  //                     //                                         });
                  //                     //                                       },
                  //                     //                                       child:
                  //                     //                                       Card(
                  //                     //                                         color:
                  //                     //                                         Theme.of(context).primaryColor,
                  //                     //                                         child: Center(
                  //                     //                                             child: Padding(
                  //                     //                                               padding: const EdgeInsets.all(10.0),
                  //                     //                                               child: Text(
                  //                     //                                                 "Submit",
                  //                     //                                                 style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold),
                  //                     //                                               ),
                  //                     //                                             )),
                  //                     //                                       ),
                  //                     //                                     )
                  //                     //                                   ],
                  //                     //                                 ),
                  //                     //                               ),
                  //                     //                             ),
                  //                     //                           );
                  //                     //                         },
                  //                     //                         fullscreenDialog:
                  //                     //                         true));
                  //                     //               }
                  //                     //               if (value ==
                  //                     //                   folderAction.delete) {
                  //                     //                 //rename folder
                  //                     //                 showModalBottomSheet(
                  //                     //                     context: context,
                  //                     //                     builder: (builder) {
                  //                     //                       return new Wrap(
                  //                     //                         children: [
                  //                     //                           Padding(
                  //                     //                             padding:
                  //                     //                             const EdgeInsets
                  //                     //                                 .all(8.0),
                  //                     //                             child: Text(
                  //                     //                               "Do you want to delete this Folder?",
                  //                     //                               style: TextStyle(
                  //                     //                                   fontSize: 20,
                  //                     //                                   color: Theme.of(
                  //                     //                                       context)
                  //                     //                                       .primaryColor),
                  //                     //                             ),
                  //                     //                           ),
                  //                     //                           Row(
                  //                     //                             children: [
                  //                     //                               Expanded(
                  //                     //                                   child:
                  //                     //                                   InkWell(
                  //                     //                                     onTap: () {
                  //                     //                                       Navigator.of(
                  //                     //                                           context)
                  //                     //                                           .pop();
                  //                     //                                     },
                  //                     //                                     child: Padding(
                  //                     //                                       padding:
                  //                     //                                       const EdgeInsets
                  //                     //                                           .all(
                  //                     //                                           8.0),
                  //                     //                                       child: Card(
                  //                     //                                         elevation:
                  //                     //                                         8,
                  //                     //                                         color: Colors
                  //                     //                                             .grey,
                  //                     //                                         child: Center(
                  //                     //                                             child: Padding(
                  //                     //                                               padding: const EdgeInsets
                  //                     //                                                   .all(
                  //                     //                                                   15.0),
                  //                     //                                               child:
                  //                     //                                               Text(
                  //                     //                                                 "Cancel",
                  //                     //                                                 style: TextStyle(
                  //                     //                                                     color:
                  //                     //                                                     Colors.white,
                  //                     //                                                     fontWeight: FontWeight.bold),
                  //                     //                                               ),
                  //                     //                                             )),
                  //                     //                                       ),
                  //                     //                                     ),
                  //                     //                                   )),
                  //                     //                               Expanded(
                  //                     //                                   child:
                  //                     //                                   InkWell(
                  //                     //                                     onTap: () {
                  //                     //                                       widget
                  //                     //                                           .customerFirestore
                  //                     //                                           .collection(
                  //                     //                                           "folders")
                  //                     //                                           .doc(snapshot.data!.docs[index].id)
                  //                     //                                           .delete()
                  //                     //                                           .then(
                  //                     //                                               (value) {
                  //                     //                                             Navigator.pop(
                  //                     //                                                 context);
                  //                     //                                           });
                  //                     //                                     },
                  //                     //                                     child: Padding(
                  //                     //                                       padding:
                  //                     //                                       const EdgeInsets
                  //                     //                                           .all(
                  //                     //                                           8.0),
                  //                     //                                       child: Card(
                  //                     //                                         elevation:
                  //                     //                                         8,
                  //                     //                                         color: Theme.of(
                  //                     //                                             context)
                  //                     //                                             .primaryColor,
                  //                     //                                         child: Center(
                  //                     //                                             child: Padding(
                  //                     //                                               padding: const EdgeInsets
                  //                     //                                                   .all(
                  //                     //                                                   15.0),
                  //                     //                                               child:
                  //                     //                                               Text(
                  //                     //                                                 "Delete",
                  //                     //                                                 style: TextStyle(
                  //                     //                                                     color:
                  //                     //                                                     Colors.white,
                  //                     //                                                     fontWeight: FontWeight.bold),
                  //                     //                                               ),
                  //                     //                                             )),
                  //                     //                                       ),
                  //                     //                                     ),
                  //                     //                                   )),
                  //                     //                             ],
                  //                     //                           ),
                  //                     //                         ],
                  //                     //                       );
                  //                     //                     });
                  //                     //               }
                  //                     //
                  //                     //               if (value == folderAction.move) {
                  //                     //                 //rename folder
                  //                     //                 showModalBottomSheet(
                  //                     //                     context: context,
                  //                     //                     builder: (builder) {
                  //                     //                       return new Wrap(
                  //                     //                         children: [
                  //                     //                           ListTile(
                  //                     //                             title: Text(
                  //                     //                               "Move Folder",
                  //                     //                               style: TextStyle(
                  //                     //                                   fontSize: 20,
                  //                     //                                   color: Theme.of(
                  //                     //                                       context)
                  //                     //                                       .primaryColor),
                  //                     //                             ),
                  //                     //                             trailing: Padding(
                  //                     //                               padding:
                  //                     //                               const EdgeInsets
                  //                     //                                   .all(8.0),
                  //                     //                               child: InkWell(
                  //                     //                                 onTap: () {
                  //                     //                                   Navigator.of(
                  //                     //                                       context)
                  //                     //                                       .pop();
                  //                     //                                 },
                  //                     //                                 child: Icon(
                  //                     //                                     Icons
                  //                     //                                         .close),
                  //                     //                               ),
                  //                     //                             ),
                  //                     //                           ),
                  //                     //                           Padding(
                  //                     //                             padding:
                  //                     //                             const EdgeInsets
                  //                     //                                 .all(8.0),
                  //                     //                             child: Text(
                  //                     //                               "Move Folder",
                  //                     //                               style: TextStyle(
                  //                     //                                   fontSize: 20,
                  //                     //                                   color: Theme.of(
                  //                     //                                       context)
                  //                     //                                       .primaryColor),
                  //                     //                             ),
                  //                     //                           ),
                  //                     //
                  //                     //                           MoveFolderActivity(
                  //                     //                             customerId: widget
                  //                     //                                 .customerId,
                  //                     //                             customerFirestore:
                  //                     //                             widget
                  //                     //                                 .customerFirestore,
                  //                     //                             curentFolderID:snapshot.data!.docs[index].id,locale: widget.locale,
                  //                     //                           ),
                  //                     //                           //here show move folder target
                  //                     //                         ],
                  //                     //                       );
                  //                     //                     });
                  //                     //               }
                  //                     //             },
                  //                     //             child:
                  //                     //             Center(child: Icon(Icons.menu)),
                  //                     //             itemBuilder: (BuildContext
                  //                     //             context) =>
                  //                     //             <PopupMenuEntry<folderAction>>[
                  //                     //               PopupMenuItem<folderAction>(
                  //                     //                 value: folderAction.rename,
                  //                     //                 child: Text('Rename'),
                  //                     //               ),
                  //                     //               PopupMenuItem<folderAction>(
                  //                     //                 value: folderAction.delete,
                  //                     //                 child: Text('Delete'),
                  //                     //               ),
                  //                     //               PopupMenuItem<folderAction>(
                  //                     //                 value: folderAction.move,
                  //                     //                 child: Text('Move'),
                  //                     //               ),
                  //                     //             ],
                  //                     //           ),
                  //                     //         ),
                  //                     //       ),
                  //                     //     ],
                  //                     //   ),
                  //                     // ),
                  //                     // Container(
                  //                     //
                  //                     //  // width: MediaQuery.of(context).size.width,
                  //                     //   child:showNextLevelFolder(snapshot.data!.docs[index].id),)
                  //
                  //                   ],
                  //                 ),
                  //
                  //                 // if(widget.isExpanded) showNextLevelFolder(snapshot.data!.docs[index].id),
                  //                 if(true) ExpandenFolderActivityLevel1(expand: expand,parentFolder: snapshot.data!.docs[index].id, customerId: widget.customerId,locale: widget.locale, customerFirestore: widget.customerFirestore,),
                  //                 //showTestItemsInFolder(snapshot.data!.docs[index].id),
                  //
                  //               ],
                  //             ),
                  //           ),),
                  //           // Align(alignment: Alignment.centerRight,child: addOrDeletePopMenuBox(snapshot.data!.docs[index].id),),
                  //         ],
                  //       ),
                  //       // if(widget.isExpanded)   Padding(padding: EdgeInsets.fromLTRB(40,0,0,0),child:  showTestItemsInFolder(snapshot.data!.docs[index].id),),
                  //       // if(widget.isExpanded)   Padding(padding: EdgeInsets.fromLTRB(40,0,0,0),child:ExpandedFiles(parentFolder: snapshot.data!.docs[index].id, customerId: widget.customerId,locale: widget.locale, customerFirestore: widget.customerFirestore,),),
                  //
                  //     ],
                  //   ),
                  // );
                  return  StreamBuilder<dynamic>(
                      stream: ExpandFolderStreamL3.getInstance().outData,
                      builder: (c, snapshotEx) {
                        if(snapshotEx.hasData && snapshotEx.data["id"] == snapshot.data!.docs[index].id )
                          return show(snapshotEx.data["expand"],snapshot.data!.docs[index].id);
                        else{
                          return show(false,snapshot.data!.docs[index].id);
                        }

                      });


                });


            return Text( snapshot.data!.docs.length.toString());
          }else return Container(width: 0,height: 0,);
        });
  }
  @override
  Widget build(BuildContext context) {
    return Column(children: [
      showNextLevelFolder(widget.parentFolder),
      // ExpandedFolders(parentFolder: widget.parentFolder, customerId: widget.customerId,locale: widget.locale, customerFirestore: widget.customerFirestore,),
      // ExpandedFiles(parentFolder: widget.parentFolder, customerId: widget.customerId,locale: widget.locale, customerFirestore: widget.customerFirestore,),

    ],);
  }

  addOrDeletePopMenuBox(String id) {
    addNewFolderNamePopUp(String id) {
      final _formKey = GlobalKey<FormState>();
      showDialog(
          context: context,
          builder: (
              context,
              ) {
            return StatefulBuilder(builder: (context, setState) {
              return AlertDialog(
                scrollable: true,
                shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.all(Radius.circular(10))),
                contentPadding: EdgeInsets.only(top: 10.0),
                content: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Container(
                      margin: EdgeInsets.only(
                          top: height * 0.01,
                          left: width * 0.04,
                          right: width * 0.04),
                      child: Row(
                        mainAxisAlignment: MainAxisAlignment.spaceBetween,
                        children: [
                          Text(
                            TextConst.addSubFolderText,
                            style: interSemiBold.copyWith(
                              color: ThemeManager().getBlackColor,
                              fontSize: width * 0.04,
                            ),
                          ),
                          InkWell(
                              onTap: () {
                                Navigator.of(context).pop();
                              },
                              child: Icon(
                                Icons.clear,
                                size: width * 0.06,
                                color: ThemeManager().getLightGrey4Color,
                              )),
                        ],
                      ),
                    ),
                    Container(
                      margin: EdgeInsets.only(top: height * 0.015),
                      height: height * 0.001,
                      color: ThemeManager().getBlackColor.withOpacity(0.19),
                    ),
                    Container(
                      margin: EdgeInsets.only(
                          top: height * 0.02,
                          left: width * 0.04,
                          right: width * 0.04),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text(
                            TextConst.folderNameText,
                            style: interMedium.copyWith(
                              color: ThemeManager().getPopUpTextGreyColor,
                              fontSize: width * 0.036,
                            ),
                          ),
                          Container(
                            margin: EdgeInsets.only(top: height * 0.015),
                            child: Form(
                              key: _formKey,
                              child: TextFormField(
                                controller: _folderNameController,
                                maxLength: 22,
                                autovalidateMode: AutovalidateMode.onUserInteraction,
                                keyboardType: TextInputType.text,
                                decoration: InputDecoration(
                                  counterText: "",
                                  border: InputBorder.none,
                                  hintText: TextConst.textFieldFolderText,
                                  hintStyle: interMedium.copyWith(
                                    color: ThemeManager().getLightGrey4Color,
                                    fontSize: width * 0.036,
                                  ),
                                  enabledBorder: OutlineInputBorder(
                                      borderSide: BorderSide(
                                        color: Colors.transparent,
                                      ),
                                      borderRadius:
                                      BorderRadius.circular(width * 0.014)),
                                  contentPadding: EdgeInsets.symmetric(
                                      vertical: height * 0.0,
                                      horizontal: width * 0.045),
                                  fillColor:
                                  ThemeManager().getLightGreenTextFieldColor,
                                  filled: true,
                                ),
                                validator: (value) {
                                  if (value!.isEmpty) {
                                    return "Please enter folder name";
                                  } else if (_folderNameController.text.length > 22) {
                                    return "Name should be 22 character only";
                                  }
                                },
                              ),
                            ),
                          ),
                          Container(
                            margin: EdgeInsets.only(top: height * 0.015),
                            child: Text(
                              "*Name must be within 10 characters.",
                              style: interMedium.copyWith(
                                color: ThemeManager().getPopUpTextGreyColor,
                                fontSize: width * 0.03,
                              ),
                            ),
                          ),
                          InkWell(
                            onTap: () async {
                              if (_formKey.currentState!.validate()) {


                                var r = await  AppFirestore(firestore: widget.customerFirestore, projectId: '', auth: FirebaseAuth.instance).createFolders(name:_folderNameController.text,parent: id );

                                if(r == true) {
                                  _folderNameController.clear();
                                  Navigator.of(context).pop();



                                }else{
                                  _folderNameController.clear();
                                  Navigator.of(context).pop();
                                  showDialog(context: context,
                                      builder: (BuildContext context){
                                        return FolderExistsPopUp();
                                      });
                                }



                              } else {}
                            },
                            child: Container(
                                margin: EdgeInsets.only(
                                    top: height * 0.04, bottom: height * 0.02),
                                child: ButtonView(
                                    buttonLabel: TextConst.saveButtonText)
                            ),
                          ),
                        ],
                      ),
                    ),
                  ],
                ),
              );
            });
          });
    }
    return PopupMenuButton(
      elevation: 1,
      icon: Icon(Icons.more_horiz),

      itemBuilder: (context) => [
        PopupMenuItem(
       //   padding: EdgeInsets.only(top: height * 0.01, left: width * 0.0065, right: width * 0.0065),

          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [

              InkWell(
                onTap: () {
                  Navigator.of(context).pop();
                  addNewFolderNamePopUp(id);
                },
                child: Container(
                  margin: EdgeInsets.only(
                      left: width * 0.005, right: width * 0.005),
                  alignment: Alignment.center,
                  child: Text(
                    TextConst.addNewFolderPopUpText,
                    style: interRegular.copyWith(
                        color: ThemeManager().getBlackColor,
                        fontSize: width * 0.035),
                  ),
                ),
              ), Container(
                margin: EdgeInsets.only(
                    top: height * 0.01, bottom: height * 0.01),
                height: height * 0.001,
                width: double.infinity,
                color: ThemeManager().getBlackColor.withOpacity(0.19),
              ),InkWell(
                onTap: () {
                  Navigator.of(context).pop();
                },
                child: Container(
                    alignment: Alignment.center,
                    child: Text(
                      TextConst.deleteFolderPopUpText,
                      style: interRegular.copyWith(
                          color: ThemeManager().getBlackColor,
                          fontSize: width * 0.035),
                    )),
              )
            ],
          ),
          // value: 1,
        ),
      ],
    );
  }
}

class ExpandedFolders extends StatefulWidget {
  String parentFolder;
  String customerId;
  bool isExpanded = false;
  FirebaseFirestore customerFirestore;
  Locale locale;
  ExpandedFolders({required this.parentFolder,required this.customerFirestore,required this.customerId,required this.locale});

  @override
  _ExpandedFoldersState createState() => _ExpandedFoldersState();
}

class _ExpandedFoldersState extends State<ExpandedFolders> {
  showNextLevelFolder(String data) {
    int step = 0;

    return StreamBuilder<QuerySnapshot>(
        stream: AppFirestore(firestore: widget.customerFirestore,projectId: "",auth: FirebaseAuth.instance).getFolders(parentFolder: data),
        builder: (context, snapshot) {
          if (snapshot.hasData && snapshot.data!.docs.length>0) {
            step++;
            return   ListView.builder(
                physics: ClampingScrollPhysics(),
                // separatorBuilder: (context, index) {
                //   return Divider();
                // },
                shrinkWrap: true,
                padding: EdgeInsets.zero,
                itemCount: snapshot.data!.docs.length,
                itemBuilder: (_, index) {

                  return   Padding(
                    padding:  EdgeInsets.fromLTRB((step* 20), 2, 0, 2),
                    child: Column(
                      children: [
                        Stack(
                          children: [
                            Align(alignment: Alignment.centerLeft,child: Padding(
                              padding:  EdgeInsets.fromLTRB(0, 0, 0, 0),
                              child: Column(
                                children: [
                                  Row(
                                    children: [
                                      GestureDetector(
                                        onTap: () {
                                          setState(() {
                                            widget.isExpanded = !widget.isExpanded;
                                          });
                                        },
                                        //newFolder.isExpanded == fals
                                        child: widget.isExpanded
                                            ? Icon(
                                          Icons.keyboard_arrow_up_outlined,
                                          size: width * 0.085,
                                          color: ThemeManager().getDarkGrey2Color,
                                        )
                                            : Icon(
                                          Icons.keyboard_arrow_down_outlined,
                                          size: width * 0.085,
                                          color: ThemeManager().getDarkGrey2Color,
                                        ),
                                      ),
                                      Container(
                                        margin: EdgeInsets.only(
                                          left: width * 0.02,
                                        ),
                                        child: SvgPicture.asset(
                                          ("assets/svg/folderIcon.svg"),
                                          fit: BoxFit.cover,
                                        ),
                                      ),
                                      Container(
                                          margin: EdgeInsets.only(
                                            left: width * 0.03,
                                          ),
                                          child: Text(
                                            snapshot.data!.docs[index]["name"],
                                            style: interRegular.copyWith(
                                              color: ThemeManager().getBlackColor,
                                              fontSize: width * 0.045,
                                            ),
                                          )),

                                      // Container(
                                      // //  height: 50,
                                      //   width: MediaQuery.of(context).size.width,
                                      //   child: Stack(
                                      //     children: [
                                      //       Align(
                                      //         alignment: Alignment.centerLeft,
                                      //         child: Row(
                                      //           children: [
                                      //             GestureDetector(
                                      //               onTap: () {
                                      //                 // setState(() {
                                      //                 //   newFolder.isExpanded = !(newFolder.isExpanded);
                                      //                 //   newFolder.isVisible = !newFolder.isVisible;
                                      //                 // });
                                      //               },
                                      //               //newFolder.isExpanded == fals
                                      //               child: false
                                      //                   ? Icon(
                                      //                 Icons.keyboard_arrow_up_outlined,
                                      //                 size: width * 0.085,
                                      //                 color: ThemeManager().getDarkGrey2Color,
                                      //               )
                                      //                   : Icon(
                                      //                 Icons.keyboard_arrow_down_outlined,
                                      //                 size: width * 0.085,
                                      //                 color: ThemeManager().getDarkGrey2Color,
                                      //               ),
                                      //             ),
                                      //             Container(
                                      //               margin: EdgeInsets.only(
                                      //                 left: width * 0.02,
                                      //               ),
                                      //               child: SvgPicture.asset(
                                      //                 ("assets/svg/folderIcon.svg"),
                                      //                 fit: BoxFit.cover,
                                      //               ),
                                      //             ),
                                      //             Container(
                                      //                 margin: EdgeInsets.only(
                                      //                   left: width * 0.03,
                                      //                 ),
                                      //                 child: Text(
                                      //                   snapshot.data!.docs[index]["name"],
                                      //                   style: interRegular.copyWith(
                                      //                     color: ThemeManager().getBlackColor,
                                      //                     fontSize: width * 0.045,
                                      //                   ),
                                      //                 ))
                                      //             // Column(
                                      //             //   mainAxisAlignment:
                                      //             //   MainAxisAlignment.center,
                                      //             //   crossAxisAlignment:
                                      //             //   CrossAxisAlignment.start,
                                      //             //   children: [
                                      //             //
                                      //             //     Text(
                                      //             //       snapshot.data!.docs[index]["name"]
                                      //             //           .toString(),
                                      //             //       style: TextStyle(
                                      //             //           fontWeight:
                                      //             //           FontWeight.bold,
                                      //             //           color: Colors.black),
                                      //             //     ),
                                      //             //     timeFormate(snapshot.data!.docs[index]["created_at"]),
                                      //             //   ],
                                      //             // ),
                                      //           ],
                                      //         ),
                                      //       ),
                                      //       Align(
                                      //         alignment: Alignment.centerRight,
                                      //         child: Container(
                                      //           height: MediaQuery.of(context)
                                      //               .size
                                      //               .height,
                                      //           width: 50,
                                      //           child: PopupMenuButton<folderAction>(
                                      //             onSelected: (folderAction value) {
                                      //               if (value ==
                                      //                   folderAction.rename) {
                                      //                 //rename folder
                                      //                 TextEditingController
                                      //                 controller =
                                      //                 TextEditingController(
                                      //                     text: snapshot.data!.docs[index]
                                      //                     ["name"]
                                      //                         .toString());
                                      //
                                      //                 Navigator.of(context)
                                      //                     .push(
                                      //                     new MaterialPageRoute<
                                      //                         Null>(
                                      //                         builder:
                                      //                             (BuildContext
                                      //                         context) {
                                      //                           return Scaffold(
                                      //                             appBar: AppBar(
                                      //                               title: Text(
                                      //                                   "Rename Folder"),
                                      //                             ),
                                      //                             body: Container(
                                      //                               decoration:
                                      //                               BoxDecoration(
                                      //                                 color: Color
                                      //                                     .fromARGB(
                                      //                                     255,
                                      //                                     247,
                                      //                                     247,
                                      //                                     247),
                                      //                                 borderRadius: BorderRadius.only(
                                      //                                     topLeft:
                                      //                                     Radius.circular(
                                      //                                         10.0),
                                      //                                     topRight:
                                      //                                     Radius.circular(10.0)),
                                      //                               ),
                                      //                               child:
                                      //                               Padding(
                                      //                                 padding: const EdgeInsets
                                      //                                     .all(
                                      //                                     15.0),
                                      //                                 child: Wrap(
                                      //                                   children: [
                                      //                                     Padding(
                                      //                                       padding:
                                      //                                       const EdgeInsets.all(8.0),
                                      //                                       child:
                                      //                                       TextFormField(
                                      //                                         controller:
                                      //                                         controller,
                                      //                                         autofocus:
                                      //                                         true,
                                      //                                         decoration:
                                      //                                         InputDecoration(
                                      //                                           labelText: 'Folder Name',
                                      //                                           border: OutlineInputBorder(),
                                      //                                         ),
                                      //                                       ),
                                      //                                     ),
                                      //                                     InkWell(
                                      //                                       onTap:
                                      //                                           () {
                                      //                                         widget.customerFirestore.collection("folders").doc(snapshot.data!.docs[index].id).update({
                                      //                                           "name": controller.text
                                      //                                         }).then((value) {
                                      //                                           Navigator.pop(context);
                                      //                                         });
                                      //                                       },
                                      //                                       child:
                                      //                                       Card(
                                      //                                         color:
                                      //                                         Theme.of(context).primaryColor,
                                      //                                         child: Center(
                                      //                                             child: Padding(
                                      //                                               padding: const EdgeInsets.all(10.0),
                                      //                                               child: Text(
                                      //                                                 "Submit",
                                      //                                                 style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold),
                                      //                                               ),
                                      //                                             )),
                                      //                                       ),
                                      //                                     )
                                      //                                   ],
                                      //                                 ),
                                      //                               ),
                                      //                             ),
                                      //                           );
                                      //                         },
                                      //                         fullscreenDialog:
                                      //                         true));
                                      //               }
                                      //               if (value ==
                                      //                   folderAction.delete) {
                                      //                 //rename folder
                                      //                 showModalBottomSheet(
                                      //                     context: context,
                                      //                     builder: (builder) {
                                      //                       return new Wrap(
                                      //                         children: [
                                      //                           Padding(
                                      //                             padding:
                                      //                             const EdgeInsets
                                      //                                 .all(8.0),
                                      //                             child: Text(
                                      //                               "Do you want to delete this Folder?",
                                      //                               style: TextStyle(
                                      //                                   fontSize: 20,
                                      //                                   color: Theme.of(
                                      //                                       context)
                                      //                                       .primaryColor),
                                      //                             ),
                                      //                           ),
                                      //                           Row(
                                      //                             children: [
                                      //                               Expanded(
                                      //                                   child:
                                      //                                   InkWell(
                                      //                                     onTap: () {
                                      //                                       Navigator.of(
                                      //                                           context)
                                      //                                           .pop();
                                      //                                     },
                                      //                                     child: Padding(
                                      //                                       padding:
                                      //                                       const EdgeInsets
                                      //                                           .all(
                                      //                                           8.0),
                                      //                                       child: Card(
                                      //                                         elevation:
                                      //                                         8,
                                      //                                         color: Colors
                                      //                                             .grey,
                                      //                                         child: Center(
                                      //                                             child: Padding(
                                      //                                               padding: const EdgeInsets
                                      //                                                   .all(
                                      //                                                   15.0),
                                      //                                               child:
                                      //                                               Text(
                                      //                                                 "Cancel",
                                      //                                                 style: TextStyle(
                                      //                                                     color:
                                      //                                                     Colors.white,
                                      //                                                     fontWeight: FontWeight.bold),
                                      //                                               ),
                                      //                                             )),
                                      //                                       ),
                                      //                                     ),
                                      //                                   )),
                                      //                               Expanded(
                                      //                                   child:
                                      //                                   InkWell(
                                      //                                     onTap: () {
                                      //                                       widget
                                      //                                           .customerFirestore
                                      //                                           .collection(
                                      //                                           "folders")
                                      //                                           .doc(snapshot.data!.docs[index].id)
                                      //                                           .delete()
                                      //                                           .then(
                                      //                                               (value) {
                                      //                                             Navigator.pop(
                                      //                                                 context);
                                      //                                           });
                                      //                                     },
                                      //                                     child: Padding(
                                      //                                       padding:
                                      //                                       const EdgeInsets
                                      //                                           .all(
                                      //                                           8.0),
                                      //                                       child: Card(
                                      //                                         elevation:
                                      //                                         8,
                                      //                                         color: Theme.of(
                                      //                                             context)
                                      //                                             .primaryColor,
                                      //                                         child: Center(
                                      //                                             child: Padding(
                                      //                                               padding: const EdgeInsets
                                      //                                                   .all(
                                      //                                                   15.0),
                                      //                                               child:
                                      //                                               Text(
                                      //                                                 "Delete",
                                      //                                                 style: TextStyle(
                                      //                                                     color:
                                      //                                                     Colors.white,
                                      //                                                     fontWeight: FontWeight.bold),
                                      //                                               ),
                                      //                                             )),
                                      //                                       ),
                                      //                                     ),
                                      //                                   )),
                                      //                             ],
                                      //                           ),
                                      //                         ],
                                      //                       );
                                      //                     });
                                      //               }
                                      //
                                      //               if (value == folderAction.move) {
                                      //                 //rename folder
                                      //                 showModalBottomSheet(
                                      //                     context: context,
                                      //                     builder: (builder) {
                                      //                       return new Wrap(
                                      //                         children: [
                                      //                           ListTile(
                                      //                             title: Text(
                                      //                               "Move Folder",
                                      //                               style: TextStyle(
                                      //                                   fontSize: 20,
                                      //                                   color: Theme.of(
                                      //                                       context)
                                      //                                       .primaryColor),
                                      //                             ),
                                      //                             trailing: Padding(
                                      //                               padding:
                                      //                               const EdgeInsets
                                      //                                   .all(8.0),
                                      //                               child: InkWell(
                                      //                                 onTap: () {
                                      //                                   Navigator.of(
                                      //                                       context)
                                      //                                       .pop();
                                      //                                 },
                                      //                                 child: Icon(
                                      //                                     Icons
                                      //                                         .close),
                                      //                               ),
                                      //                             ),
                                      //                           ),
                                      //                           Padding(
                                      //                             padding:
                                      //                             const EdgeInsets
                                      //                                 .all(8.0),
                                      //                             child: Text(
                                      //                               "Move Folder",
                                      //                               style: TextStyle(
                                      //                                   fontSize: 20,
                                      //                                   color: Theme.of(
                                      //                                       context)
                                      //                                       .primaryColor),
                                      //                             ),
                                      //                           ),
                                      //
                                      //                           MoveFolderActivity(
                                      //                             customerId: widget
                                      //                                 .customerId,
                                      //                             customerFirestore:
                                      //                             widget
                                      //                                 .customerFirestore,
                                      //                             curentFolderID:snapshot.data!.docs[index].id,locale: widget.locale,
                                      //                           ),
                                      //                           //here show move folder target
                                      //                         ],
                                      //                       );
                                      //                     });
                                      //               }
                                      //             },
                                      //             child:
                                      //             Center(child: Icon(Icons.menu)),
                                      //             itemBuilder: (BuildContext
                                      //             context) =>
                                      //             <PopupMenuEntry<folderAction>>[
                                      //               PopupMenuItem<folderAction>(
                                      //                 value: folderAction.rename,
                                      //                 child: Text('Rename'),
                                      //               ),
                                      //               PopupMenuItem<folderAction>(
                                      //                 value: folderAction.delete,
                                      //                 child: Text('Delete'),
                                      //               ),
                                      //               PopupMenuItem<folderAction>(
                                      //                 value: folderAction.move,
                                      //                 child: Text('Move'),
                                      //               ),
                                      //             ],
                                      //           ),
                                      //         ),
                                      //       ),
                                      //     ],
                                      //   ),
                                      // ),
                                      // Container(
                                      //
                                      //  // width: MediaQuery.of(context).size.width,
                                      //   child:showNextLevelFolder(snapshot.data!.docs[index].id),)

                                    ],
                                  ),

                                  if(widget.isExpanded) showNextLevelFolder(snapshot.data!.docs[index].id),
                                  //showTestItemsInFolder(snapshot.data!.docs[index].id),

                                ],
                              ),
                            ),),
                            // Align(alignment: Alignment.centerRight,child: addOrDeletePopMenuBox(snapshot.data!.docs[index].id),),
                          ],
                        ),
                       // if(widget.isExpanded)   Padding(padding: EdgeInsets.fromLTRB(40,0,0,0),child:  showTestItemsInFolder(snapshot.data!.docs[index].id),),

                      ],
                    ),
                  );

                });


            return Text( snapshot.data!.docs.length.toString());
          }else return Container(width: 0,height: 0,);
        });
  }
  @override
  Widget build(BuildContext context) {
    return showNextLevelFolder(widget.parentFolder);
  }
}


class ExpandedFiles extends StatefulWidget {
  String parentFolder;
  String customerId;
  bool isExpanded = false;
  FirebaseFirestore customerFirestore;
  Locale locale;
  ExpandedFiles({required this.parentFolder,required this.customerFirestore,required this.customerId,required this.locale});

  @override
  _ExpandedFilesState createState() => _ExpandedFilesState();
}

class _ExpandedFilesState extends State<ExpandedFiles> {
  showTestItemsInFolder(String id) {
    return  StreamBuilder<QuerySnapshot>(
        stream: widget.customerFirestore
            .collection("folders")
            .doc(id)
            .collection("records")
            .snapshots(),
        builder: (context, snapshot) {
          if (snapshot.hasData && snapshot.data!.docs.length>0) {
            // return Text(snapshot.data.docs[0].get("id"));
            Map<String, String> fileAndFolderSource =
            Map<String, String>();

            List<QueryDocumentSnapshot<Object>> filteredData = [];
            List<DocumentSnapshot<Object>> allData = [];

            // for (int i = 0; i < snapshot.data!.docs.length; i++) {
            //   // allData.add(value)
            //
            //   widget.customerFirestore
            //       .collection("pulltest")
            //       .doc(snapshot.data!.docs[i].get("id"))
            //       .get()
            //       .then((value) {
            //     //value.data()["folderID"]= snapshot.data.docs[i].id;
            //     // Map<String, dynamic> da = value.data();
            //     fileAndFolderSource.putIfAbsent(
            //         value.id, () => snapshot.data!.docs[i].id);
            //
            //     //da["folderID"] = snapshot.data.docs[i].id;
            //     allData.add(value);
            //     FilteredDataShow.getInstance().dataReload(allData);
            //
            //     print("size " + allData.length.toString());
            //   });
            // }

            // if (selectedSortType == fileSortType.none) {
            //   filteredData = snapshot.data.docs;
            // } else if (selectedSortType == fileSortType.date) {
            //   filteredData = snapshot.data.docs;
            //   filteredData.sort((a, b) {
            //     return a
            //         .get("name")
            //         .toString()
            //         .toLowerCase()
            //         .compareTo(b.get("name").toString().toLowerCase());
            //   });
            // }
            print("now = > " + allData.length.toString());

            return ListView.builder(
                physics: ClampingScrollPhysics(),
                // separatorBuilder: (context, index) {
                //   return Divider();
                // },
                padding: EdgeInsets.zero,
                shrinkWrap: true,
                itemCount:snapshot.data!.docs.length,
                itemBuilder: (_, index) {

                  try{
                    return    FutureBuilder<DocumentSnapshot>(
                        future:     widget.customerFirestore
                            .collection("pulltest")
                            .doc(snapshot.data!.docs[index].get("id"))
                            .get(),
                        builder: (BuildContext context, AsyncSnapshot<DocumentSnapshot> snapshot) {

                          if(snapshot.hasData){
                            return Container(

                              child: Stack(
                                children: [
                                  Align(
                                    alignment: Alignment.centerLeft,
                                    child: InkWell(
                                      onTap: () {

                                        if (snapshot.data!.exists &&
                                            snapshot.data!
                                                .get("name") !=
                                                null) {
                                          AppWidgets(customerId:  widget.customerId,customerFirestore:  widget
                                              .customerFirestore). showTestRecordBody(

                                              snapshot.data!.id,
                                              snapshot.data!,
                                              context,widget.locale,2
                                          );
                                        }
                                      },
                                      child: Row(
                                        children: [
                                          Padding(
                                            padding: const EdgeInsets.fromLTRB(0,0,10,0),
                                            child: Container(
                                              margin: EdgeInsets.only(
                                                left: width * 0.02,
                                              ),
                                              child: Image.asset("assets/svg/gr.png"),
                                              // child: SvgPicture.asset(
                                              //   ("assets/svg/gr.svg"),
                                              //   fit: BoxFit.cover,
                                              // ),
                                            ),
                                          ),
                                          Text(
                                              snapshot.data!
                                                  .get("name"),
                                              style: TextStyle(
                                                  fontWeight:
                                                  FontWeight
                                                      .bold,
                                                  color: Colors
                                                      .black)),
                                          // Column(
                                          //   mainAxisAlignment:
                                          //   MainAxisAlignment
                                          //       .start,
                                          //   crossAxisAlignment:
                                          //   CrossAxisAlignment
                                          //       .start,
                                          //   children: [
                                          //     Text(
                                          //         sortedList[index]
                                          //             .get("name"),
                                          //         style: TextStyle(
                                          //             fontWeight:
                                          //             FontWeight
                                          //                 .bold,
                                          //             color: Colors
                                          //                 .black)),
                                          //     timeFormate(
                                          //         sortedList[index]
                                          //             .get("time")),
                                          //   ],
                                          // ),
                                        ],
                                      ),
                                    ),
                                  ),
                                  // Align(
                                  //   alignment: Alignment.centerRight,
                                  //   child: Container(
                                  //     child:  Align(alignment: Alignment.centerRight,child: deleteMoveForTestPopMenuBox(snapshot.data!.id,snapshot.data!.data()),),
                                  //
                                  //
                                  //     // child: PopupMenuButton<
                                  //     //     folderAction>(
                                  //     //   onSelected:
                                  //     //       (folderAction value) {
                                  //     //     if (value ==
                                  //     //         folderAction.move) {
                                  //     //       //rename folder
                                  //     //       showModalBottomSheet(
                                  //     //           context: context,
                                  //     //           builder: (builder) {
                                  //     //             return new Wrap(
                                  //     //               children: [
                                  //     //                 ListTile(
                                  //     //                   title: Text(
                                  //     //                     "Move File",
                                  //     //                     style: TextStyle(
                                  //     //                         fontSize:
                                  //     //                         20,
                                  //     //                         color: Theme.of(context)
                                  //     //                             .primaryColor),
                                  //     //                   ),
                                  //     //                   trailing:
                                  //     //                   Padding(
                                  //     //                     padding:
                                  //     //                     const EdgeInsets.all(
                                  //     //                         8.0),
                                  //     //                     child:
                                  //     //                     InkWell(
                                  //     //                       onTap:
                                  //     //                           () {
                                  //     //                         Navigator.of(context)
                                  //     //                             .pop();
                                  //     //                       },
                                  //     //                       child: Icon(
                                  //     //                           Icons
                                  //     //                               .close),
                                  //     //                     ),
                                  //     //                   ),
                                  //     //                 ),
                                  //     //                 //.get("folderID").toString()
                                  //     //                 //Text(fileAndFolderSource[sortedList[index].id]),
                                  //     //
                                  //     //                 MoveFileActivity(
                                  //     //                   dataToMove:
                                  //     //                   sortedList[index]
                                  //     //                       .data(),
                                  //     //                   recordId: fileAndFolderSource[
                                  //     //                   sortedList[index]
                                  //     //                       .id]!,
                                  //     //                   customerId:
                                  //     //                   widget
                                  //     //                       .customerId,
                                  //     //                   customerFirestore:
                                  //     //                   widget
                                  //     //                       .customerFirestore,
                                  //     //                   curentFolderID: widget
                                  //     //                       .folderStack
                                  //     //                       .last,locale: widget.locale,),
                                  //     //                 //here show move folder target
                                  //     //               ],
                                  //     //             );
                                  //     //           });
                                  //     //     }
                                  //     //   },
                                  //     //   child: Center(
                                  //     //       child: Icon(
                                  //     //         Icons.menu,
                                  //     //         color: Colors.black,
                                  //     //       )),
                                  //     //   itemBuilder: (BuildContext
                                  //     //   context) =>
                                  //     //   <
                                  //     //       PopupMenuEntry<
                                  //     //           folderAction>>[
                                  //     //     PopupMenuItem<folderAction>(
                                  //     //       value: folderAction.move,
                                  //     //       child: Text('Move'),
                                  //     //     ),
                                  //     //   ],
                                  //     // ),
                                  //   ),
                                  // ),
                                ],
                              ),
                            );
                          }else return Container(height: 0,width: 0,);
                        });
                  }catch(e){
                    return Container(

                      child: Stack(
                        children: [
                          Align(
                            alignment: Alignment.centerLeft,
                            child: InkWell(
                              onTap: () {


                              },
                              child: Row(
                                children: [
                                  Padding(
                                    padding: const EdgeInsets.fromLTRB(0,0,10,0),
                                    child: Container(
                                      margin: EdgeInsets.only(
                                        left: width * 0.02,
                                      ),
                                      child: Image.asset("assets/svg/gr.png"),
                                      // child: SvgPicture.asset(
                                      //   ("assets/svg/gr.svg"),
                                      //   fit: BoxFit.cover,
                                      // ),
                                    ),
                                  ),
                                  Text("Not Found",
                                      style: TextStyle(
                                          fontWeight:
                                          FontWeight
                                              .bold,
                                          color: Colors
                                              .black)),
                                  // Column(
                                  //   mainAxisAlignment:
                                  //   MainAxisAlignment
                                  //       .start,
                                  //   crossAxisAlignment:
                                  //   CrossAxisAlignment
                                  //       .start,
                                  //   children: [
                                  //     Text(
                                  //         sortedList[index]
                                  //             .get("name"),
                                  //         style: TextStyle(
                                  //             fontWeight:
                                  //             FontWeight
                                  //                 .bold,
                                  //             color: Colors
                                  //                 .black)),
                                  //     timeFormate(
                                  //         sortedList[index]
                                  //             .get("time")),
                                  //   ],
                                  // ),
                                ],
                              ),
                            ),
                          ),
                          // Align(
                          //   alignment: Alignment.centerRight,
                          //   child: Container(
                          //     child:  Align(alignment: Alignment.centerRight,child: addOrDeletePopMenuBox(""),),
                          //
                          //
                          //     // child: PopupMenuButton<
                          //     //     folderAction>(
                          //     //   onSelected:
                          //     //       (folderAction value) {
                          //     //     if (value ==
                          //     //         folderAction.move) {
                          //     //       //rename folder
                          //     //       showModalBottomSheet(
                          //     //           context: context,
                          //     //           builder: (builder) {
                          //     //             return new Wrap(
                          //     //               children: [
                          //     //                 ListTile(
                          //     //                   title: Text(
                          //     //                     "Move File",
                          //     //                     style: TextStyle(
                          //     //                         fontSize:
                          //     //                         20,
                          //     //                         color: Theme.of(context)
                          //     //                             .primaryColor),
                          //     //                   ),
                          //     //                   trailing:
                          //     //                   Padding(
                          //     //                     padding:
                          //     //                     const EdgeInsets.all(
                          //     //                         8.0),
                          //     //                     child:
                          //     //                     InkWell(
                          //     //                       onTap:
                          //     //                           () {
                          //     //                         Navigator.of(context)
                          //     //                             .pop();
                          //     //                       },
                          //     //                       child: Icon(
                          //     //                           Icons
                          //     //                               .close),
                          //     //                     ),
                          //     //                   ),
                          //     //                 ),
                          //     //                 //.get("folderID").toString()
                          //     //                 //Text(fileAndFolderSource[sortedList[index].id]),
                          //     //
                          //     //                 MoveFileActivity(
                          //     //                   dataToMove:
                          //     //                   sortedList[index]
                          //     //                       .data(),
                          //     //                   recordId: fileAndFolderSource[
                          //     //                   sortedList[index]
                          //     //                       .id]!,
                          //     //                   customerId:
                          //     //                   widget
                          //     //                       .customerId,
                          //     //                   customerFirestore:
                          //     //                   widget
                          //     //                       .customerFirestore,
                          //     //                   curentFolderID: widget
                          //     //                       .folderStack
                          //     //                       .last,locale: widget.locale,),
                          //     //                 //here show move folder target
                          //     //               ],
                          //     //             );
                          //     //           });
                          //     //     }
                          //     //   },
                          //     //   child: Center(
                          //     //       child: Icon(
                          //     //         Icons.menu,
                          //     //         color: Colors.black,
                          //     //       )),
                          //     //   itemBuilder: (BuildContext
                          //     //   context) =>
                          //     //   <
                          //     //       PopupMenuEntry<
                          //     //           folderAction>>[
                          //     //     PopupMenuItem<folderAction>(
                          //     //       value: folderAction.move,
                          //     //       child: Text('Move'),
                          //     //     ),
                          //     //   ],
                          //     // ),
                          //   ),
                          // ),
                        ],
                      ),
                    );
                  }

                  return Text(snapshot.data!.docs[index].id);
                });


          } else {
            return Container(width: 0,height: 0,);
          }
        });

  }
  @override
  Widget build(BuildContext context) {
    return Container();
  }
}
showTestItemsInFolderForReporting(String id,FirebaseFirestore customerFirestore,String customerId,Locale locale) {
  try{
    return  StreamBuilder<QuerySnapshot>(
        stream:customerFirestore
            .collection("folders")
            .doc(id)
            .collection("records")
            .snapshots(),
        builder: (context, snapshot)  {
          if (snapshot.hasData && snapshot.data!.docs.length>0) {
            // return Text(snapshot.data.docs[0].get("id"));
            Map<String, String> fileAndFolderSource =
            Map<String, String>();

            List<DocumentSnapshot<Object>> allData = [];

            // for (int i = 0; i < snapshot.data!.docs.length; i++) {
            //   // allData.add(value)
            //
            //   widget.customerFirestore
            //       .collection("pulltest")
            //       .doc(snapshot.data!.docs[i].get("id"))
            //       .get()
            //       .then((value) {
            //     //value.data()["folderID"]= snapshot.data.docs[i].id;
            //     // Map<String, dynamic> da = value.data();
            //     fileAndFolderSource.putIfAbsent(
            //         value.id, () => snapshot.data!.docs[i].id);
            //
            //     //da["folderID"] = snapshot.data.docs[i].id;
            //     allData.add(value);
            //     FilteredDataShow.getInstance().dataReload(allData);
            //
            //     print("size " + allData.length.toString());
            //   });
            // }

            // if (selectedSortType == fileSortType.none) {
            //   filteredData = snapshot.data.docs;
            // } else if (selectedSortType == fileSortType.date) {
            //   filteredData = snapshot.data.docs;
            //   filteredData.sort((a, b) {
            //     return a
            //         .get("name")
            //         .toString()
            //         .toLowerCase()
            //         .compareTo(b.get("name").toString().toLowerCase());
            //   });
            // }
            print("now = > " + allData.length.toString());




            //sort here
            List<QueryDocumentSnapshot> filteredData = [];
            filteredData = snapshot.data!.docs;








           //  for(int i = 0 ; i < snapshot.data!.docs.length ; i ++){
           //   try{
           //    var res =  customerFirestore
           //         .collection("pulltest")
           //         .doc( snapshot.data!.docs[i].get("id")).g
           //
           //
           //
           //     Map<String, dynamic> dataToCheck = snapshot.data!.docs[i].data() as Map<String, dynamic>;
           //     if(dataToCheck["name"]!=null){
           //       filteredData.add(snapshot.data!.docs[i]);
           //
           //     }
           //   }catch(e){
           //
           //   }
           // }

            // List<QueryDocumentSnapshot> filteredData = [];
            // filteredData = snapshot.data!.docs;
            // filteredData.sort((a, b) {
            //   return a
            //       .get("name")
            //       .toString()
            //       .toLowerCase()
            //       .compareTo(b.get("name").toString().toLowerCase());
            // });

            filteredData.sort((a, b) {
              return a
                  .get("created_at")
                  .compareTo(b.get("created_at"));
            });

            filteredData.reversed;






            return ListView.separated(
                separatorBuilder: (context, index) {
                  return Divider();
                },
                physics: ClampingScrollPhysics(),
                // separatorBuilder: (context, index) {
                //   return Divider();
                // },
                padding: EdgeInsets.zero,
                shrinkWrap: true,
                itemCount:filteredData.length,
                itemBuilder: (_, index) {

                  try{
                    return    FutureBuilder<DocumentSnapshot>(
                        future:     customerFirestore
                            .collection("pulltest")
                            .doc(filteredData[index].get("id"))
                            .get(),
                        builder: (BuildContext context, AsyncSnapshot<DocumentSnapshot> snapshot) {

                          if(snapshot.hasData){
                            // snapshot.data.data()
                            try{
                              Map<String, dynamic> data = snapshot.data!.data() as Map<String, dynamic>;
                              if(data["name"]!=null){
                                return  InkWell(onTap: (){
                                  print("clciked");


                                 try{
                                   if (snapshot.data!.exists && snapshot.data!.get("name") != null) {

                                     FileClickedForReportingAsStream.getInstance().dataReload(filteredData[index].get("id"));

                                     print("passed");
                                     // if (ReportingsUi(). checkAvailableInFiles(filteredData[index].get("id")) == true) {
                                     //   print("passed true");
                                     //   ReportingsUi(). selectedItemFiles.remove(filteredData[index].get("id"));
                                     //
                                     //   ReportingsLogics().fileSelectedForReportStream().dataReload( ReportingsUi().selectedItemFiles);
                                     // } else {
                                     //   print("passed false");
                                     //   ReportingsUi(). selectedItemFiles.add(filteredData[index].get("id"));
                                     //
                                     //   ReportingsLogics().fileSelectedForReportStream().dataReload( ReportingsUi().selectedItemFiles);
                                     // }

                                   }
                                 }catch(e){

                                 }
                                },
                                  child: Padding(
                                    padding: const EdgeInsets.all(4.0),
                                    child: Padding(
                                      padding: indendfolderPadding,
                                      child: Stack(
                                        children: [
                                          Row(
                                            children: [

                                              Container(
                                                margin: EdgeInsets.only(
                                                  left: width * 0.01,
                                                ),
                                               // child:Image.asset("assets/svg/gr.png",fit: BoxFit.cover,),
                                                child:SvgPicture.asset("assets/svg/loadIcon.svg",fit: BoxFit.cover,color: ThemeManager().getYellowGradientColor,),
                                              ),
                                              Container(
                                                  margin: EdgeInsets.only(
                                                    left: width * 0.03,
                                                  ),
                                                  child: Text(snapshot.data!.get("name").toString().length>15?snapshot.data!.get("name").toString().substring(0,15):snapshot.data!.get("name"),maxLines: 1,
                                                    style: interRegular.copyWith(
                                                      color: ThemeManager().getBlackColor,
                                                      fontSize: width * 0.045,
                                                    ),
                                                  )),

                                              // Container(
                                              // //  height: 50,
                                              //   width: MediaQuery.of(context).size.width,
                                              //   child: Stack(
                                              //     children: [
                                              //       Align(
                                              //         alignment: Alignment.centerLeft,
                                              //         child: Row(
                                              //           children: [
                                              //             GestureDetector(
                                              //               onTap: () {
                                              //                 // setState(() {
                                              //                 //   newFolder.isExpanded = !(newFolder.isExpanded);
                                              //                 //   newFolder.isVisible = !newFolder.isVisible;
                                              //                 // });
                                              //               },
                                              //               //newFolder.isExpanded == fals
                                              //               child: false
                                              //                   ? Icon(
                                              //                 Icons.keyboard_arrow_up_outlined,
                                              //                 size: width * 0.085,
                                              //                 color: ThemeManager().getDarkGrey2Color,
                                              //               )
                                              //                   : Icon(
                                              //                 Icons.keyboard_arrow_down_outlined,
                                              //                 size: width * 0.085,
                                              //                 color: ThemeManager().getDarkGrey2Color,
                                              //               ),
                                              //             ),
                                              //             Container(
                                              //               margin: EdgeInsets.only(
                                              //                 left: width * 0.02,
                                              //               ),
                                              //               child: SvgPicture.asset(
                                              //                 ("assets/svg/folderIcon.svg"),
                                              //                 fit: BoxFit.cover,
                                              //               ),
                                              //             ),
                                              //             Container(
                                              //                 margin: EdgeInsets.only(
                                              //                   left: width * 0.03,
                                              //                 ),
                                              //                 child: Text(
                                              //                   snapshot.data!.docs[index]["name"],
                                              //                   style: interRegular.copyWith(
                                              //                     color: ThemeManager().getBlackColor,
                                              //                     fontSize: width * 0.045,
                                              //                   ),
                                              //                 ))
                                              //             // Column(
                                              //             //   mainAxisAlignment:
                                              //             //   MainAxisAlignment.center,
                                              //             //   crossAxisAlignment:
                                              //             //   CrossAxisAlignment.start,
                                              //             //   children: [
                                              //             //
                                              //             //     Text(
                                              //             //       snapshot.data!.docs[index]["name"]
                                              //             //           .toString(),
                                              //             //       style: TextStyle(
                                              //             //           fontWeight:
                                              //             //           FontWeight.bold,
                                              //             //           color: Colors.black),
                                              //             //     ),
                                              //             //     timeFormate(snapshot.data!.docs[index]["created_at"]),
                                              //             //   ],
                                              //             // ),
                                              //           ],
                                              //         ),
                                              //       ),
                                              //       Align(
                                              //         alignment: Alignment.centerRight,
                                              //         child: Container(
                                              //           height: MediaQuery.of(context)
                                              //               .size
                                              //               .height,
                                              //           width: 50,
                                              //           child: PopupMenuButton<folderAction>(
                                              //             onSelected: (folderAction value) {
                                              //               if (value ==
                                              //                   folderAction.rename) {
                                              //                 //rename folder
                                              //                 TextEditingController
                                              //                 controller =
                                              //                 TextEditingController(
                                              //                     text: snapshot.data!.docs[index]
                                              //                     ["name"]
                                              //                         .toString());
                                              //
                                              //                 Navigator.of(context)
                                              //                     .push(
                                              //                     new MaterialPageRoute<
                                              //                         Null>(
                                              //                         builder:
                                              //                             (BuildContext
                                              //                         context) {
                                              //                           return Scaffold(
                                              //                             appBar: AppBar(
                                              //                               title: Text(
                                              //                                   "Rename Folder"),
                                              //                             ),
                                              //                             body: Container(
                                              //                               decoration:
                                              //                               BoxDecoration(
                                              //                                 color: Color
                                              //                                     .fromARGB(
                                              //                                     255,
                                              //                                     247,
                                              //                                     247,
                                              //                                     247),
                                              //                                 borderRadius: BorderRadius.only(
                                              //                                     topLeft:
                                              //                                     Radius.circular(
                                              //                                         10.0),
                                              //                                     topRight:
                                              //                                     Radius.circular(10.0)),
                                              //                               ),
                                              //                               child:
                                              //                               Padding(
                                              //                                 padding: const EdgeInsets
                                              //                                     .all(
                                              //                                     15.0),
                                              //                                 child: Wrap(
                                              //                                   children: [
                                              //                                     Padding(
                                              //                                       padding:
                                              //                                       const EdgeInsets.all(8.0),
                                              //                                       child:
                                              //                                       TextFormField(
                                              //                                         controller:
                                              //                                         controller,
                                              //                                         autofocus:
                                              //                                         true,
                                              //                                         decoration:
                                              //                                         InputDecoration(
                                              //                                           labelText: 'Folder Name',
                                              //                                           border: OutlineInputBorder(),
                                              //                                         ),
                                              //                                       ),
                                              //                                     ),
                                              //                                     InkWell(
                                              //                                       onTap:
                                              //                                           () {
                                              //                                         widget.customerFirestore.collection("folders").doc(snapshot.data!.docs[index].id).update({
                                              //                                           "name": controller.text
                                              //                                         }).then((value) {
                                              //                                           Navigator.pop(context);
                                              //                                         });
                                              //                                       },
                                              //                                       child:
                                              //                                       Card(
                                              //                                         color:
                                              //                                         Theme.of(context).primaryColor,
                                              //                                         child: Center(
                                              //                                             child: Padding(
                                              //                                               padding: const EdgeInsets.all(10.0),
                                              //                                               child: Text(
                                              //                                                 "Submit",
                                              //                                                 style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold),
                                              //                                               ),
                                              //                                             )),
                                              //                                       ),
                                              //                                     )
                                              //                                   ],
                                              //                                 ),
                                              //                               ),
                                              //                             ),
                                              //                           );
                                              //                         },
                                              //                         fullscreenDialog:
                                              //                         true));
                                              //               }
                                              //               if (value ==
                                              //                   folderAction.delete) {
                                              //                 //rename folder
                                              //                 showModalBottomSheet(
                                              //                     context: context,
                                              //                     builder: (builder) {
                                              //                       return new Wrap(
                                              //                         children: [
                                              //                           Padding(
                                              //                             padding:
                                              //                             const EdgeInsets
                                              //                                 .all(8.0),
                                              //                             child: Text(
                                              //                               "Do you want to delete this Folder?",
                                              //                               style: TextStyle(
                                              //                                   fontSize: 20,
                                              //                                   color: Theme.of(
                                              //                                       context)
                                              //                                       .primaryColor),
                                              //                             ),
                                              //                           ),
                                              //                           Row(
                                              //                             children: [
                                              //                               Expanded(
                                              //                                   child:
                                              //                                   InkWell(
                                              //                                     onTap: () {
                                              //                                       Navigator.of(
                                              //                                           context)
                                              //                                           .pop();
                                              //                                     },
                                              //                                     child: Padding(
                                              //                                       padding:
                                              //                                       const EdgeInsets
                                              //                                           .all(
                                              //                                           8.0),
                                              //                                       child: Card(
                                              //                                         elevation:
                                              //                                         8,
                                              //                                         color: Colors
                                              //                                             .grey,
                                              //                                         child: Center(
                                              //                                             child: Padding(
                                              //                                               padding: const EdgeInsets
                                              //                                                   .all(
                                              //                                                   15.0),
                                              //                                               child:
                                              //                                               Text(
                                              //                                                 "Cancel",
                                              //                                                 style: TextStyle(
                                              //                                                     color:
                                              //                                                     Colors.white,
                                              //                                                     fontWeight: FontWeight.bold),
                                              //                                               ),
                                              //                                             )),
                                              //                                       ),
                                              //                                     ),
                                              //                                   )),
                                              //                               Expanded(
                                              //                                   child:
                                              //                                   InkWell(
                                              //                                     onTap: () {
                                              //                                       widget
                                              //                                           .customerFirestore
                                              //                                           .collection(
                                              //                                           "folders")
                                              //                                           .doc(snapshot.data!.docs[index].id)
                                              //                                           .delete()
                                              //                                           .then(
                                              //                                               (value) {
                                              //                                             Navigator.pop(
                                              //                                                 context);
                                              //                                           });
                                              //                                     },
                                              //                                     child: Padding(
                                              //                                       padding:
                                              //                                       const EdgeInsets
                                              //                                           .all(
                                              //                                           8.0),
                                              //                                       child: Card(
                                              //                                         elevation:
                                              //                                         8,
                                              //                                         color: Theme.of(
                                              //                                             context)
                                              //                                             .primaryColor,
                                              //                                         child: Center(
                                              //                                             child: Padding(
                                              //                                               padding: const EdgeInsets
                                              //                                                   .all(
                                              //                                                   15.0),
                                              //                                               child:
                                              //                                               Text(
                                              //                                                 "Delete",
                                              //                                                 style: TextStyle(
                                              //                                                     color:
                                              //                                                     Colors.white,
                                              //                                                     fontWeight: FontWeight.bold),
                                              //                                               ),
                                              //                                             )),
                                              //                                       ),
                                              //                                     ),
                                              //                                   )),
                                              //                             ],
                                              //                           ),
                                              //                         ],
                                              //                       );
                                              //                     });
                                              //               }
                                              //
                                              //               if (value == folderAction.move) {
                                              //                 //rename folder
                                              //                 showModalBottomSheet(
                                              //                     context: context,
                                              //                     builder: (builder) {
                                              //                       return new Wrap(
                                              //                         children: [
                                              //                           ListTile(
                                              //                             title: Text(
                                              //                               "Move Folder",
                                              //                               style: TextStyle(
                                              //                                   fontSize: 20,
                                              //                                   color: Theme.of(
                                              //                                       context)
                                              //                                       .primaryColor),
                                              //                             ),
                                              //                             trailing: Padding(
                                              //                               padding:
                                              //                               const EdgeInsets
                                              //                                   .all(8.0),
                                              //                               child: InkWell(
                                              //                                 onTap: () {
                                              //                                   Navigator.of(
                                              //                                       context)
                                              //                                       .pop();
                                              //                                 },
                                              //                                 child: Icon(
                                              //                                     Icons
                                              //                                         .close),
                                              //                               ),
                                              //                             ),
                                              //                           ),
                                              //                           Padding(
                                              //                             padding:
                                              //                             const EdgeInsets
                                              //                                 .all(8.0),
                                              //                             child: Text(
                                              //                               "Move Folder",
                                              //                               style: TextStyle(
                                              //                                   fontSize: 20,
                                              //                                   color: Theme.of(
                                              //                                       context)
                                              //                                       .primaryColor),
                                              //                             ),
                                              //                           ),
                                              //
                                              //                           MoveFolderActivity(
                                              //                             customerId: widget
                                              //                                 .customerId,
                                              //                             customerFirestore:
                                              //                             widget
                                              //                                 .customerFirestore,
                                              //                             curentFolderID:snapshot.data!.docs[index].id,locale: widget.locale,
                                              //                           ),
                                              //                           //here show move folder target
                                              //                         ],
                                              //                       );
                                              //                     });
                                              //               }
                                              //             },
                                              //             child:
                                              //             Center(child: Icon(Icons.menu)),
                                              //             itemBuilder: (BuildContext
                                              //             context) =>
                                              //             <PopupMenuEntry<folderAction>>[
                                              //               PopupMenuItem<folderAction>(
                                              //                 value: folderAction.rename,
                                              //                 child: Text('Rename'),
                                              //               ),
                                              //               PopupMenuItem<folderAction>(
                                              //                 value: folderAction.delete,
                                              //                 child: Text('Delete'),
                                              //               ),
                                              //               PopupMenuItem<folderAction>(
                                              //                 value: folderAction.move,
                                              //                 child: Text('Move'),
                                              //               ),
                                              //             ],
                                              //           ),
                                              //         ),
                                              //       ),
                                              //     ],
                                              //   ),
                                              // ),
                                              // Container(
                                              //
                                              //  // width: MediaQuery.of(context).size.width,
                                              //   child:showNextLevelFolder(snapshot.data!.docs[index].id),)

                                            ],
                                          ),
                                          // Align(alignment: Alignment.centerRight,child: Padding(
                                          //   padding: const EdgeInsets.all(8.0),
                                          //   child: Icon(Icons.done_outline),
                                          // ),) ,
                                          Align(alignment: Alignment.centerRight,child: Padding(
                                            padding:  EdgeInsets.only(right: width*0.01),
                                            child: StreamBuilder<List>(
                                                                        stream: ReportingsLogics().fileSelectedForReportStream().outData,
                                                                        builder: (c, snapshot) {
                                                                          if(snapshot.hasData){
                                                                            try{
                                                                              print("stream came "+snapshot.data!.length.toString());
                                                                              return snapshot.data!.contains(filteredData[index].get("id"))?Text("Remove")

                                                                                  : Text("Add");

                                                                              // return Text(
                                                                              //   ReportingsUi(). checkAvailableInFiles(filteredData[index].get("id"))
                                                                              //       ? "Remove"
                                                                              //       : "Select",
                                                                              //   style: TextStyle(
                                                                              //       color:
                                                                              //       Theme.of(context)
                                                                              //           .primaryColor,
                                                                              //       fontWeight:
                                                                              //       FontWeight.bold),
                                                                              // );


                                                                            }catch(e){
                                                                              return Text("Add");

                                                                            }
                                                                          }else{
                                                                            return Text("Add");
                                                                          }

                                                                          // return Text(
                                                                          //   ReportingsUi(). checkAvailableInFiles(filteredData[index].get("id"))
                                                                          //       ? "Remove"
                                                                          //       : "Select",
                                                                          //   style: TextStyle(
                                                                          //       color:
                                                                          //       Theme.of(context)
                                                                          //           .primaryColor,
                                                                          //       fontWeight:
                                                                          //       FontWeight.bold),
                                                                          // );
                                                                        }),
                                          ),)
                                        ],
                                      ),
                                    ),
                                  ),
                                );
                              }else{
                                return Container(height: 0,width: 0,);
                              }
                            }catch(e){
                              return Container(height: 0,width: 0,);
                            }

                            return Padding(
                              padding: const EdgeInsets.fromLTRB(20, 2, 0, 2),
                              child: InkWell(   onTap: () {

                                if (snapshot.data!.exists &&
                                    snapshot.data!
                                        .get("name") !=
                                        null) {
                                  AppWidgets(customerId: customerId,customerFirestore:customerFirestore). showTestRecordBody(

                                      snapshot.data!.id,
                                      snapshot.data!,
                                      context,locale,2
                                  );
                                }
                              },child:   Row(
                                children: [

                                  Container(
                                    margin: EdgeInsets.only(
                                      // left: width * 0.02,
                                    ),
                                    child:Image.asset("assets/svg/gr.png",fit: BoxFit.cover,),
                                  ),
                                  Container(
                                      margin: EdgeInsets.only(
                                        left: width * 0.03,
                                      ),
                                      child: Flexible(child: Text(snapshot.data!
                                          .get("name"),
                                        style: interRegular.copyWith(
                                          color: ThemeManager().getBlackColor,
                                          fontSize: width * 0.045,
                                        ),
                                      ),)),

                                  // Container(
                                  // //  height: 50,
                                  //   width: MediaQuery.of(context).size.width,
                                  //   child: Stack(
                                  //     children: [
                                  //       Align(
                                  //         alignment: Alignment.centerLeft,
                                  //         child: Row(
                                  //           children: [
                                  //             GestureDetector(
                                  //               onTap: () {
                                  //                 // setState(() {
                                  //                 //   newFolder.isExpanded = !(newFolder.isExpanded);
                                  //                 //   newFolder.isVisible = !newFolder.isVisible;
                                  //                 // });
                                  //               },
                                  //               //newFolder.isExpanded == fals
                                  //               child: false
                                  //                   ? Icon(
                                  //                 Icons.keyboard_arrow_up_outlined,
                                  //                 size: width * 0.085,
                                  //                 color: ThemeManager().getDarkGrey2Color,
                                  //               )
                                  //                   : Icon(
                                  //                 Icons.keyboard_arrow_down_outlined,
                                  //                 size: width * 0.085,
                                  //                 color: ThemeManager().getDarkGrey2Color,
                                  //               ),
                                  //             ),
                                  //             Container(
                                  //               margin: EdgeInsets.only(
                                  //                 left: width * 0.02,
                                  //               ),
                                  //               child: SvgPicture.asset(
                                  //                 ("assets/svg/folderIcon.svg"),
                                  //                 fit: BoxFit.cover,
                                  //               ),
                                  //             ),
                                  //             Container(
                                  //                 margin: EdgeInsets.only(
                                  //                   left: width * 0.03,
                                  //                 ),
                                  //                 child: Text(
                                  //                   snapshot.data!.docs[index]["name"],
                                  //                   style: interRegular.copyWith(
                                  //                     color: ThemeManager().getBlackColor,
                                  //                     fontSize: width * 0.045,
                                  //                   ),
                                  //                 ))
                                  //             // Column(
                                  //             //   mainAxisAlignment:
                                  //             //   MainAxisAlignment.center,
                                  //             //   crossAxisAlignment:
                                  //             //   CrossAxisAlignment.start,
                                  //             //   children: [
                                  //             //
                                  //             //     Text(
                                  //             //       snapshot.data!.docs[index]["name"]
                                  //             //           .toString(),
                                  //             //       style: TextStyle(
                                  //             //           fontWeight:
                                  //             //           FontWeight.bold,
                                  //             //           color: Colors.black),
                                  //             //     ),
                                  //             //     timeFormate(snapshot.data!.docs[index]["created_at"]),
                                  //             //   ],
                                  //             // ),
                                  //           ],
                                  //         ),
                                  //       ),
                                  //       Align(
                                  //         alignment: Alignment.centerRight,
                                  //         child: Container(
                                  //           height: MediaQuery.of(context)
                                  //               .size
                                  //               .height,
                                  //           width: 50,
                                  //           child: PopupMenuButton<folderAction>(
                                  //             onSelected: (folderAction value) {
                                  //               if (value ==
                                  //                   folderAction.rename) {
                                  //                 //rename folder
                                  //                 TextEditingController
                                  //                 controller =
                                  //                 TextEditingController(
                                  //                     text: snapshot.data!.docs[index]
                                  //                     ["name"]
                                  //                         .toString());
                                  //
                                  //                 Navigator.of(context)
                                  //                     .push(
                                  //                     new MaterialPageRoute<
                                  //                         Null>(
                                  //                         builder:
                                  //                             (BuildContext
                                  //                         context) {
                                  //                           return Scaffold(
                                  //                             appBar: AppBar(
                                  //                               title: Text(
                                  //                                   "Rename Folder"),
                                  //                             ),
                                  //                             body: Container(
                                  //                               decoration:
                                  //                               BoxDecoration(
                                  //                                 color: Color
                                  //                                     .fromARGB(
                                  //                                     255,
                                  //                                     247,
                                  //                                     247,
                                  //                                     247),
                                  //                                 borderRadius: BorderRadius.only(
                                  //                                     topLeft:
                                  //                                     Radius.circular(
                                  //                                         10.0),
                                  //                                     topRight:
                                  //                                     Radius.circular(10.0)),
                                  //                               ),
                                  //                               child:
                                  //                               Padding(
                                  //                                 padding: const EdgeInsets
                                  //                                     .all(
                                  //                                     15.0),
                                  //                                 child: Wrap(
                                  //                                   children: [
                                  //                                     Padding(
                                  //                                       padding:
                                  //                                       const EdgeInsets.all(8.0),
                                  //                                       child:
                                  //                                       TextFormField(
                                  //                                         controller:
                                  //                                         controller,
                                  //                                         autofocus:
                                  //                                         true,
                                  //                                         decoration:
                                  //                                         InputDecoration(
                                  //                                           labelText: 'Folder Name',
                                  //                                           border: OutlineInputBorder(),
                                  //                                         ),
                                  //                                       ),
                                  //                                     ),
                                  //                                     InkWell(
                                  //                                       onTap:
                                  //                                           () {
                                  //                                         widget.customerFirestore.collection("folders").doc(snapshot.data!.docs[index].id).update({
                                  //                                           "name": controller.text
                                  //                                         }).then((value) {
                                  //                                           Navigator.pop(context);
                                  //                                         });
                                  //                                       },
                                  //                                       child:
                                  //                                       Card(
                                  //                                         color:
                                  //                                         Theme.of(context).primaryColor,
                                  //                                         child: Center(
                                  //                                             child: Padding(
                                  //                                               padding: const EdgeInsets.all(10.0),
                                  //                                               child: Text(
                                  //                                                 "Submit",
                                  //                                                 style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold),
                                  //                                               ),
                                  //                                             )),
                                  //                                       ),
                                  //                                     )
                                  //                                   ],
                                  //                                 ),
                                  //                               ),
                                  //                             ),
                                  //                           );
                                  //                         },
                                  //                         fullscreenDialog:
                                  //                         true));
                                  //               }
                                  //               if (value ==
                                  //                   folderAction.delete) {
                                  //                 //rename folder
                                  //                 showModalBottomSheet(
                                  //                     context: context,
                                  //                     builder: (builder) {
                                  //                       return new Wrap(
                                  //                         children: [
                                  //                           Padding(
                                  //                             padding:
                                  //                             const EdgeInsets
                                  //                                 .all(8.0),
                                  //                             child: Text(
                                  //                               "Do you want to delete this Folder?",
                                  //                               style: TextStyle(
                                  //                                   fontSize: 20,
                                  //                                   color: Theme.of(
                                  //                                       context)
                                  //                                       .primaryColor),
                                  //                             ),
                                  //                           ),
                                  //                           Row(
                                  //                             children: [
                                  //                               Expanded(
                                  //                                   child:
                                  //                                   InkWell(
                                  //                                     onTap: () {
                                  //                                       Navigator.of(
                                  //                                           context)
                                  //                                           .pop();
                                  //                                     },
                                  //                                     child: Padding(
                                  //                                       padding:
                                  //                                       const EdgeInsets
                                  //                                           .all(
                                  //                                           8.0),
                                  //                                       child: Card(
                                  //                                         elevation:
                                  //                                         8,
                                  //                                         color: Colors
                                  //                                             .grey,
                                  //                                         child: Center(
                                  //                                             child: Padding(
                                  //                                               padding: const EdgeInsets
                                  //                                                   .all(
                                  //                                                   15.0),
                                  //                                               child:
                                  //                                               Text(
                                  //                                                 "Cancel",
                                  //                                                 style: TextStyle(
                                  //                                                     color:
                                  //                                                     Colors.white,
                                  //                                                     fontWeight: FontWeight.bold),
                                  //                                               ),
                                  //                                             )),
                                  //                                       ),
                                  //                                     ),
                                  //                                   )),
                                  //                               Expanded(
                                  //                                   child:
                                  //                                   InkWell(
                                  //                                     onTap: () {
                                  //                                       widget
                                  //                                           .customerFirestore
                                  //                                           .collection(
                                  //                                           "folders")
                                  //                                           .doc(snapshot.data!.docs[index].id)
                                  //                                           .delete()
                                  //                                           .then(
                                  //                                               (value) {
                                  //                                             Navigator.pop(
                                  //                                                 context);
                                  //                                           });
                                  //                                     },
                                  //                                     child: Padding(
                                  //                                       padding:
                                  //                                       const EdgeInsets
                                  //                                           .all(
                                  //                                           8.0),
                                  //                                       child: Card(
                                  //                                         elevation:
                                  //                                         8,
                                  //                                         color: Theme.of(
                                  //                                             context)
                                  //                                             .primaryColor,
                                  //                                         child: Center(
                                  //                                             child: Padding(
                                  //                                               padding: const EdgeInsets
                                  //                                                   .all(
                                  //                                                   15.0),
                                  //                                               child:
                                  //                                               Text(
                                  //                                                 "Delete",
                                  //                                                 style: TextStyle(
                                  //                                                     color:
                                  //                                                     Colors.white,
                                  //                                                     fontWeight: FontWeight.bold),
                                  //                                               ),
                                  //                                             )),
                                  //                                       ),
                                  //                                     ),
                                  //                                   )),
                                  //                             ],
                                  //                           ),
                                  //                         ],
                                  //                       );
                                  //                     });
                                  //               }
                                  //
                                  //               if (value == folderAction.move) {
                                  //                 //rename folder
                                  //                 showModalBottomSheet(
                                  //                     context: context,
                                  //                     builder: (builder) {
                                  //                       return new Wrap(
                                  //                         children: [
                                  //                           ListTile(
                                  //                             title: Text(
                                  //                               "Move Folder",
                                  //                               style: TextStyle(
                                  //                                   fontSize: 20,
                                  //                                   color: Theme.of(
                                  //                                       context)
                                  //                                       .primaryColor),
                                  //                             ),
                                  //                             trailing: Padding(
                                  //                               padding:
                                  //                               const EdgeInsets
                                  //                                   .all(8.0),
                                  //                               child: InkWell(
                                  //                                 onTap: () {
                                  //                                   Navigator.of(
                                  //                                       context)
                                  //                                       .pop();
                                  //                                 },
                                  //                                 child: Icon(
                                  //                                     Icons
                                  //                                         .close),
                                  //                               ),
                                  //                             ),
                                  //                           ),
                                  //                           Padding(
                                  //                             padding:
                                  //                             const EdgeInsets
                                  //                                 .all(8.0),
                                  //                             child: Text(
                                  //                               "Move Folder",
                                  //                               style: TextStyle(
                                  //                                   fontSize: 20,
                                  //                                   color: Theme.of(
                                  //                                       context)
                                  //                                       .primaryColor),
                                  //                             ),
                                  //                           ),
                                  //
                                  //                           MoveFolderActivity(
                                  //                             customerId: widget
                                  //                                 .customerId,
                                  //                             customerFirestore:
                                  //                             widget
                                  //                                 .customerFirestore,
                                  //                             curentFolderID:snapshot.data!.docs[index].id,locale: widget.locale,
                                  //                           ),
                                  //                           //here show move folder target
                                  //                         ],
                                  //                       );
                                  //                     });
                                  //               }
                                  //             },
                                  //             child:
                                  //             Center(child: Icon(Icons.menu)),
                                  //             itemBuilder: (BuildContext
                                  //             context) =>
                                  //             <PopupMenuEntry<folderAction>>[
                                  //               PopupMenuItem<folderAction>(
                                  //                 value: folderAction.rename,
                                  //                 child: Text('Rename'),
                                  //               ),
                                  //               PopupMenuItem<folderAction>(
                                  //                 value: folderAction.delete,
                                  //                 child: Text('Delete'),
                                  //               ),
                                  //               PopupMenuItem<folderAction>(
                                  //                 value: folderAction.move,
                                  //                 child: Text('Move'),
                                  //               ),
                                  //             ],
                                  //           ),
                                  //         ),
                                  //       ),
                                  //     ],
                                  //   ),
                                  // ),
                                  // Container(
                                  //
                                  //  // width: MediaQuery.of(context).size.width,
                                  //   child:showNextLevelFolder(snapshot.data!.docs[index].id),)

                                ],
                              ),),
                            );
                            return Container(

                              child: Stack(
                                children: [
                                  Align(
                                    alignment: Alignment.centerLeft,
                                    child: InkWell(
                                      onTap: () {

                                        if (snapshot.data!.exists &&
                                            snapshot.data!
                                                .get("name") !=
                                                null) {
                                          AppWidgets(customerId: customerId,customerFirestore:customerFirestore). showTestRecordBody(

                                              snapshot.data!.id,
                                              snapshot.data!,
                                              context,locale,2
                                          );
                                        }
                                      },
                                      child: Row(
                                        children: [
                                          Padding(
                                            padding: const EdgeInsets.fromLTRB(0,0,10,0),
                                            child: Container(
                                              margin: EdgeInsets.only(
                                                left: width * 0.02,
                                              ),
                                              child: Image.asset("assets/svg/gr.png"),
                                              // child: SvgPicture.asset(
                                              //   ("assets/svg/gr.svg"),
                                              //   fit: BoxFit.cover,
                                              // ),
                                            ),
                                          ),
                                          Text(
                                              snapshot.data!
                                                  .get("name"),
                                              style: TextStyle(
                                                  fontWeight:
                                                  FontWeight
                                                      .bold,
                                                  color: Colors
                                                      .black)),
                                          // Column(
                                          //   mainAxisAlignment:
                                          //   MainAxisAlignment
                                          //       .start,
                                          //   crossAxisAlignment:
                                          //   CrossAxisAlignment
                                          //       .start,
                                          //   children: [
                                          //     Text(
                                          //         sortedList[index]
                                          //             .get("name"),
                                          //         style: TextStyle(
                                          //             fontWeight:
                                          //             FontWeight
                                          //                 .bold,
                                          //             color: Colors
                                          //                 .black)),
                                          //     timeFormate(
                                          //         sortedList[index]
                                          //             .get("time")),
                                          //   ],
                                          // ),
                                        ],
                                      ),
                                    ),
                                  ),
                                  // Align(
                                  //   alignment: Alignment.centerRight,
                                  //   child: Container(
                                  //     child:  Align(alignment: Alignment.centerRight,child: deleteMoveForTestPopMenuBox(snapshot.data!.id,snapshot.data!.data()),),
                                  //
                                  //
                                  //     // child: PopupMenuButton<
                                  //     //     folderAction>(
                                  //     //   onSelected:
                                  //     //       (folderAction value) {
                                  //     //     if (value ==
                                  //     //         folderAction.move) {
                                  //     //       //rename folder
                                  //     //       showModalBottomSheet(
                                  //     //           context: context,
                                  //     //           builder: (builder) {
                                  //     //             return new Wrap(
                                  //     //               children: [
                                  //     //                 ListTile(
                                  //     //                   title: Text(
                                  //     //                     "Move File",
                                  //     //                     style: TextStyle(
                                  //     //                         fontSize:
                                  //     //                         20,
                                  //     //                         color: Theme.of(context)
                                  //     //                             .primaryColor),
                                  //     //                   ),
                                  //     //                   trailing:
                                  //     //                   Padding(
                                  //     //                     padding:
                                  //     //                     const EdgeInsets.all(
                                  //     //                         8.0),
                                  //     //                     child:
                                  //     //                     InkWell(
                                  //     //                       onTap:
                                  //     //                           () {
                                  //     //                         Navigator.of(context)
                                  //     //                             .pop();
                                  //     //                       },
                                  //     //                       child: Icon(
                                  //     //                           Icons
                                  //     //                               .close),
                                  //     //                     ),
                                  //     //                   ),
                                  //     //                 ),
                                  //     //                 //.get("folderID").toString()
                                  //     //                 //Text(fileAndFolderSource[sortedList[index].id]),
                                  //     //
                                  //     //                 MoveFileActivity(
                                  //     //                   dataToMove:
                                  //     //                   sortedList[index]
                                  //     //                       .data(),
                                  //     //                   recordId: fileAndFolderSource[
                                  //     //                   sortedList[index]
                                  //     //                       .id]!,
                                  //     //                   customerId:
                                  //     //                   widget
                                  //     //                       .customerId,
                                  //     //                   customerFirestore:
                                  //     //                   widget
                                  //     //                       .customerFirestore,
                                  //     //                   curentFolderID: widget
                                  //     //                       .folderStack
                                  //     //                       .last,locale: widget.locale,),
                                  //     //                 //here show move folder target
                                  //     //               ],
                                  //     //             );
                                  //     //           });
                                  //     //     }
                                  //     //   },
                                  //     //   child: Center(
                                  //     //       child: Icon(
                                  //     //         Icons.menu,
                                  //     //         color: Colors.black,
                                  //     //       )),
                                  //     //   itemBuilder: (BuildContext
                                  //     //   context) =>
                                  //     //   <
                                  //     //       PopupMenuEntry<
                                  //     //           folderAction>>[
                                  //     //     PopupMenuItem<folderAction>(
                                  //     //       value: folderAction.move,
                                  //     //       child: Text('Move'),
                                  //     //     ),
                                  //     //   ],
                                  //     // ),
                                  //   ),
                                  // ),
                                ],
                              ),
                            );
                          }else return Container(height: 0,width: 0,);
                        });

                  }catch(e){
                    return Container(height: 0,width: 0,);
                    return   Padding(
                      padding: const EdgeInsets.fromLTRB(0, 2, 0, 0),
                      child: Padding(
                        padding: const EdgeInsets.all(4.0),
                        child: Row(
                          children: [

                            Container(
                              margin: EdgeInsets.only(
                                // left: width * 0.02,
                              ),
                              child:Image.asset("assets/svg/gr.png",fit: BoxFit.cover,),
                            ),
                            Container(
                                margin: EdgeInsets.only(
                                  left: width * 0.03,
                                ),
                                child: Flexible(
                                  child: Text("Test Not Found",
                                    style: interRegular.copyWith(
                                      color: ThemeManager().getBlackColor,
                                      fontSize: width * 0.045,
                                    ),
                                  ),
                                )),

                            // Container(
                            // //  height: 50,
                            //   width: MediaQuery.of(context).size.width,
                            //   child: Stack(
                            //     children: [
                            //       Align(
                            //         alignment: Alignment.centerLeft,
                            //         child: Row(
                            //           children: [
                            //             GestureDetector(
                            //               onTap: () {
                            //                 // setState(() {
                            //                 //   newFolder.isExpanded = !(newFolder.isExpanded);
                            //                 //   newFolder.isVisible = !newFolder.isVisible;
                            //                 // });
                            //               },
                            //               //newFolder.isExpanded == fals
                            //               child: false
                            //                   ? Icon(
                            //                 Icons.keyboard_arrow_up_outlined,
                            //                 size: width * 0.085,
                            //                 color: ThemeManager().getDarkGrey2Color,
                            //               )
                            //                   : Icon(
                            //                 Icons.keyboard_arrow_down_outlined,
                            //                 size: width * 0.085,
                            //                 color: ThemeManager().getDarkGrey2Color,
                            //               ),
                            //             ),
                            //             Container(
                            //               margin: EdgeInsets.only(
                            //                 left: width * 0.02,
                            //               ),
                            //               child: SvgPicture.asset(
                            //                 ("assets/svg/folderIcon.svg"),
                            //                 fit: BoxFit.cover,
                            //               ),
                            //             ),
                            //             Container(
                            //                 margin: EdgeInsets.only(
                            //                   left: width * 0.03,
                            //                 ),
                            //                 child: Text(
                            //                   snapshot.data!.docs[index]["name"],
                            //                   style: interRegular.copyWith(
                            //                     color: ThemeManager().getBlackColor,
                            //                     fontSize: width * 0.045,
                            //                   ),
                            //                 ))
                            //             // Column(
                            //             //   mainAxisAlignment:
                            //             //   MainAxisAlignment.center,
                            //             //   crossAxisAlignment:
                            //             //   CrossAxisAlignment.start,
                            //             //   children: [
                            //             //
                            //             //     Text(
                            //             //       snapshot.data!.docs[index]["name"]
                            //             //           .toString(),
                            //             //       style: TextStyle(
                            //             //           fontWeight:
                            //             //           FontWeight.bold,
                            //             //           color: Colors.black),
                            //             //     ),
                            //             //     timeFormate(snapshot.data!.docs[index]["created_at"]),
                            //             //   ],
                            //             // ),
                            //           ],
                            //         ),
                            //       ),
                            //       Align(
                            //         alignment: Alignment.centerRight,
                            //         child: Container(
                            //           height: MediaQuery.of(context)
                            //               .size
                            //               .height,
                            //           width: 50,
                            //           child: PopupMenuButton<folderAction>(
                            //             onSelected: (folderAction value) {
                            //               if (value ==
                            //                   folderAction.rename) {
                            //                 //rename folder
                            //                 TextEditingController
                            //                 controller =
                            //                 TextEditingController(
                            //                     text: snapshot.data!.docs[index]
                            //                     ["name"]
                            //                         .toString());
                            //
                            //                 Navigator.of(context)
                            //                     .push(
                            //                     new MaterialPageRoute<
                            //                         Null>(
                            //                         builder:
                            //                             (BuildContext
                            //                         context) {
                            //                           return Scaffold(
                            //                             appBar: AppBar(
                            //                               title: Text(
                            //                                   "Rename Folder"),
                            //                             ),
                            //                             body: Container(
                            //                               decoration:
                            //                               BoxDecoration(
                            //                                 color: Color
                            //                                     .fromARGB(
                            //                                     255,
                            //                                     247,
                            //                                     247,
                            //                                     247),
                            //                                 borderRadius: BorderRadius.only(
                            //                                     topLeft:
                            //                                     Radius.circular(
                            //                                         10.0),
                            //                                     topRight:
                            //                                     Radius.circular(10.0)),
                            //                               ),
                            //                               child:
                            //                               Padding(
                            //                                 padding: const EdgeInsets
                            //                                     .all(
                            //                                     15.0),
                            //                                 child: Wrap(
                            //                                   children: [
                            //                                     Padding(
                            //                                       padding:
                            //                                       const EdgeInsets.all(8.0),
                            //                                       child:
                            //                                       TextFormField(
                            //                                         controller:
                            //                                         controller,
                            //                                         autofocus:
                            //                                         true,
                            //                                         decoration:
                            //                                         InputDecoration(
                            //                                           labelText: 'Folder Name',
                            //                                           border: OutlineInputBorder(),
                            //                                         ),
                            //                                       ),
                            //                                     ),
                            //                                     InkWell(
                            //                                       onTap:
                            //                                           () {
                            //                                         widget.customerFirestore.collection("folders").doc(snapshot.data!.docs[index].id).update({
                            //                                           "name": controller.text
                            //                                         }).then((value) {
                            //                                           Navigator.pop(context);
                            //                                         });
                            //                                       },
                            //                                       child:
                            //                                       Card(
                            //                                         color:
                            //                                         Theme.of(context).primaryColor,
                            //                                         child: Center(
                            //                                             child: Padding(
                            //                                               padding: const EdgeInsets.all(10.0),
                            //                                               child: Text(
                            //                                                 "Submit",
                            //                                                 style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold),
                            //                                               ),
                            //                                             )),
                            //                                       ),
                            //                                     )
                            //                                   ],
                            //                                 ),
                            //                               ),
                            //                             ),
                            //                           );
                            //                         },
                            //                         fullscreenDialog:
                            //                         true));
                            //               }
                            //               if (value ==
                            //                   folderAction.delete) {
                            //                 //rename folder
                            //                 showModalBottomSheet(
                            //                     context: context,
                            //                     builder: (builder) {
                            //                       return new Wrap(
                            //                         children: [
                            //                           Padding(
                            //                             padding:
                            //                             const EdgeInsets
                            //                                 .all(8.0),
                            //                             child: Text(
                            //                               "Do you want to delete this Folder?",
                            //                               style: TextStyle(
                            //                                   fontSize: 20,
                            //                                   color: Theme.of(
                            //                                       context)
                            //                                       .primaryColor),
                            //                             ),
                            //                           ),
                            //                           Row(
                            //                             children: [
                            //                               Expanded(
                            //                                   child:
                            //                                   InkWell(
                            //                                     onTap: () {
                            //                                       Navigator.of(
                            //                                           context)
                            //                                           .pop();
                            //                                     },
                            //                                     child: Padding(
                            //                                       padding:
                            //                                       const EdgeInsets
                            //                                           .all(
                            //                                           8.0),
                            //                                       child: Card(
                            //                                         elevation:
                            //                                         8,
                            //                                         color: Colors
                            //                                             .grey,
                            //                                         child: Center(
                            //                                             child: Padding(
                            //                                               padding: const EdgeInsets
                            //                                                   .all(
                            //                                                   15.0),
                            //                                               child:
                            //                                               Text(
                            //                                                 "Cancel",
                            //                                                 style: TextStyle(
                            //                                                     color:
                            //                                                     Colors.white,
                            //                                                     fontWeight: FontWeight.bold),
                            //                                               ),
                            //                                             )),
                            //                                       ),
                            //                                     ),
                            //                                   )),
                            //                               Expanded(
                            //                                   child:
                            //                                   InkWell(
                            //                                     onTap: () {
                            //                                       widget
                            //                                           .customerFirestore
                            //                                           .collection(
                            //                                           "folders")
                            //                                           .doc(snapshot.data!.docs[index].id)
                            //                                           .delete()
                            //                                           .then(
                            //                                               (value) {
                            //                                             Navigator.pop(
                            //                                                 context);
                            //                                           });
                            //                                     },
                            //                                     child: Padding(
                            //                                       padding:
                            //                                       const EdgeInsets
                            //                                           .all(
                            //                                           8.0),
                            //                                       child: Card(
                            //                                         elevation:
                            //                                         8,
                            //                                         color: Theme.of(
                            //                                             context)
                            //                                             .primaryColor,
                            //                                         child: Center(
                            //                                             child: Padding(
                            //                                               padding: const EdgeInsets
                            //                                                   .all(
                            //                                                   15.0),
                            //                                               child:
                            //                                               Text(
                            //                                                 "Delete",
                            //                                                 style: TextStyle(
                            //                                                     color:
                            //                                                     Colors.white,
                            //                                                     fontWeight: FontWeight.bold),
                            //                                               ),
                            //                                             )),
                            //                                       ),
                            //                                     ),
                            //                                   )),
                            //                             ],
                            //                           ),
                            //                         ],
                            //                       );
                            //                     });
                            //               }
                            //
                            //               if (value == folderAction.move) {
                            //                 //rename folder
                            //                 showModalBottomSheet(
                            //                     context: context,
                            //                     builder: (builder) {
                            //                       return new Wrap(
                            //                         children: [
                            //                           ListTile(
                            //                             title: Text(
                            //                               "Move Folder",
                            //                               style: TextStyle(
                            //                                   fontSize: 20,
                            //                                   color: Theme.of(
                            //                                       context)
                            //                                       .primaryColor),
                            //                             ),
                            //                             trailing: Padding(
                            //                               padding:
                            //                               const EdgeInsets
                            //                                   .all(8.0),
                            //                               child: InkWell(
                            //                                 onTap: () {
                            //                                   Navigator.of(
                            //                                       context)
                            //                                       .pop();
                            //                                 },
                            //                                 child: Icon(
                            //                                     Icons
                            //                                         .close),
                            //                               ),
                            //                             ),
                            //                           ),
                            //                           Padding(
                            //                             padding:
                            //                             const EdgeInsets
                            //                                 .all(8.0),
                            //                             child: Text(
                            //                               "Move Folder",
                            //                               style: TextStyle(
                            //                                   fontSize: 20,
                            //                                   color: Theme.of(
                            //                                       context)
                            //                                       .primaryColor),
                            //                             ),
                            //                           ),
                            //
                            //                           MoveFolderActivity(
                            //                             customerId: widget
                            //                                 .customerId,
                            //                             customerFirestore:
                            //                             widget
                            //                                 .customerFirestore,
                            //                             curentFolderID:snapshot.data!.docs[index].id,locale: widget.locale,
                            //                           ),
                            //                           //here show move folder target
                            //                         ],
                            //                       );
                            //                     });
                            //               }
                            //             },
                            //             child:
                            //             Center(child: Icon(Icons.menu)),
                            //             itemBuilder: (BuildContext
                            //             context) =>
                            //             <PopupMenuEntry<folderAction>>[
                            //               PopupMenuItem<folderAction>(
                            //                 value: folderAction.rename,
                            //                 child: Text('Rename'),
                            //               ),
                            //               PopupMenuItem<folderAction>(
                            //                 value: folderAction.delete,
                            //                 child: Text('Delete'),
                            //               ),
                            //               PopupMenuItem<folderAction>(
                            //                 value: folderAction.move,
                            //                 child: Text('Move'),
                            //               ),
                            //             ],
                            //           ),
                            //         ),
                            //       ),
                            //     ],
                            //   ),
                            // ),
                            // Container(
                            //
                            //  // width: MediaQuery.of(context).size.width,
                            //   child:showNextLevelFolder(snapshot.data!.docs[index].id),)

                          ],
                        ),
                      ),
                    );
                  }

                  return Text(snapshot.data!.docs[index].id);
                });


          } else {
            return Container(width: 0,height: 0,);
          }
        });
  }catch(e){
    return Center(child: Text("Something wrong"));

  }


}
showTestItemsInFolder(String id,FirebaseFirestore customerFirestore,String customerId,Locale locale) {
  try{

    Stream<QuerySnapshot> stream = customerFirestore
        .collection("folders")
        .doc(id)
        .collection("records").where("created_by",isEqualTo: FirebaseAuth.instance.currentUser!.uid).snapshots();
    if(shareAbleWithOtherMembers == false){
      stream = customerFirestore
          .collection("folders")
          .doc(id)
          .collection("records").where("created_by",isEqualTo: FirebaseAuth.instance.currentUser!.uid)
          .snapshots();
    }else{
      stream = customerFirestore
          .collection("folders")
          .doc(id)
          .collection("records")
          //.where("created_by",isEqualTo: FirebaseAuth.instance.currentUser!.uid)
          .snapshots();
    }
    //TestTitleUpdatedStream
    return  StreamBuilder<bool>(
        stream:TestTitleUpdatedStream.getInstance().outData,
        builder: (context, snapshot)  {
          return  StreamBuilder<QuerySnapshot>(
              stream:stream,
              builder: (context, snapshot)  {
                if (snapshot.hasData && snapshot.data!.docs.length>0) {
                  // return Text(snapshot.data.docs[0].get("id"));
                  Map<String, String> fileAndFolderSource =
                  Map<String, String>();

                  List<DocumentSnapshot<Object>> allData = [];

                  // for (int i = 0; i < snapshot.data!.docs.length; i++) {
                  //   // allData.add(value)
                  //
                  //   widget.customerFirestore
                  //       .collection("pulltest")
                  //       .doc(snapshot.data!.docs[i].get("id"))
                  //       .get()
                  //       .then((value) {
                  //     //value.data()["folderID"]= snapshot.data.docs[i].id;
                  //     // Map<String, dynamic> da = value.data();
                  //     fileAndFolderSource.putIfAbsent(
                  //         value.id, () => snapshot.data!.docs[i].id);
                  //
                  //     //da["folderID"] = snapshot.data.docs[i].id;
                  //     allData.add(value);
                  //     FilteredDataShow.getInstance().dataReload(allData);
                  //
                  //     print("size " + allData.length.toString());
                  //   });
                  // }

                  // if (selectedSortType == fileSortType.none) {
                  //   filteredData = snapshot.data.docs;
                  // } else if (selectedSortType == fileSortType.date) {
                  //   filteredData = snapshot.data.docs;
                  //   filteredData.sort((a, b) {
                  //     return a
                  //         .get("name")
                  //         .toString()
                  //         .toLowerCase()
                  //         .compareTo(b.get("name").toString().toLowerCase());
                  //   });
                  // }
                  print("now = > " + allData.length.toString());




                  //sort here
                  List<QueryDocumentSnapshot> filteredData = [];
                  filteredData = snapshot.data!.docs;








                  //  for(int i = 0 ; i < snapshot.data!.docs.length ; i ++){
                  //   try{
                  //    var res =  customerFirestore
                  //         .collection("pulltest")
                  //         .doc( snapshot.data!.docs[i].get("id")).g
                  //
                  //
                  //
                  //     Map<String, dynamic> dataToCheck = snapshot.data!.docs[i].data() as Map<String, dynamic>;
                  //     if(dataToCheck["name"]!=null){
                  //       filteredData.add(snapshot.data!.docs[i]);
                  //
                  //     }
                  //   }catch(e){
                  //
                  //   }
                  // }



                  filteredData.sort((a, b) {
                    return a
                        .get("created_at")
                        .compareTo(b.get("created_at"));
                  });

                  filteredData.reversed;






                  return ListView.builder(
                      physics: ClampingScrollPhysics(),
                      // separatorBuilder: (context, index) {return Divider();},
                      padding: EdgeInsets.zero,
                      shrinkWrap: true,
                      itemCount:snapshot.data!.docs.length,
                      itemBuilder: (_, index) {

                        try{
                          return    Padding(
                            padding: indendfolderPadding,
                            child: FutureBuilder<DocumentSnapshot>(
                                future:     customerFirestore
                                    .collection("pulltest")
                                    .doc(filteredData[index].get("id"))
                                    .get(),
                                builder: (BuildContext context, AsyncSnapshot<DocumentSnapshot> snapshot) {

                                  if(snapshot.hasData){
                                    // snapshot.data.data()
                                    try{
                                      Map<String, dynamic> data = snapshot.data!.data() as Map<String, dynamic>;
                                      if(data["name"]!=null){
                                        return  InkWell(onTap: (){

                                          if (snapshot.data!.exists && snapshot.data!.get("name") != null) {
                                            AppWidgets(customerId: customerId,customerFirestore:customerFirestore). showTestRecordBody(

                                                snapshot.data!.id,
                                                snapshot.data!,
                                                context,locale,2
                                            );
                                          }
                                        },
                                          child: Padding(
                                            padding:  EdgeInsets.only(top: width * 0.02,bottom: width * 0.02 ),
                                            child: Stack(
                                              children: [
                                                Row(
                                                  children: [

                                                    Container(
                                                      margin: EdgeInsets.only(
                                                        left: width * 0.03,
                                                      ),
                                                      // child:Image.asset("assets/svg/gr.png",fit: BoxFit.cover,),
                                                      child:SvgPicture.asset("assets/svg/loadIcon.svg",fit: BoxFit.cover,width:width * 0.075,color: ThemeManager().getYellowGradientColor,),
                                                    ),
                                                    Container(
                                                        margin: EdgeInsets.only(
                                                          left: width * 0.03,
                                                        ),
                                                        child: Text(snapshot.data!.get("name").toString().length>25?snapshot.data!.get("name").toString().substring(0,25):snapshot.data!.get("name"),maxLines: 1,
                                                          style: interRegular.copyWith(
                                                            color:AppThemeManager(). getTextColor1(),
                                                            fontSize: width * 0.045,
                                                          ),
                                                        )),

                                                    // Container(
                                                    // //  height: 50,
                                                    //   width: MediaQuery.of(context).size.width,
                                                    //   child: Stack(
                                                    //     children: [
                                                    //       Align(
                                                    //         alignment: Alignment.centerLeft,
                                                    //         child: Row(
                                                    //           children: [
                                                    //             GestureDetector(
                                                    //               onTap: () {
                                                    //                 // setState(() {
                                                    //                 //   newFolder.isExpanded = !(newFolder.isExpanded);
                                                    //                 //   newFolder.isVisible = !newFolder.isVisible;
                                                    //                 // });
                                                    //               },
                                                    //               //newFolder.isExpanded == fals
                                                    //               child: false
                                                    //                   ? Icon(
                                                    //                 Icons.keyboard_arrow_up_outlined,
                                                    //                 size: width * 0.085,
                                                    //                 color: ThemeManager().getDarkGrey2Color,
                                                    //               )
                                                    //                   : Icon(
                                                    //                 Icons.keyboard_arrow_down_outlined,
                                                    //                 size: width * 0.085,
                                                    //                 color: ThemeManager().getDarkGrey2Color,
                                                    //               ),
                                                    //             ),
                                                    //             Container(
                                                    //               margin: EdgeInsets.only(
                                                    //                 left: width * 0.02,
                                                    //               ),
                                                    //               child: SvgPicture.asset(
                                                    //                 ("assets/svg/folderIcon.svg"),
                                                    //                 fit: BoxFit.cover,
                                                    //               ),
                                                    //             ),
                                                    //             Container(
                                                    //                 margin: EdgeInsets.only(
                                                    //                   left: width * 0.03,
                                                    //                 ),
                                                    //                 child: Text(
                                                    //                   snapshot.data!.docs[index]["name"],
                                                    //                   style: interRegular.copyWith(
                                                    //                     color: ThemeManager().getBlackColor,
                                                    //                     fontSize: width * 0.045,
                                                    //                   ),
                                                    //                 ))
                                                    //             // Column(
                                                    //             //   mainAxisAlignment:
                                                    //             //   MainAxisAlignment.center,
                                                    //             //   crossAxisAlignment:
                                                    //             //   CrossAxisAlignment.start,
                                                    //             //   children: [
                                                    //             //
                                                    //             //     Text(
                                                    //             //       snapshot.data!.docs[index]["name"]
                                                    //             //           .toString(),
                                                    //             //       style: TextStyle(
                                                    //             //           fontWeight:
                                                    //             //           FontWeight.bold,
                                                    //             //           color: Colors.black),
                                                    //             //     ),
                                                    //             //     timeFormate(snapshot.data!.docs[index]["created_at"]),
                                                    //             //   ],
                                                    //             // ),
                                                    //           ],
                                                    //         ),
                                                    //       ),
                                                    //       Align(
                                                    //         alignment: Alignment.centerRight,
                                                    //         child: Container(
                                                    //           height: MediaQuery.of(context)
                                                    //               .size
                                                    //               .height,
                                                    //           width: 50,
                                                    //           child: PopupMenuButton<folderAction>(
                                                    //             onSelected: (folderAction value) {
                                                    //               if (value ==
                                                    //                   folderAction.rename) {
                                                    //                 //rename folder
                                                    //                 TextEditingController
                                                    //                 controller =
                                                    //                 TextEditingController(
                                                    //                     text: snapshot.data!.docs[index]
                                                    //                     ["name"]
                                                    //                         .toString());
                                                    //
                                                    //                 Navigator.of(context)
                                                    //                     .push(
                                                    //                     new MaterialPageRoute<
                                                    //                         Null>(
                                                    //                         builder:
                                                    //                             (BuildContext
                                                    //                         context) {
                                                    //                           return Scaffold(
                                                    //                             appBar: AppBar(
                                                    //                               title: Text(
                                                    //                                   "Rename Folder"),
                                                    //                             ),
                                                    //                             body: Container(
                                                    //                               decoration:
                                                    //                               BoxDecoration(
                                                    //                                 color: Color
                                                    //                                     .fromARGB(
                                                    //                                     255,
                                                    //                                     247,
                                                    //                                     247,
                                                    //                                     247),
                                                    //                                 borderRadius: BorderRadius.only(
                                                    //                                     topLeft:
                                                    //                                     Radius.circular(
                                                    //                                         10.0),
                                                    //                                     topRight:
                                                    //                                     Radius.circular(10.0)),
                                                    //                               ),
                                                    //                               child:
                                                    //                               Padding(
                                                    //                                 padding: const EdgeInsets
                                                    //                                     .all(
                                                    //                                     15.0),
                                                    //                                 child: Wrap(
                                                    //                                   children: [
                                                    //                                     Padding(
                                                    //                                       padding:
                                                    //                                       const EdgeInsets.all(8.0),
                                                    //                                       child:
                                                    //                                       TextFormField(
                                                    //                                         controller:
                                                    //                                         controller,
                                                    //                                         autofocus:
                                                    //                                         true,
                                                    //                                         decoration:
                                                    //                                         InputDecoration(
                                                    //                                           labelText: 'Folder Name',
                                                    //                                           border: OutlineInputBorder(),
                                                    //                                         ),
                                                    //                                       ),
                                                    //                                     ),
                                                    //                                     InkWell(
                                                    //                                       onTap:
                                                    //                                           () {
                                                    //                                         widget.customerFirestore.collection("folders").doc(snapshot.data!.docs[index].id).update({
                                                    //                                           "name": controller.text
                                                    //                                         }).then((value) {
                                                    //                                           Navigator.pop(context);
                                                    //                                         });
                                                    //                                       },
                                                    //                                       child:
                                                    //                                       Card(
                                                    //                                         color:
                                                    //                                         Theme.of(context).primaryColor,
                                                    //                                         child: Center(
                                                    //                                             child: Padding(
                                                    //                                               padding: const EdgeInsets.all(10.0),
                                                    //                                               child: Text(
                                                    //                                                 "Submit",
                                                    //                                                 style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold),
                                                    //                                               ),
                                                    //                                             )),
                                                    //                                       ),
                                                    //                                     )
                                                    //                                   ],
                                                    //                                 ),
                                                    //                               ),
                                                    //                             ),
                                                    //                           );
                                                    //                         },
                                                    //                         fullscreenDialog:
                                                    //                         true));
                                                    //               }
                                                    //               if (value ==
                                                    //                   folderAction.delete) {
                                                    //                 //rename folder
                                                    //                 showModalBottomSheet(
                                                    //                     context: context,
                                                    //                     builder: (builder) {
                                                    //                       return new Wrap(
                                                    //                         children: [
                                                    //                           Padding(
                                                    //                             padding:
                                                    //                             const EdgeInsets
                                                    //                                 .all(8.0),
                                                    //                             child: Text(
                                                    //                               "Do you want to delete this Folder?",
                                                    //                               style: TextStyle(
                                                    //                                   fontSize: 20,
                                                    //                                   color: Theme.of(
                                                    //                                       context)
                                                    //                                       .primaryColor),
                                                    //                             ),
                                                    //                           ),
                                                    //                           Row(
                                                    //                             children: [
                                                    //                               Expanded(
                                                    //                                   child:
                                                    //                                   InkWell(
                                                    //                                     onTap: () {
                                                    //                                       Navigator.of(
                                                    //                                           context)
                                                    //                                           .pop();
                                                    //                                     },
                                                    //                                     child: Padding(
                                                    //                                       padding:
                                                    //                                       const EdgeInsets
                                                    //                                           .all(
                                                    //                                           8.0),
                                                    //                                       child: Card(
                                                    //                                         elevation:
                                                    //                                         8,
                                                    //                                         color: Colors
                                                    //                                             .grey,
                                                    //                                         child: Center(
                                                    //                                             child: Padding(
                                                    //                                               padding: const EdgeInsets
                                                    //                                                   .all(
                                                    //                                                   15.0),
                                                    //                                               child:
                                                    //                                               Text(
                                                    //                                                 "Cancel",
                                                    //                                                 style: TextStyle(
                                                    //                                                     color:
                                                    //                                                     Colors.white,
                                                    //                                                     fontWeight: FontWeight.bold),
                                                    //                                               ),
                                                    //                                             )),
                                                    //                                       ),
                                                    //                                     ),
                                                    //                                   )),
                                                    //                               Expanded(
                                                    //                                   child:
                                                    //                                   InkWell(
                                                    //                                     onTap: () {
                                                    //                                       widget
                                                    //                                           .customerFirestore
                                                    //                                           .collection(
                                                    //                                           "folders")
                                                    //                                           .doc(snapshot.data!.docs[index].id)
                                                    //                                           .delete()
                                                    //                                           .then(
                                                    //                                               (value) {
                                                    //                                             Navigator.pop(
                                                    //                                                 context);
                                                    //                                           });
                                                    //                                     },
                                                    //                                     child: Padding(
                                                    //                                       padding:
                                                    //                                       const EdgeInsets
                                                    //                                           .all(
                                                    //                                           8.0),
                                                    //                                       child: Card(
                                                    //                                         elevation:
                                                    //                                         8,
                                                    //                                         color: Theme.of(
                                                    //                                             context)
                                                    //                                             .primaryColor,
                                                    //                                         child: Center(
                                                    //                                             child: Padding(
                                                    //                                               padding: const EdgeInsets
                                                    //                                                   .all(
                                                    //                                                   15.0),
                                                    //                                               child:
                                                    //                                               Text(
                                                    //                                                 "Delete",
                                                    //                                                 style: TextStyle(
                                                    //                                                     color:
                                                    //                                                     Colors.white,
                                                    //                                                     fontWeight: FontWeight.bold),
                                                    //                                               ),
                                                    //                                             )),
                                                    //                                       ),
                                                    //                                     ),
                                                    //                                   )),
                                                    //                             ],
                                                    //                           ),
                                                    //                         ],
                                                    //                       );
                                                    //                     });
                                                    //               }
                                                    //
                                                    //               if (value == folderAction.move) {
                                                    //                 //rename folder
                                                    //                 showModalBottomSheet(
                                                    //                     context: context,
                                                    //                     builder: (builder) {
                                                    //                       return new Wrap(
                                                    //                         children: [
                                                    //                           ListTile(
                                                    //                             title: Text(
                                                    //                               "Move Folder",
                                                    //                               style: TextStyle(
                                                    //                                   fontSize: 20,
                                                    //                                   color: Theme.of(
                                                    //                                       context)
                                                    //                                       .primaryColor),
                                                    //                             ),
                                                    //                             trailing: Padding(
                                                    //                               padding:
                                                    //                               const EdgeInsets
                                                    //                                   .all(8.0),
                                                    //                               child: InkWell(
                                                    //                                 onTap: () {
                                                    //                                   Navigator.of(
                                                    //                                       context)
                                                    //                                       .pop();
                                                    //                                 },
                                                    //                                 child: Icon(
                                                    //                                     Icons
                                                    //                                         .close),
                                                    //                               ),
                                                    //                             ),
                                                    //                           ),
                                                    //                           Padding(
                                                    //                             padding:
                                                    //                             const EdgeInsets
                                                    //                                 .all(8.0),
                                                    //                             child: Text(
                                                    //                               "Move Folder",
                                                    //                               style: TextStyle(
                                                    //                                   fontSize: 20,
                                                    //                                   color: Theme.of(
                                                    //                                       context)
                                                    //                                       .primaryColor),
                                                    //                             ),
                                                    //                           ),
                                                    //
                                                    //                           MoveFolderActivity(
                                                    //                             customerId: widget
                                                    //                                 .customerId,
                                                    //                             customerFirestore:
                                                    //                             widget
                                                    //                                 .customerFirestore,
                                                    //                             curentFolderID:snapshot.data!.docs[index].id,locale: widget.locale,
                                                    //                           ),
                                                    //                           //here show move folder target
                                                    //                         ],
                                                    //                       );
                                                    //                     });
                                                    //               }
                                                    //             },
                                                    //             child:
                                                    //             Center(child: Icon(Icons.menu)),
                                                    //             itemBuilder: (BuildContext
                                                    //             context) =>
                                                    //             <PopupMenuEntry<folderAction>>[
                                                    //               PopupMenuItem<folderAction>(
                                                    //                 value: folderAction.rename,
                                                    //                 child: Text('Rename'),
                                                    //               ),
                                                    //               PopupMenuItem<folderAction>(
                                                    //                 value: folderAction.delete,
                                                    //                 child: Text('Delete'),
                                                    //               ),
                                                    //               PopupMenuItem<folderAction>(
                                                    //                 value: folderAction.move,
                                                    //                 child: Text('Move'),
                                                    //               ),
                                                    //             ],
                                                    //           ),
                                                    //         ),
                                                    //       ),
                                                    //     ],
                                                    //   ),
                                                    // ),
                                                    // Container(
                                                    //
                                                    //  // width: MediaQuery.of(context).size.width,
                                                    //   child:showNextLevelFolder(snapshot.data!.docs[index].id),)

                                                  ],
                                                ),
                                                // Align(alignment: Alignment.centerRight,child: Padding(
                                                //   padding: const EdgeInsets.all(8.0),
                                                //   child: Icon(Icons.done_outline),
                                                // ),)
                                              ],
                                            ),
                                          ),
                                        );
                                      }else{
                                        return Container(height: 0,width: 0,);
                                      }
                                    }catch(e){
                                      return Container(height: 0,width: 0,);
                                    }

                                    return Padding(
                                      padding: const EdgeInsets.fromLTRB(20, 2, 0, 2),
                                      child: InkWell(   onTap: () {

                                        if (snapshot.data!.exists &&
                                            snapshot.data!
                                                .get("name") !=
                                                null) {
                                          AppWidgets(customerId: customerId,customerFirestore:customerFirestore). showTestRecordBody(

                                              snapshot.data!.id,
                                              snapshot.data!,
                                              context,locale,2
                                          );
                                        }
                                      },child:   Row(
                                        children: [

                                          Container(
                                            margin: EdgeInsets.only(
                                              // left: width * 0.02,
                                            ),
                                            child:Image.asset("assets/svg/gr.png",fit: BoxFit.cover,),
                                          ),
                                          Container(
                                              margin: EdgeInsets.only(
                                                left: width * 0.03,
                                              ),
                                              child: Flexible(child: Text(snapshot.data!
                                                  .get("name"),
                                                style: interRegular.copyWith(
                                                  color: ThemeManager().getBlackColor,
                                                  fontSize: width * 0.045,
                                                ),
                                              ),)),

                                          // Container(
                                          // //  height: 50,
                                          //   width: MediaQuery.of(context).size.width,
                                          //   child: Stack(
                                          //     children: [
                                          //       Align(
                                          //         alignment: Alignment.centerLeft,
                                          //         child: Row(
                                          //           children: [
                                          //             GestureDetector(
                                          //               onTap: () {
                                          //                 // setState(() {
                                          //                 //   newFolder.isExpanded = !(newFolder.isExpanded);
                                          //                 //   newFolder.isVisible = !newFolder.isVisible;
                                          //                 // });
                                          //               },
                                          //               //newFolder.isExpanded == fals
                                          //               child: false
                                          //                   ? Icon(
                                          //                 Icons.keyboard_arrow_up_outlined,
                                          //                 size: width * 0.085,
                                          //                 color: ThemeManager().getDarkGrey2Color,
                                          //               )
                                          //                   : Icon(
                                          //                 Icons.keyboard_arrow_down_outlined,
                                          //                 size: width * 0.085,
                                          //                 color: ThemeManager().getDarkGrey2Color,
                                          //               ),
                                          //             ),
                                          //             Container(
                                          //               margin: EdgeInsets.only(
                                          //                 left: width * 0.02,
                                          //               ),
                                          //               child: SvgPicture.asset(
                                          //                 ("assets/svg/folderIcon.svg"),
                                          //                 fit: BoxFit.cover,
                                          //               ),
                                          //             ),
                                          //             Container(
                                          //                 margin: EdgeInsets.only(
                                          //                   left: width * 0.03,
                                          //                 ),
                                          //                 child: Text(
                                          //                   snapshot.data!.docs[index]["name"],
                                          //                   style: interRegular.copyWith(
                                          //                     color: ThemeManager().getBlackColor,
                                          //                     fontSize: width * 0.045,
                                          //                   ),
                                          //                 ))
                                          //             // Column(
                                          //             //   mainAxisAlignment:
                                          //             //   MainAxisAlignment.center,
                                          //             //   crossAxisAlignment:
                                          //             //   CrossAxisAlignment.start,
                                          //             //   children: [
                                          //             //
                                          //             //     Text(
                                          //             //       snapshot.data!.docs[index]["name"]
                                          //             //           .toString(),
                                          //             //       style: TextStyle(
                                          //             //           fontWeight:
                                          //             //           FontWeight.bold,
                                          //             //           color: Colors.black),
                                          //             //     ),
                                          //             //     timeFormate(snapshot.data!.docs[index]["created_at"]),
                                          //             //   ],
                                          //             // ),
                                          //           ],
                                          //         ),
                                          //       ),
                                          //       Align(
                                          //         alignment: Alignment.centerRight,
                                          //         child: Container(
                                          //           height: MediaQuery.of(context)
                                          //               .size
                                          //               .height,
                                          //           width: 50,
                                          //           child: PopupMenuButton<folderAction>(
                                          //             onSelected: (folderAction value) {
                                          //               if (value ==
                                          //                   folderAction.rename) {
                                          //                 //rename folder
                                          //                 TextEditingController
                                          //                 controller =
                                          //                 TextEditingController(
                                          //                     text: snapshot.data!.docs[index]
                                          //                     ["name"]
                                          //                         .toString());
                                          //
                                          //                 Navigator.of(context)
                                          //                     .push(
                                          //                     new MaterialPageRoute<
                                          //                         Null>(
                                          //                         builder:
                                          //                             (BuildContext
                                          //                         context) {
                                          //                           return Scaffold(
                                          //                             appBar: AppBar(
                                          //                               title: Text(
                                          //                                   "Rename Folder"),
                                          //                             ),
                                          //                             body: Container(
                                          //                               decoration:
                                          //                               BoxDecoration(
                                          //                                 color: Color
                                          //                                     .fromARGB(
                                          //                                     255,
                                          //                                     247,
                                          //                                     247,
                                          //                                     247),
                                          //                                 borderRadius: BorderRadius.only(
                                          //                                     topLeft:
                                          //                                     Radius.circular(
                                          //                                         10.0),
                                          //                                     topRight:
                                          //                                     Radius.circular(10.0)),
                                          //                               ),
                                          //                               child:
                                          //                               Padding(
                                          //                                 padding: const EdgeInsets
                                          //                                     .all(
                                          //                                     15.0),
                                          //                                 child: Wrap(
                                          //                                   children: [
                                          //                                     Padding(
                                          //                                       padding:
                                          //                                       const EdgeInsets.all(8.0),
                                          //                                       child:
                                          //                                       TextFormField(
                                          //                                         controller:
                                          //                                         controller,
                                          //                                         autofocus:
                                          //                                         true,
                                          //                                         decoration:
                                          //                                         InputDecoration(
                                          //                                           labelText: 'Folder Name',
                                          //                                           border: OutlineInputBorder(),
                                          //                                         ),
                                          //                                       ),
                                          //                                     ),
                                          //                                     InkWell(
                                          //                                       onTap:
                                          //                                           () {
                                          //                                         widget.customerFirestore.collection("folders").doc(snapshot.data!.docs[index].id).update({
                                          //                                           "name": controller.text
                                          //                                         }).then((value) {
                                          //                                           Navigator.pop(context);
                                          //                                         });
                                          //                                       },
                                          //                                       child:
                                          //                                       Card(
                                          //                                         color:
                                          //                                         Theme.of(context).primaryColor,
                                          //                                         child: Center(
                                          //                                             child: Padding(
                                          //                                               padding: const EdgeInsets.all(10.0),
                                          //                                               child: Text(
                                          //                                                 "Submit",
                                          //                                                 style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold),
                                          //                                               ),
                                          //                                             )),
                                          //                                       ),
                                          //                                     )
                                          //                                   ],
                                          //                                 ),
                                          //                               ),
                                          //                             ),
                                          //                           );
                                          //                         },
                                          //                         fullscreenDialog:
                                          //                         true));
                                          //               }
                                          //               if (value ==
                                          //                   folderAction.delete) {
                                          //                 //rename folder
                                          //                 showModalBottomSheet(
                                          //                     context: context,
                                          //                     builder: (builder) {
                                          //                       return new Wrap(
                                          //                         children: [
                                          //                           Padding(
                                          //                             padding:
                                          //                             const EdgeInsets
                                          //                                 .all(8.0),
                                          //                             child: Text(
                                          //                               "Do you want to delete this Folder?",
                                          //                               style: TextStyle(
                                          //                                   fontSize: 20,
                                          //                                   color: Theme.of(
                                          //                                       context)
                                          //                                       .primaryColor),
                                          //                             ),
                                          //                           ),
                                          //                           Row(
                                          //                             children: [
                                          //                               Expanded(
                                          //                                   child:
                                          //                                   InkWell(
                                          //                                     onTap: () {
                                          //                                       Navigator.of(
                                          //                                           context)
                                          //                                           .pop();
                                          //                                     },
                                          //                                     child: Padding(
                                          //                                       padding:
                                          //                                       const EdgeInsets
                                          //                                           .all(
                                          //                                           8.0),
                                          //                                       child: Card(
                                          //                                         elevation:
                                          //                                         8,
                                          //                                         color: Colors
                                          //                                             .grey,
                                          //                                         child: Center(
                                          //                                             child: Padding(
                                          //                                               padding: const EdgeInsets
                                          //                                                   .all(
                                          //                                                   15.0),
                                          //                                               child:
                                          //                                               Text(
                                          //                                                 "Cancel",
                                          //                                                 style: TextStyle(
                                          //                                                     color:
                                          //                                                     Colors.white,
                                          //                                                     fontWeight: FontWeight.bold),
                                          //                                               ),
                                          //                                             )),
                                          //                                       ),
                                          //                                     ),
                                          //                                   )),
                                          //                               Expanded(
                                          //                                   child:
                                          //                                   InkWell(
                                          //                                     onTap: () {
                                          //                                       widget
                                          //                                           .customerFirestore
                                          //                                           .collection(
                                          //                                           "folders")
                                          //                                           .doc(snapshot.data!.docs[index].id)
                                          //                                           .delete()
                                          //                                           .then(
                                          //                                               (value) {
                                          //                                             Navigator.pop(
                                          //                                                 context);
                                          //                                           });
                                          //                                     },
                                          //                                     child: Padding(
                                          //                                       padding:
                                          //                                       const EdgeInsets
                                          //                                           .all(
                                          //                                           8.0),
                                          //                                       child: Card(
                                          //                                         elevation:
                                          //                                         8,
                                          //                                         color: Theme.of(
                                          //                                             context)
                                          //                                             .primaryColor,
                                          //                                         child: Center(
                                          //                                             child: Padding(
                                          //                                               padding: const EdgeInsets
                                          //                                                   .all(
                                          //                                                   15.0),
                                          //                                               child:
                                          //                                               Text(
                                          //                                                 "Delete",
                                          //                                                 style: TextStyle(
                                          //                                                     color:
                                          //                                                     Colors.white,
                                          //                                                     fontWeight: FontWeight.bold),
                                          //                                               ),
                                          //                                             )),
                                          //                                       ),
                                          //                                     ),
                                          //                                   )),
                                          //                             ],
                                          //                           ),
                                          //                         ],
                                          //                       );
                                          //                     });
                                          //               }
                                          //
                                          //               if (value == folderAction.move) {
                                          //                 //rename folder
                                          //                 showModalBottomSheet(
                                          //                     context: context,
                                          //                     builder: (builder) {
                                          //                       return new Wrap(
                                          //                         children: [
                                          //                           ListTile(
                                          //                             title: Text(
                                          //                               "Move Folder",
                                          //                               style: TextStyle(
                                          //                                   fontSize: 20,
                                          //                                   color: Theme.of(
                                          //                                       context)
                                          //                                       .primaryColor),
                                          //                             ),
                                          //                             trailing: Padding(
                                          //                               padding:
                                          //                               const EdgeInsets
                                          //                                   .all(8.0),
                                          //                               child: InkWell(
                                          //                                 onTap: () {
                                          //                                   Navigator.of(
                                          //                                       context)
                                          //                                       .pop();
                                          //                                 },
                                          //                                 child: Icon(
                                          //                                     Icons
                                          //                                         .close),
                                          //                               ),
                                          //                             ),
                                          //                           ),
                                          //                           Padding(
                                          //                             padding:
                                          //                             const EdgeInsets
                                          //                                 .all(8.0),
                                          //                             child: Text(
                                          //                               "Move Folder",
                                          //                               style: TextStyle(
                                          //                                   fontSize: 20,
                                          //                                   color: Theme.of(
                                          //                                       context)
                                          //                                       .primaryColor),
                                          //                             ),
                                          //                           ),
                                          //
                                          //                           MoveFolderActivity(
                                          //                             customerId: widget
                                          //                                 .customerId,
                                          //                             customerFirestore:
                                          //                             widget
                                          //                                 .customerFirestore,
                                          //                             curentFolderID:snapshot.data!.docs[index].id,locale: widget.locale,
                                          //                           ),
                                          //                           //here show move folder target
                                          //                         ],
                                          //                       );
                                          //                     });
                                          //               }
                                          //             },
                                          //             child:
                                          //             Center(child: Icon(Icons.menu)),
                                          //             itemBuilder: (BuildContext
                                          //             context) =>
                                          //             <PopupMenuEntry<folderAction>>[
                                          //               PopupMenuItem<folderAction>(
                                          //                 value: folderAction.rename,
                                          //                 child: Text('Rename'),
                                          //               ),
                                          //               PopupMenuItem<folderAction>(
                                          //                 value: folderAction.delete,
                                          //                 child: Text('Delete'),
                                          //               ),
                                          //               PopupMenuItem<folderAction>(
                                          //                 value: folderAction.move,
                                          //                 child: Text('Move'),
                                          //               ),
                                          //             ],
                                          //           ),
                                          //         ),
                                          //       ),
                                          //     ],
                                          //   ),
                                          // ),
                                          // Container(
                                          //
                                          //  // width: MediaQuery.of(context).size.width,
                                          //   child:showNextLevelFolder(snapshot.data!.docs[index].id),)

                                        ],
                                      ),),
                                    );
                                    return Container(

                                      child: Stack(
                                        children: [
                                          Align(
                                            alignment: Alignment.centerLeft,
                                            child: InkWell(
                                              onTap: () {

                                                if (snapshot.data!.exists &&
                                                    snapshot.data!
                                                        .get("name") !=
                                                        null) {
                                                  AppWidgets(customerId: customerId,customerFirestore:customerFirestore). showTestRecordBody(

                                                      snapshot.data!.id,
                                                      snapshot.data!,
                                                      context,locale,2
                                                  );
                                                }
                                              },
                                              child: Row(
                                                children: [
                                                  Padding(
                                                    padding: const EdgeInsets.fromLTRB(0,0,10,0),
                                                    child: Container(
                                                      margin: EdgeInsets.only(
                                                        left: width * 0.02,
                                                      ),
                                                      child: Image.asset("assets/svg/gr.png"),
                                                      // child: SvgPicture.asset(
                                                      //   ("assets/svg/gr.svg"),
                                                      //   fit: BoxFit.cover,
                                                      // ),
                                                    ),
                                                  ),
                                                  Text(
                                                      snapshot.data!
                                                          .get("name"),
                                                      style: TextStyle(
                                                          fontWeight:
                                                          FontWeight
                                                              .bold,
                                                          color: Colors
                                                              .black)),
                                                  // Column(
                                                  //   mainAxisAlignment:
                                                  //   MainAxisAlignment
                                                  //       .start,
                                                  //   crossAxisAlignment:
                                                  //   CrossAxisAlignment
                                                  //       .start,
                                                  //   children: [
                                                  //     Text(
                                                  //         sortedList[index]
                                                  //             .get("name"),
                                                  //         style: TextStyle(
                                                  //             fontWeight:
                                                  //             FontWeight
                                                  //                 .bold,
                                                  //             color: Colors
                                                  //                 .black)),
                                                  //     timeFormate(
                                                  //         sortedList[index]
                                                  //             .get("time")),
                                                  //   ],
                                                  // ),
                                                ],
                                              ),
                                            ),
                                          ),
                                          // Align(
                                          //   alignment: Alignment.centerRight,
                                          //   child: Container(
                                          //     child:  Align(alignment: Alignment.centerRight,child: deleteMoveForTestPopMenuBox(snapshot.data!.id,snapshot.data!.data()),),
                                          //
                                          //
                                          //     // child: PopupMenuButton<
                                          //     //     folderAction>(
                                          //     //   onSelected:
                                          //     //       (folderAction value) {
                                          //     //     if (value ==
                                          //     //         folderAction.move) {
                                          //     //       //rename folder
                                          //     //       showModalBottomSheet(
                                          //     //           context: context,
                                          //     //           builder: (builder) {
                                          //     //             return new Wrap(
                                          //     //               children: [
                                          //     //                 ListTile(
                                          //     //                   title: Text(
                                          //     //                     "Move File",
                                          //     //                     style: TextStyle(
                                          //     //                         fontSize:
                                          //     //                         20,
                                          //     //                         color: Theme.of(context)
                                          //     //                             .primaryColor),
                                          //     //                   ),
                                          //     //                   trailing:
                                          //     //                   Padding(
                                          //     //                     padding:
                                          //     //                     const EdgeInsets.all(
                                          //     //                         8.0),
                                          //     //                     child:
                                          //     //                     InkWell(
                                          //     //                       onTap:
                                          //     //                           () {
                                          //     //                         Navigator.of(context)
                                          //     //                             .pop();
                                          //     //                       },
                                          //     //                       child: Icon(
                                          //     //                           Icons
                                          //     //                               .close),
                                          //     //                     ),
                                          //     //                   ),
                                          //     //                 ),
                                          //     //                 //.get("folderID").toString()
                                          //     //                 //Text(fileAndFolderSource[sortedList[index].id]),
                                          //     //
                                          //     //                 MoveFileActivity(
                                          //     //                   dataToMove:
                                          //     //                   sortedList[index]
                                          //     //                       .data(),
                                          //     //                   recordId: fileAndFolderSource[
                                          //     //                   sortedList[index]
                                          //     //                       .id]!,
                                          //     //                   customerId:
                                          //     //                   widget
                                          //     //                       .customerId,
                                          //     //                   customerFirestore:
                                          //     //                   widget
                                          //     //                       .customerFirestore,
                                          //     //                   curentFolderID: widget
                                          //     //                       .folderStack
                                          //     //                       .last,locale: widget.locale,),
                                          //     //                 //here show move folder target
                                          //     //               ],
                                          //     //             );
                                          //     //           });
                                          //     //     }
                                          //     //   },
                                          //     //   child: Center(
                                          //     //       child: Icon(
                                          //     //         Icons.menu,
                                          //     //         color: Colors.black,
                                          //     //       )),
                                          //     //   itemBuilder: (BuildContext
                                          //     //   context) =>
                                          //     //   <
                                          //     //       PopupMenuEntry<
                                          //     //           folderAction>>[
                                          //     //     PopupMenuItem<folderAction>(
                                          //     //       value: folderAction.move,
                                          //     //       child: Text('Move'),
                                          //     //     ),
                                          //     //   ],
                                          //     // ),
                                          //   ),
                                          // ),
                                        ],
                                      ),
                                    );
                                  }else return Container(height: 0,width: 0,);
                                }),
                          );
                        }catch(e){
                          return   Padding(
                            padding: const EdgeInsets.fromLTRB(0, 2, 0, 0),
                            child: Padding(
                              padding: const EdgeInsets.all(4.0),
                              child: Padding(
                                padding: indendfolderPadding,
                                child: Row(
                                  children: [

                                    Container(
                                      margin: EdgeInsets.only(
                                        // left: width * 0.02,
                                      ),
                                      child:Image.asset("assets/svg/gr.png",fit: BoxFit.cover,),
                                    ),
                                    Container(
                                        margin: EdgeInsets.only(
                                          left: width * 0.03,
                                        ),
                                        child: Flexible(
                                          child: Text("Test Not Found",
                                            style: interRegular.copyWith(
                                              color: AppThemeManager(). getTextColor1(),
                                              fontSize: width * 0.045,
                                            ),
                                          ),
                                        )),

                                    // Container(
                                    // //  height: 50,
                                    //   width: MediaQuery.of(context).size.width,
                                    //   child: Stack(
                                    //     children: [
                                    //       Align(
                                    //         alignment: Alignment.centerLeft,
                                    //         child: Row(
                                    //           children: [
                                    //             GestureDetector(
                                    //               onTap: () {
                                    //                 // setState(() {
                                    //                 //   newFolder.isExpanded = !(newFolder.isExpanded);
                                    //                 //   newFolder.isVisible = !newFolder.isVisible;
                                    //                 // });
                                    //               },
                                    //               //newFolder.isExpanded == fals
                                    //               child: false
                                    //                   ? Icon(
                                    //                 Icons.keyboard_arrow_up_outlined,
                                    //                 size: width * 0.085,
                                    //                 color: ThemeManager().getDarkGrey2Color,
                                    //               )
                                    //                   : Icon(
                                    //                 Icons.keyboard_arrow_down_outlined,
                                    //                 size: width * 0.085,
                                    //                 color: ThemeManager().getDarkGrey2Color,
                                    //               ),
                                    //             ),
                                    //             Container(
                                    //               margin: EdgeInsets.only(
                                    //                 left: width * 0.02,
                                    //               ),
                                    //               child: SvgPicture.asset(
                                    //                 ("assets/svg/folderIcon.svg"),
                                    //                 fit: BoxFit.cover,
                                    //               ),
                                    //             ),
                                    //             Container(
                                    //                 margin: EdgeInsets.only(
                                    //                   left: width * 0.03,
                                    //                 ),
                                    //                 child: Text(
                                    //                   snapshot.data!.docs[index]["name"],
                                    //                   style: interRegular.copyWith(
                                    //                     color: ThemeManager().getBlackColor,
                                    //                     fontSize: width * 0.045,
                                    //                   ),
                                    //                 ))
                                    //             // Column(
                                    //             //   mainAxisAlignment:
                                    //             //   MainAxisAlignment.center,
                                    //             //   crossAxisAlignment:
                                    //             //   CrossAxisAlignment.start,
                                    //             //   children: [
                                    //             //
                                    //             //     Text(
                                    //             //       snapshot.data!.docs[index]["name"]
                                    //             //           .toString(),
                                    //             //       style: TextStyle(
                                    //             //           fontWeight:
                                    //             //           FontWeight.bold,
                                    //             //           color: Colors.black),
                                    //             //     ),
                                    //             //     timeFormate(snapshot.data!.docs[index]["created_at"]),
                                    //             //   ],
                                    //             // ),
                                    //           ],
                                    //         ),
                                    //       ),
                                    //       Align(
                                    //         alignment: Alignment.centerRight,
                                    //         child: Container(
                                    //           height: MediaQuery.of(context)
                                    //               .size
                                    //               .height,
                                    //           width: 50,
                                    //           child: PopupMenuButton<folderAction>(
                                    //             onSelected: (folderAction value) {
                                    //               if (value ==
                                    //                   folderAction.rename) {
                                    //                 //rename folder
                                    //                 TextEditingController
                                    //                 controller =
                                    //                 TextEditingController(
                                    //                     text: snapshot.data!.docs[index]
                                    //                     ["name"]
                                    //                         .toString());
                                    //
                                    //                 Navigator.of(context)
                                    //                     .push(
                                    //                     new MaterialPageRoute<
                                    //                         Null>(
                                    //                         builder:
                                    //                             (BuildContext
                                    //                         context) {
                                    //                           return Scaffold(
                                    //                             appBar: AppBar(
                                    //                               title: Text(
                                    //                                   "Rename Folder"),
                                    //                             ),
                                    //                             body: Container(
                                    //                               decoration:
                                    //                               BoxDecoration(
                                    //                                 color: Color
                                    //                                     .fromARGB(
                                    //                                     255,
                                    //                                     247,
                                    //                                     247,
                                    //                                     247),
                                    //                                 borderRadius: BorderRadius.only(
                                    //                                     topLeft:
                                    //                                     Radius.circular(
                                    //                                         10.0),
                                    //                                     topRight:
                                    //                                     Radius.circular(10.0)),
                                    //                               ),
                                    //                               child:
                                    //                               Padding(
                                    //                                 padding: const EdgeInsets
                                    //                                     .all(
                                    //                                     15.0),
                                    //                                 child: Wrap(
                                    //                                   children: [
                                    //                                     Padding(
                                    //                                       padding:
                                    //                                       const EdgeInsets.all(8.0),
                                    //                                       child:
                                    //                                       TextFormField(
                                    //                                         controller:
                                    //                                         controller,
                                    //                                         autofocus:
                                    //                                         true,
                                    //                                         decoration:
                                    //                                         InputDecoration(
                                    //                                           labelText: 'Folder Name',
                                    //                                           border: OutlineInputBorder(),
                                    //                                         ),
                                    //                                       ),
                                    //                                     ),
                                    //                                     InkWell(
                                    //                                       onTap:
                                    //                                           () {
                                    //                                         widget.customerFirestore.collection("folders").doc(snapshot.data!.docs[index].id).update({
                                    //                                           "name": controller.text
                                    //                                         }).then((value) {
                                    //                                           Navigator.pop(context);
                                    //                                         });
                                    //                                       },
                                    //                                       child:
                                    //                                       Card(
                                    //                                         color:
                                    //                                         Theme.of(context).primaryColor,
                                    //                                         child: Center(
                                    //                                             child: Padding(
                                    //                                               padding: const EdgeInsets.all(10.0),
                                    //                                               child: Text(
                                    //                                                 "Submit",
                                    //                                                 style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold),
                                    //                                               ),
                                    //                                             )),
                                    //                                       ),
                                    //                                     )
                                    //                                   ],
                                    //                                 ),
                                    //                               ),
                                    //                             ),
                                    //                           );
                                    //                         },
                                    //                         fullscreenDialog:
                                    //                         true));
                                    //               }
                                    //               if (value ==
                                    //                   folderAction.delete) {
                                    //                 //rename folder
                                    //                 showModalBottomSheet(
                                    //                     context: context,
                                    //                     builder: (builder) {
                                    //                       return new Wrap(
                                    //                         children: [
                                    //                           Padding(
                                    //                             padding:
                                    //                             const EdgeInsets
                                    //                                 .all(8.0),
                                    //                             child: Text(
                                    //                               "Do you want to delete this Folder?",
                                    //                               style: TextStyle(
                                    //                                   fontSize: 20,
                                    //                                   color: Theme.of(
                                    //                                       context)
                                    //                                       .primaryColor),
                                    //                             ),
                                    //                           ),
                                    //                           Row(
                                    //                             children: [
                                    //                               Expanded(
                                    //                                   child:
                                    //                                   InkWell(
                                    //                                     onTap: () {
                                    //                                       Navigator.of(
                                    //                                           context)
                                    //                                           .pop();
                                    //                                     },
                                    //                                     child: Padding(
                                    //                                       padding:
                                    //                                       const EdgeInsets
                                    //                                           .all(
                                    //                                           8.0),
                                    //                                       child: Card(
                                    //                                         elevation:
                                    //                                         8,
                                    //                                         color: Colors
                                    //                                             .grey,
                                    //                                         child: Center(
                                    //                                             child: Padding(
                                    //                                               padding: const EdgeInsets
                                    //                                                   .all(
                                    //                                                   15.0),
                                    //                                               child:
                                    //                                               Text(
                                    //                                                 "Cancel",
                                    //                                                 style: TextStyle(
                                    //                                                     color:
                                    //                                                     Colors.white,
                                    //                                                     fontWeight: FontWeight.bold),
                                    //                                               ),
                                    //                                             )),
                                    //                                       ),
                                    //                                     ),
                                    //                                   )),
                                    //                               Expanded(
                                    //                                   child:
                                    //                                   InkWell(
                                    //                                     onTap: () {
                                    //                                       widget
                                    //                                           .customerFirestore
                                    //                                           .collection(
                                    //                                           "folders")
                                    //                                           .doc(snapshot.data!.docs[index].id)
                                    //                                           .delete()
                                    //                                           .then(
                                    //                                               (value) {
                                    //                                             Navigator.pop(
                                    //                                                 context);
                                    //                                           });
                                    //                                     },
                                    //                                     child: Padding(
                                    //                                       padding:
                                    //                                       const EdgeInsets
                                    //                                           .all(
                                    //                                           8.0),
                                    //                                       child: Card(
                                    //                                         elevation:
                                    //                                         8,
                                    //                                         color: Theme.of(
                                    //                                             context)
                                    //                                             .primaryColor,
                                    //                                         child: Center(
                                    //                                             child: Padding(
                                    //                                               padding: const EdgeInsets
                                    //                                                   .all(
                                    //                                                   15.0),
                                    //                                               child:
                                    //                                               Text(
                                    //                                                 "Delete",
                                    //                                                 style: TextStyle(
                                    //                                                     color:
                                    //                                                     Colors.white,
                                    //                                                     fontWeight: FontWeight.bold),
                                    //                                               ),
                                    //                                             )),
                                    //                                       ),
                                    //                                     ),
                                    //                                   )),
                                    //                             ],
                                    //                           ),
                                    //                         ],
                                    //                       );
                                    //                     });
                                    //               }
                                    //
                                    //               if (value == folderAction.move) {
                                    //                 //rename folder
                                    //                 showModalBottomSheet(
                                    //                     context: context,
                                    //                     builder: (builder) {
                                    //                       return new Wrap(
                                    //                         children: [
                                    //                           ListTile(
                                    //                             title: Text(
                                    //                               "Move Folder",
                                    //                               style: TextStyle(
                                    //                                   fontSize: 20,
                                    //                                   color: Theme.of(
                                    //                                       context)
                                    //                                       .primaryColor),
                                    //                             ),
                                    //                             trailing: Padding(
                                    //                               padding:
                                    //                               const EdgeInsets
                                    //                                   .all(8.0),
                                    //                               child: InkWell(
                                    //                                 onTap: () {
                                    //                                   Navigator.of(
                                    //                                       context)
                                    //                                       .pop();
                                    //                                 },
                                    //                                 child: Icon(
                                    //                                     Icons
                                    //                                         .close),
                                    //                               ),
                                    //                             ),
                                    //                           ),
                                    //                           Padding(
                                    //                             padding:
                                    //                             const EdgeInsets
                                    //                                 .all(8.0),
                                    //                             child: Text(
                                    //                               "Move Folder",
                                    //                               style: TextStyle(
                                    //                                   fontSize: 20,
                                    //                                   color: Theme.of(
                                    //                                       context)
                                    //                                       .primaryColor),
                                    //                             ),
                                    //                           ),
                                    //
                                    //                           MoveFolderActivity(
                                    //                             customerId: widget
                                    //                                 .customerId,
                                    //                             customerFirestore:
                                    //                             widget
                                    //                                 .customerFirestore,
                                    //                             curentFolderID:snapshot.data!.docs[index].id,locale: widget.locale,
                                    //                           ),
                                    //                           //here show move folder target
                                    //                         ],
                                    //                       );
                                    //                     });
                                    //               }
                                    //             },
                                    //             child:
                                    //             Center(child: Icon(Icons.menu)),
                                    //             itemBuilder: (BuildContext
                                    //             context) =>
                                    //             <PopupMenuEntry<folderAction>>[
                                    //               PopupMenuItem<folderAction>(
                                    //                 value: folderAction.rename,
                                    //                 child: Text('Rename'),
                                    //               ),
                                    //               PopupMenuItem<folderAction>(
                                    //                 value: folderAction.delete,
                                    //                 child: Text('Delete'),
                                    //               ),
                                    //               PopupMenuItem<folderAction>(
                                    //                 value: folderAction.move,
                                    //                 child: Text('Move'),
                                    //               ),
                                    //             ],
                                    //           ),
                                    //         ),
                                    //       ),
                                    //     ],
                                    //   ),
                                    // ),
                                    // Container(
                                    //
                                    //  // width: MediaQuery.of(context).size.width,
                                    //   child:showNextLevelFolder(snapshot.data!.docs[index].id),)

                                  ],
                                ),
                              ),
                            ),
                          );
                        }

                        return Text(snapshot.data!.docs[index].id);
                      });


                } else {
                  return Container(width: 0,height: 0,);
                }
              });
        });

  }catch(e){
    return Center(child: Text("Something wrong"));

  }


}

class _AllFileFolderActivityState extends State<AllFileFolderActivity> {
  fileSortType selectedSortType = fileSortType.none;

  @override
  Widget build(BuildContext context) {
    SimpleDialog dialog = SimpleDialog(children: [
      Center(child: Text('Create a Folder')),
      Padding(
        padding: const EdgeInsets.all(8.0),
        child: TextField(
          controller: _folderNameController,
        ),
      ),
      InkWell(
        onTap: () async{
           AppFirestore(firestore: widget.customerFirestore, projectId: '', auth: FirebaseAuth.instance).createFolders(name:_folderNameController.text,parent: widget.folderStack.last );
         //  Navigator.pop(context);
           _folderNameController.clear();

// Close progress dialog
          final dialogContextCompleter = Completer<BuildContext>();
          final dialogContext = await dialogContextCompleter.future;
          Navigator.pop(dialogContext);
        },
        child: Card(
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(0.0),
          ),
          color: Theme.of(context).primaryColor,
          child: Container(
              child: Padding(
            padding: const EdgeInsets.all(8.0),
            child: Center(
                child: Text(
              "Create",
              style: TextStyle(color: Colors.white),
            )),
          )),
        ),
      )
    ]);

    return Wrap(
     // mainAxisAlignment: MainAxisAlignment.start,
     // crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Container(
          margin: EdgeInsets.only(left: width * 0.03,bottom: 10),
          child: Stack(children: [
            Align(alignment: Alignment.centerLeft,child: Text(
              "Browse",
              style: interMedium.copyWith(
                  color:  AppThemeManager().getTextColor2(),
                  fontSize: width * 0.04),
            ),),
            Align(alignment: Alignment.centerRight,child: addOrDeletePopMenuBox("root",0,),),

          ],),
        ),
        // Stack(
        //   children: [
        //     Align(
        //       alignment: Alignment.centerLeft,
        //       child: widget.folderStack.length > 1
        //           ? Row(
        //               mainAxisAlignment: MainAxisAlignment.start,
        //               crossAxisAlignment: CrossAxisAlignment.center,
        //               children: [
        //                 Card(
        //                   child: InkWell(
        //                       onTap: () {
        //                         setState(() {
        //                           widget.folderStack.removeLast();
        //                         });
        //                       },
        //                       child: Padding(
        //                         padding: const EdgeInsets.all(8.0),
        //                         child: Icon(Icons.chevron_left_outlined),
        //                       )),
        //                 ),
        //                 Padding(
        //                   padding: const EdgeInsets.all(8.0),
        //                   child: Text(
        //                     widget.currentFolderName,
        //                     style:
        //                         TextStyle(color: Colors.black, fontSize: 20),
        //                   ),
        //                 )
        //               ],
        //             )
        //           : Container(
        //               width: 0,
        //               height: 0,
        //             ),
        //     ),
        //     Align(
        //       alignment: Alignment.centerRight,
        //       child: Wrap(
        //         children: [
        //           Card(
        //             child: InkWell(
        //               onTap: () {
        //                 showDialog<void>(
        //                     context: context, builder: (context) => dialog);
        //               },
        //               child: Padding(
        //                 padding: const EdgeInsets.all(8.0),
        //                 child: Icon(Icons.add),
        //               ),
        //             ),
        //           ),
        //           // Card(
        //           //   child: InkWell(
        //           //     onTap: () {
        //           //       showDialog<void>(
        //           //           context: context, builder: (context) => dialog);
        //           //     },
        //           //     child: Padding(
        //           //       padding: const EdgeInsets.all(8.0),
        //           //       child: Icon(Icons.sort),
        //           //     ),
        //           //   ),
        //           // ),
        //           Container(
        //             width: 50,
        //             height: 50,
        //             child: Card(
        //               child: PopupMenuButton<fileSortType>(
        //                 onSelected: (fileSortType value) {
        //                   setState(() {
        //                     selectedSortType = value;
        //                   });
        //                 },
        //                 initialValue: selectedSortType,
        //                 child: Center(child: Icon(Icons.sort)),
        //                 itemBuilder: (BuildContext context) =>
        //                     <PopupMenuEntry<fileSortType>>[
        //                   PopupMenuItem<fileSortType>(
        //                     value: fileSortType.none,
        //                     child: Text('None'),
        //                   ),
        //                   PopupMenuItem<fileSortType>(
        //                     value: fileSortType.title,
        //                     child: Text('Title'),
        //                   ),
        //                   PopupMenuItem<fileSortType>(
        //                     value: fileSortType.date,
        //                     child: Text('Date'),
        //                   ),
        //                 ],
        //               ),
        //             ),
        //           ),
        //         ],
        //       ),
        //     ),
        //   ],
        // ),
        // Divider(),
        ExpandenFolderActivity(parentFolder: widget.folderStack.last, customerId: widget.customerId,locale: widget.locale, customerFirestore: widget.customerFirestore,),
        // Padding(padding: EdgeInsets.fromLTRB(0,10, 0, 0),child: showNextLevelFolder(widget.folderStack.last),),
        // ExpandenFolderActivity(parentFolder: widget.folderStack.last,),
        // showTestItemsInFolder(widget.folderStack.last),
        // StreamBuilder<QuerySnapshot>(
        //   stream: AppFirestore(firestore: widget.customerFirestore,projectId: "",auth: FirebaseAuth.instance).getFolders(parentFolder: widget.folderStack.last),
        //
        //     builder: (context, snapshot) {
        //
        //         if (snapshot.hasData && snapshot.data!.docs.length>0) {
        //           //List list = snapshot.data.docs;
        //           List<QueryDocumentSnapshot<Object?>> sortedList = [];
        //
        //           if (selectedSortType == fileSortType.none) {
        //             sortedList = snapshot.data!.docs;
        //           }
        //           if (selectedSortType == fileSortType.title) {
        //             sortedList = snapshot.data!.docs;
        //            try{
        //              sortedList.sort((a, b) {
        //                return a
        //                    .get("name")
        //                    .toString()
        //                    .toLowerCase()
        //                    .compareTo(b.get("name").toString().toLowerCase());
        //              });
        //            }catch(e){
        //              print("exception on sorting by title");
        //              print(e);
        //            }
        //           }
        //           if (selectedSortType == fileSortType.date) {
        //             sortedList = snapshot.data!.docs;
        //           try{
        //             sortedList.sort((a, b) {
        //               return a
        //                   .get("created_at")
        //                   .toString()
        //                   .toLowerCase()
        //                   .compareTo(
        //                   b.get("created_at").toString().toLowerCase());
        //             });
        //           }catch(e){
        //             print("exception on sorting by date");
        //             print(e);
        //           }
        //             sortedList = sortedList.reversed.toList();
        //           }
        //           return ListView.builder(
        //               physics: ClampingScrollPhysics(),
        //               // separatorBuilder: (context, index) {
        //               //   return Divider();
        //               // },
        //               shrinkWrap: true,
        //               padding: EdgeInsets.zero,
        //               itemCount: sortedList.length,
        //               itemBuilder: (_, index) {
        //                 return Container(
        //                   width: MediaQuery.of(context).size.width,
        //                   child: InkWell(
        //                     onTap: () {
        //                       // setState(() {
        //                       //   widget.currentFolderName =
        //                       //       sortedList[index]["name"];
        //                       //   widget.folderStack.add(sortedList[index].id);
        //                       // });
        //                     },
        //                     child: Padding(
        //                       padding: const EdgeInsets.fromLTRB(0, 2, 0, 2),
        //                       child: Wrap(
        //                         children: [
        //                           Container(
        //                             height: 50,
        //                             width: MediaQuery.of(context).size.width,
        //                             child: Stack(
        //                               children: [
        //                                 Align(
        //                                   alignment: Alignment.centerLeft,
        //                                   child: Row(
        //                                     children: [
        //                                       GestureDetector(
        //                                         onTap: () {
        //                                           // setState(() {
        //                                           //   newFolder.isExpanded = !(newFolder.isExpanded);
        //                                           //   newFolder.isVisible = !newFolder.isVisible;
        //                                           // });
        //                                         },
        //                                         //newFolder.isExpanded == fals
        //                                         child: true
        //                                             ? Icon(
        //                                           Icons.keyboard_arrow_up_outlined,
        //                                           size: width * 0.085,
        //                                           color: ThemeManager().getDarkGrey2Color,
        //                                         )
        //                                             : Icon(
        //                                           Icons.keyboard_arrow_down_outlined,
        //                                           size: width * 0.085,
        //                                           color: ThemeManager().getDarkGrey2Color,
        //                                         ),
        //                                       ),
        //                                       Container(
        //                                         margin: EdgeInsets.only(
        //                                           left: width * 0.02,
        //                                         ),
        //                                         child: SvgPicture.asset(
        //                                           ("assets/svg/folderIcon.svg"),
        //                                           fit: BoxFit.cover,
        //                                         ),
        //                                       ),
        //                                       Column(
        //                                         mainAxisAlignment:
        //                                             MainAxisAlignment.center,
        //                                         crossAxisAlignment:
        //                                             CrossAxisAlignment.start,
        //                                         children: [
        //                                           Text(
        //                                             sortedList[index]["name"]
        //                                                 .toString(),
        //                                             style: TextStyle(
        //                                                 fontWeight:
        //                                                     FontWeight.bold,
        //                                                 color: Colors.black),
        //                                           ),
        //                                           timeFormate(sortedList[index]
        //                                               ["created_at"]),
        //                                         ],
        //                                       ),
        //                                     ],
        //                                   ),
        //                                 ),
        //                                 Align(
        //                                   alignment: Alignment.centerRight,
        //                                   child: Container(
        //                                     height: MediaQuery.of(context)
        //                                         .size
        //                                         .height,
        //                                     width: 50,
        //                                     child: PopupMenuButton<folderAction>(
        //                                       onSelected: (folderAction value) {
        //                                         if (value ==
        //                                             folderAction.rename) {
        //                                           //rename folder
        //                                           TextEditingController
        //                                               controller =
        //                                               TextEditingController(
        //                                                   text: sortedList[index]
        //                                                           ["name"]
        //                                                       .toString());
        //
        //                                           Navigator.of(context)
        //                                               .push(
        //                                                   new MaterialPageRoute<
        //                                                           Null>(
        //                                                       builder:
        //                                                           (BuildContext
        //                                                               context) {
        //                                                         return Scaffold(
        //                                                           appBar: AppBar(
        //                                                             title: Text(
        //                                                                 "Rename Folder"),
        //                                                           ),
        //                                                           body: Container(
        //                                                             decoration:
        //                                                                 BoxDecoration(
        //                                                               color: Color
        //                                                                   .fromARGB(
        //                                                                       255,
        //                                                                       247,
        //                                                                       247,
        //                                                                       247),
        //                                                               borderRadius: BorderRadius.only(
        //                                                                   topLeft:
        //                                                                       Radius.circular(
        //                                                                           10.0),
        //                                                                   topRight:
        //                                                                       Radius.circular(10.0)),
        //                                                             ),
        //                                                             child:
        //                                                                 Padding(
        //                                                               padding: const EdgeInsets
        //                                                                       .all(
        //                                                                   15.0),
        //                                                               child: Wrap(
        //                                                                 children: [
        //                                                                   Padding(
        //                                                                     padding:
        //                                                                         const EdgeInsets.all(8.0),
        //                                                                     child:
        //                                                                         TextFormField(
        //                                                                       controller:
        //                                                                           controller,
        //                                                                       autofocus:
        //                                                                           true,
        //                                                                       decoration:
        //                                                                           InputDecoration(
        //                                                                         labelText: 'Folder Name',
        //                                                                         border: OutlineInputBorder(),
        //                                                                       ),
        //                                                                     ),
        //                                                                   ),
        //                                                                   InkWell(
        //                                                                     onTap:
        //                                                                         () {
        //                                                                       widget.customerFirestore.collection("folders").doc(sortedList[index].id).update({
        //                                                                         "name": controller.text
        //                                                                       }).then((value) {
        //                                                                         Navigator.pop(context);
        //                                                                       });
        //                                                                     },
        //                                                                     child:
        //                                                                         Card(
        //                                                                       color:
        //                                                                           Theme.of(context).primaryColor,
        //                                                                       child: Center(
        //                                                                           child: Padding(
        //                                                                         padding: const EdgeInsets.all(10.0),
        //                                                                         child: Text(
        //                                                                           "Submit",
        //                                                                           style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold),
        //                                                                         ),
        //                                                                       )),
        //                                                                     ),
        //                                                                   )
        //                                                                 ],
        //                                                               ),
        //                                                             ),
        //                                                           ),
        //                                                         );
        //                                                       },
        //                                                       fullscreenDialog:
        //                                                           true));
        //                                         }
        //                                         if (value ==
        //                                             folderAction.delete) {
        //                                           //rename folder
        //                                           showModalBottomSheet(
        //                                               context: context,
        //                                               builder: (builder) {
        //                                                 return new Wrap(
        //                                                   children: [
        //                                                     Padding(
        //                                                       padding:
        //                                                           const EdgeInsets
        //                                                               .all(8.0),
        //                                                       child: Text(
        //                                                         "Do you want to delete this Folder?",
        //                                                         style: TextStyle(
        //                                                             fontSize: 20,
        //                                                             color: Theme.of(
        //                                                                     context)
        //                                                                 .primaryColor),
        //                                                       ),
        //                                                     ),
        //                                                     Row(
        //                                                       children: [
        //                                                         Expanded(
        //                                                             child:
        //                                                                 InkWell(
        //                                                           onTap: () {
        //                                                             Navigator.of(
        //                                                                     context)
        //                                                                 .pop();
        //                                                           },
        //                                                           child: Padding(
        //                                                             padding:
        //                                                                 const EdgeInsets
        //                                                                         .all(
        //                                                                     8.0),
        //                                                             child: Card(
        //                                                               elevation:
        //                                                                   8,
        //                                                               color: Colors
        //                                                                   .grey,
        //                                                               child: Center(
        //                                                                   child: Padding(
        //                                                                 padding: const EdgeInsets
        //                                                                         .all(
        //                                                                     15.0),
        //                                                                 child:
        //                                                                     Text(
        //                                                                   "Cancel",
        //                                                                   style: TextStyle(
        //                                                                       color:
        //                                                                           Colors.white,
        //                                                                       fontWeight: FontWeight.bold),
        //                                                                 ),
        //                                                               )),
        //                                                             ),
        //                                                           ),
        //                                                         )),
        //                                                         Expanded(
        //                                                             child:
        //                                                                 InkWell(
        //                                                           onTap: () {
        //                                                             widget
        //                                                                 .customerFirestore
        //                                                                 .collection(
        //                                                                     "folders")
        //                                                                 .doc(sortedList[
        //                                                                         index]
        //                                                                     .id)
        //                                                                 .delete()
        //                                                                 .then(
        //                                                                     (value) {
        //                                                               Navigator.pop(
        //                                                                   context);
        //                                                             });
        //                                                           },
        //                                                           child: Padding(
        //                                                             padding:
        //                                                                 const EdgeInsets
        //                                                                         .all(
        //                                                                     8.0),
        //                                                             child: Card(
        //                                                               elevation:
        //                                                                   8,
        //                                                               color: Theme.of(
        //                                                                       context)
        //                                                                   .primaryColor,
        //                                                               child: Center(
        //                                                                   child: Padding(
        //                                                                 padding: const EdgeInsets
        //                                                                         .all(
        //                                                                     15.0),
        //                                                                 child:
        //                                                                     Text(
        //                                                                   "Delete",
        //                                                                   style: TextStyle(
        //                                                                       color:
        //                                                                           Colors.white,
        //                                                                       fontWeight: FontWeight.bold),
        //                                                                 ),
        //                                                               )),
        //                                                             ),
        //                                                           ),
        //                                                         )),
        //                                                       ],
        //                                                     ),
        //                                                   ],
        //                                                 );
        //                                               });
        //                                         }
        //
        //                                         if (value == folderAction.move) {
        //                                           //rename folder
        //                                           showModalBottomSheet(
        //                                               context: context,
        //                                               builder: (builder) {
        //                                                 return new Wrap(
        //                                                   children: [
        //                                                     ListTile(
        //                                                       title: Text(
        //                                                         "Move Folder",
        //                                                         style: TextStyle(
        //                                                             fontSize: 20,
        //                                                             color: Theme.of(
        //                                                                     context)
        //                                                                 .primaryColor),
        //                                                       ),
        //                                                       trailing: Padding(
        //                                                         padding:
        //                                                             const EdgeInsets
        //                                                                 .all(8.0),
        //                                                         child: InkWell(
        //                                                           onTap: () {
        //                                                             Navigator.of(
        //                                                                     context)
        //                                                                 .pop();
        //                                                           },
        //                                                           child: Icon(
        //                                                               Icons
        //                                                                   .close),
        //                                                         ),
        //                                                       ),
        //                                                     ),
        //                                                     Padding(
        //                                                       padding:
        //                                                           const EdgeInsets
        //                                                               .all(8.0),
        //                                                       child: Text(
        //                                                         "Move Folder",
        //                                                         style: TextStyle(
        //                                                             fontSize: 20,
        //                                                             color: Theme.of(
        //                                                                     context)
        //                                                                 .primaryColor),
        //                                                       ),
        //                                                     ),
        //
        //                                                     MoveFolderActivity(
        //                                                       customerId: widget
        //                                                           .customerId,
        //                                                       customerFirestore:
        //                                                           widget
        //                                                               .customerFirestore,
        //                                                       curentFolderID:
        //                                                           sortedList[
        //                                                                   index]
        //                                                               .id,locale: widget.locale,
        //                                                     ),
        //                                                     //here show move folder target
        //                                                   ],
        //                                                 );
        //                                               });
        //                                         }
        //                                       },
        //                                       child:
        //                                           Center(child: Icon(Icons.more_horiz)),
        //                                       itemBuilder: (BuildContext
        //                                               context) =>
        //                                           <PopupMenuEntry<folderAction>>[
        //                                         PopupMenuItem<folderAction>(
        //                                           value: folderAction.rename,
        //                                           child: Text('Rename'),
        //                                         ),
        //                                         PopupMenuItem<folderAction>(
        //                                           value: folderAction.delete,
        //                                           child: Text('Delete'),
        //                                         ),
        //                                         PopupMenuItem<folderAction>(
        //                                           value: folderAction.move,
        //                                           child: Text('Move'),
        //                                         ),
        //                                       ],
        //                                     ),
        //                                   ),
        //                                 ),
        //                               ],
        //                             ),
        //                           ),
        //                           Container(
        //
        //                             width: MediaQuery.of(context).size.width,
        //                             child:showNextLevelFolder(snapshot.data!.docs[index],),)
        //
        //                         ],
        //                       ),
        //                     ),
        //                   ),
        //                 );
        //
        //               });
        //         } else
        //           return Container(
        //               height: 000, child: Center(child: Text("No Folders")));
        //
        //     }),

      ],
    );
  }


  deleteMoveForTestPopMenuBox(String id,dynamic data) {
    return PopupMenuButton(
      elevation: 1,
      icon: Icon(Icons.more_horiz),

      itemBuilder: (context) => [
        PopupMenuItem(
          padding: EdgeInsets.only(
              top: height * 0.01, left: width * 0.0065, right: width * 0.0065),

          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [

              InkWell(
                onTap: () {
                  //move
                  showModalBottomSheet(shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.only(topLeft: Radius.circular(20),topRight: Radius.circular(20)),
                  ),
                  context: context,
                  builder: (context) {
                  return Container(child: MoveFileActivity(move: true,
                    dataToMove:data,
                    recordId: id,
                    customerId:
                    widget
                        .customerId,
                    customerFirestore:
                    widget
                        .customerFirestore,
                    curentFolderID: widget
                        .folderStack
                        .last,locale: widget.locale,),);});

                },
                child: Container(
                  margin: EdgeInsets.only(
                      left: width * 0.005, right: width * 0.005),
                  alignment: Alignment.center,
                  child: Text(
                    "Move",
                    style: interRegular.copyWith(
                        color: ThemeManager().getBlackColor,
                        fontSize: width * 0.035),
                  ),
                ),
              ), Container(
                margin: EdgeInsets.only(
                    top: height * 0.01, bottom: height * 0.01),
                height: height * 0.001,
                width: double.infinity,
                color: ThemeManager().getBlackColor.withOpacity(0.19),
              ),InkWell(
                onTap: () {
                  Navigator.of(context).pop();
                },
                child: Container(
                    alignment: Alignment.center,
                    child: Text(
                      TextConst.deleteFolderPopUpText,
                      style: interRegular.copyWith(
                          color: ThemeManager().getBlackColor,
                          fontSize: width * 0.035),
                    )),
              )
            ],
          ),
          // value: 1,
        ),
      ],
    );
  }
  addOrDeletePopMenuBox(String id,int level) {
    return PopupMenuButton(
      elevation: 1,
      icon: Icon(Icons.more_horiz),

      itemBuilder: (context) => [
        PopupMenuItem(
       //   padding: EdgeInsets.only(top: height * 0.01, left: width * 0.0065, right: width * 0.0065),

          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [

              InkWell(
                onTap: () {

                  Navigator.of(context).pop();
                  addNewFolderNamePopUp(id);

                },
                child: Container(
                  margin: EdgeInsets.only(
                      left: width * 0.005, right: width * 0.005),
                  alignment: Alignment.center,
                  child: Text(
                    TextConst.addNewFolderPopUpText,
                    style: interRegular.copyWith(
                        color: ThemeManager().getBlackColor,
                        fontSize: width * 0.035),
                  ),
                ),
              ), Container(
                margin: EdgeInsets.only(
                    top: height * 0.01, bottom: height * 0.01),
                height: height * 0.001,
                width: double.infinity,
                color: ThemeManager().getBlackColor.withOpacity(0.19),
              ),InkWell(
                onTap: () {
                 // widget.customerFirestore.collection("folders").doc(id).delete();
                 // Navigator.of(context).pop();
                },
                child: Container(
                    alignment: Alignment.center,
                    child: Text(
                      TextConst.deleteFolderPopUpText,
                      style: interRegular.copyWith(
                          color: ThemeManager().getLightGrey1Color,
                          fontSize: width * 0.035),
                    )),
              )
            ],
          ),
          // value: 1,
        ),
      ],
    );
  }

  //---------------Add new folder Name Dialogue Box------------------
  addNewFolderNamePopUp(String id) {
    final _formKey = GlobalKey<FormState>();
    showDialog(
        context: context,
        builder: (
            context,
            ) {
          return StatefulBuilder(builder: (context, setState) {
            return AlertDialog(
              scrollable: true,
              shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.all(Radius.circular(10))),
              contentPadding: EdgeInsets.only(top: 10.0),
              content: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Container(
                    margin: EdgeInsets.only(
                        top: height * 0.01,
                        left: width * 0.04,
                        right: width * 0.04),
                    child: Row(
                      mainAxisAlignment: MainAxisAlignment.spaceBetween,
                      children: [
                        Text("Add New Folder",
                          style: interSemiBold.copyWith(
                            color: ThemeManager().getBlackColor,
                            fontSize: width * 0.04,
                          ),
                        ),
                        InkWell(
                            onTap: () {
                              Navigator.of(context).pop();
                            },
                            child: Icon(
                              Icons.clear,
                              size: width * 0.06,
                              color: ThemeManager().getLightGrey4Color,
                            )),
                      ],
                    ),
                  ),
                  Container(
                    margin: EdgeInsets.only(top: height * 0.015),
                    height: height * 0.001,
                    color: ThemeManager().getBlackColor.withOpacity(0.19),
                  ),
                  Container(
                    margin: EdgeInsets.only(
                        top: height * 0.02,
                        left: width * 0.04,
                        right: width * 0.04),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          TextConst.folderNameText,
                          style: interMedium.copyWith(
                            color: ThemeManager().getPopUpTextGreyColor,
                            fontSize: width * 0.036,
                          ),
                        ),
                        Container(
                          margin: EdgeInsets.only(top: height * 0.015),
                          child: Form(
                            key: _formKey,
                            child: TextFormField(
                              controller: _folderNameController,
                              maxLength: 22,
                              autovalidateMode: AutovalidateMode.onUserInteraction,
                              keyboardType: TextInputType.text,
                              decoration: InputDecoration(
                                counterText: "",
                                border: InputBorder.none,
                                hintText: "Folder 1",
                                hintStyle: interMedium.copyWith(
                                  color: ThemeManager().getLightGrey4Color,
                                  fontSize: width * 0.036,
                                ),
                                enabledBorder: OutlineInputBorder(
                                    borderSide: BorderSide(
                                      color: Colors.transparent,
                                    ),
                                    borderRadius:
                                    BorderRadius.circular(width * 0.014)),
                                contentPadding: EdgeInsets.symmetric(
                                    vertical: height * 0.0,
                                    horizontal: width * 0.045),
                                fillColor:
                                ThemeManager().getLightGreenTextFieldColor,
                                filled: true,
                              ),
                              validator: (value) {
                                if (value!.isEmpty) {


                                  AppFirestore(firestore: widget.customerFirestore, projectId: '', auth: FirebaseAuth.instance).checkFolders(name:_folderNameController.text,parent: id ).then((valueR) {
                                    if(valueR == false) {
                                      showDialog(context: context,
                                          builder: (BuildContext context){
                                        return FolderExistsPopUp();
                                      });

                                      return "Folder name exists";
                                    }



                                    else  return null;
                                  });


                                } else

                                  if (value!.isEmpty) {
                                  return "Please enter folder name";
                                } else if (_folderNameController.text.length > 22) {
                                  return "Name should be 22 character only";
                                }
                              },
                            ),
                          ),
                        ),
                        // Container(
                        //   margin: EdgeInsets.only(top: height * 0.015),
                        //   child: Text(
                        //     "*Name must be within 10 characters.",
                        //     style: interMedium.copyWith(
                        //       color: ThemeManager().getPopUpTextGreyColor,
                        //       fontSize: width * 0.03,
                        //     ),
                        //   ),
                        // ),
                        InkWell(
                          onTap: () async {
                            if (_formKey.currentState!.validate()) {
                             var r = await  AppFirestore(firestore: widget.customerFirestore, projectId: '', auth: FirebaseAuth.instance).createFolders(name:_folderNameController.text,parent: id );

                             if(r == true) {
                               _folderNameController.clear();
                               Navigator.of(context).pop();
                             }else{
                               _folderNameController.clear();
                               Navigator.of(context).pop();
                               showDialog(context: context,
                                   builder: (BuildContext context){
                                     return FolderExistsPopUp();
                                   });
                             }


                            } else {}
                          },
                          child: Container(
                              margin: EdgeInsets.only(
                                  top: height * 0.04, bottom: height * 0.02),
                              child: ButtonView(
                                  buttonLabel: TextConst.saveButtonText)
                          ),
                        ),
                      ],
                    ),
                  ),
                ],
              ),
            );
          });
        });
  }

  showTestItemsInFolderSorted(String id) {
  return  StreamBuilder<QuerySnapshot>(
        stream: widget.customerFirestore
            .collection("folders")
            .doc(id)
            .collection("records")
            .snapshots(),
        builder: (context, snapshot) {
          if (snapshot.hasData && snapshot.data!.docs.length>0) {
            // return Text(snapshot.data.docs[0].get("id"));
            Map<String, String> fileAndFolderSource =
            Map<String, String>();

            List<QueryDocumentSnapshot<Object>> filteredData = [];
            List<DocumentSnapshot<Object>> allData = [];

            for (int i = 0; i < snapshot.data!.docs.length; i++) {
              // allData.add(value)

              widget.customerFirestore
                  .collection("pulltest")
                  .doc(snapshot.data!.docs[i].get("id"))
                  .get()
                  .then((value) {
                //value.data()["folderID"]= snapshot.data.docs[i].id;
                // Map<String, dynamic> da = value.data();
                fileAndFolderSource.putIfAbsent(
                    value.id, () => snapshot.data!.docs[i].id);

                //da["folderID"] = snapshot.data.docs[i].id;
                allData.add(value);
                FilteredDataShow.getInstance().dataReload(allData);

                print("size " + allData.length.toString());
              });
            }

            // if (selectedSortType == fileSortType.none) {
            //   filteredData = snapshot.data.docs;
            // } else if (selectedSortType == fileSortType.date) {
            //   filteredData = snapshot.data.docs;
            //   filteredData.sort((a, b) {
            //     return a
            //         .get("name")
            //         .toString()
            //         .toLowerCase()
            //         .compareTo(b.get("name").toString().toLowerCase());
            //   });
            // }
            print("now = > " + allData.length.toString());

            return StreamBuilder<List<DocumentSnapshot<Object>>>(
                stream: FilteredDataShow.getInstance().outData,
                builder: (BuildContext context,
                    AsyncSnapshot<List<DocumentSnapshot<Object>>>
                    snapshot) {
                  List<DocumentSnapshot<Object>> sortedList = [];
                  if (snapshot.hasData && snapshot.data!.length > 0) {
                    if (selectedSortType == fileSortType.none) {
                      sortedList = snapshot.data!;
                    }
                    if (selectedSortType == fileSortType.title) {
                      sortedList = snapshot.data!;
                      try{
                        sortedList.sort((a, b) {
                          return a
                              .get("name")
                              .toString()
                              .toLowerCase()
                              .compareTo(
                              b.get("name").toString().toLowerCase());
                        });
                      }catch(e){
                        print(e);
                      }
                    }
                    if (selectedSortType == fileSortType.date) {
                      sortedList = snapshot.data!;
                      try{
                        sortedList.sort((a, b) {
                          return a
                              .get("time")
                              .toString()
                              .toLowerCase()
                              .compareTo(
                              b.get("time").toString().toLowerCase());
                        });
                      }catch(e){

                      }
                      sortedList = sortedList.reversed.toList();
                    }
                    return sortedList.length > 0
                        ? ListView.builder(
                        physics: ClampingScrollPhysics(),
                        // separatorBuilder: (context, index) {
                        //   return Divider();
                        // },
                        padding: EdgeInsets.zero,
                        shrinkWrap: true,
                        itemCount: sortedList.length,
                        itemBuilder: (_, index) {
                          if (sortedList[index].exists &&
                              sortedList[index].get("name") != null) {
                            return Container(

                              child: Stack(
                                children: [
                                  Align(
                                    alignment: Alignment.centerLeft,
                                    child: InkWell(
                                      onTap: () {
                                        print(sortedList[index]
                                            .data()
                                            .toString());
                                        if (sortedList[index]
                                            .exists &&
                                            sortedList[index]
                                                .get("name") !=
                                                null) {
                                          AppWidgets(customerId:  widget.customerId,customerFirestore:  widget
                                              .customerFirestore). showTestRecordBody(

                                              sortedList[index].id,
                                              sortedList[index],
                                              context,widget.locale,2
                                          );
                                        }
                                      },
                                      child: Row(
                                        children: [
                                          Container(
                                            margin: EdgeInsets.only(
                                              left: width * 0.02,
                                            ),
                                           child: Image.asset("assets/svg/gr.png"),
                                            // child: SvgPicture.asset(
                                            //   ("assets/svg/gr.svg"),
                                            //   fit: BoxFit.cover,
                                            // ),
                                          ),
                                          Text(
                                              sortedList[index]
                                                  .get("name"),
                                              style: TextStyle(
                                                  fontWeight:
                                                  FontWeight
                                                      .bold,
                                                  color: Colors
                                                      .black)),
                                          // Column(
                                          //   mainAxisAlignment:
                                          //   MainAxisAlignment
                                          //       .start,
                                          //   crossAxisAlignment:
                                          //   CrossAxisAlignment
                                          //       .start,
                                          //   children: [
                                          //     Text(
                                          //         sortedList[index]
                                          //             .get("name"),
                                          //         style: TextStyle(
                                          //             fontWeight:
                                          //             FontWeight
                                          //                 .bold,
                                          //             color: Colors
                                          //                 .black)),
                                          //     timeFormate(
                                          //         sortedList[index]
                                          //             .get("time")),
                                          //   ],
                                          // ),
                                        ],
                                      ),
                                    ),
                                  ),
                                  Align(
                                    alignment: Alignment.centerRight,
                                    child: Container(
                                    // child:  Align(alignment: Alignment.centerRight,child: addOrDeletePopMenuBox(""),),


                                      // child: PopupMenuButton<
                                      //     folderAction>(
                                      //   onSelected:
                                      //       (folderAction value) {
                                      //     if (value ==
                                      //         folderAction.move) {
                                      //       //rename folder
                                      //       showModalBottomSheet(
                                      //           context: context,
                                      //           builder: (builder) {
                                      //             return new Wrap(
                                      //               children: [
                                      //                 ListTile(
                                      //                   title: Text(
                                      //                     "Move File",
                                      //                     style: TextStyle(
                                      //                         fontSize:
                                      //                         20,
                                      //                         color: Theme.of(context)
                                      //                             .primaryColor),
                                      //                   ),
                                      //                   trailing:
                                      //                   Padding(
                                      //                     padding:
                                      //                     const EdgeInsets.all(
                                      //                         8.0),
                                      //                     child:
                                      //                     InkWell(
                                      //                       onTap:
                                      //                           () {
                                      //                         Navigator.of(context)
                                      //                             .pop();
                                      //                       },
                                      //                       child: Icon(
                                      //                           Icons
                                      //                               .close),
                                      //                     ),
                                      //                   ),
                                      //                 ),
                                      //                 //.get("folderID").toString()
                                      //                 //Text(fileAndFolderSource[sortedList[index].id]),
                                      //
                                      //                 MoveFileActivity(
                                      //                   dataToMove:
                                      //                   sortedList[index]
                                      //                       .data(),
                                      //                   recordId: fileAndFolderSource[
                                      //                   sortedList[index]
                                      //                       .id]!,
                                      //                   customerId:
                                      //                   widget
                                      //                       .customerId,
                                      //                   customerFirestore:
                                      //                   widget
                                      //                       .customerFirestore,
                                      //                   curentFolderID: widget
                                      //                       .folderStack
                                      //                       .last,locale: widget.locale,),
                                      //                 //here show move folder target
                                      //               ],
                                      //             );
                                      //           });
                                      //     }
                                      //   },
                                      //   child: Center(
                                      //       child: Icon(
                                      //         Icons.menu,
                                      //         color: Colors.black,
                                      //       )),
                                      //   itemBuilder: (BuildContext
                                      //   context) =>
                                      //   <
                                      //       PopupMenuEntry<
                                      //           folderAction>>[
                                      //     PopupMenuItem<folderAction>(
                                      //       value: folderAction.move,
                                      //       child: Text('Move'),
                                      //     ),
                                      //   ],
                                      // ),
                                    ),
                                  ),
                                ],
                              ),
                            );
                          } else
                            return Container(
                              width: 0,
                              height: 0,
                            );
                        })
                        : Container(
                      width: 0,
                      height: 0,
                    );
                  } else
                    return Container(
                      width: 0,
                      height: 0,
                    );
                });


          } else {
            return Text("");
          }
        });

  }


}



TextEditingController _folderNameController = TextEditingController();

class MoveFolderActivity extends StatefulWidget {
  List<String> folderStack = ["root"];
  String currentFolderName = "";
  FirebaseFirestore customerFirestore;
  String customerId;
  String curentFolderID;
  Locale locale;

  MoveFolderActivity(
      {required this.curentFolderID,required this.customerId,required this.customerFirestore,required this.locale});

  @override
  _MoveFolderActivityState createState() => _MoveFolderActivityState();
}

class _MoveFolderActivityState extends State<MoveFolderActivity> {
  fileSortType selectedSortType = fileSortType.none;

  @override
  Widget build(BuildContext context) {
    SimpleDialog dialog = SimpleDialog(children: [
      Center(child: Text('Create a Folder')),
      Padding(
        padding: const EdgeInsets.all(8.0),
        child: TextField(
          controller: _folderNameController,
        ),
      ),
      InkWell(
        onTap: () {
          widget.customerFirestore.collection("folders").add({
            "name": _folderNameController.text,
            "parent": widget.folderStack.last,
            "created_at": new DateTime.now().millisecondsSinceEpoch
          }).then((value) {
            Navigator.pop(context);
            _folderNameController.clear();
          });
        },
        child: Card(
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(0.0),
          ),
          color: Theme.of(context).primaryColor,
          child: Container(
              child: Padding(
            padding: const EdgeInsets.all(8.0),
            child: Center(
                child: Text(
              "Create",
              style: TextStyle(color: Colors.white),
            )),
          )),
        ),
      )
    ]);

    return SingleChildScrollView(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.start,
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          InkWell(
            onTap: () {
              widget.customerFirestore
                  .collection("folders")
                  .doc(widget.curentFolderID)
                  .update({"parent": widget.folderStack.last}).then((value) {
                Navigator.pop(context);
              });
            },
            child: Center(
              child: Padding(
                padding: const EdgeInsets.all(3.0),
                child: Container(
                  decoration: BoxDecoration(
                      color: Theme.of(context).primaryColor,
                      borderRadius: BorderRadius.circular(5)),
                  width: MediaQuery.of(context).size.width,
                  child: Center(
                      child: Padding(
                    padding: const EdgeInsets.all(8.0),
                    child: Text(
                      "Paste Here",
                      style: TextStyle(color: Colors.white),
                    ),
                  )),
                ),
              ),
            ),
          ),
          Stack(
            children: [
              Align(
                alignment: Alignment.centerLeft,
                child: widget.folderStack.length > 1
                    ? Row(
                        mainAxisAlignment: MainAxisAlignment.start,
                        crossAxisAlignment: CrossAxisAlignment.center,
                        children: [
                          Card(
                            child: InkWell(
                                onTap: () {
                                  setState(() {
                                    widget.folderStack.removeLast();
                                  });
                                },
                                child: Padding(
                                  padding: const EdgeInsets.all(8.0),
                                  child: Icon(Icons.chevron_left_outlined),
                                )),
                          ),
                          Padding(
                            padding: const EdgeInsets.all(8.0),
                            child: Text(
                              widget.currentFolderName,
                              style:
                                  TextStyle(color: Colors.black, fontSize: 20),
                            ),
                          )
                        ],
                      )
                    : Container(
                        width: 0,
                        height: 0,
                      ),
              ),
              Align(
                alignment: Alignment.centerRight,
                child: Wrap(
                  children: [
                    Card(
                      child: InkWell(
                        onTap: () {
                          showDialog<void>(
                              context: context, builder: (context) => dialog);
                        },
                        child: Padding(
                          padding: const EdgeInsets.all(8.0),
                          child: Icon(Icons.add),
                        ),
                      ),
                    ),
                    // Card(
                    //   child: InkWell(
                    //     onTap: () {
                    //       showDialog<void>(
                    //           context: context, builder: (context) => dialog);
                    //     },
                    //     child: Padding(
                    //       padding: const EdgeInsets.all(8.0),
                    //       child: Icon(Icons.sort),
                    //     ),
                    //   ),
                    // ),
                    Container(
                      width: 50,
                      height: 50,
                      child: Card(
                        child: PopupMenuButton<fileSortType>(
                          onSelected: (fileSortType value) {
                            setState(() {
                              selectedSortType = value;
                            });
                          },
                          initialValue: selectedSortType,
                          child: Center(child: Icon(Icons.sort)),
                          itemBuilder: (BuildContext context) =>
                              <PopupMenuEntry<fileSortType>>[
                            PopupMenuItem<fileSortType>(
                              value: fileSortType.none,
                              child: Text('None'),
                            ),
                            PopupMenuItem<fileSortType>(
                              value: fileSortType.title,
                              child: Text('Title'),
                            ),
                            PopupMenuItem<fileSortType>(
                              value: fileSortType.date,
                              child: Text('Date'),
                            ),
                          ],
                        ),
                      ),
                    ),
                  ],
                ),
              ),
            ],
          ),
          Divider(),
          StreamBuilder<QuerySnapshot>(
              stream: widget.customerFirestore
                  .collection("folders")
                  //  .orderBy("created_at",descending: true)
                  .where(
                    "parent",
                    isEqualTo: widget.folderStack.last,
                  )
                  .snapshots(),
              builder: (context, snapshot) {
                if (snapshot.hasData &&
                    snapshot.data != null &&
                    snapshot.data!.docs != null) {
                  if (snapshot.data!.size > 0) {
                    //List list = snapshot.data.docs;
                    List<QueryDocumentSnapshot<Object?>> sortedList = [];

                    if (selectedSortType == fileSortType.none) {
                      sortedList = snapshot.data!.docs;
                    }
                    if (selectedSortType == fileSortType.title) {
                      sortedList = snapshot.data!.docs;
                     try{
                       sortedList.sort((a, b) {
                         return a
                             .get("name")
                             .toString()
                             .toLowerCase()
                             .compareTo(b.get("name").toString().toLowerCase());
                       });
                     }catch(e){
                       print(e);
                     }
                    }
                    if (selectedSortType == fileSortType.date) {
                      sortedList = snapshot.data!.docs;
                      try{
                        sortedList.sort((a, b) {
                          return a
                              .get("created_at")
                              .toString()
                              .toLowerCase()
                              .compareTo(
                              b.get("created_at").toString().toLowerCase());
                        });
                      }catch(e){
                        print(e);
                      }
                      sortedList = sortedList.reversed.toList();
                    }

                    return ListView.builder(
                        physics: ClampingScrollPhysics(),
                        // separatorBuilder: (context, index) {
                        //   return Divider();
                        // },
                        shrinkWrap: true,
                        padding: EdgeInsets.zero,
                        itemCount: sortedList.length,
                        itemBuilder: (_, index) {
                          return Container(
                            width: MediaQuery.of(context).size.width,
                            child: InkWell(
                              onTap: () {
                                setState(() {
                                  widget.currentFolderName =
                                      sortedList[index]["name"];
                                  widget.folderStack.add(sortedList[index].id);
                                });
                              },
                              child: Padding(
                                padding: const EdgeInsets.fromLTRB(0, 2, 0, 2),
                                child: Container(
                                  height: 80,
                                  width: MediaQuery.of(context).size.width,
                                  child: Stack(
                                    children: [
                                      Align(
                                        alignment: Alignment.centerLeft,
                                        child: Row(
                                          children: [
                                            Padding(
                                              padding:
                                                  const EdgeInsets.fromLTRB(
                                                      5, 5, 5, 5),
                                              child: Padding(
                                                padding:
                                                    const EdgeInsets.all(4.0),
                                                child: Icon(
                                                  Icons.folder,
                                                  color: Theme.of(context)
                                                      .primaryColor,
                                                  size: 60,
                                                ),
                                              ),
                                            ),
                                            Column(
                                              mainAxisAlignment:
                                                  MainAxisAlignment.center,
                                              crossAxisAlignment:
                                                  CrossAxisAlignment.start,
                                              children: [
                                                Text(
                                                  sortedList[index]["name"]
                                                      .toString(),
                                                  style: TextStyle(
                                                      fontWeight:
                                                          FontWeight.bold,
                                                      color: Colors.black),
                                                ),
                                                timeFormate(sortedList[index]
                                                    ["created_at"]),
                                              ],
                                            ),
                                          ],
                                        ),
                                      ),


                                    ],
                                  ),
                                ),
                              ),
                            ),
                          );

                        });
                  } else
                    return Container(
                        height: 000, child: Center(child: Text("No Folders")));
                } else {
                  return Center(child: Text("No Folders"));
                }
              }),
          StreamBuilder<QuerySnapshot>(
              stream: widget.customerFirestore
                  .collection("folders")
                  .doc(widget.folderStack.last)
                  .collection("records")
                  .snapshots(),
              builder: (context, snapshot) {
                if (snapshot.hasData &&
                    snapshot.data != null &&
                    snapshot.data!.docs.length > 0) {
                  // return Text(snapshot.data.docs[0].get("id"));

                  List<QueryDocumentSnapshot<Object>> filteredData = [];
                  List<DocumentSnapshot<Object>> allData = [];

                  for (int i = 0; i < snapshot.data!.docs.length; i++) {
                    // allData.add(value)

                    widget.customerFirestore
                        .collection("pulltest")
                        .doc(snapshot.data!.docs[i].get("id"))
                        .get()
                        .then((value) {
                      allData.add(value);
                      FilteredDataShow.getInstance().dataReload(allData);

                      print("size " + allData.length.toString());
                    });
                  }


                  print("now = > " + allData.length.toString());

                  return StreamBuilder<List<DocumentSnapshot<Object>>>(
                      stream: FilteredDataShow.getInstance().outData,
                      builder: (BuildContext context,
                          AsyncSnapshot<List<DocumentSnapshot<Object>>>
                              snapshot) {
                        List<DocumentSnapshot<Object>> sortedList = [];
                        if (snapshot.hasData && snapshot.data!.length > 0) {
                          if (selectedSortType == fileSortType.none) {
                            sortedList = snapshot.data!;
                          }
                          if (selectedSortType == fileSortType.title) {
                            sortedList = snapshot.data!;
                           try{
                             sortedList.sort((a, b) {
                               return a
                                   .get("name")
                                   .toString()
                                   .toLowerCase()
                                   .compareTo(
                                   b.get("name").toString().toLowerCase());
                             });
                           }catch(e){
                             print(e);
                           }
                          }
                          if (selectedSortType == fileSortType.date) {
                            sortedList = snapshot.data!;
                           try{
                             sortedList.sort((a, b) {
                               return a
                                   .get("time")
                                   .toString()
                                   .toLowerCase()
                                   .compareTo(
                                   b.get("time").toString().toLowerCase());
                             });
                           }catch(e){
                             print(e);
                           }
                            sortedList = sortedList.reversed.toList();
                          }
                          return sortedList.length > 0
                              ? ListView.builder(
                                  physics: ClampingScrollPhysics(),
                                  // separatorBuilder: (context, index) {
                                  //   return Divider();
                                  // },
                                  padding: EdgeInsets.zero,
                                  shrinkWrap: true,
                                  itemCount: sortedList.length,
                                  itemBuilder: (_, index) {
                                    if (sortedList[index].exists &&
                                        sortedList[index].get("name") != null) {
                                      return InkWell(
                                        onTap: () {
                                          print(sortedList[index]
                                              .data()
                                              .toString());
                                          if (sortedList[index].exists &&
                                              sortedList[index].get("name") !=
                                                  null) {
                                           AppWidgets(customerId:  widget.customerId,customerFirestore:  widget.customerFirestore). showTestRecordBody(

                                                sortedList[index].id,
                                                sortedList[index],
                                                context,widget.locale,2
                                               );
                                          }
                                        },
                                        child: Row(
                                          children: [
                                            Padding(
                                              padding:
                                                  const EdgeInsets.fromLTRB(
                                                      5, 5, 5, 5),
                                              child: Padding(
                                                padding:
                                                    const EdgeInsets.all(4.0),
                                                child: Icon(
                                                  Icons.sticky_note_2_rounded,
                                                  size: 60,
                                                ),
                                              ),
                                            ),
                                            Column(
                                              mainAxisAlignment:
                                                  MainAxisAlignment.start,
                                              crossAxisAlignment:
                                                  CrossAxisAlignment.start,
                                              children: [
                                                Text(
                                                    sortedList[index]
                                                        .get("name"),
                                                    style: TextStyle(
                                                        fontWeight:
                                                            FontWeight.bold,
                                                        color: Colors.black)),
                                                timeFormate(sortedList[index]
                                                    .get("time")),
                                              ],
                                            ),
                                          ],
                                        ),
                                      );
                                    } else
                                      return Container(
                                        width: 0,
                                        height: 0,
                                      );
                                  })
                              : Container(
                                  width: 0,
                                  height: 0,
                                );
                        } else
                          return Container(
                            width: 0,
                            height: 0,
                          );
                      });


                } else {
                  return Text("");
                }
              })
        ],
      ),
    );
  }
}

class MoveFileActivity extends StatefulWidget {
  List<String> folderStack = ["root"];
  String currentFolderName = "";
  late FirebaseFirestore customerFirestore;
  late String customerId;
  late String curentFolderID;
  late String recordId ;
  dynamic dataToMove;
  Locale locale;
  bool move;

  MoveFileActivity(
      {required this.dataToMove,
        required  this.recordId,
        required this.curentFolderID,
        required this.customerId,
        required this.move,
        required this.locale,
        required  this.customerFirestore});

  @override
  _MoveFileActivityState createState() => _MoveFileActivityState();
}

class _MoveFileActivityState extends State<MoveFileActivity> {
  fileSortType selectedSortType = fileSortType.none;
  showNextLevelFolderForMovingTest(String data,String id) {
    int step = 0;

    return StreamBuilder<QuerySnapshot>(
        stream: AppFirestore(firestore: widget.customerFirestore,projectId: "",auth: FirebaseAuth.instance).getFolders(parentFolder: data),
        builder: (context, snapshot) {
          if (snapshot.hasData && snapshot.data!.docs.length>0) {
            step++;

            List<QueryDocumentSnapshot> filteredData = [];
            filteredData = snapshot.data!.docs;
            filteredData.sort((a, b) {
              return a
                  .get("name")
                  .toString()
                  .toLowerCase()
                  .compareTo(b.get("name").toString().toLowerCase());
            });


            return   ListView.builder(
                physics: ClampingScrollPhysics(),
                // separatorBuilder: (context, index) {
                //   return Divider();
                // },
                shrinkWrap: true,
                padding: EdgeInsets.zero,
                itemCount: filteredData.length,
                itemBuilder: (_, index) {

                  return   Padding(
                    padding:  EdgeInsets.fromLTRB((step* 30), 2, 0, 2),
                    child: Column(
                      children: [
                        Stack(
                          children: [
                            Align(alignment: Alignment.centerLeft,child: Padding(
                              padding:  EdgeInsets.fromLTRB(0, 0, 0, 0),
                              child: Column(
                                children: [
                                  InkWell(onTap: (){
                                    //save here


                                if(widget.move == true) {
                                  widget.customerFirestore
                                      .collection("folders")
                                      .doc(widget.curentFolderID)
                                      .collection("records").where(
                                      "id", isEqualTo: widget.recordId)
                                      .get()
                                      .then((value) {
                                    if (value.size > 0 &&
                                        value.docs.length > 0) {
                                      print("Record found");
                                      print(value.docs.first.data());
                                      widget.customerFirestore
                                          .collection("folders")
                                          .doc(filteredData[index].id)
                                          .collection("records")
                                          .add(value.docs.first.data())
                                          .then((valueR) {
                                        widget.customerFirestore
                                            .collection("folders")
                                            .doc(widget.curentFolderID)
                                            .collection("records")
                                            .doc(value.docs.first.id)
                                            .delete()
                                            .then((value) {
                                          widget.customerFirestore
                                              .collection("pulltest")
                                              .doc(widget.recordId).update({
                                            "folder": filteredData[index].id
                                          });

                                          Navigator.pop(context);
                                        });
                                      });
                                    } else {
                                      widget.customerFirestore
                                          .collection("folders")
                                          .doc(filteredData[index].id)
                                          .collection("records")
                                          .add({"created_at":DateTime.now().millisecondsSinceEpoch,"created_by":FirebaseAuth.instance.currentUser!.uid,"id":widget.recordId}).then((value){    widget.customerFirestore
                                          .collection("pulltest")
                                          .doc(widget.recordId).update({
                                        "folder": filteredData[index].id
                                      });
                                          Navigator.pop(context);});
                                    }
                                  });
                                }else{
                                  widget.customerFirestore
                                      .collection("folders")
                                      .doc(filteredData[index].id)
                                      .collection("records")
                                      .add({"created_at":DateTime.now().millisecondsSinceEpoch,"created_by":FirebaseAuth.instance.currentUser!.uid,"id":widget.recordId}).then((value){

                                        widget.customerFirestore
                                      .collection("pulltest")
                                      .doc(widget.recordId).update({
                                    "folder": filteredData[index].id
                                  });
                                      Navigator.pop(context);});
                                }









                                    print("saved in folder");
                                    Future.delayed(Duration.zero, () {
                                      isTestRunning = false;

                                      if(true) try{


                                        CustomerHomePageLogic().tabChangedStream.dataReload(0);

                                        // CustomerHomePageLogic().tabChangedStream.dataReload(1);
                                        // CustomerHomePageLogic().connectedDevicesStream.dataReload(true);
                                        //   CustomerHomePageLogic().testRunningUniversalNotifier.dataReload(false);
                                        //   //  CustomerHomePageLogic().connectedDevicesStream.dataReload(true);
                                        //   Navigator.pop(context);
                                        //  // Navigator.pop(context);
                                        // //  Navigator.pop(context);
                                        //   CustomerHomePageLogic().connectedDevicesStream.dataReload(true);
                                        //  // Navigator.of(context).popUntil((route) => route.isFirst);
                                        //   Navigator.pop(context);
                                        //   CustomerHomePageLogic().connectedDevicesStream.dataReload(true);
                                        //   Navigator.pop(context);
                                        //   CustomerHomePageLogic().connectedDevicesStream.dataReload(true);
                                        print("success");
                                      }catch(e){
                                        print("Error on going home");
                                        print(e);
                                        // CustomerHomePageLogic().connectedDevicesStream.dataReload(true);
                                        // // Navigator.of(context).popUntil((route) => route.isFirst);
                                        // Navigator.pop(context);
                                        // CustomerHomePageLogic().connectedDevicesStream.dataReload(true);
                                        // Navigator.pop(context);
                                        // CustomerHomePageLogic().connectedDevicesStream.dataReload(true);


                                        CustomerHomePageLogic().tabChangedStream.dataReload(0);

                                        // CustomerHomePageLogic().tabChangedStream.dataReload(1);
                                        //  CustomerHomePageLogic().connectedDevicesStream.dataReload(true);
                                      }


                                      // Navigator.of(context).popUntil((route) => route.isFirst);
                                      // returnHomePage(context);
                                      bool didCanceled = false;

                                      // Navigator.push(
                                      //     context,
                                      //     MaterialPageRoute(
                                      //         builder: (BuildContext context) =>
                                      //             SaveSucessActivity()));
                                    });
                                  },
                                    child: Row(
                                      children: [
                                        GestureDetector(
                                          onTap: () {
                                            // setState(() {
                                            //   newFolder.isExpanded = !(newFolder.isExpanded);
                                            //   newFolder.isVisible = !newFolder.isVisible;
                                            // });
                                          },
                                          //newFolder.isExpanded == fals
                                          child: false
                                              ? Icon(
                                            Icons.keyboard_arrow_up_outlined,
                                            size: width * 0.085,
                                            color: ThemeManager().getDarkGrey2Color,
                                          )
                                              : Icon(
                                            Icons.keyboard_arrow_down_outlined,
                                            size: width * 0.085,
                                            color: ThemeManager().getDarkGrey2Color,
                                          ),
                                        ),
                                        Container(
                                          margin: EdgeInsets.only(
                                            left: width * 0.02,
                                          ),
                                          child: SvgPicture.asset(
                                            ("assets/svg/folderIcon.svg"),
                                            fit: BoxFit.cover,
                                          ),
                                        ),
                                        Container(
                                            margin: EdgeInsets.only(
                                              left: width * 0.03,
                                            ),
                                            child: Text(filteredData[index]["name"],
                                              style: interRegular.copyWith(
                                                color: ThemeManager().getBlackColor,
                                                fontSize: width * 0.045,
                                              ),
                                            )),

                                        // Container(
                                        // //  height: 50,
                                        //   width: MediaQuery.of(context).size.width,
                                        //   child: Stack(
                                        //     children: [
                                        //       Align(
                                        //         alignment: Alignment.centerLeft,
                                        //         child: Row(
                                        //           children: [
                                        //             GestureDetector(
                                        //               onTap: () {
                                        //                 // setState(() {
                                        //                 //   newFolder.isExpanded = !(newFolder.isExpanded);
                                        //                 //   newFolder.isVisible = !newFolder.isVisible;
                                        //                 // });
                                        //               },
                                        //               //newFolder.isExpanded == fals
                                        //               child: false
                                        //                   ? Icon(
                                        //                 Icons.keyboard_arrow_up_outlined,
                                        //                 size: width * 0.085,
                                        //                 color: ThemeManager().getDarkGrey2Color,
                                        //               )
                                        //                   : Icon(
                                        //                 Icons.keyboard_arrow_down_outlined,
                                        //                 size: width * 0.085,
                                        //                 color: ThemeManager().getDarkGrey2Color,
                                        //               ),
                                        //             ),
                                        //             Container(
                                        //               margin: EdgeInsets.only(
                                        //                 left: width * 0.02,
                                        //               ),
                                        //               child: SvgPicture.asset(
                                        //                 ("assets/svg/folderIcon.svg"),
                                        //                 fit: BoxFit.cover,
                                        //               ),
                                        //             ),
                                        //             Container(
                                        //                 margin: EdgeInsets.only(
                                        //                   left: width * 0.03,
                                        //                 ),
                                        //                 child: Text(
                                        //                   snapshot.data!.docs[index]["name"],
                                        //                   style: interRegular.copyWith(
                                        //                     color: ThemeManager().getBlackColor,
                                        //                     fontSize: width * 0.045,
                                        //                   ),
                                        //                 ))
                                        //             // Column(
                                        //             //   mainAxisAlignment:
                                        //             //   MainAxisAlignment.center,
                                        //             //   crossAxisAlignment:
                                        //             //   CrossAxisAlignment.start,
                                        //             //   children: [
                                        //             //
                                        //             //     Text(
                                        //             //       snapshot.data!.docs[index]["name"]
                                        //             //           .toString(),
                                        //             //       style: TextStyle(
                                        //             //           fontWeight:
                                        //             //           FontWeight.bold,
                                        //             //           color: Colors.black),
                                        //             //     ),
                                        //             //     timeFormate(snapshot.data!.docs[index]["created_at"]),
                                        //             //   ],
                                        //             // ),
                                        //           ],
                                        //         ),
                                        //       ),
                                        //       Align(
                                        //         alignment: Alignment.centerRight,
                                        //         child: Container(
                                        //           height: MediaQuery.of(context)
                                        //               .size
                                        //               .height,
                                        //           width: 50,
                                        //           child: PopupMenuButton<folderAction>(
                                        //             onSelected: (folderAction value) {
                                        //               if (value ==
                                        //                   folderAction.rename) {
                                        //                 //rename folder
                                        //                 TextEditingController
                                        //                 controller =
                                        //                 TextEditingController(
                                        //                     text: snapshot.data!.docs[index]
                                        //                     ["name"]
                                        //                         .toString());
                                        //
                                        //                 Navigator.of(context)
                                        //                     .push(
                                        //                     new MaterialPageRoute<
                                        //                         Null>(
                                        //                         builder:
                                        //                             (BuildContext
                                        //                         context) {
                                        //                           return Scaffold(
                                        //                             appBar: AppBar(
                                        //                               title: Text(
                                        //                                   "Rename Folder"),
                                        //                             ),
                                        //                             body: Container(
                                        //                               decoration:
                                        //                               BoxDecoration(
                                        //                                 color: Color
                                        //                                     .fromARGB(
                                        //                                     255,
                                        //                                     247,
                                        //                                     247,
                                        //                                     247),
                                        //                                 borderRadius: BorderRadius.only(
                                        //                                     topLeft:
                                        //                                     Radius.circular(
                                        //                                         10.0),
                                        //                                     topRight:
                                        //                                     Radius.circular(10.0)),
                                        //                               ),
                                        //                               child:
                                        //                               Padding(
                                        //                                 padding: const EdgeInsets
                                        //                                     .all(
                                        //                                     15.0),
                                        //                                 child: Wrap(
                                        //                                   children: [
                                        //                                     Padding(
                                        //                                       padding:
                                        //                                       const EdgeInsets.all(8.0),
                                        //                                       child:
                                        //                                       TextFormField(
                                        //                                         controller:
                                        //                                         controller,
                                        //                                         autofocus:
                                        //                                         true,
                                        //                                         decoration:
                                        //                                         InputDecoration(
                                        //                                           labelText: 'Folder Name',
                                        //                                           border: OutlineInputBorder(),
                                        //                                         ),
                                        //                                       ),
                                        //                                     ),
                                        //                                     InkWell(
                                        //                                       onTap:
                                        //                                           () {
                                        //                                         widget.customerFirestore.collection("folders").doc(snapshot.data!.docs[index].id).update({
                                        //                                           "name": controller.text
                                        //                                         }).then((value) {
                                        //                                           Navigator.pop(context);
                                        //                                         });
                                        //                                       },
                                        //                                       child:
                                        //                                       Card(
                                        //                                         color:
                                        //                                         Theme.of(context).primaryColor,
                                        //                                         child: Center(
                                        //                                             child: Padding(
                                        //                                               padding: const EdgeInsets.all(10.0),
                                        //                                               child: Text(
                                        //                                                 "Submit",
                                        //                                                 style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold),
                                        //                                               ),
                                        //                                             )),
                                        //                                       ),
                                        //                                     )
                                        //                                   ],
                                        //                                 ),
                                        //                               ),
                                        //                             ),
                                        //                           );
                                        //                         },
                                        //                         fullscreenDialog:
                                        //                         true));
                                        //               }
                                        //               if (value ==
                                        //                   folderAction.delete) {
                                        //                 //rename folder
                                        //                 showModalBottomSheet(
                                        //                     context: context,
                                        //                     builder: (builder) {
                                        //                       return new Wrap(
                                        //                         children: [
                                        //                           Padding(
                                        //                             padding:
                                        //                             const EdgeInsets
                                        //                                 .all(8.0),
                                        //                             child: Text(
                                        //                               "Do you want to delete this Folder?",
                                        //                               style: TextStyle(
                                        //                                   fontSize: 20,
                                        //                                   color: Theme.of(
                                        //                                       context)
                                        //                                       .primaryColor),
                                        //                             ),
                                        //                           ),
                                        //                           Row(
                                        //                             children: [
                                        //                               Expanded(
                                        //                                   child:
                                        //                                   InkWell(
                                        //                                     onTap: () {
                                        //                                       Navigator.of(
                                        //                                           context)
                                        //                                           .pop();
                                        //                                     },
                                        //                                     child: Padding(
                                        //                                       padding:
                                        //                                       const EdgeInsets
                                        //                                           .all(
                                        //                                           8.0),
                                        //                                       child: Card(
                                        //                                         elevation:
                                        //                                         8,
                                        //                                         color: Colors
                                        //                                             .grey,
                                        //                                         child: Center(
                                        //                                             child: Padding(
                                        //                                               padding: const EdgeInsets
                                        //                                                   .all(
                                        //                                                   15.0),
                                        //                                               child:
                                        //                                               Text(
                                        //                                                 "Cancel",
                                        //                                                 style: TextStyle(
                                        //                                                     color:
                                        //                                                     Colors.white,
                                        //                                                     fontWeight: FontWeight.bold),
                                        //                                               ),
                                        //                                             )),
                                        //                                       ),
                                        //                                     ),
                                        //                                   )),
                                        //                               Expanded(
                                        //                                   child:
                                        //                                   InkWell(
                                        //                                     onTap: () {
                                        //                                       widget
                                        //                                           .customerFirestore
                                        //                                           .collection(
                                        //                                           "folders")
                                        //                                           .doc(snapshot.data!.docs[index].id)
                                        //                                           .delete()
                                        //                                           .then(
                                        //                                               (value) {
                                        //                                             Navigator.pop(
                                        //                                                 context);
                                        //                                           });
                                        //                                     },
                                        //                                     child: Padding(
                                        //                                       padding:
                                        //                                       const EdgeInsets
                                        //                                           .all(
                                        //                                           8.0),
                                        //                                       child: Card(
                                        //                                         elevation:
                                        //                                         8,
                                        //                                         color: Theme.of(
                                        //                                             context)
                                        //                                             .primaryColor,
                                        //                                         child: Center(
                                        //                                             child: Padding(
                                        //                                               padding: const EdgeInsets
                                        //                                                   .all(
                                        //                                                   15.0),
                                        //                                               child:
                                        //                                               Text(
                                        //                                                 "Delete",
                                        //                                                 style: TextStyle(
                                        //                                                     color:
                                        //                                                     Colors.white,
                                        //                                                     fontWeight: FontWeight.bold),
                                        //                                               ),
                                        //                                             )),
                                        //                                       ),
                                        //                                     ),
                                        //                                   )),
                                        //                             ],
                                        //                           ),
                                        //                         ],
                                        //                       );
                                        //                     });
                                        //               }
                                        //
                                        //               if (value == folderAction.move) {
                                        //                 //rename folder
                                        //                 showModalBottomSheet(
                                        //                     context: context,
                                        //                     builder: (builder) {
                                        //                       return new Wrap(
                                        //                         children: [
                                        //                           ListTile(
                                        //                             title: Text(
                                        //                               "Move Folder",
                                        //                               style: TextStyle(
                                        //                                   fontSize: 20,
                                        //                                   color: Theme.of(
                                        //                                       context)
                                        //                                       .primaryColor),
                                        //                             ),
                                        //                             trailing: Padding(
                                        //                               padding:
                                        //                               const EdgeInsets
                                        //                                   .all(8.0),
                                        //                               child: InkWell(
                                        //                                 onTap: () {
                                        //                                   Navigator.of(
                                        //                                       context)
                                        //                                       .pop();
                                        //                                 },
                                        //                                 child: Icon(
                                        //                                     Icons
                                        //                                         .close),
                                        //                               ),
                                        //                             ),
                                        //                           ),
                                        //                           Padding(
                                        //                             padding:
                                        //                             const EdgeInsets
                                        //                                 .all(8.0),
                                        //                             child: Text(
                                        //                               "Move Folder",
                                        //                               style: TextStyle(
                                        //                                   fontSize: 20,
                                        //                                   color: Theme.of(
                                        //                                       context)
                                        //                                       .primaryColor),
                                        //                             ),
                                        //                           ),
                                        //
                                        //                           MoveFolderActivity(
                                        //                             customerId: widget
                                        //                                 .customerId,
                                        //                             customerFirestore:
                                        //                             widget
                                        //                                 .customerFirestore,
                                        //                             curentFolderID:snapshot.data!.docs[index].id,locale: widget.locale,
                                        //                           ),
                                        //                           //here show move folder target
                                        //                         ],
                                        //                       );
                                        //                     });
                                        //               }
                                        //             },
                                        //             child:
                                        //             Center(child: Icon(Icons.menu)),
                                        //             itemBuilder: (BuildContext
                                        //             context) =>
                                        //             <PopupMenuEntry<folderAction>>[
                                        //               PopupMenuItem<folderAction>(
                                        //                 value: folderAction.rename,
                                        //                 child: Text('Rename'),
                                        //               ),
                                        //               PopupMenuItem<folderAction>(
                                        //                 value: folderAction.delete,
                                        //                 child: Text('Delete'),
                                        //               ),
                                        //               PopupMenuItem<folderAction>(
                                        //                 value: folderAction.move,
                                        //                 child: Text('Move'),
                                        //               ),
                                        //             ],
                                        //           ),
                                        //         ),
                                        //       ),
                                        //     ],
                                        //   ),
                                        // ),
                                        // Container(
                                        //
                                        //  // width: MediaQuery.of(context).size.width,
                                        //   child:showNextLevelFolder(snapshot.data!.docs[index].id),)

                                      ],
                                    ),
                                  ),

                                  showNextLevelFolderForMovingTest(filteredData[index].id,id),
                                  //showTestItemsInFolder(snapshot.data!.docs[index].id),

                                ],
                              ),
                            ),),
                            // Align(alignment: Alignment.centerRight,child: addOrDeletePopMenuBox(snapshot.data!.docs[index].id),),
                          ],
                        ),
                        // showTestItemsInFolderForTestSave(snapshot.data!.docs[index].id),
                      ],
                    ),
                  );

                });


            return Text( snapshot.data!.docs.length.toString());
          }else return Container(width: 0,height: 0,);
        });
  }
  @override
  Widget build(BuildContext context) {
    SimpleDialog dialog = SimpleDialog(children: [
      Center(child: Text('Create a Folder')),
      Padding(
        padding: const EdgeInsets.all(8.0),
        child: TextField(
          controller: _folderNameController,
        ),
      ),
      InkWell(
        onTap: () {
          widget.customerFirestore.collection("folders").add({
            "name": _folderNameController.text,
            "parent": widget.folderStack.last,
            "created_at": new DateTime.now().millisecondsSinceEpoch
          }).then((value) {
            Navigator.pop(context);
            _folderNameController.clear();
          });
        },
        child: Card(
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(0.0),
          ),
          color: Theme.of(context).primaryColor,
          child: Container(
              child: Padding(
            padding: const EdgeInsets.all(8.0),
            child: Center(
                child: Text(
              "Create",
              style: TextStyle(color: Colors.white),
            )),
          )),
        ),
      )
    ]);

    return  Dialog(
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(10),
      ),
      elevation: 0,
      backgroundColor: Colors.transparent,
      child: Scaffold(body:Wrap(children:[

        Padding(
          padding: const EdgeInsets.all(8.0),
          child: Text(widget.move? "Select Folder To Move":"Select Folder To Save",style: interRegular.copyWith(
              color: ThemeManager().getBlackColor,
              fontWeight: FontWeight.w800,
              fontSize: width * 0.052)),
        ),
        Divider(),
        showNextLevelFolderForMovingTest("root",widget.recordId),
      ])),
    );


    return Container(color: Colors.white,
      child: SingleChildScrollView(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.start,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            InkWell(
              onTap: () {
                print(widget.curentFolderID);
                print(widget.recordId);
                widget.customerFirestore
                    .collection("folders")
                    .doc(widget.curentFolderID)
                    .collection("records")
                    .doc(widget.recordId)
                    .get()
                    .then((value) {
                  if (value.exists && value.data() != null) {
                    widget.customerFirestore
                        .collection("folders")
                        .doc(widget.folderStack.last)
                        .collection("records")
                        .add(value.data()!)
                        .then((value) {
                      widget.customerFirestore
                          .collection("folders")
                          .doc(widget.curentFolderID)
                          .collection("records")
                          .doc(widget.recordId)
                          .delete()
                          .then((value) {
                        Navigator.pop(context);
                      });
                    });
                  } else {
                    print("Move error.No record found on source");
                  }
                });
              },
              child: Center(
                child: Padding(
                  padding: const EdgeInsets.all(3.0),
                  child: Container(
                    decoration: BoxDecoration(
                        color: Theme.of(context).primaryColor,
                        borderRadius: BorderRadius.circular(5)),
                    width: MediaQuery.of(context).size.width,
                    child: Center(
                        child: Padding(
                      padding: const EdgeInsets.all(8.0),
                      child: Text(
                        "Paste Here",
                        style: TextStyle(color: Colors.white),
                      ),
                    )),
                  ),
                ),
              ),
            ),
            Stack(
              children: [
                Align(
                  alignment: Alignment.centerLeft,
                  child: widget.folderStack.length > 1
                      ? Row(
                          mainAxisAlignment: MainAxisAlignment.start,
                          crossAxisAlignment: CrossAxisAlignment.center,
                          children: [
                            Card(
                              child: InkWell(
                                  onTap: () {
                                    setState(() {
                                      widget.folderStack.removeLast();
                                    });
                                  },
                                  child: Padding(
                                    padding: const EdgeInsets.all(8.0),
                                    child: Icon(Icons.chevron_left_outlined),
                                  )),
                            ),
                            Padding(
                              padding: const EdgeInsets.all(8.0),
                              child: Text(
                                widget.currentFolderName,
                                style:
                                    TextStyle(color: Colors.black, fontSize: 20),
                              ),
                            )
                          ],
                        )
                      : Container(
                          width: 0,
                          height: 0,
                        ),
                ),
                Align(
                  alignment: Alignment.centerRight,
                  child: Wrap(
                    children: [
                      Card(
                        child: InkWell(
                          onTap: () {
                            showDialog<void>(
                                context: context, builder: (context) => dialog);
                          },
                          child: Padding(
                            padding: const EdgeInsets.all(8.0),
                            child: Icon(Icons.add),
                          ),
                        ),
                      ),
                      // Card(
                      //   child: InkWell(
                      //     onTap: () {
                      //       showDialog<void>(
                      //           context: context, builder: (context) => dialog);
                      //     },
                      //     child: Padding(
                      //       padding: const EdgeInsets.all(8.0),
                      //       child: Icon(Icons.sort),
                      //     ),
                      //   ),
                      // ),
                      Container(
                        width: 50,
                        height: 50,
                        child: Card(
                          child: PopupMenuButton<fileSortType>(
                            onSelected: (fileSortType value) {
                              setState(() {
                                selectedSortType = value;
                              });
                            },
                            initialValue: selectedSortType,
                            child: Center(child: Icon(Icons.sort)),
                            itemBuilder: (BuildContext context) =>
                                <PopupMenuEntry<fileSortType>>[
                              PopupMenuItem<fileSortType>(
                                value: fileSortType.none,
                                child: Text('None'),
                              ),
                              PopupMenuItem<fileSortType>(
                                value: fileSortType.title,
                                child: Text('Title'),
                              ),
                              PopupMenuItem<fileSortType>(
                                value: fileSortType.date,
                                child: Text('Date'),
                              ),
                            ],
                          ),
                        ),
                      ),
                    ],
                  ),
                ),
              ],
            ),
            Divider(),
            StreamBuilder<QuerySnapshot>(
                stream: widget.customerFirestore
                    .collection("folders")
                    //  .orderBy("created_at",descending: true)
                    .where(
                      "parent",
                      isEqualTo: widget.folderStack.last,
                    )
                    .snapshots(),
                builder: (context, snapshot) {
                  if (snapshot.hasData &&
                      snapshot.data != null &&
                      snapshot.data!.docs != null) {
                    if (snapshot.data!.size > 0) {
                      //List list = snapshot.data.docs;
                      List<QueryDocumentSnapshot<Object?>> sortedList = [];

                      if (selectedSortType == fileSortType.none) {
                        sortedList = snapshot.data!.docs;
                      }
                      if (selectedSortType == fileSortType.title) {
                        sortedList = snapshot.data!.docs;
                       try{
                         sortedList.sort((a, b) {
                           return a
                               .get("name")
                               .toString()
                               .toLowerCase()
                               .compareTo(b.get("name").toString().toLowerCase());
                         });
                       }catch(e){
                         print(e);
                       }
                      }
                      if (selectedSortType == fileSortType.date) {
                        sortedList = snapshot.data!.docs;
                      try{
                        sortedList.sort((a, b) {
                          return a
                              .get("created_at")
                              .toString()
                              .toLowerCase()
                              .compareTo(
                              b.get("created_at").toString().toLowerCase());
                        });
                      }catch(e){
                        print(e);
                      }
                        sortedList = sortedList.reversed.toList();
                      }

                      return ListView.builder(
                          physics: ClampingScrollPhysics(),
                          // separatorBuilder: (context, index) {
                          //   return Divider();
                          // },
                          shrinkWrap: true,
                          padding: EdgeInsets.zero,
                          itemCount: sortedList.length,
                          itemBuilder: (_, index) {
                            return Container(
                              width: MediaQuery.of(context).size.width,
                              child: InkWell(
                                onTap: () {
                                  setState(() {
                                    widget.currentFolderName =
                                        sortedList[index]["name"];
                                    widget.folderStack.add(sortedList[index].id);
                                  });
                                },
                                child: Padding(
                                  padding: const EdgeInsets.fromLTRB(0, 2, 0, 2),
                                  child: Container(
                                    height: 80,
                                    width: MediaQuery.of(context).size.width,
                                    child: Stack(
                                      children: [
                                        Align(
                                          alignment: Alignment.centerLeft,
                                          child: Row(
                                            children: [
                                              Padding(
                                                padding:
                                                    const EdgeInsets.fromLTRB(
                                                        5, 5, 5, 5),
                                                child: Padding(
                                                  padding:
                                                      const EdgeInsets.all(4.0),
                                                  child: Icon(
                                                    Icons.folder,
                                                    color: Theme.of(context)
                                                        .primaryColor,
                                                    size: 60,
                                                  ),
                                                ),
                                              ),
                                              Column(
                                                mainAxisAlignment:
                                                    MainAxisAlignment.center,
                                                crossAxisAlignment:
                                                    CrossAxisAlignment.start,
                                                children: [
                                                  Text(
                                                    sortedList[index]["name"]
                                                        .toString(),
                                                    style: TextStyle(
                                                        fontWeight:
                                                            FontWeight.bold,
                                                        color: Colors.black),
                                                  ),
                                                  timeFormate(sortedList[index]
                                                      ["created_at"]),
                                                ],
                                              ),
                                            ],
                                          ),
                                        ),

                                      ],
                                    ),
                                  ),
                                ),
                              ),
                            );

                          });
                    } else
                      return Container(
                          height: 000, child: Center(child: Text("No Folders")));
                  } else {
                    return Center(child: Text("No Folders"));
                  }
                }),
            StreamBuilder<QuerySnapshot>(
                stream: widget.customerFirestore
                    .collection("folders")
                    .doc(widget.folderStack.last)
                    .collection("records")
                    .snapshots(),
                builder: (context, snapshot) {
                  if (snapshot.hasData &&
                      snapshot.data != null &&
                      snapshot.data!.docs.length > 0) {
                    // return Text(snapshot.data.docs[0].get("id"));

                    List<QueryDocumentSnapshot<Object>> filteredData = [];
                    List<DocumentSnapshot<Object>> allData = [];

                    for (int i = 0; i < snapshot.data!.docs.length; i++) {
                      // allData.add(value)

                      widget.customerFirestore
                          .collection("pulltest")
                          .doc(snapshot.data!.docs[i].get("id"))
                          .get()
                          .then((value) {
                        allData.add(value);
                        FilteredDataShow.getInstance().dataReload(allData);

                        print("size " + allData.length.toString());
                      });
                    }

                    // if (selectedSortType == fileSortType.none) {
                    //   filteredData = snapshot.data.docs;
                    // } else if (selectedSortType == fileSortType.date) {
                    //   filteredData = snapshot.data.docs;
                    //   filteredData.sort((a, b) {
                    //     return a
                    //         .get("name")
                    //         .toString()
                    //         .toLowerCase()
                    //         .compareTo(b.get("name").toString().toLowerCase());
                    //   });
                    // }
                    print("now = > " + allData.length.toString());

                    return StreamBuilder<List<DocumentSnapshot<Object>>>(
                        stream: FilteredDataShow.getInstance().outData,
                        builder: (BuildContext context,
                            AsyncSnapshot<List<DocumentSnapshot<Object>>>
                                snapshot) {
                          List<DocumentSnapshot<Object?>> sortedList = [];
                          if (snapshot.hasData && snapshot.data!.length > 0) {
                            if (selectedSortType == fileSortType.none) {
                              sortedList = snapshot.data!;
                            }
                            if (selectedSortType == fileSortType.title) {
                              sortedList = snapshot.data!;
                             try{
                               sortedList.sort((a, b) {
                                 return a
                                     .get("name")
                                     .toString()
                                     .toLowerCase()
                                     .compareTo(
                                     b.get("name").toString().toLowerCase());
                               });
                             }catch(e){
                               print(e);
                             }
                            }
                            if (selectedSortType == fileSortType.date) {
                              sortedList = snapshot.data!;
                            try{
                              sortedList.sort((a, b) {
                                return a
                                    .get("time")
                                    .toString()
                                    .toLowerCase()
                                    .compareTo(
                                    b.get("time").toString().toLowerCase());
                              });
                            }catch(e){
                              print(e);

                            }
                              sortedList = sortedList.reversed.toList();
                            }
                            return sortedList.length > 0
                                ? ListView.builder(
                                    physics: ClampingScrollPhysics(),
                                    // separatorBuilder: (context, index) {
                                    //   return Divider();
                                    // },
                                    padding: EdgeInsets.zero,
                                    shrinkWrap: true,
                                    itemCount: sortedList.length,
                                    itemBuilder: (_, index) {
                                      if (sortedList[index].exists &&
                                          sortedList[index].get("name") != null) {
                                        return InkWell(
                                          onTap: () {
                                            print(sortedList[index]
                                                .data()
                                                .toString());
                                            if (sortedList[index].exists &&
                                                sortedList[index].get("name") !=
                                                    null) {
                                             AppWidgets(customerId:  widget.customerId,customerFirestore:   widget.customerFirestore). showTestRecordBody(

                                                  sortedList[index].id,
                                                  sortedList[index],
                                                  context,widget.locale,2
                                                );
                                            }
                                          },
                                          child: Row(
                                            children: [
                                              Padding(
                                                padding:
                                                    const EdgeInsets.fromLTRB(
                                                        5, 5, 5, 5),
                                                child: Padding(
                                                  padding:
                                                      const EdgeInsets.all(4.0),
                                                  child: Icon(
                                                    Icons.sticky_note_2_rounded,
                                                    size: 60,
                                                  ),
                                                ),
                                              ),
                                              Column(
                                                mainAxisAlignment:
                                                    MainAxisAlignment.start,
                                                crossAxisAlignment:
                                                    CrossAxisAlignment.start,
                                                children: [
                                                  Text(
                                                      sortedList[index]
                                                          .get("name"),
                                                      style: TextStyle(
                                                          fontWeight:
                                                              FontWeight.bold,
                                                          color: Colors.black)),
                                                  timeFormate(sortedList[index]
                                                      .get("time")),
                                                ],
                                              ),
                                            ],
                                          ),
                                        );
                                      } else
                                        return Container(
                                          width: 0,
                                          height: 0,
                                        );
                                    })
                                : Container(
                                    width: 0,
                                    height: 0,
                                  );
                          } else
                            return Container(
                              width: 0,
                              height: 0,
                            );
                        });


                  } else {
                    return Text("");
                  }
                })
          ],
        ),
      ),
    );
  }
}

class DecimalTextInputFormatter extends TextInputFormatter {
  DecimalTextInputFormatter({required this.decimalRange})
      : assert(decimalRange == null || decimalRange > 0);

  final int decimalRange;

  @override
  TextEditingValue formatEditUpdate(
    TextEditingValue oldValue, // unused.
    TextEditingValue newValue,
  ) {
    TextSelection newSelection = newValue.selection;
    String truncated = newValue.text;

    if (decimalRange != null) {
      String value = newValue.text;

      if (value.contains(".") &&
          value.substring(value.indexOf(".") + 1).length > decimalRange) {
        truncated = oldValue.text;
        newSelection = oldValue.selection;
      } else if (value == ".") {
        truncated = "0.";

        newSelection = newValue.selection.copyWith(
          baseOffset: math.min(truncated.length, truncated.length + 1),
          extentOffset: math.min(truncated.length, truncated.length + 1),
        );
      }

      return TextEditingValue(
        text: truncated,
        selection: newSelection,
        composing: TextRange.empty,
      );
    }
    return newValue;
  }
}



/// Convert to image format.
class ImageConverter {
  /// toImage
  static Future<Uint8List> toImage(
      {required RenderSignaturePad renderSignaturePad}) async {
    return Uint8List.fromList(<int>[0]);
  }
}
class FirmwareSettingsPage extends StatefulWidget {
  BluetoothDevice device;

  FirmwareSettingsPage({required this.device});

  @override
  _SettingsPageState createState() => _SettingsPageState();
}

class _SettingsPageState extends State<FirmwareSettingsPage> {
  @override
  Widget build(BuildContext context) {
    return Container(color: Colors.white,child: SafeArea(
      child: Scaffold(body: Column(
        children: [
          ApplicationAppbar().getAppbar(title:"Firmware Update"),
         Expanded(child:  StreamBuilder<QuerySnapshot>(
             stream: FirebaseFirestore.instance.collection("firmwares").snapshots(),
             builder: (context, snapshotfirmaware) {

               if (snapshotfirmaware.hasData) {
                 return  snapshotfirmaware.data!.docs.length == 0?   Text("No firmware available",
                   style: TextStyle(fontSize: 20),
                 ):      ListView.separated(shrinkWrap: true,
                     separatorBuilder: (context, index) => Divider(

                     ),
                     padding:  EdgeInsets.all(8),
                     itemCount: snapshotfirmaware.data!.docs.length,
                     itemBuilder: (BuildContext context, int index) {
                       return ListTile(onTap: (){
                         //prepare update DownloadFirmwareData

                         Navigator.of(context).push(
                             MaterialPageRoute(
                                 builder:
                                     (context) {
                                   // d.connect(autoConnect: true);
                                   return WriteFirmware(device: widget.device,file: base64Decode(snapshotfirmaware.data!.docs[index].get("file")));
                                   return Scaffold(body: Center(child: Text("up"),),);
                                   //return DeviceScreenLessDetails(r.device);
                                 }));
                         // Navigator.push(
                         //   context,
                         //   MaterialPageRoute(builder: (context) => DownloadFirmwareData(file: base64Decode(snapshotfirmaware.data!.docs[index].get("file")),)),
                         // );


                       },subtitle: Text(convertDate(snapshotfirmaware.data!.docs[index].get("time"))),title:Text(snapshotfirmaware.data!.docs[index].get("name")),);
                     });
               } else {
                 return  Text("No firmware available",
                   style: TextStyle(fontSize: 20),
                 );
               }
             }),),
        ],
      ),),
    ),);
  }
}


class DownloadFirmwareData extends StatefulWidget {
  Uint8List file;
  DownloadFirmwareData({required this.file});

  @override
  _DownloadFirmwareDataState createState() => _DownloadFirmwareDataState();
}

class _DownloadFirmwareDataState extends State<DownloadFirmwareData> {

  @override
  Widget build(BuildContext context) {
    return Scaffold(body: SingleChildScrollView(child: Column(
      children: [
        Text("Firmware downloaded",style: TextStyle(fontSize: 20),),
        Text(((widget.file.length/(1024).ceil()).toString()+" KB"),style: TextStyle(fontSize: 20)),


        StreamBuilder<BluetoothState>(
            stream: FlutterBlue.instance.state,
            initialData: BluetoothState.unknown,
            builder: (c, snapshot) {
              final state = snapshot.data;
              if (state == BluetoothState.on) {
                // return Text("Blutooth on");
                return StreamBuilder<List<BluetoothDevice>>(
                  stream: Stream.periodic(Duration(seconds: 0))
                      .asyncMap((_) =>
                  FlutterBlue.instance.connectedDevices),
                  initialData: [],
                  builder: (c, snapshot) {
                    if (snapshot.hasData &&
                        snapshot.data!.length > 0) {


                      return Column(
                        children: snapshot.data!
                            .map((d) => ListTile(
                          onTap: () {



                          },

                          title: Text(d.name),
                          subtitle: Text(d.id.toString()),
                          trailing: StreamBuilder<
                              BluetoothDeviceState>(
                            stream: d.state,
                            initialData: BluetoothDeviceState
                                .disconnected,
                            builder: (c, snapshot) {
                              if (snapshot.data ==
                                  BluetoothDeviceState
                                      .connected) {
                                return InkWell(
                                  onTap: () {
                                    Navigator.of(context).push(
                                        MaterialPageRoute(
                                            builder:
                                                (context) {
                                             // d.connect(autoConnect: true);
                                             return WriteFirmware(device: d,file: widget.file);
                                              return Scaffold(body: Center(child: Text("up"),),);
                                              //return DeviceScreenLessDetails(r.device);
                                            }));
                                  },
                                  child: Text(
                                    "Update",
                                    style: TextStyle(
                                        color: Theme.of(
                                            context)
                                            .primaryColor),
                                  ),
                                );

                              }
                              return Text(
                                  snapshot.data.toString());
                            },
                          ),
                        ))
                            .toList(),
                      );
                    } else {
                      return ListTile(
                        onTap: () {
                          FlutterBlue.instance.startScan(
                              timeout: Duration(seconds: 4));
                          showDialog<void>(
                              context: context,
                              builder: (context) => SimpleDialog(
                                children: [
                                  StreamBuilder<List<ScanResult>>(
                                    stream: FlutterBlue
                                        .instance.scanResults,
                                    initialData: [],
                                    builder: (c, snapshot) {
                                      //  updateData(snapshot.data);
                                      FirebaseFirestore firestore;
                                      //  Database(firestore: firestore).addData(snapshot.data);

                                      return Column(
                                        children: snapshot.data!
                                            .map(
                                              (r) =>
                                              ScanResultTile(
                                                result: r,
                                                onTap: () {
                                                  r.device
                                                      .connect(
                                                      autoConnect:
                                                      false)
                                                      .then(
                                                          (value) {

                                                      });
                                                  //return Text("ok");
                                                  //   return   PerformTestPage(device: r.device,project: widget.projectID,);
                                                  //return Scaffold(body: Center(child: Text("ok"),),);
                                                  Navigator.pop(
                                                      context);
                                                  //return ConnectedDevicePage(device: r.device);
                                                  //return DeviceScreenLessDetails(r.device);
                                                },
                                              ),
                                          //     (r) => ScanResultTile(
                                          //   result: r,
                                          //   onTap: () => Navigator.of(context)
                                          //       .push(MaterialPageRoute(builder: (context) {
                                          //     r.device.connect(autoConnect: false);
                                          //     //return Text("ok");
                                          //  //   return   PerformTestPage(device: r.device,project: widget.projectID,);
                                          //     return   PerformTestPage(device: r.device,project:"o",);
                                          //     Navigator.pop(context);
                                          //     //return ConnectedDevicePage(device: r.device);
                                          //     //return DeviceScreenLessDetails(r.device);
                                          //   })),
                                          // ),
                                        )
                                            .toList(),
                                      );
                                    },
                                  )
                                ],
                              ));
                        },
                        title: Text("No Device is Connected"),
                        trailing: Text(
                          "Scan",
                          style: TextStyle(color: Colors.blue),
                        ),
                      );
                    }
                  },
                );

              }
              return ListTile(
                title: Text("Turn on Blutooth"),
                trailing: Icon(
                  Icons.bluetooth_disabled,
                  color: Theme.of(context).primaryColor,
                ),
              );
              //return BluetoothOffScreen(state: state);
            }),


        // InkWell(onTap: (){
        //   //apply update
        //
        //
        //
        // },
        //   child: Padding(
        //     padding: EdgeInsets.all(10),
        //     child: Card(
        //       color: Theme.of(context).primaryColor,
        //       child: Container(width: MediaQuery.of(context).size.width,child: Center(child: Padding(
        //       padding: const EdgeInsets.all(8.0),
        //       child: Text("Update",style: TextStyle(fontSize: 20,color: Colors.white),),
        //     ),),),
        //     ),
        //   ),
        // )

      ],
    ),),appBar: AppBar(title: Text("Firmware update"),),);
  }
}
class WriteFirmware extends StatefulWidget {
  BluetoothDevice device;
  Uint8List file ;
  int count =0 ;

  WriteFirmware({required this.file,required this.device});

  @override
  _WriteFirmwareState createState() => _WriteFirmwareState();
}

class _WriteFirmwareState extends State<WriteFirmware> {
  List<int> myheader = [] ;
  @override
  void initState() {
    // TODO: implement initState
    super.initState();
    listenforDiviceStatus();
    discoverServices();


    //List<int>headerData = [67, 67, 50, 54, 120, 50, 82, 49, 3, 1, -1, -1, 7, 0, -12, 109, 2, 0, 48, 48, 48, 49];
   // print(headerData);
    Int8List int8Data = Int8List.fromList(widget.file.toList());

    myheader.addAll(int8Data.sublist(0,8));
    myheader.addAll(int8Data.sublist(12,14));
    myheader.addAll(int8Data.sublist(16,20));
    myheader.addAll(int8Data.sublist(24,28));
    myheader.addAll(int8Data.sublist(32,36));
    print(myheader);
     prepareFile();
  }

  Future<void> conenctDevice() async {
    try {
      await widget.device.connect(autoConnect: false);
    } catch (e) {
      // if (e.code != 'already_connected') {
      //   throw e;
      // }
    } finally {
      await widget.device.discoverServices();
    }
  }
  Widget firmwareUpdateCompleteScreenView(){
    return  Wrap(
      children: [
        Stack(
          alignment: Alignment.center,

          children: [

            //----------------------Image - Update complete-------------
            Container(
                alignment: Alignment.topCenter,
                child: Image.asset(
                  "assets/images/firmwareUpdateCompleteImage.png",
                  scale: 0.98,
                )
            ),

            //------------------Update complete text------------
            Positioned(
              bottom: 0,
              child: Container(
                  margin: EdgeInsets.only(bottom: height * 0.011),
                  child: Text(
                    "Update Complete",
                    style: interSemiBold.copyWith(fontSize: width * 0.051),
                  )
              ),
            )
          ],
        ),

        //------------------Instruction text------------
        Container(
          margin: EdgeInsets.only(
              top: height * 0.0025, left: width * 0.18, right: width * 0.18),
          child: Text(
            "Your product has now restarted with the latest firmware. ",
            textAlign: TextAlign.center,
            style: interMedium.copyWith(
                fontSize: width * 0.035,
                height: height * 0.0018,
                color: ThemeManager().getBlackColor.withOpacity(0.7)),
          ),
        ),

        //-----------------------Button Finish-----------------
        GestureDetector(
          onTap: (){
            Navigator.of(context).popUntil((route) => route.isFirst);
          },
          child: Container(
              margin: EdgeInsets.only(
                  top: height * 0.02, left: width * 0.25, right: width * 0.25),
              child: ButtonView(
                buttonLabel: TextConst.finishText,
              )),
        ),

      ],
    );
  }
  @override
  Widget build(BuildContext context) {

    Widget firmwareUpdateInProgressScreenView(String progress){
      return Column(

        children: [

          //----------------------Image - Update in progress-------------
          Container(
              margin: EdgeInsets.only(top: height * 0.075),
              alignment: Alignment.topCenter,
              child: Image.asset(
                "assets/images/firmwareUpdateInProgressImage.png",
                fit: BoxFit.fill,
                height: height * 0.29,
                width: width * 0.79,
              )),

          //-------------------Progress percentage-------------
          Container(
            margin: EdgeInsets.only(top: height * 0.008, bottom: height * 0.025),

            child: Row(
              mainAxisAlignment: MainAxisAlignment.center,

              children: [
                Container(
                    padding: EdgeInsets.only(bottom: height * 0.002),
                    child: Row(
                      children: [

                        //------------Scanning icon--------
                        Container(
                          margin: EdgeInsets.only(right: width*0.03),
                          child: SpinKitWave(
                            type: SpinKitWaveType.start,
                            color: ThemeManager().getDarkGreenColor,
                            size: width*0.09,
                          ),
                        ),

                        //-----------Progress percentage text----------
                        Container(
                          child: Text(
                            "Update in Progress "+progress+"%....",
                            style: interSemiBold.copyWith(
                                color: ThemeManager().getDarkGreenColor,
                                fontSize: width * 0.037),
                          ),
                        )
                      ],
                    )),
              ],
            ),
          ),

          //------------------Instruction text------------
          Text(
            "This may take a few minutes",
            style: interRegular.copyWith(
                fontSize: width * 0.038,
                color: ThemeManager().getLightGrey1Color),
          ),
        ],
      );
    }



    Widget firmwareUpdateErrorScreenView(){
      return Column(
        children: [
          Container(
              margin: EdgeInsets.only(top: height * 0.035),
              alignment: Alignment.topCenter,
              child: Image.asset(
                "assets/images/firmwareUpdateErrorImage.png",
                scale: 0.98,
                // fit: BoxFit.fill,
                // height: height * 0.29,
                // width: width * 0.75,
              )),
          Container(
              margin:
              EdgeInsets.only(top: height * 0.02, bottom: height * 0.011),
              child: Text(
                "Update Error",
                style: interSemiBold.copyWith(fontSize: width * 0.05),
              )),
          Container(
            margin: EdgeInsets.only(
                top: height * 0.0025, left: width * 0.12, right: width * 0.12),
            child: Text(
              "There has been a error updating your product.",

              textAlign: TextAlign.center,
              style: interMedium.copyWith(fontSize: width * 0.038,height: height*0.0018),
            ),
          ),
          GestureDetector(
            onTap: (){
              Navigator.pop(context);
            },
            child: Container(
                margin: EdgeInsets.only(
                    top: height * 0.02, left: width * 0.25, right: width * 0.25),
                child: ButtonView(
                  buttonLabel: TextConst.retryText,
                )),
          ),
        ],
      );
    }
    return Container(color: Colors.white,
      child: SafeArea(
        child: Scaffold(appBar:  AppBar(
          elevation: 1,
          title: Text(
            TextConst.firmwareUpdateText,
            style: interBold.copyWith(
                color: ThemeManager().getBlackColor, fontSize: width * 0.047),
          ),
          centerTitle: true,
          leading: InkWell(
              onTap: () {
                Navigator.pop(context);
              },
              child: Container(
                  child: Center(
                    child: Image.asset("assets/icons/backArrowIcon.png"),))),
          backgroundColor: ThemeManager().getWhiteColor,
        ),body: StreamBuilder<BluetoothDeviceState>(
            stream: widget.device.state,
            builder: (c, snapshot) {
              if(snapshot.data == BluetoothDeviceState.connected){
                return Center(child: Padding(
                  padding: const EdgeInsets.all(8.0),
                  child:widget.count<2?CircularProgressIndicator():  firmwareUpdateInProgressScreenView((widget.count*100/663).toStringAsFixed(1)) ,
                ),);
              }else{
                return firmwareUpdateErrorScreenView();
                return Center(child: Column(mainAxisAlignment: MainAxisAlignment.center,crossAxisAlignment: CrossAxisAlignment.center,
                  children: [
                    Text("Device is disconnected",style: TextStyle(fontSize: 30),),
                    RaisedButton(onPressed:(){
                      Navigator.pop(context);
                    },child: Text("Go Back"),)
                  ],
                ),);

              }

            })),
      ),
    );
    return Scaffold(appBar: AppBar(),body: Center(child: Text(widget.count.toString(),style: TextStyle(fontSize: 30),),),);
  }

  Future<void> discoverServices() async {
    await Future.delayed(Duration(seconds: 1));
    try{
      await widget.device.discoverServices();
     // await conenctDevice();
      List<BluetoothService> allServices = await widget.device.services.first ;

     // BluetoothCharacteristic write = allServices[4].characteristics.last;
     //print(write);
     // print(write.uuid.toString());

      // for(var g in  allServices[4].characteristics){
      //   print(g.uuid.toString()+ " "+g.serviceUuid.toString()+"  "+g.properties.toString());
      // }


       await widget.device.requestMtu(255);
       print("current mtu ");
    int mtu = await  widget.device.mtu.first;
    print(mtu);

    //now start write

      List processedData = [];

      //print(utf8.encode(widget.));



    }catch(e){
      print(e);

    }


  }
     GET_BYTE_FROM_UINT32(int uint32,int whichByte) {
    switch (whichByte) {
      case 0:
        return (uint32 & 0xFF);
      case 1:
        return ((uint32 >> 8) & 0xff);
      case 2:
        return ((uint32 >> 16) & 0xff);
      case 3:
        return ((uint32 >> 24) & 0xff);
      default:
        return 0x00;
    }
  }
  void prepareFile()async {
    int BUILD_UINT16( a,  b) {
      return ((((a & 0xFF) << 8) & 0x0000FF00) | ((b & 0x000000FF)));
    }
    conv(a, b, c, d) {
      int al, bl, cl, dl, result;
      al = (((a & 0xFF) << 24) & 0x00000000FF000000);
      bl = (((b & 0xFF) << 16) & 0x0000000000FF0000);
      cl = (((c & 0xFF) << 8) & 0x000000000000FF00);
      dl = ((d & 0xFF) & 0x00000000000000FF);
      result = ((al | bl | cl | dl) & 0x00000000FFFFFFFF);
      return result;
    }

    for(int i = 0 ; i <  100 ; i ++){
      print("pos "+i.toString()+" "+ widget.file[i].toString());
    }
    var intList = widget.file.toList();
    //step 1
    await widget.device.requestMtu(255);

    print("downloaded file");
    print(widget.file);
    Uint8List int32bytes(int value) =>
        Uint8List(4)
          ..buffer.asInt32List()[0] = value;


    int PixelPerCommand = 244;

    List<List<int>> chunks = [];

    //start
    int TIOADEoadBlockSize = 244;


    int dataSize = TIOADEoadBlockSize - 4;
    int readSize = dataSize;

    int totalPixel = intList.length;
    double iteration = totalPixel / PixelPerCommand;
  //   for (int i = 0; i < iteration; i++) {
  //     int block = i ;
  //
  //
  //
  //
  //   if (widget.file.length - ((block) * dataSize) < dataSize) {
  //     readSize = widget.file
  //         .length - ((block) * dataSize);
  //   }
  //
  //     //Uint8List buffer = Uint8List(244);
  //     final byteList = Int8List(244);
  //
  //     //var buffer =  Uint8List(244).buffer;
  //
  //
  //     // var byte0 = block & 0xff;
  //     // var byte1 = (block >> 8) & 0xff;
  //     // var byte2 = (block >> 16) & 0xff;
  //     // var byte3 = block >> 24;
  //
  //     var byte0 = block & 0xff;
  //     var byte1 = (block >> 8) & 0xff;
  //     var byte2 = (block >> 16) & 0xff;
  //     var byte3 =( block >> 24) ;
  //     byteList[0] = byte0;
  //     byteList[1] = byte1;
  //     byteList[2] = byte2;
  //     byteList[3] = byte3;
  //
  //   for (int ii = 0; ii < 4; ii++) {
  //
  //     //byteList[ii] = GET_BYTE_FROM_UINT32(block, ii);
  //     //byteList =
  //   }
  //   //Log.d("mkl","Block: " + block + " srcPos: " + (int)(dataSize * block) + " dstPos: " + 4 + " readSize: " + readSize);
  //   //Log.d("mkl","Sent Block " +blockRequestChar.getUuid().toString()+" data "+buffer);
  //     print("set range happening");
  //    // print("4 4 "+readSize.toString()+" "+" src "+dataSize.toString()+"x"+block.toString());
  //     byteList.setRange(4, 4 + readSize, widget.file, (dataSize * block));
  //   // Log.i("filebuffer", Arrays.toString(fileReader.getRawImageData()));
  //
  //      // print(buffer[0].toString() + "==" + buffer[buffer.length - 1].toString());
  //       print(byteList);
  //       //print(i.toString());
  //       //print(byteList);
  //
  //
  //   // Log.d("mkl","Sent Block " + block + " With Data:" + TIOADEoadDefinitions.BytetohexString(buffer));
  //
  //
  // }

    //end








  //  int totalPixel = intList.length;
   // double iteration = totalPixel / PixelPerCommand;
    for (int i = 0; i < iteration; i++) {
      if (((i * PixelPerCommand) + PixelPerCommand) <
          intList.length) {
        chunks.add(intList.sublist((i * PixelPerCommand),
            ((i * PixelPerCommand) + PixelPerCommand)));
      } else {
        chunks.add(intList.sublist(
            (i * PixelPerCommand), (intList.length - 1)));
      }
    }
    print("Total block q"+ chunks.length.toString());
    print(chunks.first);
    Uint8List bytes4 = Uint8List.fromList(chunks.first);
    print(bytes4);
    print("Total block q e"+ chunks.length.toString());
    await Future.delayed(Duration(seconds: 2));
    Map<String,BluetoothCharacteristic> oadCharacter = await OsDependentSettings().getOADCharacters(device: widget.device);
    await Future.delayed(Duration(seconds: 2));
    print(oadCharacter["header"]!.uuid.toString());
    print(oadCharacter["startStop"]!.uuid.toString());
    print(oadCharacter["image"]);
    await Future.delayed(Duration(seconds: 2));

      BluetoothCharacteristic characteristicStepHeaderC1 = oadCharacter["header"]!;


    characteristicStepHeaderC1.setNotifyValue(true);
    await Future.delayed(Duration(seconds: 2));
   BluetoothCharacteristic characteristicimageC2 = oadCharacter["image"]!;
    characteristicimageC2.setNotifyValue(true);
    await Future.delayed(Duration(seconds: 2));
   BluetoothCharacteristic characteristicStartStopC5 = oadCharacter["startStop"]!;
    characteristicStartStopC5.setNotifyValue(true);

  // HexEncoder _hexEncoder;

    characteristicimageC2.value.listen((event) {
      print("notify "+characteristicimageC2.uuid.toString());
      print(Int8List.fromList(event));


    });
    characteristicStepHeaderC1.value.listen((event) async {
      print("notify "+characteristicStepHeaderC1.uuid.toString());
      print(Int8List.fromList(event));
      if(event.length == 1 && event.first == 0){

        await Future.delayed(Duration(seconds: 4));
        await characteristicStartStopC5.write(Int8List.fromList([3]), withoutResponse: OsDependentSettings().writeWithresponse);

      }

    });
    write(int block)async{
      //print(chunks[index].first.toString()+"="+chunks[index].last.toString());
      int readSize = dataSize;
      if (widget.file.length - ((block) * dataSize) < dataSize) {
        readSize = widget.file
            .length - ((block) * dataSize);
      }

      //Uint8List buffer = Uint8List(244);
      //TIOADEoadTotalBlocks = this.fileReader.getRawImageData().length / (TIOADEoadBlockSize - 4);
      final byteList = Int8List(readSize+4);

      //var buffer =  Uint8List(244).buffer;


      // var byte0 = block & 0xff;
      // var byte1 = (block >> 8) & 0xff;
      // var byte2 = (block >> 16) & 0xff;
      // var byte3 = block >> 24;

      var byte0 = block & 0xff;
      var byte1 = (block >> 8) & 0xff;
      var byte2 = (block >> 16) & 0xff;
      var byte3 =( block >> 24) ;
      byteList[0] = byte0;
      byteList[1] = byte1;
      byteList[2] = byte2;
      byteList[3] = byte3;

      for (int ii = 0; ii < 4; ii++) {

        //byteList[ii] = GET_BYTE_FROM_UINT32(block, ii);
        //byteList =
      }
      //Log.d("mkl","Block: " + block + " srcPos: " + (int)(dataSize * block) + " dstPos: " + 4 + " readSize: " + readSize);
      //Log.d("mkl","Sent Block " +blockRequestChar.getUuid().toString()+" data "+buffer);
      print("set range happening");
      // print("4 4 "+readSize.toString()+" "+" src "+dataSize.toString()+"x"+block.toString());
      byteList.setRange(4, 4 + readSize, widget.file, (dataSize * block));



setState(() {
  widget.count = block;
});


      await characteristicimageC2.write(byteList,withoutResponse: OsDependentSettings().writeWithresponse);

    }



    int currentIndex = 0;
    push(int pos)async{
      if(true){
        print("sending data => "+pos.toString()+"  " +pos.toString());
        await Future.delayed(Duration(milliseconds: 100));
        await write(pos);




      }else{
        //last step
        //board should restart
        await characteristicStartStopC5.write([4],withoutResponse: OsDependentSettings().writeWithresponse);

      }
    }
    bool ifc5_16_sent = false;
    bool isHeaderSent = false;
    bool ifc5_3_sent = false;
    characteristicStartStopC5.value.listen((event)async {
      print("notify " + characteristicStartStopC5.uuid.toString());
      Int8List int8 = Int8List.fromList(event);
      print("si");
      print(int8);
      print("unis");
      print(event);

      if(event.length == 2 && event[0] == 4 && event[1] == 0){
        showAlertDialog(BuildContext context) {

          // set up the buttons
          Widget remindButton = TextButton(
            child: Text("Back to Home"),
            onPressed:  () {
              Navigator.pop(context);
              Navigator.pop(context);
              Navigator.pop(context);
              Navigator.pop(context);
            },
          );



          // set up the AlertDialog
          AlertDialog alert = AlertDialog(
            title: Text("Success"),
            content: Text("OAD is successfull"),
            actions: [
              remindButton,

            ],
          );

          // show the dialog
          showDialog(
            context: context,
            builder: (BuildContext context) {
              return Dialog(child: Container(width: MediaQuery.of(context).size.width*0.8 ,child: Padding(
                padding: const EdgeInsets.only(bottom: 20),
                child: firmwareUpdateCompleteScreenView(),
              ),),);
            },
          );
        }
        showAlertDialog(context);
      }

      if (event.length == 3) {
        print("sending [16]");
        await Future.delayed(Duration(seconds: 2));
        print("byte size " + BUILD_UINT16(int8[2], int8[1]).toString());
        await characteristicStartStopC5.write(Int8List.fromList([16,00,00,00,00,00]),
            withoutResponse: OsDependentSettings().writeWithresponse);
      }
      if (event.length == 5) {
        print("sending header");
        
        await Future.delayed(Duration(seconds: 2));
        await characteristicStepHeaderC1.write(
            myheader, withoutResponse: OsDependentSettings().writeWithresponse);
      }

      if (int8.length == 6) {
        currentIndex++;
        //currentIndex < 664
        if (int8[1]!=14)
          push(conv(int8[5], int8[4], int8[3], int8[2]));

      else
    {
      await Future.delayed(Duration(milliseconds: 2));

      await characteristicStartStopC5.write(Int8List.fromList([4]),withoutResponse: OsDependentSettings().writeWithresponse);

    }
      }




if(false){
  if(false && ifc5_16_sent == false){
    await Future.delayed(Duration(seconds: 2));
    //await characteristicStartStopC5.write(Int8List.fromList([16]),withoutResponse: OsDependentSettings().writeWithresponse);
    ifc5_16_sent = true;
  }else{
    if(isHeaderSent == false){
      await Future.delayed(Duration(seconds: 2));
      List<int>headerData = [67, 67, 50, 54, 120, 50, 82, 49, 3, 1, -1, -1, 7, 0, -12, 109, 2, 0, 48, 48, 48, 49];
      Int8List int8 = Int8List.fromList(headerData);
      await characteristicStepHeaderC1.write(int8,withoutResponse: OsDependentSettings().writeWithresponse);
      isHeaderSent = true;
    }else{
      print("almost happy");
      if(ifc5_3_sent == false) {
        print("almost happy here");
        await Future.delayed(Duration(seconds: 2));
        // await characteristicStartStopC5.write(Int8List.fromList([3]), withoutResponse: OsDependentSettings().writeWithresponse);
        ifc5_3_sent = true;
        if(event.length>4){
          // print(" cal index "+conv(event[5], event[4], event[3], event[2]).toString());
          await Future.delayed(Duration(milliseconds: 500));
          currentIndex++;

          Int8List int8 =  Int8List.fromList(event);


          //push(conv(int8[5], int8[4], int8[3], int8[2]));
        }


      }else{
        if(event.length>4){
          Int8List int8 =  Int8List.fromList(event);
          print(" cal index "+conv(int8[5], int8[4], int8[3], int8[2]).toString());
          await Future.delayed(Duration(milliseconds: 500));
          currentIndex++;


          //push(conv(int8[5], int8[4], int8[3], int8[2]));
        }
        print("happy");


      }
    }
  }
}


      //print(AsciiDecoder().convert(event));
      //print(convertMkl(event));
    });

    //step 2
    await Future.delayed(Duration(seconds: 2));
    print("first write");
    await characteristicStartStopC5.write(Int8List.fromList([1]),withoutResponse: OsDependentSettings().writeWithresponse);
    //await characteristicStartStopC5.write(Int8List.fromList([0]),withoutResponse: OsDependentSettings().writeWithresponse);
    await Future.delayed(Duration(seconds: 3));

    // //step 3
    // await characteristicStartStop.write([16],withoutResponse: OsDependentSettings().writeWithresponse);
    // await Future.delayed(Duration(seconds: 1));
    // //step 4
    // await Future.delayed(Duration(seconds: 2));
    // List<int>headerData = [67, 67, 50, 54, 120, 50, 82, 49, 3, 1, -1, -1, 7, 0, -12, 109, 2, 0, 48, 48, 48, 49];
    // await characteristicStepHeader.write(headerData,withoutResponse: OsDependentSettings().writeWithresponse);
    //
    //
    // await Future.delayed(Duration(seconds: 3));
    //
    // await characteristicStartStop.write([3],withoutResponse: OsDependentSettings().writeWithresponse);
    // await Future.delayed(Duration(seconds: 1));
    //step 4


    // characteristicStartStop.value.listen((event) {
    //   print("notify "+characteristicStartStop.uuid.toString());
    //   print(event);
    //   //print(utf8.decode(event));
    //   currentIndex++;
    //   push();
    //   //print(AsciiDecoder().convert(event));
    //   //print(convertMkl(event));
    // });

  //  await characteristicimage.write(chunks[0],withoutResponse: OsDependentSettings().writeWithresponse);


    //last step




  }

  void listenforDiviceStatus() {




  }
}


String convertDate(int date) {
  DateTime now = DateTime.fromMillisecondsSinceEpoch(date);
  String formattedDate = DateFormat('HH:mm a dd MMM').format(now);
  return formattedDate;
}

String convertMkl(List<int> data) {
  String returnValue = "";

  final result = data.map((b) => '${b.toRadixString(16).padLeft(2, '0')}');
  print('bytes: ${result}');
  var bd = ByteData(data.length);
  for (int i = 0; i < data.length; i++) {
    String tempVal = data[i].toRadixString(16).padLeft(2, '0').toString();
    //returnValue = returnValue+tempVal;

    bd.setUint8(i, data[i].toInt());
  }
  var f = bd.getFloat32(0);
  print(f);
  bd.setUint32(0, 0x41480000);
  var f1 = bd.getFloat32(0);
  print(f1);
  // print(_hexEncoder.);
//  returnValue =data[0].toRadixString(16).padLeft(2, '0')+data[0].toRadixString(16).padLeft(2, '0')+data[0].toRadixString(16).padLeft(2, '0')+data[0].toRadixString(16).padLeft(2, '0');
  return f.toString();
}
class VideoPlay extends StatefulWidget {
  File file;
  VideoPlay({required this.file});
  @override
  _VideoPlayState createState() => _VideoPlayState();
}

class _VideoPlayState extends State<VideoPlay> {
  late VideoPlayerController _controller;

  @override
  void initState() {
    super.initState();
    _controller = VideoPlayerController.file(widget.file)
      ..initialize().then((_) {
        // Ensure the first frame is shown after the video is initialized, even before the play button has been pressed.
        setState(() {
          _controller.setVolume(0);
          _controller.play();
          _controller.setLooping(true);
        });
      });
  }

  @override
  Widget build(BuildContext context) {
    return Center(
      child: _controller.value.isInitialized
          ? VideoPlayer(_controller)
          : Container(),
    );
  }

  @override
  void dispose() {
    super.dispose();
    _controller.dispose();
  }
}



class AllFileFolderActivitySaveTestUIUX extends StatefulWidget {
  List<String> folderStack = ["root"];
  String currentFolderName = "";
  FirebaseFirestore customerFirestore;
  String id;

  AllFileFolderActivitySaveTestUIUX({required this.id,required this.customerFirestore,});

  @override
  _AllFileFolderActivitySaveTestUIUXState createState() => _AllFileFolderActivitySaveTestUIUXState();
}

class _AllFileFolderActivitySaveTestUIUXState extends State<AllFileFolderActivitySaveTestUIUX> {
  fileSortType selectedSortType = fileSortType.none;

  @override
  Widget build(BuildContext context) {
    SimpleDialog dialog = SimpleDialog(children: [
      Center(child: Text('Create a Folder')),
      Padding(
        padding: const EdgeInsets.all(8.0),
        child: TextField(
          controller: _folderNameController,
        ),
      ),
      InkWell(
        onTap: () async{
          AppFirestore(firestore: widget.customerFirestore, projectId: '', auth: FirebaseAuth.instance).createFolders(name:_folderNameController.text,parent: widget.folderStack.last );
          //  Navigator.pop(context);
          _folderNameController.clear();

// Close progress dialog
          final dialogContextCompleter = Completer<BuildContext>();
          final dialogContext = await dialogContextCompleter.future;
          Navigator.pop(dialogContext);
        },
        child: Card(
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(0.0),
          ),
          color: Theme.of(context).primaryColor,
          child: Container(
              child: Padding(
                padding: const EdgeInsets.all(8.0),
                child: Center(
                    child: Text(
                      "Create",
                      style: TextStyle(color: Colors.white),
                    )),
              )),
        ),
      )
    ]);
    double screenWidth = MediaQuery.of(context).size.width;
    var bottomNav = Wrap(
      children: [
        Container(
          //margin: EdgeInsets.only(top: height*0.008),
          height: height*0.001,
          width: double.infinity,
          color: ThemeManager().getBlackColor.withOpacity(.15),
        ),
        Container(height:  (height * 0.075)- height*0.001,
          child: Center(
            child: Row(children:[
              Expanded(child: InkWell(onTap: (){
                Navigator.pop(context);
                Navigator.pop(context);
                Navigator.pop(context);
                CustomerHomePageLogic().tabChangedStream.dataReload(0);
              },
                child: Center(child: Container(
                    padding: EdgeInsets.only(right: screenWidth * 0.06),
                    child: SvgPicture.asset(
                      "assets/svg/homeIcon.svg",
                      color: ThemeManager().getDarkGrey3Color,
                      width: screenWidth * 0.028,
                      height: screenWidth * 0.06,
                    )),),
              )),
              Expanded(child: InkWell(onTap: (){
                Navigator.pop(context);
                Navigator.pop(context);
                Navigator.pop(context);
                CustomerHomePageLogic().tabChangedStream.dataReload(1);
              },
                child: Center(child: Container(
                    padding: EdgeInsets.only(right: screenWidth * 0.06),
                    child: SvgPicture.asset(
                      "assets/svg/strokeIcon.svg",
                      color: ThemeManager().getDarkGreenColor,
                      width: screenWidth * 0.028,
                      height: screenWidth * 0.06,
                    )),),
              )),
              Expanded(child: InkWell(onTap: (){
                Navigator.pop(context);
                Navigator.pop(context);
                Navigator.pop(context);
                CustomerHomePageLogic().tabChangedStream.dataReload(2);
              },
                child: Center(child: Container(
                    padding: EdgeInsets.only(right: screenWidth * 0.06),
                    child: SvgPicture.asset(
                      "assets/svg/chartIcon.svg",
                      color: ThemeManager().getDarkGrey3Color,
                      width: screenWidth * 0.028,
                      height: screenWidth * 0.06,
                    )),),
              )),
              Expanded(child: InkWell(onTap: (){
                Navigator.pop(context);
                Navigator.pop(context);
                Navigator.pop(context);
                CustomerHomePageLogic().tabChangedStream.dataReload(3);
              },
                child: Center(child: Container(
                    padding: EdgeInsets.only(right: screenWidth * 0.06),
                    child: SvgPicture.asset(
                      "assets/svg/vectorIcon.svg",
                      color: ThemeManager().getDarkGrey3Color,
                      width: screenWidth * 0.028,
                      height: screenWidth * 0.06,
                    )),),
              )),
            ],),
          ),
        ),
      ],
    );
    return SafeArea(child: Scaffold(

      // floatingActionButton: FloatingActionButton(
      //   onPressed: () {
      //   runTest();
      //   },
      //   child: widget.shouldCollect?Text((widget.testDuration - widget.start).toString()):Icon(Icons.group_work_sharp),
      // ),
      // appBar: AppBar(
      //   title: Text(widget.duration.toString() +
      //       " second | " +
      //       widget.targetLoad.toString() +
      //       " kN"),
      //   actions: <Widget>[
      //
      //
      //
      //     StreamBuilder<bool>(
      //       stream: TestStartStopStream.getInstance().outData,
      //       initialData: false,
      //       builder: (c, snapshot) {
      //         if(snapshot.hasData && snapshot.data == true){
      //           return  Padding(
      //             padding: const EdgeInsets.all(8.0),
      //             child: InkWell(
      //
      //               //  onPressed: onPressed,
      //                 onTap: () async {
      //                   TestStartStopStream.getInstance().dataReload(false);
      //                 },
      //                 child: Icon(Icons.stop)),
      //           );
      //         }else{
      //           return Container(width: 0,height: 0,);
      //         }
      //       },
      //     )
      //   ],
      // ),

      //widget.data2.length > 0 && widget.shouldCollect == false
        body: Stack(
          children: [
            Scaffold(  backgroundColor: ThemeManager().getWhiteColor,

              //-------------------------App bar of screen-------------------
              appBar: PreferredSize(
                preferredSize: Size(0,kToolbarHeight),
                child: AppBarCustom(appbarTitle: "Select Folder",),
              ),
              body: Container(
                margin: EdgeInsets.only(
                    //left: 0,right: width*0.05,
                    top: height*0.025),
                child: Column(

                  mainAxisAlignment: MainAxisAlignment.start,
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Container(
                      margin: EdgeInsets.only(left: width * 0.03),
                      child: Text(
                        "Browse",
                        style: interMedium.copyWith(
                            color: ThemeManager().getLightGrey1Color,
                            fontSize: width * 0.04),
                      ),
                    ),
                    // Stack(
                    //   children: [
                    //     Align(
                    //       alignment: Alignment.centerLeft,
                    //       child: widget.folderStack.length > 1
                    //           ? Row(
                    //               mainAxisAlignment: MainAxisAlignment.start,
                    //               crossAxisAlignment: CrossAxisAlignment.center,
                    //               children: [
                    //                 Card(
                    //                   child: InkWell(
                    //                       onTap: () {
                    //                         setState(() {
                    //                           widget.folderStack.removeLast();
                    //                         });
                    //                       },
                    //                       child: Padding(
                    //                         padding: const EdgeInsets.all(8.0),
                    //                         child: Icon(Icons.chevron_left_outlined),
                    //                       )),
                    //                 ),
                    //                 Padding(
                    //                   padding: const EdgeInsets.all(8.0),
                    //                   child: Text(
                    //                     widget.currentFolderName,
                    //                     style:
                    //                         TextStyle(color: Colors.black, fontSize: 20),
                    //                   ),
                    //                 )
                    //               ],
                    //             )
                    //           : Container(
                    //               width: 0,
                    //               height: 0,
                    //             ),
                    //     ),
                    //     Align(
                    //       alignment: Alignment.centerRight,
                    //       child: Wrap(
                    //         children: [
                    //           Card(
                    //             child: InkWell(
                    //               onTap: () {
                    //                 showDialog<void>(
                    //                     context: context, builder: (context) => dialog);
                    //               },
                    //               child: Padding(
                    //                 padding: const EdgeInsets.all(8.0),
                    //                 child: Icon(Icons.add),
                    //               ),
                    //             ),
                    //           ),
                    //           // Card(
                    //           //   child: InkWell(
                    //           //     onTap: () {
                    //           //       showDialog<void>(
                    //           //           context: context, builder: (context) => dialog);
                    //           //     },
                    //           //     child: Padding(
                    //           //       padding: const EdgeInsets.all(8.0),
                    //           //       child: Icon(Icons.sort),
                    //           //     ),
                    //           //   ),
                    //           // ),
                    //           Container(
                    //             width: 50,
                    //             height: 50,
                    //             child: Card(
                    //               child: PopupMenuButton<fileSortType>(
                    //                 onSelected: (fileSortType value) {
                    //                   setState(() {
                    //                     selectedSortType = value;
                    //                   });
                    //                 },
                    //                 initialValue: selectedSortType,
                    //                 child: Center(child: Icon(Icons.sort)),
                    //                 itemBuilder: (BuildContext context) =>
                    //                     <PopupMenuEntry<fileSortType>>[
                    //                   PopupMenuItem<fileSortType>(
                    //                     value: fileSortType.none,
                    //                     child: Text('None'),
                    //                   ),
                    //                   PopupMenuItem<fileSortType>(
                    //                     value: fileSortType.title,
                    //                     child: Text('Title'),
                    //                   ),
                    //                   PopupMenuItem<fileSortType>(
                    //                     value: fileSortType.date,
                    //                     child: Text('Date'),
                    //                   ),
                    //                 ],
                    //               ),
                    //             ),
                    //           ),
                    //         ],
                    //       ),
                    //     ),
                    //   ],
                    // ),
                    // Divider(),
                    Padding(padding: EdgeInsets.fromLTRB(0,10, 0, 0),child: showNextLevelFolderForSavingTest(widget.folderStack.last,widget.id),),
                    // showTestItemsInFolderForTestSave(widget.folderStack.last),
                    // StreamBuilder<QuerySnapshot>(
                    //   stream: AppFirestore(firestore: widget.customerFirestore,projectId: "",auth: FirebaseAuth.instance).getFolders(parentFolder: widget.folderStack.last),
                    //
                    //     builder: (context, snapshot) {
                    //
                    //         if (snapshot.hasData && snapshot.data!.docs.length>0) {
                    //           //List list = snapshot.data.docs;
                    //           List<QueryDocumentSnapshot<Object?>> sortedList = [];
                    //
                    //           if (selectedSortType == fileSortType.none) {
                    //             sortedList = snapshot.data!.docs;
                    //           }
                    //           if (selectedSortType == fileSortType.title) {
                    //             sortedList = snapshot.data!.docs;
                    //            try{
                    //              sortedList.sort((a, b) {
                    //                return a
                    //                    .get("name")
                    //                    .toString()
                    //                    .toLowerCase()
                    //                    .compareTo(b.get("name").toString().toLowerCase());
                    //              });
                    //            }catch(e){
                    //              print("exception on sorting by title");
                    //              print(e);
                    //            }
                    //           }
                    //           if (selectedSortType == fileSortType.date) {
                    //             sortedList = snapshot.data!.docs;
                    //           try{
                    //             sortedList.sort((a, b) {
                    //               return a
                    //                   .get("created_at")
                    //                   .toString()
                    //                   .toLowerCase()
                    //                   .compareTo(
                    //                   b.get("created_at").toString().toLowerCase());
                    //             });
                    //           }catch(e){
                    //             print("exception on sorting by date");
                    //             print(e);
                    //           }
                    //             sortedList = sortedList.reversed.toList();
                    //           }
                    //           return ListView.builder(
                    //               physics: ClampingScrollPhysics(),
                    //               // separatorBuilder: (context, index) {
                    //               //   return Divider();
                    //               // },
                    //               shrinkWrap: true,
                    //               padding: EdgeInsets.zero,
                    //               itemCount: sortedList.length,
                    //               itemBuilder: (_, index) {
                    //                 return Container(
                    //                   width: MediaQuery.of(context).size.width,
                    //                   child: InkWell(
                    //                     onTap: () {
                    //                       // setState(() {
                    //                       //   widget.currentFolderName =
                    //                       //       sortedList[index]["name"];
                    //                       //   widget.folderStack.add(sortedList[index].id);
                    //                       // });
                    //                     },
                    //                     child: Padding(
                    //                       padding: const EdgeInsets.fromLTRB(0, 2, 0, 2),
                    //                       child: Wrap(
                    //                         children: [
                    //                           Container(
                    //                             height: 50,
                    //                             width: MediaQuery.of(context).size.width,
                    //                             child: Stack(
                    //                               children: [
                    //                                 Align(
                    //                                   alignment: Alignment.centerLeft,
                    //                                   child: Row(
                    //                                     children: [
                    //                                       GestureDetector(
                    //                                         onTap: () {
                    //                                           // setState(() {
                    //                                           //   newFolder.isExpanded = !(newFolder.isExpanded);
                    //                                           //   newFolder.isVisible = !newFolder.isVisible;
                    //                                           // });
                    //                                         },
                    //                                         //newFolder.isExpanded == fals
                    //                                         child: true
                    //                                             ? Icon(
                    //                                           Icons.keyboard_arrow_up_outlined,
                    //                                           size: width * 0.085,
                    //                                           color: ThemeManager().getDarkGrey2Color,
                    //                                         )
                    //                                             : Icon(
                    //                                           Icons.keyboard_arrow_down_outlined,
                    //                                           size: width * 0.085,
                    //                                           color: ThemeManager().getDarkGrey2Color,
                    //                                         ),
                    //                                       ),
                    //                                       Container(
                    //                                         margin: EdgeInsets.only(
                    //                                           left: width * 0.02,
                    //                                         ),
                    //                                         child: SvgPicture.asset(
                    //                                           ("assets/svg/folderIcon.svg"),
                    //                                           fit: BoxFit.cover,
                    //                                         ),
                    //                                       ),
                    //                                       Column(
                    //                                         mainAxisAlignment:
                    //                                             MainAxisAlignment.center,
                    //                                         crossAxisAlignment:
                    //                                             CrossAxisAlignment.start,
                    //                                         children: [
                    //                                           Text(
                    //                                             sortedList[index]["name"]
                    //                                                 .toString(),
                    //                                             style: TextStyle(
                    //                                                 fontWeight:
                    //                                                     FontWeight.bold,
                    //                                                 color: Colors.black),
                    //                                           ),
                    //                                           timeFormate(sortedList[index]
                    //                                               ["created_at"]),
                    //                                         ],
                    //                                       ),
                    //                                     ],
                    //                                   ),
                    //                                 ),
                    //                                 Align(
                    //                                   alignment: Alignment.centerRight,
                    //                                   child: Container(
                    //                                     height: MediaQuery.of(context)
                    //                                         .size
                    //                                         .height,
                    //                                     width: 50,
                    //                                     child: PopupMenuButton<folderAction>(
                    //                                       onSelected: (folderAction value) {
                    //                                         if (value ==
                    //                                             folderAction.rename) {
                    //                                           //rename folder
                    //                                           TextEditingController
                    //                                               controller =
                    //                                               TextEditingController(
                    //                                                   text: sortedList[index]
                    //                                                           ["name"]
                    //                                                       .toString());
                    //
                    //                                           Navigator.of(context)
                    //                                               .push(
                    //                                                   new MaterialPageRoute<
                    //                                                           Null>(
                    //                                                       builder:
                    //                                                           (BuildContext
                    //                                                               context) {
                    //                                                         return Scaffold(
                    //                                                           appBar: AppBar(
                    //                                                             title: Text(
                    //                                                                 "Rename Folder"),
                    //                                                           ),
                    //                                                           body: Container(
                    //                                                             decoration:
                    //                                                                 BoxDecoration(
                    //                                                               color: Color
                    //                                                                   .fromARGB(
                    //                                                                       255,
                    //                                                                       247,
                    //                                                                       247,
                    //                                                                       247),
                    //                                                               borderRadius: BorderRadius.only(
                    //                                                                   topLeft:
                    //                                                                       Radius.circular(
                    //                                                                           10.0),
                    //                                                                   topRight:
                    //                                                                       Radius.circular(10.0)),
                    //                                                             ),
                    //                                                             child:
                    //                                                                 Padding(
                    //                                                               padding: const EdgeInsets
                    //                                                                       .all(
                    //                                                                   15.0),
                    //                                                               child: Wrap(
                    //                                                                 children: [
                    //                                                                   Padding(
                    //                                                                     padding:
                    //                                                                         const EdgeInsets.all(8.0),
                    //                                                                     child:
                    //                                                                         TextFormField(
                    //                                                                       controller:
                    //                                                                           controller,
                    //                                                                       autofocus:
                    //                                                                           true,
                    //                                                                       decoration:
                    //                                                                           InputDecoration(
                    //                                                                         labelText: 'Folder Name',
                    //                                                                         border: OutlineInputBorder(),
                    //                                                                       ),
                    //                                                                     ),
                    //                                                                   ),
                    //                                                                   InkWell(
                    //                                                                     onTap:
                    //                                                                         () {
                    //                                                                       widget.customerFirestore.collection("folders").doc(sortedList[index].id).update({
                    //                                                                         "name": controller.text
                    //                                                                       }).then((value) {
                    //                                                                         Navigator.pop(context);
                    //                                                                       });
                    //                                                                     },
                    //                                                                     child:
                    //                                                                         Card(
                    //                                                                       color:
                    //                                                                           Theme.of(context).primaryColor,
                    //                                                                       child: Center(
                    //                                                                           child: Padding(
                    //                                                                         padding: const EdgeInsets.all(10.0),
                    //                                                                         child: Text(
                    //                                                                           "Submit",
                    //                                                                           style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold),
                    //                                                                         ),
                    //                                                                       )),
                    //                                                                     ),
                    //                                                                   )
                    //                                                                 ],
                    //                                                               ),
                    //                                                             ),
                    //                                                           ),
                    //                                                         );
                    //                                                       },
                    //                                                       fullscreenDialog:
                    //                                                           true));
                    //                                         }
                    //                                         if (value ==
                    //                                             folderAction.delete) {
                    //                                           //rename folder
                    //                                           showModalBottomSheet(
                    //                                               context: context,
                    //                                               builder: (builder) {
                    //                                                 return new Wrap(
                    //                                                   children: [
                    //                                                     Padding(
                    //                                                       padding:
                    //                                                           const EdgeInsets
                    //                                                               .all(8.0),
                    //                                                       child: Text(
                    //                                                         "Do you want to delete this Folder?",
                    //                                                         style: TextStyle(
                    //                                                             fontSize: 20,
                    //                                                             color: Theme.of(
                    //                                                                     context)
                    //                                                                 .primaryColor),
                    //                                                       ),
                    //                                                     ),
                    //                                                     Row(
                    //                                                       children: [
                    //                                                         Expanded(
                    //                                                             child:
                    //                                                                 InkWell(
                    //                                                           onTap: () {
                    //                                                             Navigator.of(
                    //                                                                     context)
                    //                                                                 .pop();
                    //                                                           },
                    //                                                           child: Padding(
                    //                                                             padding:
                    //                                                                 const EdgeInsets
                    //                                                                         .all(
                    //                                                                     8.0),
                    //                                                             child: Card(
                    //                                                               elevation:
                    //                                                                   8,
                    //                                                               color: Colors
                    //                                                                   .grey,
                    //                                                               child: Center(
                    //                                                                   child: Padding(
                    //                                                                 padding: const EdgeInsets
                    //                                                                         .all(
                    //                                                                     15.0),
                    //                                                                 child:
                    //                                                                     Text(
                    //                                                                   "Cancel",
                    //                                                                   style: TextStyle(
                    //                                                                       color:
                    //                                                                           Colors.white,
                    //                                                                       fontWeight: FontWeight.bold),
                    //                                                                 ),
                    //                                                               )),
                    //                                                             ),
                    //                                                           ),
                    //                                                         )),
                    //                                                         Expanded(
                    //                                                             child:
                    //                                                                 InkWell(
                    //                                                           onTap: () {
                    //                                                             widget
                    //                                                                 .customerFirestore
                    //                                                                 .collection(
                    //                                                                     "folders")
                    //                                                                 .doc(sortedList[
                    //                                                                         index]
                    //                                                                     .id)
                    //                                                                 .delete()
                    //                                                                 .then(
                    //                                                                     (value) {
                    //                                                               Navigator.pop(
                    //                                                                   context);
                    //                                                             });
                    //                                                           },
                    //                                                           child: Padding(
                    //                                                             padding:
                    //                                                                 const EdgeInsets
                    //                                                                         .all(
                    //                                                                     8.0),
                    //                                                             child: Card(
                    //                                                               elevation:
                    //                                                                   8,
                    //                                                               color: Theme.of(
                    //                                                                       context)
                    //                                                                   .primaryColor,
                    //                                                               child: Center(
                    //                                                                   child: Padding(
                    //                                                                 padding: const EdgeInsets
                    //                                                                         .all(
                    //                                                                     15.0),
                    //                                                                 child:
                    //                                                                     Text(
                    //                                                                   "Delete",
                    //                                                                   style: TextStyle(
                    //                                                                       color:
                    //                                                                           Colors.white,
                    //                                                                       fontWeight: FontWeight.bold),
                    //                                                                 ),
                    //                                                               )),
                    //                                                             ),
                    //                                                           ),
                    //                                                         )),
                    //                                                       ],
                    //                                                     ),
                    //                                                   ],
                    //                                                 );
                    //                                               });
                    //                                         }
                    //
                    //                                         if (value == folderAction.move) {
                    //                                           //rename folder
                    //                                           showModalBottomSheet(
                    //                                               context: context,
                    //                                               builder: (builder) {
                    //                                                 return new Wrap(
                    //                                                   children: [
                    //                                                     ListTile(
                    //                                                       title: Text(
                    //                                                         "Move Folder",
                    //                                                         style: TextStyle(
                    //                                                             fontSize: 20,
                    //                                                             color: Theme.of(
                    //                                                                     context)
                    //                                                                 .primaryColor),
                    //                                                       ),
                    //                                                       trailing: Padding(
                    //                                                         padding:
                    //                                                             const EdgeInsets
                    //                                                                 .all(8.0),
                    //                                                         child: InkWell(
                    //                                                           onTap: () {
                    //                                                             Navigator.of(
                    //                                                                     context)
                    //                                                                 .pop();
                    //                                                           },
                    //                                                           child: Icon(
                    //                                                               Icons
                    //                                                                   .close),
                    //                                                         ),
                    //                                                       ),
                    //                                                     ),
                    //                                                     Padding(
                    //                                                       padding:
                    //                                                           const EdgeInsets
                    //                                                               .all(8.0),
                    //                                                       child: Text(
                    //                                                         "Move Folder",
                    //                                                         style: TextStyle(
                    //                                                             fontSize: 20,
                    //                                                             color: Theme.of(
                    //                                                                     context)
                    //                                                                 .primaryColor),
                    //                                                       ),
                    //                                                     ),
                    //
                    //                                                     MoveFolderActivity(
                    //                                                       customerId: widget
                    //                                                           .customerId,
                    //                                                       customerFirestore:
                    //                                                           widget
                    //                                                               .customerFirestore,
                    //                                                       curentFolderID:
                    //                                                           sortedList[
                    //                                                                   index]
                    //                                                               .id,locale: widget.locale,
                    //                                                     ),
                    //                                                     //here show move folder target
                    //                                                   ],
                    //                                                 );
                    //                                               });
                    //                                         }
                    //                                       },
                    //                                       child:
                    //                                           Center(child: Icon(Icons.more_horiz)),
                    //                                       itemBuilder: (BuildContext
                    //                                               context) =>
                    //                                           <PopupMenuEntry<folderAction>>[
                    //                                         PopupMenuItem<folderAction>(
                    //                                           value: folderAction.rename,
                    //                                           child: Text('Rename'),
                    //                                         ),
                    //                                         PopupMenuItem<folderAction>(
                    //                                           value: folderAction.delete,
                    //                                           child: Text('Delete'),
                    //                                         ),
                    //                                         PopupMenuItem<folderAction>(
                    //                                           value: folderAction.move,
                    //                                           child: Text('Move'),
                    //                                         ),
                    //                                       ],
                    //                                     ),
                    //                                   ),
                    //                                 ),
                    //                               ],
                    //                             ),
                    //                           ),
                    //                           Container(
                    //
                    //                             width: MediaQuery.of(context).size.width,
                    //                             child:showNextLevelFolder(snapshot.data!.docs[index],),)
                    //
                    //                         ],
                    //                       ),
                    //                     ),
                    //                   ),
                    //                 );
                    //
                    //               });
                    //         } else
                    //           return Container(
                    //               height: 000, child: Center(child: Text("No Folders")));
                    //
                    //     }),

                  ],
                ),
              ),
            ),
            Align(alignment: Alignment.bottomCenter,child: AppBottomNavigationar(context: context).getNavigationBar(level: 0),),
          ],
        )));


  }

  showNextLevelFolder(String data) {
    int step = 0;

    return StreamBuilder<QuerySnapshot>(
        stream: AppFirestore(firestore: widget.customerFirestore,projectId: "",auth: FirebaseAuth.instance).getFolders(parentFolder: data),
        builder: (context, snapshot) {
          if (snapshot.hasData && snapshot.data!.docs.length>0) {
            step++;
            return   ListView.builder(
                physics: ClampingScrollPhysics(),
                // separatorBuilder: (context, index) {
                //   return Divider();
                // },
                shrinkWrap: true,
                padding: EdgeInsets.zero,
                itemCount: snapshot.data!.docs.length,
                itemBuilder: (_, index) {

                  return   Padding(
                    padding:  EdgeInsets.fromLTRB((step* 30), 2, 0, 2),
                    child: Column(
                      children: [
                        Stack(
                          children: [
                            Align(alignment: Alignment.centerLeft,child: Padding(
                              padding:  EdgeInsets.fromLTRB(0, 0, 0, 0),
                              child: Column(
                                children: [
                                  Row(
                                    children: [
                                      GestureDetector(
                                        onTap: () {
                                          // setState(() {
                                          //   newFolder.isExpanded = !(newFolder.isExpanded);
                                          //   newFolder.isVisible = !newFolder.isVisible;
                                          // });
                                        },
                                        //newFolder.isExpanded == fals
                                        child: false
                                            ? Icon(
                                          Icons.keyboard_arrow_up_outlined,
                                          size: width * 0.085,
                                          color: ThemeManager().getDarkGrey2Color,
                                        )
                                            : Icon(
                                          Icons.keyboard_arrow_down_outlined,
                                          size: width * 0.085,
                                          color: ThemeManager().getDarkGrey2Color,
                                        ),
                                      ),
                                      Container(
                                        margin: EdgeInsets.only(
                                          left: width * 0.02,
                                        ),
                                        child: SvgPicture.asset(
                                          ("assets/svg/folderIcon.svg"),
                                          fit: BoxFit.cover,
                                        ),
                                      ),
                                      Container(
                                          margin: EdgeInsets.only(
                                            left: width * 0.03,
                                          ),
                                          child: Text(
                                            snapshot.data!.docs[index]["name"],
                                            style: interRegular.copyWith(
                                              color: ThemeManager().getBlackColor,
                                              fontSize: width * 0.045,
                                            ),
                                          )),

                                      // Container(
                                      // //  height: 50,
                                      //   width: MediaQuery.of(context).size.width,
                                      //   child: Stack(
                                      //     children: [
                                      //       Align(
                                      //         alignment: Alignment.centerLeft,
                                      //         child: Row(
                                      //           children: [
                                      //             GestureDetector(
                                      //               onTap: () {
                                      //                 // setState(() {
                                      //                 //   newFolder.isExpanded = !(newFolder.isExpanded);
                                      //                 //   newFolder.isVisible = !newFolder.isVisible;
                                      //                 // });
                                      //               },
                                      //               //newFolder.isExpanded == fals
                                      //               child: false
                                      //                   ? Icon(
                                      //                 Icons.keyboard_arrow_up_outlined,
                                      //                 size: width * 0.085,
                                      //                 color: ThemeManager().getDarkGrey2Color,
                                      //               )
                                      //                   : Icon(
                                      //                 Icons.keyboard_arrow_down_outlined,
                                      //                 size: width * 0.085,
                                      //                 color: ThemeManager().getDarkGrey2Color,
                                      //               ),
                                      //             ),
                                      //             Container(
                                      //               margin: EdgeInsets.only(
                                      //                 left: width * 0.02,
                                      //               ),
                                      //               child: SvgPicture.asset(
                                      //                 ("assets/svg/folderIcon.svg"),
                                      //                 fit: BoxFit.cover,
                                      //               ),
                                      //             ),
                                      //             Container(
                                      //                 margin: EdgeInsets.only(
                                      //                   left: width * 0.03,
                                      //                 ),
                                      //                 child: Text(
                                      //                   snapshot.data!.docs[index]["name"],
                                      //                   style: interRegular.copyWith(
                                      //                     color: ThemeManager().getBlackColor,
                                      //                     fontSize: width * 0.045,
                                      //                   ),
                                      //                 ))
                                      //             // Column(
                                      //             //   mainAxisAlignment:
                                      //             //   MainAxisAlignment.center,
                                      //             //   crossAxisAlignment:
                                      //             //   CrossAxisAlignment.start,
                                      //             //   children: [
                                      //             //
                                      //             //     Text(
                                      //             //       snapshot.data!.docs[index]["name"]
                                      //             //           .toString(),
                                      //             //       style: TextStyle(
                                      //             //           fontWeight:
                                      //             //           FontWeight.bold,
                                      //             //           color: Colors.black),
                                      //             //     ),
                                      //             //     timeFormate(snapshot.data!.docs[index]["created_at"]),
                                      //             //   ],
                                      //             // ),
                                      //           ],
                                      //         ),
                                      //       ),
                                      //       Align(
                                      //         alignment: Alignment.centerRight,
                                      //         child: Container(
                                      //           height: MediaQuery.of(context)
                                      //               .size
                                      //               .height,
                                      //           width: 50,
                                      //           child: PopupMenuButton<folderAction>(
                                      //             onSelected: (folderAction value) {
                                      //               if (value ==
                                      //                   folderAction.rename) {
                                      //                 //rename folder
                                      //                 TextEditingController
                                      //                 controller =
                                      //                 TextEditingController(
                                      //                     text: snapshot.data!.docs[index]
                                      //                     ["name"]
                                      //                         .toString());
                                      //
                                      //                 Navigator.of(context)
                                      //                     .push(
                                      //                     new MaterialPageRoute<
                                      //                         Null>(
                                      //                         builder:
                                      //                             (BuildContext
                                      //                         context) {
                                      //                           return Scaffold(
                                      //                             appBar: AppBar(
                                      //                               title: Text(
                                      //                                   "Rename Folder"),
                                      //                             ),
                                      //                             body: Container(
                                      //                               decoration:
                                      //                               BoxDecoration(
                                      //                                 color: Color
                                      //                                     .fromARGB(
                                      //                                     255,
                                      //                                     247,
                                      //                                     247,
                                      //                                     247),
                                      //                                 borderRadius: BorderRadius.only(
                                      //                                     topLeft:
                                      //                                     Radius.circular(
                                      //                                         10.0),
                                      //                                     topRight:
                                      //                                     Radius.circular(10.0)),
                                      //                               ),
                                      //                               child:
                                      //                               Padding(
                                      //                                 padding: const EdgeInsets
                                      //                                     .all(
                                      //                                     15.0),
                                      //                                 child: Wrap(
                                      //                                   children: [
                                      //                                     Padding(
                                      //                                       padding:
                                      //                                       const EdgeInsets.all(8.0),
                                      //                                       child:
                                      //                                       TextFormField(
                                      //                                         controller:
                                      //                                         controller,
                                      //                                         autofocus:
                                      //                                         true,
                                      //                                         decoration:
                                      //                                         InputDecoration(
                                      //                                           labelText: 'Folder Name',
                                      //                                           border: OutlineInputBorder(),
                                      //                                         ),
                                      //                                       ),
                                      //                                     ),
                                      //                                     InkWell(
                                      //                                       onTap:
                                      //                                           () {
                                      //                                         widget.customerFirestore.collection("folders").doc(snapshot.data!.docs[index].id).update({
                                      //                                           "name": controller.text
                                      //                                         }).then((value) {
                                      //                                           Navigator.pop(context);
                                      //                                         });
                                      //                                       },
                                      //                                       child:
                                      //                                       Card(
                                      //                                         color:
                                      //                                         Theme.of(context).primaryColor,
                                      //                                         child: Center(
                                      //                                             child: Padding(
                                      //                                               padding: const EdgeInsets.all(10.0),
                                      //                                               child: Text(
                                      //                                                 "Submit",
                                      //                                                 style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold),
                                      //                                               ),
                                      //                                             )),
                                      //                                       ),
                                      //                                     )
                                      //                                   ],
                                      //                                 ),
                                      //                               ),
                                      //                             ),
                                      //                           );
                                      //                         },
                                      //                         fullscreenDialog:
                                      //                         true));
                                      //               }
                                      //               if (value ==
                                      //                   folderAction.delete) {
                                      //                 //rename folder
                                      //                 showModalBottomSheet(
                                      //                     context: context,
                                      //                     builder: (builder) {
                                      //                       return new Wrap(
                                      //                         children: [
                                      //                           Padding(
                                      //                             padding:
                                      //                             const EdgeInsets
                                      //                                 .all(8.0),
                                      //                             child: Text(
                                      //                               "Do you want to delete this Folder?",
                                      //                               style: TextStyle(
                                      //                                   fontSize: 20,
                                      //                                   color: Theme.of(
                                      //                                       context)
                                      //                                       .primaryColor),
                                      //                             ),
                                      //                           ),
                                      //                           Row(
                                      //                             children: [
                                      //                               Expanded(
                                      //                                   child:
                                      //                                   InkWell(
                                      //                                     onTap: () {
                                      //                                       Navigator.of(
                                      //                                           context)
                                      //                                           .pop();
                                      //                                     },
                                      //                                     child: Padding(
                                      //                                       padding:
                                      //                                       const EdgeInsets
                                      //                                           .all(
                                      //                                           8.0),
                                      //                                       child: Card(
                                      //                                         elevation:
                                      //                                         8,
                                      //                                         color: Colors
                                      //                                             .grey,
                                      //                                         child: Center(
                                      //                                             child: Padding(
                                      //                                               padding: const EdgeInsets
                                      //                                                   .all(
                                      //                                                   15.0),
                                      //                                               child:
                                      //                                               Text(
                                      //                                                 "Cancel",
                                      //                                                 style: TextStyle(
                                      //                                                     color:
                                      //                                                     Colors.white,
                                      //                                                     fontWeight: FontWeight.bold),
                                      //                                               ),
                                      //                                             )),
                                      //                                       ),
                                      //                                     ),
                                      //                                   )),
                                      //                               Expanded(
                                      //                                   child:
                                      //                                   InkWell(
                                      //                                     onTap: () {
                                      //                                       widget
                                      //                                           .customerFirestore
                                      //                                           .collection(
                                      //                                           "folders")
                                      //                                           .doc(snapshot.data!.docs[index].id)
                                      //                                           .delete()
                                      //                                           .then(
                                      //                                               (value) {
                                      //                                             Navigator.pop(
                                      //                                                 context);
                                      //                                           });
                                      //                                     },
                                      //                                     child: Padding(
                                      //                                       padding:
                                      //                                       const EdgeInsets
                                      //                                           .all(
                                      //                                           8.0),
                                      //                                       child: Card(
                                      //                                         elevation:
                                      //                                         8,
                                      //                                         color: Theme.of(
                                      //                                             context)
                                      //                                             .primaryColor,
                                      //                                         child: Center(
                                      //                                             child: Padding(
                                      //                                               padding: const EdgeInsets
                                      //                                                   .all(
                                      //                                                   15.0),
                                      //                                               child:
                                      //                                               Text(
                                      //                                                 "Delete",
                                      //                                                 style: TextStyle(
                                      //                                                     color:
                                      //                                                     Colors.white,
                                      //                                                     fontWeight: FontWeight.bold),
                                      //                                               ),
                                      //                                             )),
                                      //                                       ),
                                      //                                     ),
                                      //                                   )),
                                      //                             ],
                                      //                           ),
                                      //                         ],
                                      //                       );
                                      //                     });
                                      //               }
                                      //
                                      //               if (value == folderAction.move) {
                                      //                 //rename folder
                                      //                 showModalBottomSheet(
                                      //                     context: context,
                                      //                     builder: (builder) {
                                      //                       return new Wrap(
                                      //                         children: [
                                      //                           ListTile(
                                      //                             title: Text(
                                      //                               "Move Folder",
                                      //                               style: TextStyle(
                                      //                                   fontSize: 20,
                                      //                                   color: Theme.of(
                                      //                                       context)
                                      //                                       .primaryColor),
                                      //                             ),
                                      //                             trailing: Padding(
                                      //                               padding:
                                      //                               const EdgeInsets
                                      //                                   .all(8.0),
                                      //                               child: InkWell(
                                      //                                 onTap: () {
                                      //                                   Navigator.of(
                                      //                                       context)
                                      //                                       .pop();
                                      //                                 },
                                      //                                 child: Icon(
                                      //                                     Icons
                                      //                                         .close),
                                      //                               ),
                                      //                             ),
                                      //                           ),
                                      //                           Padding(
                                      //                             padding:
                                      //                             const EdgeInsets
                                      //                                 .all(8.0),
                                      //                             child: Text(
                                      //                               "Move Folder",
                                      //                               style: TextStyle(
                                      //                                   fontSize: 20,
                                      //                                   color: Theme.of(
                                      //                                       context)
                                      //                                       .primaryColor),
                                      //                             ),
                                      //                           ),
                                      //
                                      //                           MoveFolderActivity(
                                      //                             customerId: widget
                                      //                                 .customerId,
                                      //                             customerFirestore:
                                      //                             widget
                                      //                                 .customerFirestore,
                                      //                             curentFolderID:snapshot.data!.docs[index].id,locale: widget.locale,
                                      //                           ),
                                      //                           //here show move folder target
                                      //                         ],
                                      //                       );
                                      //                     });
                                      //               }
                                      //             },
                                      //             child:
                                      //             Center(child: Icon(Icons.menu)),
                                      //             itemBuilder: (BuildContext
                                      //             context) =>
                                      //             <PopupMenuEntry<folderAction>>[
                                      //               PopupMenuItem<folderAction>(
                                      //                 value: folderAction.rename,
                                      //                 child: Text('Rename'),
                                      //               ),
                                      //               PopupMenuItem<folderAction>(
                                      //                 value: folderAction.delete,
                                      //                 child: Text('Delete'),
                                      //               ),
                                      //               PopupMenuItem<folderAction>(
                                      //                 value: folderAction.move,
                                      //                 child: Text('Move'),
                                      //               ),
                                      //             ],
                                      //           ),
                                      //         ),
                                      //       ),
                                      //     ],
                                      //   ),
                                      // ),
                                      // Container(
                                      //
                                      //  // width: MediaQuery.of(context).size.width,
                                      //   child:showNextLevelFolder(snapshot.data!.docs[index].id),)

                                    ],
                                  ),

                                  showNextLevelFolder(snapshot.data!.docs[index].id),
                                  //showTestItemsInFolder(snapshot.data!.docs[index].id),

                                ],
                              ),
                            ),),
                            Align(alignment: Alignment.centerRight,child: addOrDeletePopMenuBox(snapshot.data!.docs[index].id),),
                          ],
                        ),
                        showTestItemsInFolder(snapshot.data!.docs[index].id),
                      ],
                    ),
                  );

                });


            return Text( snapshot.data!.docs.length.toString());
          }else return Container(width: 0,height: 0,);
        });
  }
  showNextLevelFolderForSavingTest(String data,String id) {
    int step = 0;

    return StreamBuilder<QuerySnapshot>(
        stream: AppFirestore(firestore: widget.customerFirestore,projectId: "",auth: FirebaseAuth.instance).getFolders(parentFolder: data),
        builder: (context, snapshot) {
          if (snapshot.hasData && snapshot.data!.docs.length>0) {
            step++;

            List<QueryDocumentSnapshot> filteredData = [];
            filteredData = snapshot.data!.docs;
            filteredData.sort((a, b) {
              return a
                  .get("name")
                  .toString()
                  .toLowerCase()
                  .compareTo(b.get("name").toString().toLowerCase());
            });
            double leftpa = width*0.06;


            return   ListView.separated(
                physics: ClampingScrollPhysics(),
                separatorBuilder: (context, index) {
                  return Divider();
                },
                shrinkWrap: true,
                padding: EdgeInsets.zero,
                itemCount: filteredData.length,
                itemBuilder: (_, index) {

                  return   Padding(
                    padding:  EdgeInsets.fromLTRB(0, 2, 0, 2),
                    child: Column(
                      children: [
                        Stack(
                          children: [
                            Align(alignment: Alignment.centerLeft,child: Padding(
                              padding:  EdgeInsets.fromLTRB((step*leftpa), 0, 0, 0),
                              child: Column(
                                children: [
                                  InkWell(onTap: (){
                                    //save here
                                    print("Should save in folder");

                                    widget.customerFirestore
                                        .collection("folders")
                                        .doc(filteredData[index].id)
                                        .collection("records")
                                        .add({
                                      "id":id,
                                      "created_at": new DateTime.now().millisecondsSinceEpoch,"created_by":FirebaseAuth.instance.currentUser!.uid,
                                    });

                                    widget.customerFirestore
                                        .collection("pulltest")
                                        .doc(id)
                                        .update({
                                      "folder":filteredData[index].id,
                                    });


                                    print("saved in folder");
                                    Future.delayed(Duration.zero, () {
                                      isTestRunning = false;

                                    if(true) try{
                                      //rob found

                                      Navigator.of(context).popUntil((route) => route.isFirst);
                                       CustomerHomePageLogic().tabChangedStream.dataReload(0);
                                       Future.delayed(Duration(seconds: 1)).then((value) {
                                         CustomerHomePageLogic().tabChangedStream.dataReload(1);
                                       });
                                      // CustomerHomePageLogic().tabChangedStream.dataReload(1);
                                      // CustomerHomePageLogic().connectedDevicesStream.dataReload(true);
                                     //   CustomerHomePageLogic().testRunningUniversalNotifier.dataReload(false);
                                     //   //  CustomerHomePageLogic().connectedDevicesStream.dataReload(true);
                                     //   Navigator.pop(context);
                                     //  // Navigator.pop(context);
                                     // //  Navigator.pop(context);
                                     //   CustomerHomePageLogic().connectedDevicesStream.dataReload(true);
                                     //  // Navigator.of(context).popUntil((route) => route.isFirst);
                                     //   Navigator.pop(context);
                                     //   CustomerHomePageLogic().connectedDevicesStream.dataReload(true);
                                     //   Navigator.pop(context);
                                     //   CustomerHomePageLogic().connectedDevicesStream.dataReload(true);
                                       print("success");
                                     }catch(e){
                                       print("Error on going home");
                                       print(e);
                                       // CustomerHomePageLogic().connectedDevicesStream.dataReload(true);
                                       // // Navigator.of(context).popUntil((route) => route.isFirst);
                                       // Navigator.pop(context);
                                       // CustomerHomePageLogic().connectedDevicesStream.dataReload(true);
                                       // Navigator.pop(context);
                                       // CustomerHomePageLogic().connectedDevicesStream.dataReload(true);

                                       Navigator.of(context).popUntil((route) => route.isFirst);
                                       CustomerHomePageLogic().tabChangedStream.dataReload(0);
                                       Future.delayed(Duration(seconds: 1)).then((value) {
                                         CustomerHomePageLogic().tabChangedStream.dataReload(1);
                                       });
                                     }

                                      showDialog(context: context,
                                          builder: (BuildContext context){
                                            return TestSavedPopUp( );
                                          }
                                      );
                                      // Navigator.of(context).popUntil((route) => route.isFirst);
                                      // returnHomePage(context);
                                      bool didCanceled = false;

                                      // Navigator.push(
                                      //     context,
                                      //     MaterialPageRoute(
                                      //         builder: (BuildContext context) =>
                                      //             SaveSucessActivity()));
                                    });
                                  },
                                    child: Padding(
                                      padding:  EdgeInsets.fromLTRB(0, 2, 0, 2),
                                      child: Row(
                                        children: [
                                          GestureDetector(
                                            onTap: () {
                                              // setState(() {
                                              //   newFolder.isExpanded = !(newFolder.isExpanded);
                                              //   newFolder.isVisible = !newFolder.isVisible;
                                              // });
                                            },
                                            //newFolder.isExpanded == fals
                                            child: false
                                                ? Icon(
                                              Icons.keyboard_arrow_up_outlined,
                                              size: width * 0.085,
                                              color: ThemeManager().getDarkGrey2Color,
                                            )
                                                : Icon(
                                              Icons.keyboard_arrow_down_outlined,
                                              size: width * 0.085,
                                              color: ThemeManager().getDarkGrey2Color,
                                            ),
                                          ),
                                          Container(
                                            margin: EdgeInsets.only(
                                              left: width * 0.02,
                                            ),
                                            child: SvgPicture.asset(
                                              ("assets/svg/folder_open.svg"),
                                              fit: BoxFit.cover,width: width*0.075,
                                            ),
                                          ),
                                          Container(
                                              margin: EdgeInsets.only(
                                                left: width * 0.03,
                                              ),
                                              child: Text(filteredData[index]["name"],
                                                style: interRegular.copyWith(
                                                  color: ThemeManager().getBlackColor,
                                                  fontSize: width * 0.045,
                                                ),
                                              )),

                                          // Container(
                                          // //  height: 50,
                                          //   width: MediaQuery.of(context).size.width,
                                          //   child: Stack(
                                          //     children: [
                                          //       Align(
                                          //         alignment: Alignment.centerLeft,
                                          //         child: Row(
                                          //           children: [
                                          //             GestureDetector(
                                          //               onTap: () {
                                          //                 // setState(() {
                                          //                 //   newFolder.isExpanded = !(newFolder.isExpanded);
                                          //                 //   newFolder.isVisible = !newFolder.isVisible;
                                          //                 // });
                                          //               },
                                          //               //newFolder.isExpanded == fals
                                          //               child: false
                                          //                   ? Icon(
                                          //                 Icons.keyboard_arrow_up_outlined,
                                          //                 size: width * 0.085,
                                          //                 color: ThemeManager().getDarkGrey2Color,
                                          //               )
                                          //                   : Icon(
                                          //                 Icons.keyboard_arrow_down_outlined,
                                          //                 size: width * 0.085,
                                          //                 color: ThemeManager().getDarkGrey2Color,
                                          //               ),
                                          //             ),
                                          //             Container(
                                          //               margin: EdgeInsets.only(
                                          //                 left: width * 0.02,
                                          //               ),
                                          //               child: SvgPicture.asset(
                                          //                 ("assets/svg/folderIcon.svg"),
                                          //                 fit: BoxFit.cover,
                                          //               ),
                                          //             ),
                                          //             Container(
                                          //                 margin: EdgeInsets.only(
                                          //                   left: width * 0.03,
                                          //                 ),
                                          //                 child: Text(
                                          //                   snapshot.data!.docs[index]["name"],
                                          //                   style: interRegular.copyWith(
                                          //                     color: ThemeManager().getBlackColor,
                                          //                     fontSize: width * 0.045,
                                          //                   ),
                                          //                 ))
                                          //             // Column(
                                          //             //   mainAxisAlignment:
                                          //             //   MainAxisAlignment.center,
                                          //             //   crossAxisAlignment:
                                          //             //   CrossAxisAlignment.start,
                                          //             //   children: [
                                          //             //
                                          //             //     Text(
                                          //             //       snapshot.data!.docs[index]["name"]
                                          //             //           .toString(),
                                          //             //       style: TextStyle(
                                          //             //           fontWeight:
                                          //             //           FontWeight.bold,
                                          //             //           color: Colors.black),
                                          //             //     ),
                                          //             //     timeFormate(snapshot.data!.docs[index]["created_at"]),
                                          //             //   ],
                                          //             // ),
                                          //           ],
                                          //         ),
                                          //       ),
                                          //       Align(
                                          //         alignment: Alignment.centerRight,
                                          //         child: Container(
                                          //           height: MediaQuery.of(context)
                                          //               .size
                                          //               .height,
                                          //           width: 50,
                                          //           child: PopupMenuButton<folderAction>(
                                          //             onSelected: (folderAction value) {
                                          //               if (value ==
                                          //                   folderAction.rename) {
                                          //                 //rename folder
                                          //                 TextEditingController
                                          //                 controller =
                                          //                 TextEditingController(
                                          //                     text: snapshot.data!.docs[index]
                                          //                     ["name"]
                                          //                         .toString());
                                          //
                                          //                 Navigator.of(context)
                                          //                     .push(
                                          //                     new MaterialPageRoute<
                                          //                         Null>(
                                          //                         builder:
                                          //                             (BuildContext
                                          //                         context) {
                                          //                           return Scaffold(
                                          //                             appBar: AppBar(
                                          //                               title: Text(
                                          //                                   "Rename Folder"),
                                          //                             ),
                                          //                             body: Container(
                                          //                               decoration:
                                          //                               BoxDecoration(
                                          //                                 color: Color
                                          //                                     .fromARGB(
                                          //                                     255,
                                          //                                     247,
                                          //                                     247,
                                          //                                     247),
                                          //                                 borderRadius: BorderRadius.only(
                                          //                                     topLeft:
                                          //                                     Radius.circular(
                                          //                                         10.0),
                                          //                                     topRight:
                                          //                                     Radius.circular(10.0)),
                                          //                               ),
                                          //                               child:
                                          //                               Padding(
                                          //                                 padding: const EdgeInsets
                                          //                                     .all(
                                          //                                     15.0),
                                          //                                 child: Wrap(
                                          //                                   children: [
                                          //                                     Padding(
                                          //                                       padding:
                                          //                                       const EdgeInsets.all(8.0),
                                          //                                       child:
                                          //                                       TextFormField(
                                          //                                         controller:
                                          //                                         controller,
                                          //                                         autofocus:
                                          //                                         true,
                                          //                                         decoration:
                                          //                                         InputDecoration(
                                          //                                           labelText: 'Folder Name',
                                          //                                           border: OutlineInputBorder(),
                                          //                                         ),
                                          //                                       ),
                                          //                                     ),
                                          //                                     InkWell(
                                          //                                       onTap:
                                          //                                           () {
                                          //                                         widget.customerFirestore.collection("folders").doc(snapshot.data!.docs[index].id).update({
                                          //                                           "name": controller.text
                                          //                                         }).then((value) {
                                          //                                           Navigator.pop(context);
                                          //                                         });
                                          //                                       },
                                          //                                       child:
                                          //                                       Card(
                                          //                                         color:
                                          //                                         Theme.of(context).primaryColor,
                                          //                                         child: Center(
                                          //                                             child: Padding(
                                          //                                               padding: const EdgeInsets.all(10.0),
                                          //                                               child: Text(
                                          //                                                 "Submit",
                                          //                                                 style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold),
                                          //                                               ),
                                          //                                             )),
                                          //                                       ),
                                          //                                     )
                                          //                                   ],
                                          //                                 ),
                                          //                               ),
                                          //                             ),
                                          //                           );
                                          //                         },
                                          //                         fullscreenDialog:
                                          //                         true));
                                          //               }
                                          //               if (value ==
                                          //                   folderAction.delete) {
                                          //                 //rename folder
                                          //                 showModalBottomSheet(
                                          //                     context: context,
                                          //                     builder: (builder) {
                                          //                       return new Wrap(
                                          //                         children: [
                                          //                           Padding(
                                          //                             padding:
                                          //                             const EdgeInsets
                                          //                                 .all(8.0),
                                          //                             child: Text(
                                          //                               "Do you want to delete this Folder?",
                                          //                               style: TextStyle(
                                          //                                   fontSize: 20,
                                          //                                   color: Theme.of(
                                          //                                       context)
                                          //                                       .primaryColor),
                                          //                             ),
                                          //                           ),
                                          //                           Row(
                                          //                             children: [
                                          //                               Expanded(
                                          //                                   child:
                                          //                                   InkWell(
                                          //                                     onTap: () {
                                          //                                       Navigator.of(
                                          //                                           context)
                                          //                                           .pop();
                                          //                                     },
                                          //                                     child: Padding(
                                          //                                       padding:
                                          //                                       const EdgeInsets
                                          //                                           .all(
                                          //                                           8.0),
                                          //                                       child: Card(
                                          //                                         elevation:
                                          //                                         8,
                                          //                                         color: Colors
                                          //                                             .grey,
                                          //                                         child: Center(
                                          //                                             child: Padding(
                                          //                                               padding: const EdgeInsets
                                          //                                                   .all(
                                          //                                                   15.0),
                                          //                                               child:
                                          //                                               Text(
                                          //                                                 "Cancel",
                                          //                                                 style: TextStyle(
                                          //                                                     color:
                                          //                                                     Colors.white,
                                          //                                                     fontWeight: FontWeight.bold),
                                          //                                               ),
                                          //                                             )),
                                          //                                       ),
                                          //                                     ),
                                          //                                   )),
                                          //                               Expanded(
                                          //                                   child:
                                          //                                   InkWell(
                                          //                                     onTap: () {
                                          //                                       widget
                                          //                                           .customerFirestore
                                          //                                           .collection(
                                          //                                           "folders")
                                          //                                           .doc(snapshot.data!.docs[index].id)
                                          //                                           .delete()
                                          //                                           .then(
                                          //                                               (value) {
                                          //                                             Navigator.pop(
                                          //                                                 context);
                                          //                                           });
                                          //                                     },
                                          //                                     child: Padding(
                                          //                                       padding:
                                          //                                       const EdgeInsets
                                          //                                           .all(
                                          //                                           8.0),
                                          //                                       child: Card(
                                          //                                         elevation:
                                          //                                         8,
                                          //                                         color: Theme.of(
                                          //                                             context)
                                          //                                             .primaryColor,
                                          //                                         child: Center(
                                          //                                             child: Padding(
                                          //                                               padding: const EdgeInsets
                                          //                                                   .all(
                                          //                                                   15.0),
                                          //                                               child:
                                          //                                               Text(
                                          //                                                 "Delete",
                                          //                                                 style: TextStyle(
                                          //                                                     color:
                                          //                                                     Colors.white,
                                          //                                                     fontWeight: FontWeight.bold),
                                          //                                               ),
                                          //                                             )),
                                          //                                       ),
                                          //                                     ),
                                          //                                   )),
                                          //                             ],
                                          //                           ),
                                          //                         ],
                                          //                       );
                                          //                     });
                                          //               }
                                          //
                                          //               if (value == folderAction.move) {
                                          //                 //rename folder
                                          //                 showModalBottomSheet(
                                          //                     context: context,
                                          //                     builder: (builder) {
                                          //                       return new Wrap(
                                          //                         children: [
                                          //                           ListTile(
                                          //                             title: Text(
                                          //                               "Move Folder",
                                          //                               style: TextStyle(
                                          //                                   fontSize: 20,
                                          //                                   color: Theme.of(
                                          //                                       context)
                                          //                                       .primaryColor),
                                          //                             ),
                                          //                             trailing: Padding(
                                          //                               padding:
                                          //                               const EdgeInsets
                                          //                                   .all(8.0),
                                          //                               child: InkWell(
                                          //                                 onTap: () {
                                          //                                   Navigator.of(
                                          //                                       context)
                                          //                                       .pop();
                                          //                                 },
                                          //                                 child: Icon(
                                          //                                     Icons
                                          //                                         .close),
                                          //                               ),
                                          //                             ),
                                          //                           ),
                                          //                           Padding(
                                          //                             padding:
                                          //                             const EdgeInsets
                                          //                                 .all(8.0),
                                          //                             child: Text(
                                          //                               "Move Folder",
                                          //                               style: TextStyle(
                                          //                                   fontSize: 20,
                                          //                                   color: Theme.of(
                                          //                                       context)
                                          //                                       .primaryColor),
                                          //                             ),
                                          //                           ),
                                          //
                                          //                           MoveFolderActivity(
                                          //                             customerId: widget
                                          //                                 .customerId,
                                          //                             customerFirestore:
                                          //                             widget
                                          //                                 .customerFirestore,
                                          //                             curentFolderID:snapshot.data!.docs[index].id,locale: widget.locale,
                                          //                           ),
                                          //                           //here show move folder target
                                          //                         ],
                                          //                       );
                                          //                     });
                                          //               }
                                          //             },
                                          //             child:
                                          //             Center(child: Icon(Icons.menu)),
                                          //             itemBuilder: (BuildContext
                                          //             context) =>
                                          //             <PopupMenuEntry<folderAction>>[
                                          //               PopupMenuItem<folderAction>(
                                          //                 value: folderAction.rename,
                                          //                 child: Text('Rename'),
                                          //               ),
                                          //               PopupMenuItem<folderAction>(
                                          //                 value: folderAction.delete,
                                          //                 child: Text('Delete'),
                                          //               ),
                                          //               PopupMenuItem<folderAction>(
                                          //                 value: folderAction.move,
                                          //                 child: Text('Move'),
                                          //               ),
                                          //             ],
                                          //           ),
                                          //         ),
                                          //       ),
                                          //     ],
                                          //   ),
                                          // ),
                                          // Container(
                                          //
                                          //  // width: MediaQuery.of(context).size.width,
                                          //   child:showNextLevelFolder(snapshot.data!.docs[index].id),)

                                        ],
                                      ),
                                    ),
                                  ),

                                  showNextLevelFolderForSavingTest(filteredData[index].id,id),
                                  //showTestItemsInFolder(snapshot.data!.docs[index].id),

                                ],
                              ),
                            ),),
                           // Align(alignment: Alignment.centerRight,child: addOrDeletePopMenuBox(snapshot.data!.docs[index].id),),
                          ],
                        ),
                       // showTestItemsInFolderForTestSave(snapshot.data!.docs[index].id),
                      ],
                    ),
                  );

                });


            return Text( snapshot.data!.docs.length.toString());
          }else return Container(width: 0,height: 0,);
        });
  }




  deleteMoveForTestPopMenuBox(String id,dynamic data) {
    return PopupMenuButton(
      elevation: 1,
      icon: Icon(Icons.more_horiz),

      itemBuilder: (context) => [
        PopupMenuItem(
          padding: EdgeInsets.only(
              top: height * 0.01, left: width * 0.0065, right: width * 0.0065),

          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [

              InkWell(
                onTap: () {
                  //move
                  // showModalBottomSheet(shape: RoundedRectangleBorder(
                  //   borderRadius: BorderRadius.only(topLeft: Radius.circular(20),topRight: Radius.circular(20)),
                  // ),
                  //     context: context,
                  //     builder: (context) {
                  //       return Container(child: MoveFileActivity(
                  //         dataToMove:data,
                  //         recordId: id,
                  //         customerId:
                  //         widget
                  //             .customerId,
                  //         customerFirestore:
                  //         widget
                  //             .customerFirestore,
                  //         curentFolderID: widget
                  //             .folderStack
                  //             .last,locale: widget.locale,),);});

                },
                child: Container(
                  margin: EdgeInsets.only(
                      left: width * 0.005, right: width * 0.005),
                  alignment: Alignment.center,
                  child: Text(
                    "Move",
                    style: interRegular.copyWith(
                        color: ThemeManager().getBlackColor,
                        fontSize: width * 0.035),
                  ),
                ),
              ), Container(
                margin: EdgeInsets.only(
                    top: height * 0.01, bottom: height * 0.01),
                height: height * 0.001,
                width: double.infinity,
                color: ThemeManager().getBlackColor.withOpacity(0.19),
              ),InkWell(
                onTap: () {
                  Navigator.of(context).pop();
                },
                child: Container(
                    alignment: Alignment.center,
                    child: Text(
                      TextConst.deleteFolderPopUpText,
                      style: interRegular.copyWith(
                          color: ThemeManager().getBlackColor,
                          fontSize: width * 0.035),
                    )),
              )
            ],
          ),
          // value: 1,
        ),
      ],
    );
  }
  addOrDeletePopMenuBox(String id) {
    return PopupMenuButton(
      elevation: 1,
      icon: Icon(Icons.more_horiz),

      itemBuilder: (context) => [
        PopupMenuItem(
       //   padding: EdgeInsets.only(top: height * 0.01, left: width * 0.0065, right: width * 0.0065),

          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [

              InkWell(
                onTap: () {
                  Navigator.of(context).pop();
                  addNewFolderNamePopUp(id);
                },
                child: Container(
                  margin: EdgeInsets.only(
                      left: width * 0.005, right: width * 0.005),
                  alignment: Alignment.center,
                  child: Text(
                    TextConst.addNewFolderPopUpText,
                    style: interRegular.copyWith(
                        color: ThemeManager().getBlackColor,
                        fontSize: width * 0.035),
                  ),
                ),
              ), Container(
                margin: EdgeInsets.only(
                    top: height * 0.01, bottom: height * 0.01),
                height: height * 0.001,
                width: double.infinity,
                color: ThemeManager().getBlackColor.withOpacity(0.19),
              ),InkWell(
                onTap: () {
                  Navigator.of(context).pop();
                },
                child: Container(
                    alignment: Alignment.center,
                    child: Text(
                      TextConst.deleteFolderPopUpText,
                      style: interRegular.copyWith(
                          color: ThemeManager().getBlackColor,
                          fontSize: width * 0.035),
                    )),
              )
            ],
          ),
          // value: 1,
        ),
      ],
    );
  }

  //---------------Add new folder Name Dialogue Box------------------
  addNewFolderNamePopUp(String id) {
    final _formKey = GlobalKey<FormState>();
    showDialog(
        context: context,
        builder: (
            context,
            ) {
          return StatefulBuilder(builder: (context, setState) {
            return AlertDialog(
              scrollable: true,
              shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.all(Radius.circular(10))),
              contentPadding: EdgeInsets.only(top: 10.0),
              content: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Container(
                    margin: EdgeInsets.only(
                        top: height * 0.01,
                        left: width * 0.04,
                        right: width * 0.04),
                    child: Row(
                      mainAxisAlignment: MainAxisAlignment.spaceBetween,
                      children: [
                        Text(
                          TextConst.addSubFolderText,
                          style: interSemiBold.copyWith(
                            color: ThemeManager().getBlackColor,
                            fontSize: width * 0.04,
                          ),
                        ),
                        InkWell(
                            onTap: () {
                              Navigator.of(context).pop();
                            },
                            child: Icon(
                              Icons.clear,
                              size: width * 0.06,
                              color: ThemeManager().getLightGrey4Color,
                            )),
                      ],
                    ),
                  ),
                  Container(
                    margin: EdgeInsets.only(top: height * 0.015),
                    height: height * 0.001,
                    color: ThemeManager().getBlackColor.withOpacity(0.19),
                  ),
                  Container(
                    margin: EdgeInsets.only(
                        top: height * 0.02,
                        left: width * 0.04,
                        right: width * 0.04),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          TextConst.folderNameText,
                          style: interMedium.copyWith(
                            color: ThemeManager().getPopUpTextGreyColor,
                            fontSize: width * 0.036,
                          ),
                        ),
                        Container(
                          margin: EdgeInsets.only(top: height * 0.015),
                          child: Form(
                            key: _formKey,
                            child: TextFormField(
                              controller: _folderNameController,
                              maxLength: 22,
                              autovalidateMode: AutovalidateMode.onUserInteraction,
                              keyboardType: TextInputType.text,
                              decoration: InputDecoration(
                                counterText: "",
                                border: InputBorder.none,
                                hintText: TextConst.textFieldFolderText,
                                hintStyle: interMedium.copyWith(
                                  color: ThemeManager().getLightGrey4Color,
                                  fontSize: width * 0.036,
                                ),
                                enabledBorder: OutlineInputBorder(
                                    borderSide: BorderSide(
                                      color: Colors.transparent,
                                    ),
                                    borderRadius:
                                    BorderRadius.circular(width * 0.014)),
                                contentPadding: EdgeInsets.symmetric(
                                    vertical: height * 0.0,
                                    horizontal: width * 0.045),
                                fillColor:
                                ThemeManager().getLightGreenTextFieldColor,
                                filled: true,
                              ),
                              validator: (value) {
                                if (value!.isEmpty) {
                                  return "Please enter folder name";
                                } else if (_folderNameController.text.length > 22) {
                                  return "Name should be 22 character only";
                                }
                              },
                            ),
                          ),
                        ),
                        Container(
                          margin: EdgeInsets.only(top: height * 0.015),
                          child: Text(
                            "*Name must be within 10 characters.",
                            style: interMedium.copyWith(
                              color: ThemeManager().getPopUpTextGreyColor,
                              fontSize: width * 0.03,
                            ),
                          ),
                        ),
                        InkWell(
                          onTap: () async {
                            if (_formKey.currentState!.validate()) {


                              var r = await  AppFirestore(firestore: widget.customerFirestore, projectId: '', auth: FirebaseAuth.instance).createFolders(name:_folderNameController.text,parent: id );

                              if(r == true) {
                                _folderNameController.clear();
                                Navigator.of(context).pop();



                              }else{
                                _folderNameController.clear();
                                Navigator.of(context).pop();
                                showDialog(context: context,
                                    builder: (BuildContext context){
                                      return FolderExistsPopUp();
                                    });
                              }





                              // Navigator.of(context).pop();
                            } else {}
                          },
                          child: Container(
                              margin: EdgeInsets.only(
                                  top: height * 0.04, bottom: height * 0.02),
                              child: ButtonView(
                                  buttonLabel: TextConst.saveButtonText)
                          ),
                        ),
                      ],
                    ),
                  ),
                ],
              ),
            );
          });
        });
  }

  showTestItemsInFolderSorted(String id) {
    return  StreamBuilder<QuerySnapshot>(
        stream: widget.customerFirestore
            .collection("folders")
            .doc(id)
            .collection("records")
            .snapshots(),
        builder: (context, snapshot) {
          if (snapshot.hasData && snapshot.data!.docs.length>0) {
            // return Text(snapshot.data.docs[0].get("id"));
            Map<String, String> fileAndFolderSource =
            Map<String, String>();

            List<QueryDocumentSnapshot<Object>> filteredData = [];
            List<DocumentSnapshot<Object>> allData = [];

            for (int i = 0; i < snapshot.data!.docs.length; i++) {
              // allData.add(value)

              widget.customerFirestore
                  .collection("pulltest")
                  .doc(snapshot.data!.docs[i].get("id"))
                  .get()
                  .then((value) {
                //value.data()["folderID"]= snapshot.data.docs[i].id;
                // Map<String, dynamic> da = value.data();
                fileAndFolderSource.putIfAbsent(
                    value.id, () => snapshot.data!.docs[i].id);

                //da["folderID"] = snapshot.data.docs[i].id;
                allData.add(value);
                FilteredDataShow.getInstance().dataReload(allData);

                print("size " + allData.length.toString());
              });
            }

            // if (selectedSortType == fileSortType.none) {
            //   filteredData = snapshot.data.docs;
            // } else if (selectedSortType == fileSortType.date) {
            //   filteredData = snapshot.data.docs;
            //   filteredData.sort((a, b) {
            //     return a
            //         .get("name")
            //         .toString()
            //         .toLowerCase()
            //         .compareTo(b.get("name").toString().toLowerCase());
            //   });
            // }
            print("now = > " + allData.length.toString());

            return StreamBuilder<List<DocumentSnapshot<Object>>>(
                stream: FilteredDataShow.getInstance().outData,
                builder: (BuildContext context,
                    AsyncSnapshot<List<DocumentSnapshot<Object>>>
                    snapshot) {
                  List<DocumentSnapshot<Object>> sortedList = [];
                  if (snapshot.hasData && snapshot.data!.length > 0) {
                    if (selectedSortType == fileSortType.none) {
                      sortedList = snapshot.data!;
                    }
                    if (selectedSortType == fileSortType.title) {
                      sortedList = snapshot.data!;
                      try{
                        sortedList.sort((a, b) {
                          return a
                              .get("name")
                              .toString()
                              .toLowerCase()
                              .compareTo(
                              b.get("name").toString().toLowerCase());
                        });
                      }catch(e){
                        print(e);
                      }
                    }
                    if (selectedSortType == fileSortType.date) {
                      sortedList = snapshot.data!;
                      try{
                        sortedList.sort((a, b) {
                          return a
                              .get("time")
                              .toString()
                              .toLowerCase()
                              .compareTo(
                              b.get("time").toString().toLowerCase());
                        });
                      }catch(e){

                      }
                      sortedList = sortedList.reversed.toList();
                    }
                    return sortedList.length > 0
                        ? ListView.builder(
                        physics: ClampingScrollPhysics(),
                        // separatorBuilder: (context, index) {
                        //   return Divider();
                        // },
                        padding: EdgeInsets.zero,
                        shrinkWrap: true,
                        itemCount: sortedList.length,
                        itemBuilder: (_, index) {
                          if (sortedList[index].exists &&
                              sortedList[index].get("name") != null) {
                            return Container(

                              child: Stack(
                                children: [
                                  Align(
                                    alignment: Alignment.centerLeft,
                                    child: InkWell(
                                      onTap: () {
                                        print(sortedList[index]
                                            .data()
                                            .toString());
                                        if (sortedList[index]
                                            .exists &&
                                            sortedList[index]
                                                .get("name") !=
                                                null) {
                                          // AppWidgets(customerId:  widget.customerId,customerFirestore:  widget
                                          //     .customerFirestore). showTestRecordBody(
                                          //
                                          //     sortedList[index].id,
                                          //     sortedList[index],
                                          //     context,widget.locale
                                          // );
                                        }
                                      },
                                      child: Row(
                                        children: [
                                          Container(
                                            margin: EdgeInsets.only(
                                              left: width * 0.02,
                                            ),
                                            child: Image.asset("assets/svg/gr.png"),
                                            // child: SvgPicture.asset(
                                            //   ("assets/svg/gr.svg"),
                                            //   fit: BoxFit.cover,
                                            // ),
                                          ),
                                          Text(
                                              sortedList[index]
                                                  .get("name"),
                                              style: TextStyle(
                                                  fontWeight:
                                                  FontWeight
                                                      .bold,
                                                  color: Colors
                                                      .black)),
                                          // Column(
                                          //   mainAxisAlignment:
                                          //   MainAxisAlignment
                                          //       .start,
                                          //   crossAxisAlignment:
                                          //   CrossAxisAlignment
                                          //       .start,
                                          //   children: [
                                          //     Text(
                                          //         sortedList[index]
                                          //             .get("name"),
                                          //         style: TextStyle(
                                          //             fontWeight:
                                          //             FontWeight
                                          //                 .bold,
                                          //             color: Colors
                                          //                 .black)),
                                          //     timeFormate(
                                          //         sortedList[index]
                                          //             .get("time")),
                                          //   ],
                                          // ),
                                        ],
                                      ),
                                    ),
                                  ),
                                  Align(
                                    alignment: Alignment.centerRight,
                                    child: Container(
                                      child:  Align(alignment: Alignment.centerRight,child: addOrDeletePopMenuBox(""),),


                                      // child: PopupMenuButton<
                                      //     folderAction>(
                                      //   onSelected:
                                      //       (folderAction value) {
                                      //     if (value ==
                                      //         folderAction.move) {
                                      //       //rename folder
                                      //       showModalBottomSheet(
                                      //           context: context,
                                      //           builder: (builder) {
                                      //             return new Wrap(
                                      //               children: [
                                      //                 ListTile(
                                      //                   title: Text(
                                      //                     "Move File",
                                      //                     style: TextStyle(
                                      //                         fontSize:
                                      //                         20,
                                      //                         color: Theme.of(context)
                                      //                             .primaryColor),
                                      //                   ),
                                      //                   trailing:
                                      //                   Padding(
                                      //                     padding:
                                      //                     const EdgeInsets.all(
                                      //                         8.0),
                                      //                     child:
                                      //                     InkWell(
                                      //                       onTap:
                                      //                           () {
                                      //                         Navigator.of(context)
                                      //                             .pop();
                                      //                       },
                                      //                       child: Icon(
                                      //                           Icons
                                      //                               .close),
                                      //                     ),
                                      //                   ),
                                      //                 ),
                                      //                 //.get("folderID").toString()
                                      //                 //Text(fileAndFolderSource[sortedList[index].id]),
                                      //
                                      //                 MoveFileActivity(
                                      //                   dataToMove:
                                      //                   sortedList[index]
                                      //                       .data(),
                                      //                   recordId: fileAndFolderSource[
                                      //                   sortedList[index]
                                      //                       .id]!,
                                      //                   customerId:
                                      //                   widget
                                      //                       .customerId,
                                      //                   customerFirestore:
                                      //                   widget
                                      //                       .customerFirestore,
                                      //                   curentFolderID: widget
                                      //                       .folderStack
                                      //                       .last,locale: widget.locale,),
                                      //                 //here show move folder target
                                      //               ],
                                      //             );
                                      //           });
                                      //     }
                                      //   },
                                      //   child: Center(
                                      //       child: Icon(
                                      //         Icons.menu,
                                      //         color: Colors.black,
                                      //       )),
                                      //   itemBuilder: (BuildContext
                                      //   context) =>
                                      //   <
                                      //       PopupMenuEntry<
                                      //           folderAction>>[
                                      //     PopupMenuItem<folderAction>(
                                      //       value: folderAction.move,
                                      //       child: Text('Move'),
                                      //     ),
                                      //   ],
                                      // ),
                                    ),
                                  ),
                                ],
                              ),
                            );
                          } else
                            return Container(
                              width: 0,
                              height: 0,
                            );
                        })
                        : Container(
                      width: 0,
                      height: 0,
                    );
                  } else
                    return Container(
                      width: 0,
                      height: 0,
                    );
                });


          } else {
            return Text("");
          }
        });

  }
  showTestItemsInFolder(String id) {
    return  StreamBuilder<QuerySnapshot>(
        stream: widget.customerFirestore
            .collection("folders")
            .doc(id)
            .collection("records")
            .snapshots(),
        builder: (context, snapshot) {
          if (snapshot.hasData && snapshot.data!.docs.length>0) {
            // return Text(snapshot.data.docs[0].get("id"));
            Map<String, String> fileAndFolderSource =
            Map<String, String>();

            List<QueryDocumentSnapshot<Object>> filteredData = [];
            List<DocumentSnapshot<Object>> allData = [];

            // for (int i = 0; i < snapshot.data!.docs.length; i++) {
            //   // allData.add(value)
            //
            //   widget.customerFirestore
            //       .collection("pulltest")
            //       .doc(snapshot.data!.docs[i].get("id"))
            //       .get()
            //       .then((value) {
            //     //value.data()["folderID"]= snapshot.data.docs[i].id;
            //     // Map<String, dynamic> da = value.data();
            //     fileAndFolderSource.putIfAbsent(
            //         value.id, () => snapshot.data!.docs[i].id);
            //
            //     //da["folderID"] = snapshot.data.docs[i].id;
            //     allData.add(value);
            //     FilteredDataShow.getInstance().dataReload(allData);
            //
            //     print("size " + allData.length.toString());
            //   });
            // }

            // if (selectedSortType == fileSortType.none) {
            //   filteredData = snapshot.data.docs;
            // } else if (selectedSortType == fileSortType.date) {
            //   filteredData = snapshot.data.docs;
            //   filteredData.sort((a, b) {
            //     return a
            //         .get("name")
            //         .toString()
            //         .toLowerCase()
            //         .compareTo(b.get("name").toString().toLowerCase());
            //   });
            // }
            print("now = > " + allData.length.toString());

            return ListView.builder(
                physics: ClampingScrollPhysics(),
                // separatorBuilder: (context, index) {
                //   return Divider();
                // },
                padding: EdgeInsets.zero,
                shrinkWrap: true,
                itemCount:snapshot.data!.docs.length,
                itemBuilder: (_, index) {

                  try{
                    return    FutureBuilder<DocumentSnapshot>(
                        future:     widget.customerFirestore
                            .collection("pulltest")
                            .doc(snapshot.data!.docs[index].get("id"))
                            .get(),
                        builder: (BuildContext context, AsyncSnapshot<DocumentSnapshot> snapshot) {

                          if(snapshot.hasData){
                            return Container(

                              child: Stack(
                                children: [
                                  Align(
                                    alignment: Alignment.centerLeft,
                                    child: InkWell(
                                      onTap: () {

                                        if (snapshot.data!.exists &&
                                            snapshot.data!
                                                .get("name") !=
                                                null) {
                                          // AppWidgets(customerId:  widget.customerId,customerFirestore:  widget
                                          //     .customerFirestore). showTestRecordBody(
                                          //
                                          //     snapshot.data!.id,
                                          //     snapshot.data!,
                                          //     context,widget.locale
                                          // );
                                        }
                                      },
                                      child: Row(
                                        children: [
                                          Padding(
                                            padding: const EdgeInsets.fromLTRB(0,0,10,0),
                                            child: Container(
                                              margin: EdgeInsets.only(
                                                left: width * 0.02,
                                              ),
                                              child: Image.asset("assets/svg/gr.png"),
                                              // child: SvgPicture.asset(
                                              //   ("assets/svg/gr.svg"),
                                              //   fit: BoxFit.cover,
                                              // ),
                                            ),
                                          ),
                                          Text(
                                              snapshot.data!
                                                  .get("name"),
                                              style: TextStyle(
                                                  fontWeight:
                                                  FontWeight
                                                      .bold,
                                                  color: Colors
                                                      .black)),
                                          // Column(
                                          //   mainAxisAlignment:
                                          //   MainAxisAlignment
                                          //       .start,
                                          //   crossAxisAlignment:
                                          //   CrossAxisAlignment
                                          //       .start,
                                          //   children: [
                                          //     Text(
                                          //         sortedList[index]
                                          //             .get("name"),
                                          //         style: TextStyle(
                                          //             fontWeight:
                                          //             FontWeight
                                          //                 .bold,
                                          //             color: Colors
                                          //                 .black)),
                                          //     timeFormate(
                                          //         sortedList[index]
                                          //             .get("time")),
                                          //   ],
                                          // ),
                                        ],
                                      ),
                                    ),
                                  ),
                                  Align(
                                    alignment: Alignment.centerRight,
                                    child: Container(
                                      child:  Align(alignment: Alignment.centerRight,child: deleteMoveForTestPopMenuBox(snapshot.data!.id,snapshot.data!.data()),),


                                      // child: PopupMenuButton<
                                      //     folderAction>(
                                      //   onSelected:
                                      //       (folderAction value) {
                                      //     if (value ==
                                      //         folderAction.move) {
                                      //       //rename folder
                                      //       showModalBottomSheet(
                                      //           context: context,
                                      //           builder: (builder) {
                                      //             return new Wrap(
                                      //               children: [
                                      //                 ListTile(
                                      //                   title: Text(
                                      //                     "Move File",
                                      //                     style: TextStyle(
                                      //                         fontSize:
                                      //                         20,
                                      //                         color: Theme.of(context)
                                      //                             .primaryColor),
                                      //                   ),
                                      //                   trailing:
                                      //                   Padding(
                                      //                     padding:
                                      //                     const EdgeInsets.all(
                                      //                         8.0),
                                      //                     child:
                                      //                     InkWell(
                                      //                       onTap:
                                      //                           () {
                                      //                         Navigator.of(context)
                                      //                             .pop();
                                      //                       },
                                      //                       child: Icon(
                                      //                           Icons
                                      //                               .close),
                                      //                     ),
                                      //                   ),
                                      //                 ),
                                      //                 //.get("folderID").toString()
                                      //                 //Text(fileAndFolderSource[sortedList[index].id]),
                                      //
                                      //                 MoveFileActivity(
                                      //                   dataToMove:
                                      //                   sortedList[index]
                                      //                       .data(),
                                      //                   recordId: fileAndFolderSource[
                                      //                   sortedList[index]
                                      //                       .id]!,
                                      //                   customerId:
                                      //                   widget
                                      //                       .customerId,
                                      //                   customerFirestore:
                                      //                   widget
                                      //                       .customerFirestore,
                                      //                   curentFolderID: widget
                                      //                       .folderStack
                                      //                       .last,locale: widget.locale,),
                                      //                 //here show move folder target
                                      //               ],
                                      //             );
                                      //           });
                                      //     }
                                      //   },
                                      //   child: Center(
                                      //       child: Icon(
                                      //         Icons.menu,
                                      //         color: Colors.black,
                                      //       )),
                                      //   itemBuilder: (BuildContext
                                      //   context) =>
                                      //   <
                                      //       PopupMenuEntry<
                                      //           folderAction>>[
                                      //     PopupMenuItem<folderAction>(
                                      //       value: folderAction.move,
                                      //       child: Text('Move'),
                                      //     ),
                                      //   ],
                                      // ),
                                    ),
                                  ),
                                ],
                              ),
                            );
                          }else return Container(height: 0,width: 0,);
                        });
                  }catch(e){
                    return Container(

                      child: Stack(
                        children: [
                          Align(
                            alignment: Alignment.centerLeft,
                            child: InkWell(
                              onTap: () {


                              },
                              child: Row(
                                children: [
                                  Padding(
                                    padding: const EdgeInsets.fromLTRB(0,0,10,0),
                                    child: Container(
                                      margin: EdgeInsets.only(
                                        left: width * 0.02,
                                      ),
                                      child: Image.asset("assets/svg/gr.png"),
                                      // child: SvgPicture.asset(
                                      //   ("assets/svg/gr.svg"),
                                      //   fit: BoxFit.cover,
                                      // ),
                                    ),
                                  ),
                                  Text("Not Found",
                                      style: TextStyle(
                                          fontWeight:
                                          FontWeight
                                              .bold,
                                          color: Colors
                                              .black)),
                                  // Column(
                                  //   mainAxisAlignment:
                                  //   MainAxisAlignment
                                  //       .start,
                                  //   crossAxisAlignment:
                                  //   CrossAxisAlignment
                                  //       .start,
                                  //   children: [
                                  //     Text(
                                  //         sortedList[index]
                                  //             .get("name"),
                                  //         style: TextStyle(
                                  //             fontWeight:
                                  //             FontWeight
                                  //                 .bold,
                                  //             color: Colors
                                  //                 .black)),
                                  //     timeFormate(
                                  //         sortedList[index]
                                  //             .get("time")),
                                  //   ],
                                  // ),
                                ],
                              ),
                            ),
                          ),
                          Align(
                            alignment: Alignment.centerRight,
                            child: Container(
                              child:  Align(alignment: Alignment.centerRight,child: addOrDeletePopMenuBox(""),),


                              // child: PopupMenuButton<
                              //     folderAction>(
                              //   onSelected:
                              //       (folderAction value) {
                              //     if (value ==
                              //         folderAction.move) {
                              //       //rename folder
                              //       showModalBottomSheet(
                              //           context: context,
                              //           builder: (builder) {
                              //             return new Wrap(
                              //               children: [
                              //                 ListTile(
                              //                   title: Text(
                              //                     "Move File",
                              //                     style: TextStyle(
                              //                         fontSize:
                              //                         20,
                              //                         color: Theme.of(context)
                              //                             .primaryColor),
                              //                   ),
                              //                   trailing:
                              //                   Padding(
                              //                     padding:
                              //                     const EdgeInsets.all(
                              //                         8.0),
                              //                     child:
                              //                     InkWell(
                              //                       onTap:
                              //                           () {
                              //                         Navigator.of(context)
                              //                             .pop();
                              //                       },
                              //                       child: Icon(
                              //                           Icons
                              //                               .close),
                              //                     ),
                              //                   ),
                              //                 ),
                              //                 //.get("folderID").toString()
                              //                 //Text(fileAndFolderSource[sortedList[index].id]),
                              //
                              //                 MoveFileActivity(
                              //                   dataToMove:
                              //                   sortedList[index]
                              //                       .data(),
                              //                   recordId: fileAndFolderSource[
                              //                   sortedList[index]
                              //                       .id]!,
                              //                   customerId:
                              //                   widget
                              //                       .customerId,
                              //                   customerFirestore:
                              //                   widget
                              //                       .customerFirestore,
                              //                   curentFolderID: widget
                              //                       .folderStack
                              //                       .last,locale: widget.locale,),
                              //                 //here show move folder target
                              //               ],
                              //             );
                              //           });
                              //     }
                              //   },
                              //   child: Center(
                              //       child: Icon(
                              //         Icons.menu,
                              //         color: Colors.black,
                              //       )),
                              //   itemBuilder: (BuildContext
                              //   context) =>
                              //   <
                              //       PopupMenuEntry<
                              //           folderAction>>[
                              //     PopupMenuItem<folderAction>(
                              //       value: folderAction.move,
                              //       child: Text('Move'),
                              //     ),
                              //   ],
                              // ),
                            ),
                          ),
                        ],
                      ),
                    );
                  }

                  return Text(snapshot.data!.docs[index].id);
                });


          } else {
            return Container(width: 0,height: 0,);
          }
        });

  }
  // showTestItemsInFolderForTestSave(String id) {
  //   return  StreamBuilder<QuerySnapshot>(
  //       stream: widget.customerFirestore
  //           .collection("folders")
  //           .doc(id)
  //           .collection("records")
  //           .snapshots(),
  //       builder: (context, snapshot) {
  //         if (snapshot.hasData && snapshot.data!.docs.length>0) {
  //           // return Text(snapshot.data.docs[0].get("id"));
  //           Map<String, String> fileAndFolderSource =
  //           Map<String, String>();
  //
  //           List<QueryDocumentSnapshot<Object>> filteredData = [];
  //           List<DocumentSnapshot<Object>> allData = [];
  //
  //           // for (int i = 0; i < snapshot.data!.docs.length; i++) {
  //           //   // allData.add(value)
  //           //
  //           //   widget.customerFirestore
  //           //       .collection("pulltest")
  //           //       .doc(snapshot.data!.docs[i].get("id"))
  //           //       .get()
  //           //       .then((value) {
  //           //     //value.data()["folderID"]= snapshot.data.docs[i].id;
  //           //     // Map<String, dynamic> da = value.data();
  //           //     fileAndFolderSource.putIfAbsent(
  //           //         value.id, () => snapshot.data!.docs[i].id);
  //           //
  //           //     //da["folderID"] = snapshot.data.docs[i].id;
  //           //     allData.add(value);
  //           //     FilteredDataShow.getInstance().dataReload(allData);
  //           //
  //           //     print("size " + allData.length.toString());
  //           //   });
  //           // }
  //
  //           // if (selectedSortType == fileSortType.none) {
  //           //   filteredData = snapshot.data.docs;
  //           // } else if (selectedSortType == fileSortType.date) {
  //           //   filteredData = snapshot.data.docs;
  //           //   filteredData.sort((a, b) {
  //           //     return a
  //           //         .get("name")
  //           //         .toString()
  //           //         .toLowerCase()
  //           //         .compareTo(b.get("name").toString().toLowerCase());
  //           //   });
  //           // }
  //           print("now = > " + allData.length.toString());
  //
  //           return ListView.builder(
  //               physics: ClampingScrollPhysics(),
  //               // separatorBuilder: (context, index) {
  //               //   return Divider();
  //               // },
  //               padding: EdgeInsets.zero,
  //               shrinkWrap: true,
  //               itemCount:snapshot.data!.docs.length,
  //               itemBuilder: (_, index) {
  //
  //                 try{
  //                   return    FutureBuilder<DocumentSnapshot>(
  //                       future:     widget.customerFirestore
  //                           .collection("pulltest")
  //                           .doc(snapshot.data!.docs[index].get("id"))
  //                           .get(),
  //                       builder: (BuildContext context, AsyncSnapshot<DocumentSnapshot> snapshot) {
  //
  //                         if(snapshot.hasData){
  //                           return Container(
  //
  //                             child: Stack(
  //                               children: [
  //                                 Align(
  //                                   alignment: Alignment.centerLeft,
  //                                   child: InkWell(
  //                                     onTap: () {
  //
  //                                       if (snapshot.data!.exists &&
  //                                           snapshot.data!
  //                                               .get("name") !=
  //                                               null) {
  //                                         AppWidgets(customerId:  widget.customerId,customerFirestore:  widget
  //                                             .customerFirestore). showTestRecordBody(
  //
  //                                             snapshot.data!.id,
  //                                             snapshot.data!,
  //                                             context,widget.locale
  //                                         );
  //                                       }
  //                                     },
  //                                     child: Row(
  //                                       children: [
  //                                         Padding(
  //                                           padding: const EdgeInsets.fromLTRB(0,0,10,0),
  //                                           child: Container(
  //                                             margin: EdgeInsets.only(
  //                                               left: width * 0.02,
  //                                             ),
  //                                             child: Image.asset("assets/svg/gr.png"),
  //                                             // child: SvgPicture.asset(
  //                                             //   ("assets/svg/gr.svg"),
  //                                             //   fit: BoxFit.cover,
  //                                             // ),
  //                                           ),
  //                                         ),
  //                                         Text(
  //                                             snapshot.data!
  //                                                 .get("name"),
  //                                             style: TextStyle(
  //                                                 fontWeight:
  //                                                 FontWeight
  //                                                     .bold,
  //                                                 color: Colors
  //                                                     .black)),
  //                                         // Column(
  //                                         //   mainAxisAlignment:
  //                                         //   MainAxisAlignment
  //                                         //       .start,
  //                                         //   crossAxisAlignment:
  //                                         //   CrossAxisAlignment
  //                                         //       .start,
  //                                         //   children: [
  //                                         //     Text(
  //                                         //         sortedList[index]
  //                                         //             .get("name"),
  //                                         //         style: TextStyle(
  //                                         //             fontWeight:
  //                                         //             FontWeight
  //                                         //                 .bold,
  //                                         //             color: Colors
  //                                         //                 .black)),
  //                                         //     timeFormate(
  //                                         //         sortedList[index]
  //                                         //             .get("time")),
  //                                         //   ],
  //                                         // ),
  //                                       ],
  //                                     ),
  //                                   ),
  //                                 ),
  //                                 Align(
  //                                   alignment: Alignment.centerRight,
  //                                   child: Container(
  //                                     child:  Align(alignment: Alignment.centerRight,child: deleteMoveForTestPopMenuBox(snapshot.data!.id,snapshot.data!.data()),),
  //
  //
  //                                     // child: PopupMenuButton<
  //                                     //     folderAction>(
  //                                     //   onSelected:
  //                                     //       (folderAction value) {
  //                                     //     if (value ==
  //                                     //         folderAction.move) {
  //                                     //       //rename folder
  //                                     //       showModalBottomSheet(
  //                                     //           context: context,
  //                                     //           builder: (builder) {
  //                                     //             return new Wrap(
  //                                     //               children: [
  //                                     //                 ListTile(
  //                                     //                   title: Text(
  //                                     //                     "Move File",
  //                                     //                     style: TextStyle(
  //                                     //                         fontSize:
  //                                     //                         20,
  //                                     //                         color: Theme.of(context)
  //                                     //                             .primaryColor),
  //                                     //                   ),
  //                                     //                   trailing:
  //                                     //                   Padding(
  //                                     //                     padding:
  //                                     //                     const EdgeInsets.all(
  //                                     //                         8.0),
  //                                     //                     child:
  //                                     //                     InkWell(
  //                                     //                       onTap:
  //                                     //                           () {
  //                                     //                         Navigator.of(context)
  //                                     //                             .pop();
  //                                     //                       },
  //                                     //                       child: Icon(
  //                                     //                           Icons
  //                                     //                               .close),
  //                                     //                     ),
  //                                     //                   ),
  //                                     //                 ),
  //                                     //                 //.get("folderID").toString()
  //                                     //                 //Text(fileAndFolderSource[sortedList[index].id]),
  //                                     //
  //                                     //                 MoveFileActivity(
  //                                     //                   dataToMove:
  //                                     //                   sortedList[index]
  //                                     //                       .data(),
  //                                     //                   recordId: fileAndFolderSource[
  //                                     //                   sortedList[index]
  //                                     //                       .id]!,
  //                                     //                   customerId:
  //                                     //                   widget
  //                                     //                       .customerId,
  //                                     //                   customerFirestore:
  //                                     //                   widget
  //                                     //                       .customerFirestore,
  //                                     //                   curentFolderID: widget
  //                                     //                       .folderStack
  //                                     //                       .last,locale: widget.locale,),
  //                                     //                 //here show move folder target
  //                                     //               ],
  //                                     //             );
  //                                     //           });
  //                                     //     }
  //                                     //   },
  //                                     //   child: Center(
  //                                     //       child: Icon(
  //                                     //         Icons.menu,
  //                                     //         color: Colors.black,
  //                                     //       )),
  //                                     //   itemBuilder: (BuildContext
  //                                     //   context) =>
  //                                     //   <
  //                                     //       PopupMenuEntry<
  //                                     //           folderAction>>[
  //                                     //     PopupMenuItem<folderAction>(
  //                                     //       value: folderAction.move,
  //                                     //       child: Text('Move'),
  //                                     //     ),
  //                                     //   ],
  //                                     // ),
  //                                   ),
  //                                 ),
  //                               ],
  //                             ),
  //                           );
  //                         }else return Container(height: 0,width: 0,);
  //                       });
  //                 }catch(e){
  //                   return Container(
  //
  //                     child: Stack(
  //                       children: [
  //                         Align(
  //                           alignment: Alignment.centerLeft,
  //                           child: InkWell(
  //                             onTap: () {
  //
  //
  //                             },
  //                             child: Row(
  //                               children: [
  //                                 Padding(
  //                                   padding: const EdgeInsets.fromLTRB(0,0,10,0),
  //                                   child: Container(
  //                                     margin: EdgeInsets.only(
  //                                       left: width * 0.02,
  //                                     ),
  //                                     child: Image.asset("assets/svg/gr.png"),
  //                                     // child: SvgPicture.asset(
  //                                     //   ("assets/svg/gr.svg"),
  //                                     //   fit: BoxFit.cover,
  //                                     // ),
  //                                   ),
  //                                 ),
  //                                 Text("Not Found",
  //                                     style: TextStyle(
  //                                         fontWeight:
  //                                         FontWeight
  //                                             .bold,
  //                                         color: Colors
  //                                             .black)),
  //                                 // Column(
  //                                 //   mainAxisAlignment:
  //                                 //   MainAxisAlignment
  //                                 //       .start,
  //                                 //   crossAxisAlignment:
  //                                 //   CrossAxisAlignment
  //                                 //       .start,
  //                                 //   children: [
  //                                 //     Text(
  //                                 //         sortedList[index]
  //                                 //             .get("name"),
  //                                 //         style: TextStyle(
  //                                 //             fontWeight:
  //                                 //             FontWeight
  //                                 //                 .bold,
  //                                 //             color: Colors
  //                                 //                 .black)),
  //                                 //     timeFormate(
  //                                 //         sortedList[index]
  //                                 //             .get("time")),
  //                                 //   ],
  //                                 // ),
  //                               ],
  //                             ),
  //                           ),
  //                         ),
  //                         Align(
  //                           alignment: Alignment.centerRight,
  //                           child: Container(
  //                             child:  Align(alignment: Alignment.centerRight,child: addOrDeletePopMenuBox(""),),
  //
  //
  //                             // child: PopupMenuButton<
  //                             //     folderAction>(
  //                             //   onSelected:
  //                             //       (folderAction value) {
  //                             //     if (value ==
  //                             //         folderAction.move) {
  //                             //       //rename folder
  //                             //       showModalBottomSheet(
  //                             //           context: context,
  //                             //           builder: (builder) {
  //                             //             return new Wrap(
  //                             //               children: [
  //                             //                 ListTile(
  //                             //                   title: Text(
  //                             //                     "Move File",
  //                             //                     style: TextStyle(
  //                             //                         fontSize:
  //                             //                         20,
  //                             //                         color: Theme.of(context)
  //                             //                             .primaryColor),
  //                             //                   ),
  //                             //                   trailing:
  //                             //                   Padding(
  //                             //                     padding:
  //                             //                     const EdgeInsets.all(
  //                             //                         8.0),
  //                             //                     child:
  //                             //                     InkWell(
  //                             //                       onTap:
  //                             //                           () {
  //                             //                         Navigator.of(context)
  //                             //                             .pop();
  //                             //                       },
  //                             //                       child: Icon(
  //                             //                           Icons
  //                             //                               .close),
  //                             //                     ),
  //                             //                   ),
  //                             //                 ),
  //                             //                 //.get("folderID").toString()
  //                             //                 //Text(fileAndFolderSource[sortedList[index].id]),
  //                             //
  //                             //                 MoveFileActivity(
  //                             //                   dataToMove:
  //                             //                   sortedList[index]
  //                             //                       .data(),
  //                             //                   recordId: fileAndFolderSource[
  //                             //                   sortedList[index]
  //                             //                       .id]!,
  //                             //                   customerId:
  //                             //                   widget
  //                             //                       .customerId,
  //                             //                   customerFirestore:
  //                             //                   widget
  //                             //                       .customerFirestore,
  //                             //                   curentFolderID: widget
  //                             //                       .folderStack
  //                             //                       .last,locale: widget.locale,),
  //                             //                 //here show move folder target
  //                             //               ],
  //                             //             );
  //                             //           });
  //                             //     }
  //                             //   },
  //                             //   child: Center(
  //                             //       child: Icon(
  //                             //         Icons.menu,
  //                             //         color: Colors.black,
  //                             //       )),
  //                             //   itemBuilder: (BuildContext
  //                             //   context) =>
  //                             //   <
  //                             //       PopupMenuEntry<
  //                             //           folderAction>>[
  //                             //     PopupMenuItem<folderAction>(
  //                             //       value: folderAction.move,
  //                             //       child: Text('Move'),
  //                             //     ),
  //                             //   ],
  //                             // ),
  //                           ),
  //                         ),
  //                       ],
  //                     ),
  //                   );
  //                 }
  //
  //                 return Text(snapshot.data!.docs[index].id);
  //               });
  //
  //
  //         } else {
  //           return Container(width: 0,height: 0,);
  //         }
  //       });
  //
  // }
}